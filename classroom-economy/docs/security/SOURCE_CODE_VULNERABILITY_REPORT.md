# Source Code Vulnerability & Mitigation Strategy

**Scope:** Application logic, input validation, and code defects.

### 1. Financial Race Conditions (Double Spending)
*   **Vulnerability:** The code checks for sufficient funds (`if balance < price`) and then inserts a transaction in a separate step.
*   **Risk:** Concurrent requests can exploit this gap to spend the same money twice or buy items without sufficient funds.
*   **Mitigation Strategy:**
    *   **Database Locking:** Use `db.session.execute(select(...).with_for_update())` to lock the student/account row during the transaction process. This forces sequential processing of financial actions.

### 2. Denial of Service (Login Loop)
*   **Vulnerability:** The student login falls back to iterating through all legacy records if a fast lookup fails.
*   **Risk:** Attackers can exhaust server CPU by flooding the login endpoint with invalid usernames.
*   **Mitigation Strategy:**
    *   **Refactor:** Remove the legacy fallback loop. Enforce a one-time migration script to update all student records with the efficient lookup hash, then remove the O(N) loop code entirely.

### 3. Cross-Site Scripting (XSS)
*   **Vulnerability:** Templates use the `| safe` filter on variables like `period_states_json` and `log.message`.
*   **Risk:** Stored XSS. A malicious admin or manipulated log entry can execute JavaScript in the victim's browser.
*   **Mitigation Strategy:**
    *   **Context-Aware Escaping:** Remove `| safe`. Use Flask/Jinja's built-in `tojson` filter for safely embedding JSON in `<script>` tags (e.g., `{{ data | tojson }}`), which handles escaping correctly.

### 4. Inventory Management Logic
*   **Vulnerability:** Inventory is decremented in application memory (`item.inventory -= 1`), susceptible to race conditions.
*   **Risk:** Selling more items than are available.
*   **Mitigation Strategy:**
    *   **Atomic Updates:** Use a database query to decrement the value: `StoreItem.query.filter_by(id=...).update({"inventory": StoreItem.inventory - quantity})`.
