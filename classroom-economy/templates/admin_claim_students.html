{% extends "layout_admin.html" %}
{% set page_title = "Claim Your Students" %}
{% block title %}Claim Your Students{% endblock %}
{% block page_icon %}group_add{% endblock %}
{% block content %}

<div class="row">
  <div class="col-12">
    <div class="card shadow">
      <div class="card-body">
        <h2 class="card-title mb-4">
          <span class="material-symbols-outlined" style="vertical-align: middle;">group_add</span>
          Welcome! Let's set up your student roster
        </h2>

        <div class="alert alert-info">
          <h5><span class="material-symbols-outlined" style="vertical-align: middle;">info</span> One-Time Setup</h5>
          <p class="mb-2">
            We found <strong>{{ orphaned_students|length }} student(s)</strong> in the system that haven't been assigned to a teacher yet.
          </p>
          <p class="mb-0">
            Please select the students that belong to your class. You can select all, some, or none.
            Once you confirm, these students will be assigned to you and this step won't be shown again.
          </p>
        </div>

        {% if orphaned_students|length == 0 %}
          <div class="alert alert-success">
            <h5><span class="material-symbols-outlined" style="vertical-align: middle;">check_circle</span> All Set!</h5>
            <p class="mb-0">There are no orphaned students in the system. You're ready to go!</p>
          </div>
          <form method="POST" action="{{ url_for('admin.claim_students') }}">
            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
            <button type="submit" class="btn btn-primary">
              <span class="material-symbols-outlined" style="vertical-align: middle;">check</span>
              Complete Setup
            </button>
          </form>
        {% else %}
          <form method="POST" action="{{ url_for('admin.claim_students') }}" id="claimForm">
            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
            <!-- Select All Controls -->
            <div class="mb-3 d-flex justify-content-between align-items-center">
              <div>
                <button type="button" class="btn btn-sm btn-outline-primary" onclick="selectAll()">
                  <span class="material-symbols-outlined" style="vertical-align: middle; font-size: 18px;">select_all</span>
                  Select All
                </button>
                <button type="button" class="btn btn-sm btn-outline-secondary" onclick="deselectAll()">
                  <span class="material-symbols-outlined" style="vertical-align: middle; font-size: 18px;">deselect</span>
                  Deselect All
                </button>
              </div>
              <div>
                <span id="selectedCount" class="badge bg-primary">0 selected</span>
              </div>
            </div>

            <!-- Student List -->
            <div class="table-responsive">
              <table class="table table-hover">
                <thead>
                  <tr>
                    <th style="width: 50px;">
                      <input type="checkbox" id="selectAllCheckbox" onchange="toggleAllCheckboxes(this)">
                    </th>
                    <th>Student Name</th>
                    <th>Block/Period</th>
                    <th>Setup Status</th>
                  </tr>
                </thead>
                <tbody>
                  {% for student in orphaned_students %}
                    <tr>
                      <td>
                        <input type="checkbox"
                               name="student_ids"
                               value="{{ student.id }}"
                               class="student-checkbox"
                               onchange="updateSelectedCount()">
                      </td>
                      <td>
                        <strong>{{ student.first_name }} {{ student.last_initial }}.</strong>
                      </td>
                      <td>
                        <span class="badge bg-secondary">{{ student.block }}</span>
                      </td>
                      <td>
                        {% if student.has_completed_setup %}
                          <span class="badge bg-success">Complete</span>
                        {% else %}
                          <span class="badge bg-warning">Pending</span>
                        {% endif %}
                      </td>
                    </tr>
                  {% endfor %}
                </tbody>
              </table>
            </div>

            <!-- Submit Buttons -->
            <div class="mt-4 d-flex justify-content-between">
              <button type="submit" class="btn btn-primary btn-lg">
                <span class="material-symbols-outlined" style="vertical-align: middle;">check</span>
                Claim Selected Students
              </button>
              <button type="submit" class="btn btn-outline-secondary" onclick="return confirm('Are you sure you don\'t want to claim any students? You can always assign them later via the system admin.')">
                <span class="material-symbols-outlined" style="vertical-align: middle;">skip_next</span>
                Skip for Now
              </button>
            </div>
          </form>
        {% endif %}
      </div>
    </div>
  </div>
</div>

<script>
function selectAll() {
  document.querySelectorAll('.student-checkbox').forEach(cb => cb.checked = true);
  document.getElementById('selectAllCheckbox').checked = true;
  updateSelectedCount();
}

function deselectAll() {
  document.querySelectorAll('.student-checkbox').forEach(cb => cb.checked = false);
  document.getElementById('selectAllCheckbox').checked = false;
  updateSelectedCount();
}

function toggleAllCheckboxes(source) {
  document.querySelectorAll('.student-checkbox').forEach(cb => cb.checked = source.checked);
  updateSelectedCount();
}

function updateSelectedCount() {
  const count = document.querySelectorAll('.student-checkbox:checked').length;
  document.getElementById('selectedCount').textContent = count + ' selected';

  // Update the "select all" checkbox state
  const allCheckboxes = document.querySelectorAll('.student-checkbox');
  const checkedCheckboxes = document.querySelectorAll('.student-checkbox:checked');
  const selectAllCheckbox = document.getElementById('selectAllCheckbox');

  if (checkedCheckboxes.length === 0) {
    selectAllCheckbox.checked = false;
    selectAllCheckbox.indeterminate = false;
  } else if (checkedCheckboxes.length === allCheckboxes.length) {
    selectAllCheckbox.checked = true;
    selectAllCheckbox.indeterminate = false;
  } else {
    selectAllCheckbox.checked = false;
    selectAllCheckbox.indeterminate = true;
  }
}

// Initialize count on page load
document.addEventListener('DOMContentLoaded', updateSelectedCount);
</script>

{% endblock %}
