{% extends "layout_admin.html" %}
{% set page_title = "Payroll Management" %}
{% set current_page = "payroll" %}
{% block title %}Payroll Management{% endblock %}
{% block content %}

<!-- Nav Tabs -->
<ul class="nav nav-tabs mb-4" id="payrollTabs" role="tablist">
  <li class="nav-item" role="presentation">
    <button class="nav-link active" id="overview-tab" data-bs-toggle="tab" data-bs-target="#overview" type="button" role="tab">
      <i class="bi bi-grid me-1"></i>Overview
    </button>
  </li>
  <li class="nav-item" role="presentation">
    <button class="nav-link" id="history-tab" data-bs-toggle="tab" data-bs-target="#history" type="button" role="tab">
      <i class="bi bi-clock-history me-1"></i>History
    </button>
  </li>
  <li class="nav-item" role="presentation">
    <button class="nav-link" id="settings-tab" data-bs-toggle="tab" data-bs-target="#settings" type="button" role="tab">
      <i class="bi bi-gear me-1"></i>Settings
    </button>
  </li>
  <li class="nav-item" role="presentation">
    <button class="nav-link" id="students-tab" data-bs-toggle="tab" data-bs-target="#students" type="button" role="tab">
      <i class="bi bi-people me-1"></i>Students
    </button>
  </li>
  <li class="nav-item" role="presentation">
    <button class="nav-link" id="rewards-fines-tab" data-bs-toggle="tab" data-bs-target="#rewards-fines" type="button" role="tab">
      <i class="bi bi-star me-1"></i>Rewards & Fines
    </button>
  </li>
  <li class="nav-item" role="presentation">
    <button class="nav-link" id="manual-payment-tab" data-bs-toggle="tab" data-bs-target="#manual-payment" type="button" role="tab">
      <i class="bi bi-cash-coin me-1"></i>Manual Payment
    </button>
  </li>
</ul>

<div class="tab-content" id="payrollTabContent">
  <!-- OVERVIEW TAB -->
  <div class="tab-pane fade show active" id="overview" role="tabpanel">
    <div class="row">
      <!-- Next Payroll by Block -->
      <div class="col-lg-6 mb-4">
        <div class="card shadow">
          <div class="card-header bg-primary text-white">
            <h5 class="mb-0"><i class="bi bi-calendar-event me-2"></i>Next Payroll by Block</h5>
          </div>
          <div class="card-body">
            {% if next_payroll_by_block %}
              <div class="table-responsive">
                <table class="table table-sm">
                  <thead>
                    <tr>
                      <th>Block</th>
                      <th>Next Run Date</th>
                      <th>Estimated Payout</th>
                    </tr>
                  </thead>
                  <tbody>
                    {% for block_info in next_payroll_by_block %}
                    <tr>
                      <td><strong>{{ block_info.block }}</strong></td>
                      <td>
                        {% if block_info.next_date %}
                          <span class="local-timestamp" data-timestamp="{{ block_info.next_date.isoformat() }}Z"></span>
                        {% else %}
                          N/A
                        {% endif %}
                      </td>
                      <td>${{ "%.2f"|format(block_info.estimate|default(0)) }}</td>
                    </tr>
                    {% endfor %}
                  </tbody>
                </table>
              </div>
            {% else %}
              <p class="text-muted">No payroll schedule configured.</p>
            {% endif %}
          </div>
        </div>
      </div>

      <!-- Quick Stats -->
      <div class="col-lg-6 mb-4">
        <div class="card shadow">
          <div class="card-header bg-success text-white">
            <h5 class="mb-0"><i class="bi bi-graph-up me-2"></i>Quick Stats</h5>
          </div>
          <div class="card-body">
            <div class="row text-center">
              <div class="col-6 mb-3">
                <h3 class="text-primary">${{ "%.2f"|format(total_payroll_estimate|default(0)) }}</h3>
                <small class="text-muted">Total Estimated Payout</small>
              </div>
              <div class="col-6 mb-3">
                <h3 class="text-success">{{ total_students|default(0) }}</h3>
                <small class="text-muted">Total Students</small>
              </div>
              <div class="col-6">
                <h3 class="text-info">${{ "%.2f"|format(avg_payout|default(0)) }}</h3>
                <small class="text-muted">Average Payout</small>
              </div>
              <div class="col-6">
                <h3 class="text-warning">{{ total_blocks|default(0) }}</h3>
                <small class="text-muted">Active Blocks</small>
              </div>
            </div>
            <hr>
            <button id="runPayrollBtn" class="btn btn-primary w-100">
              <i class="bi bi-play-circle me-2"></i>Run Payroll Now
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Recent Payroll Activity -->
    <div class="card shadow">
      <div class="card-header">
        <h5 class="mb-0"><i class="bi bi-list-ul me-2"></i>Recent Payroll Activity</h5>
      </div>
      <div class="card-body">
        {% if recent_payrolls %}
          <div class="table-responsive">
            <table class="table table-striped table-hover">
              <thead>
                <tr>
                  <th>Date</th>
                  <th>Student Name</th>
                  <th>Block</th>
                  <th>Amount</th>
                  <th>Account</th>
                </tr>
              </thead>
              <tbody>
                {% for record in recent_payrolls %}
                <tr>
                  <td>
                    {% if record.timestamp %}
                      <span class="local-timestamp" data-timestamp="{{ record.timestamp.isoformat() }}Z"></span>
                    {% else %}
                      N/A
                    {% endif %}
                  </td>
                  <td>
                    {% if record.student %}
                      <a href="{{ url_for('student_detail', student_id=record.student_id) }}">
                        {{ record.student.full_name }}
                      </a>
                    {% else %}
                      <em>Unknown</em>
                    {% endif %}
                  </td>
                  <td>{{ record.student.block if record.student else "N/A" }}</td>
                  <td class="text-success fw-bold">${{ "%.2f"|format(record.amount) }}</td>
                  <td><span class="badge bg-secondary">{{ record.account_type|title }}</span></td>
                </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
          <div class="text-end">
            <a href="{{ url_for('admin_payroll_history') }}" class="btn btn-outline-secondary btn-sm">View Full History</a>
          </div>
        {% else %}
          <p class="text-muted">No recent payrolls found.</p>
        {% endif %}
      </div>
    </div>
  </div>

  <!-- HISTORY TAB -->
  <div class="tab-pane fade" id="history" role="tabpanel">
    <div class="card shadow">
      <div class="card-header">
        <h5 class="mb-0"><i class="bi bi-clock-history me-2"></i>Payroll History</h5>
      </div>
      <div class="card-body">
        <p>View detailed payroll history with filtering options.</p>
        <a href="{{ url_for('admin_payroll_history') }}" class="btn btn-primary">
          <i class="bi bi-box-arrow-up-right me-2"></i>Open Full History Page
        </a>
      </div>
    </div>
  </div>

  <!-- SETTINGS TAB -->
  <div class="tab-pane fade" id="settings" role="tabpanel">
    <div class="card shadow mb-4">
      <div class="card-header bg-primary text-white">
        <h5 class="mb-0"><i class="bi bi-gear me-2"></i>Payroll Settings</h5>
      </div>
      <div class="card-body">
        <form method="POST" action="{{ url_for('admin_payroll_settings') }}" id="payrollSettingsForm">
          {{ settings_form.hidden_tag() }}

          <!-- 2x2 Card Grid -->
          <div class="row">
            <!-- Top Left: Global Pay Rate Settings -->
            <div class="col-lg-6 mb-4">
              <div class="card shadow-sm h-100 border-primary">
                <div class="card-header bg-primary bg-opacity-10">
                  <h6 class="mb-0 text-primary"><i class="bi bi-currency-dollar me-2"></i>Pay Rate Settings</h6>
                </div>
                <div class="card-body">
                  <div class="mb-3">
                    {{ settings_form.pay_rate.label(class="form-label fw-bold") }}
                    <div class="input-group">
                      <span class="input-group-text">$</span>
                      {{ settings_form.pay_rate(class="form-control", placeholder="0.25", step="0.01") }}
                      <span class="input-group-text">/min</span>
                    </div>
                    <small class="text-muted">Amount paid per minute of attendance</small>
                  </div>
                  <div class="mb-3">
                    {{ settings_form.bonus_rate.label(class="form-label fw-bold") }}
                    <div class="input-group">
                      <span class="input-group-text">$</span>
                      {{ settings_form.bonus_rate(class="form-control", placeholder="0.00", step="0.01") }}
                      <span class="input-group-text">/min</span>
                    </div>
                    <small class="text-muted">Additional bonus rate (optional)</small>
                  </div>
                  <div class="mb-0">
                    {{ settings_form.overtime_multiplier.label(class="form-label fw-bold") }}
                    <div class="input-group">
                      {{ settings_form.overtime_multiplier(class="form-control", placeholder="1.0", step="0.1") }}
                      <span class="input-group-text">x</span>
                    </div>
                    <small class="text-muted">Multiplier for overtime hours</small>
                  </div>
                </div>
              </div>
            </div>

            <!-- Top Right: Schedule & Frequency -->
            <div class="col-lg-6 mb-4">
              <div class="card shadow-sm h-100 border-success">
                <div class="card-header bg-success bg-opacity-10">
                  <h6 class="mb-0 text-success"><i class="bi bi-calendar-check me-2"></i>Schedule & Frequency</h6>
                </div>
                <div class="card-body">
                  <div class="mb-3">
                    {{ settings_form.payroll_frequency_days.label(class="form-label fw-bold") }}
                    <div class="input-group">
                      {{ settings_form.payroll_frequency_days(class="form-control", placeholder="14") }}
                      <span class="input-group-text">days</span>
                    </div>
                    <small class="text-muted">How often payroll runs (e.g., 14 = bi-weekly)</small>
                  </div>
                  <div class="alert alert-info mb-0">
                    <small>
                      <i class="bi bi-info-circle me-2"></i>
                      <strong>Next Payroll:</strong>
                      {% if next_global_payroll %}
                        <span class="local-timestamp" data-timestamp="{{ next_global_payroll.isoformat() }}Z"></span>
                      {% else %}
                        Not scheduled
                      {% endif %}
                    </small>
                  </div>
                </div>
              </div>
            </div>

            <!-- Bottom Left: Per-Block Settings -->
            <div class="col-lg-6 mb-4">
              <div class="card shadow-sm h-100 border-info">
                <div class="card-header bg-info bg-opacity-10">
                  <h6 class="mb-0 text-info"><i class="bi bi-calendar2-week me-2"></i>Block-Specific Settings</h6>
                </div>
                <div class="card-body">
                  <div class="mb-3">
                    {{ settings_form.block.label(class="form-label fw-bold") }}
                    {{ settings_form.block(class="form-select") }}
                    <small class="text-muted">Apply settings to specific block or global</small>
                  </div>
                  <div class="mb-3">
                    <div class="form-check form-switch">
                      {{ settings_form.apply_to_all(class="form-check-input", role="switch") }}
                      {{ settings_form.apply_to_all.label(class="form-check-label fw-bold") }}
                    </div>
                    <small class="text-muted">Apply these settings to all blocks</small>
                  </div>
                  <div class="alert alert-light border mb-0">
                    <small>
                      <strong>Current Block Settings:</strong><br>
                      {% if block_settings %}
                        {% for setting in block_settings %}
                          <span class="badge bg-secondary me-1">{{ setting.block or "Global" }}: ${{ "%.2f"|format(setting.pay_rate) }}/min</span>
                        {% endfor %}
                      {% else %}
                        No specific settings configured
                      {% endif %}
                    </small>
                  </div>
                </div>
              </div>
            </div>

            <!-- Bottom Right: Advanced Options -->
            <div class="col-lg-6 mb-4">
              <div class="card shadow-sm h-100 border-warning">
                <div class="card-header bg-warning bg-opacity-10">
                  <h6 class="mb-0 text-warning"><i class="bi bi-sliders me-2"></i>Advanced Options</h6>
                </div>
                <div class="card-body">
                  <div class="mb-3">
                    <div class="form-check form-switch">
                      {{ settings_form.is_active(class="form-check-input", role="switch") }}
                      {{ settings_form.is_active.label(class="form-check-label fw-bold") }}
                    </div>
                    <small class="text-muted">Enable/disable these settings</small>
                  </div>
                  <div class="alert alert-warning mb-0">
                    <small>
                      <i class="bi bi-exclamation-triangle me-2"></i>
                      <strong>Note:</strong> Changes to payroll settings will affect the next payroll run. Past payrolls are not retroactively adjusted.
                    </small>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <div class="text-end">
            {{ settings_form.submit(class="btn btn-primary btn-lg") }}
          </div>
        </form>
      </div>
    </div>
  </div>

  <!-- STUDENTS TAB -->
  <div class="tab-pane fade" id="students" role="tabpanel">
    <div class="card shadow">
      <div class="card-header">
        <h5 class="mb-0"><i class="bi bi-people me-2"></i>Student Payroll Statistics</h5>
      </div>
      <div class="card-body">
        {% if student_stats %}
          <div class="table-responsive">
            <table class="table table-striped table-hover">
              <thead>
                <tr>
                  <th>Student Name</th>
                  <th>Block</th>
                  <th>Unpaid Time</th>
                  <th>Estimated Payout</th>
                  <th>Last Payroll</th>
                  <th>Total Earned</th>
                </tr>
              </thead>
              <tbody>
                {% for stat in student_stats %}
                <tr>
                  <td>
                    <a href="{{ url_for('student_detail', student_id=stat.student_id) }}">
                      {{ stat.student_name }}
                    </a>
                  </td>
                  <td>{{ stat.block }}</td>
                  <td>{{ stat.unpaid_minutes|default(0) }} min</td>
                  <td class="text-success fw-bold">${{ "%.2f"|format(stat.estimated_payout|default(0)) }}</td>
                  <td>
                    {% if stat.last_payroll_date %}
                      <span class="local-timestamp" data-timestamp="{{ stat.last_payroll_date.isoformat() }}Z"></span>
                    {% else %}
                      Never
                    {% endif %}
                  </td>
                  <td class="text-primary fw-bold">${{ "%.2f"|format(stat.total_earned|default(0)) }}</td>
                </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
        {% else %}
          <p class="text-muted">No student data available.</p>
        {% endif %}
      </div>
    </div>
  </div>

  <!-- REWARDS & FINES TAB -->
  <div class="tab-pane fade" id="rewards-fines" role="tabpanel">
    <div class="row">
      <!-- Rewards Section -->
      <div class="col-lg-6 mb-4">
        <div class="card shadow h-100">
          <div class="card-header bg-success text-white">
            <h5 class="mb-0"><i class="bi bi-award me-2"></i>Rewards</h5>
          </div>
          <div class="card-body">
            <!-- Add Reward Form -->
            <form method="POST" action="{{ url_for('admin_payroll_add_reward') }}" class="mb-4">
              {{ reward_form.hidden_tag() }}
              <div class="mb-2">
                {{ reward_form.name(class="form-control form-control-sm", placeholder="Reward Name") }}
              </div>
              <div class="mb-2">
                {{ reward_form.description(class="form-control form-control-sm", rows=2, placeholder="Description (optional)") }}
              </div>
              <div class="input-group input-group-sm mb-2">
                <span class="input-group-text">$</span>
                {{ reward_form.amount(class="form-control", placeholder="Amount", step="0.01") }}
              </div>
              <div class="form-check form-switch mb-2">
                {{ reward_form.is_active(class="form-check-input", role="switch", checked="checked") }}
                {{ reward_form.is_active.label(class="form-check-label") }}
              </div>
              {{ reward_form.submit(class="btn btn-success btn-sm w-100") }}
            </form>

            <!-- Existing Rewards -->
            <hr>
            <h6>Existing Rewards</h6>
            {% if rewards %}
              <ul class="list-group list-group-flush">
                {% for reward in rewards %}
                <li class="list-group-item d-flex justify-content-between align-items-center">
                  <div>
                    <strong>{{ reward.name }}</strong>
                    {% if reward.description %}
                      <br><small class="text-muted">{{ reward.description }}</small>
                    {% endif %}
                  </div>
                  <div class="text-end">
                    <span class="badge bg-success">${{ "%.2f"|format(reward.amount) }}</span>
                    {% if not reward.is_active %}
                      <span class="badge bg-secondary">Inactive</span>
                    {% endif %}
                    <br>
                    <button class="btn btn-sm btn-outline-danger mt-1" onclick="deleteReward({{ reward.id }})">Delete</button>
                  </div>
                </li>
                {% endfor %}
              </ul>
            {% else %}
              <p class="text-muted small">No rewards created yet.</p>
            {% endif %}
          </div>
        </div>
      </div>

      <!-- Fines Section -->
      <div class="col-lg-6 mb-4">
        <div class="card shadow h-100">
          <div class="card-header bg-danger text-white">
            <h5 class="mb-0"><i class="bi bi-exclamation-triangle me-2"></i>Fines</h5>
          </div>
          <div class="card-body">
            <!-- Add Fine Form -->
            <form method="POST" action="{{ url_for('admin_payroll_add_fine') }}" class="mb-4">
              {{ fine_form.hidden_tag() }}
              <div class="mb-2">
                {{ fine_form.name(class="form-control form-control-sm", placeholder="Fine Name") }}
              </div>
              <div class="mb-2">
                {{ fine_form.description(class="form-control form-control-sm", rows=2, placeholder="Description (optional)") }}
              </div>
              <div class="input-group input-group-sm mb-2">
                <span class="input-group-text">$</span>
                {{ fine_form.amount(class="form-control", placeholder="Amount", step="0.01") }}
              </div>
              <div class="form-check form-switch mb-2">
                {{ fine_form.is_active(class="form-check-input", role="switch", checked="checked") }}
                {{ fine_form.is_active.label(class="form-check-label") }}
              </div>
              {{ fine_form.submit(class="btn btn-danger btn-sm w-100") }}
            </form>

            <!-- Existing Fines -->
            <hr>
            <h6>Existing Fines</h6>
            {% if fines %}
              <ul class="list-group list-group-flush">
                {% for fine in fines %}
                <li class="list-group-item d-flex justify-content-between align-items-center">
                  <div>
                    <strong>{{ fine.name }}</strong>
                    {% if fine.description %}
                      <br><small class="text-muted">{{ fine.description }}</small>
                    {% endif %}
                  </div>
                  <div class="text-end">
                    <span class="badge bg-danger">-${{ "%.2f"|format(fine.amount) }}</span>
                    {% if not fine.is_active %}
                      <span class="badge bg-secondary">Inactive</span>
                    {% endif %}
                    <br>
                    <button class="btn btn-sm btn-outline-danger mt-1" onclick="deleteFine({{ fine.id }})">Delete</button>
                  </div>
                </li>
                {% endfor %}
              </ul>
            {% else %}
              <p class="text-muted small">No fines created yet.</p>
            {% endif %}
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- MANUAL PAYMENT TAB -->
  <div class="tab-pane fade" id="manual-payment" role="tabpanel">
    <div class="card shadow">
      <div class="card-header bg-primary text-white">
        <h5 class="mb-0"><i class="bi bi-cash-coin me-2"></i>Send Manual Payment</h5>
      </div>
      <div class="card-body">
        <form method="POST" action="{{ url_for('admin_payroll_manual_payment') }}" id="manualPaymentForm">
          {{ manual_payment_form.hidden_tag() }}

          <div class="row">
            <div class="col-lg-6">
              <div class="card mb-3">
                <div class="card-header">
                  <h6 class="mb-0">Payment Details</h6>
                </div>
                <div class="card-body">
                  <div class="mb-3">
                    {{ manual_payment_form.description.label(class="form-label fw-bold") }}
                    {{ manual_payment_form.description(class="form-control", placeholder="e.g., Bonus for excellent attendance") }}
                  </div>
                  <div class="mb-3">
                    {{ manual_payment_form.amount.label(class="form-label fw-bold") }}
                    <div class="input-group">
                      <span class="input-group-text">$</span>
                      {{ manual_payment_form.amount(class="form-control", placeholder="0.00", step="0.01") }}
                    </div>
                  </div>
                  <div class="mb-3">
                    {{ manual_payment_form.account_type.label(class="form-label fw-bold") }}
                    {{ manual_payment_form.account_type(class="form-select") }}
                  </div>
                </div>
              </div>
            </div>

            <div class="col-lg-6">
              <div class="card mb-3">
                <div class="card-header">
                  <h6 class="mb-0">Select Students</h6>
                </div>
                <div class="card-body" style="max-height: 400px; overflow-y: auto;">
                  <div class="form-check mb-2">
                    <input class="form-check-input" type="checkbox" id="selectAllStudents">
                    <label class="form-check-label fw-bold" for="selectAllStudents">
                      Select All Students
                    </label>
                  </div>
                  <hr>
                  {% if all_students %}
                    {% for student in all_students %}
                    <div class="form-check mb-2">
                      <input class="form-check-input student-checkbox" type="checkbox" name="student_ids" value="{{ student.id }}" id="student_{{ student.id }}">
                      <label class="form-check-label" for="student_{{ student.id }}">
                        {{ student.full_name }} <small class="text-muted">({{ student.block }})</small>
                      </label>
                    </div>
                    {% endfor %}
                  {% else %}
                    <p class="text-muted">No students found.</p>
                  {% endif %}
                </div>
              </div>
            </div>
          </div>

          <div class="alert alert-info">
            <i class="bi bi-info-circle me-2"></i>
            <strong>Selected:</strong> <span id="selectedCount">0</span> student(s) will receive this payment.
          </div>

          <div class="text-end">
            {{ manual_payment_form.submit(class="btn btn-primary btn-lg") }}
          </div>
        </form>
      </div>
    </div>
  </div>
</div>

<!-- JavaScript -->
<script>
// Convert UTC timestamps to local time
document.addEventListener("DOMContentLoaded", () => {
    document.querySelectorAll(".local-timestamp").forEach(el => {
        const utcString = el.dataset.timestamp;
        if (utcString) {
            const date = new Date(utcString);
            const options = {
                year: 'numeric',
                month: 'short',
                day: 'numeric',
                hour: 'numeric',
                minute: 'numeric',
                hour12: true
            };
            el.textContent = date.toLocaleString(undefined, options);
        } else {
            el.textContent = 'â€”';
        }
    });

    // Select All Students checkbox
    const selectAllCheckbox = document.getElementById('selectAllStudents');
    const studentCheckboxes = document.querySelectorAll('.student-checkbox');
    const selectedCountEl = document.getElementById('selectedCount');

    if (selectAllCheckbox) {
        selectAllCheckbox.addEventListener('change', function() {
            studentCheckboxes.forEach(cb => cb.checked = this.checked);
            updateSelectedCount();
        });
    }

    studentCheckboxes.forEach(cb => {
        cb.addEventListener('change', updateSelectedCount);
    });

    function updateSelectedCount() {
        const count = Array.from(studentCheckboxes).filter(cb => cb.checked).length;
        if (selectedCountEl) {
            selectedCountEl.textContent = count;
        }
    }

    updateSelectedCount();
});

// Run Payroll
document.getElementById('runPayrollBtn')?.addEventListener('click', async function() {
  const csrfToken = document.querySelector('meta[name="csrf-token"]').getAttribute('content');
  try {
    const resp = await fetch('{{ url_for("run_payroll") }}', {
      method: 'POST',
      headers: {
        'X-Requested-With': 'XMLHttpRequest',
        'Content-Type': 'application/json',
        'X-CSRFToken': csrfToken
      }
    });
    const payload = await resp.json();
    if (!resp.ok) throw new Error(payload.message || 'Payroll failed');
    showToast(payload.message || 'Payroll complete.', 'success');
    setTimeout(() => location.reload(), 1500);
  } catch (e) {
    showToast(e.message, 'error');
  }
});

// Delete Reward
function deleteReward(rewardId) {
  if (!confirm('Are you sure you want to delete this reward?')) return;

  const csrfToken = document.querySelector('meta[name="csrf-token"]').getAttribute('content');
  fetch(`/admin/payroll/rewards/${rewardId}/delete`, {
    method: 'POST',
    headers: {
      'X-CSRFToken': csrfToken,
      'Content-Type': 'application/json'
    }
  })
  .then(resp => resp.json())
  .then(data => {
    if (data.success) {
      showToast('Reward deleted successfully', 'success');
      setTimeout(() => location.reload(), 1000);
    } else {
      showToast(data.message || 'Failed to delete reward', 'error');
    }
  })
  .catch(err => showToast('Error deleting reward', 'error'));
}

// Delete Fine
function deleteFine(fineId) {
  if (!confirm('Are you sure you want to delete this fine?')) return;

  const csrfToken = document.querySelector('meta[name="csrf-token"]').getAttribute('content');
  fetch(`/admin/payroll/fines/${fineId}/delete`, {
    method: 'POST',
    headers: {
      'X-CSRFToken': csrfToken,
      'Content-Type': 'application/json'
    }
  })
  .then(resp => resp.json())
  .then(data => {
    if (data.success) {
      showToast('Fine deleted successfully', 'success');
      setTimeout(() => location.reload(), 1000);
    } else {
      showToast(data.message || 'Failed to delete fine', 'error');
    }
  })
  .catch(err => showToast('Error deleting fine', 'error'));
}

// Toast notification helper (assumes this exists in layout)
function showToast(message, type) {
  // If there's a global toast function, use it
  // Otherwise, just alert
  if (window.toast) {
    window.toast(message, type);
  } else {
    alert(message);
  }
}
</script>

{% endblock %}
