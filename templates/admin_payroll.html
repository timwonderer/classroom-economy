{% extends "layout_admin.html" %}
{% set page_title = "Payroll Management" %}
{% set current_page = "payroll" %}
{% block title %}Payroll Management{% endblock %}
{% block content %}

<!-- Nav Tabs -->
<ul class="nav nav-tabs mb-4" id="payrollTabs" role="tablist">
  <li class="nav-item" role="presentation">
    <button class="nav-link active" id="overview-tab" data-bs-toggle="tab" data-bs-target="#overview" type="button" role="tab">
      <i class="bi bi-grid me-1"></i>Overview
    </button>
  </li>
  <li class="nav-item" role="presentation">
    <button class="nav-link" id="history-tab" data-bs-toggle="tab" data-bs-target="#history" type="button" role="tab">
      <i class="bi bi-clock-history me-1"></i>History
    </button>
  </li>
  <li class="nav-item" role="presentation">
    <button class="nav-link" id="settings-tab" data-bs-toggle="tab" data-bs-target="#settings" type="button" role="tab">
      <i class="bi bi-gear me-1"></i>Settings
    </button>
  </li>
  <li class="nav-item" role="presentation">
    <button class="nav-link" id="rewards-fines-tab" data-bs-toggle="tab" data-bs-target="#rewards-fines" type="button" role="tab">
      <i class="bi bi-star me-1"></i>Rewards & Fines
    </button>
  </li>
  <li class="nav-item" role="presentation">
    <button class="nav-link" id="manual-payment-tab" data-bs-toggle="tab" data-bs-target="#manual-payment" type="button" role="tab">
      <i class="bi bi-cash-coin me-1"></i>Manual
    </button>
  </li>
</ul>

<div class="tab-content" id="payrollTabContent">
  <!-- OVERVIEW TAB -->
  <div class="tab-pane fade show active" id="overview" role="tabpanel">
    <div class="row">
      <!-- Next Payroll by Block -->
      <div class="col-lg-6 mb-4">
        <div class="card shadow">
          <div class="card-header bg-primary text-white">
            <h5 class="mb-0"><i class="bi bi-calendar-event me-2"></i>Next Payroll by Block</h5>
          </div>
          <div class="card-body">
            {% if next_payroll_by_block %}
              <div class="table-responsive">
                <table class="table table-sm">
                  <thead>
                    <tr>
                      <th>Block</th>
                      <th>Next Run Date</th>
                      <th>Estimated Payout</th>
                    </tr>
                  </thead>
                  <tbody>
                    {% for block_info in next_payroll_by_block %}
                    <tr>
                      <td><strong>{{ block_info.block }}</strong></td>
                      <td>
                        {% if block_info.next_date %}
                          <span class="local-timestamp" data-timestamp="{{ block_info.next_date.isoformat() }}Z"></span>
                        {% else %}
                          N/A
                        {% endif %}
                      </td>
                      <td>${{ "%.2f"|format(block_info.estimate|default(0)) }}</td>
                    </tr>
                    {% endfor %}
                  </tbody>
                </table>
              </div>
            {% else %}
              <p class="text-muted">No payroll schedule configured.</p>
            {% endif %}
          </div>
        </div>
      </div>

      <!-- Quick Stats -->
      <div class="col-lg-6 mb-4">
        <div class="card shadow">
          <div class="card-header bg-success text-white">
            <h5 class="mb-0"><i class="bi bi-graph-up me-2"></i>Quick Stats</h5>
          </div>
          <div class="card-body">
            <div class="row text-center">
              <div class="col-6 mb-3">
                <h3 class="text-primary">${{ "%.2f"|format(total_payroll_estimate|default(0)) }}</h3>
                <small class="text-muted">Total Estimated Payout</small>
              </div>
              <div class="col-6 mb-3">
                <h3 class="text-success">{{ total_students|default(0) }}</h3>
                <small class="text-muted">Total Students</small>
              </div>
              <div class="col-6">
                <h3 class="text-info">${{ "%.2f"|format(avg_payout|default(0)) }}</h3>
                <small class="text-muted">Average Payout</small>
              </div>
              <div class="col-6">
                <h3 class="text-warning">{{ total_blocks|default(0) }}</h3>
                <small class="text-muted">Active Blocks</small>
              </div>
            </div>
            <hr>
            <button id="runPayrollBtn" class="btn btn-primary w-100">
              <i class="bi bi-play-circle me-2"></i>Run Payroll Now
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Recent Payroll Activity -->
    <div class="card shadow">
      <div class="card-header">
        <h5 class="mb-0"><i class="bi bi-list-ul me-2"></i>Recent Payroll Activity</h5>
      </div>
      <div class="card-body">
        {% if recent_payrolls %}
          <div class="table-responsive">
            <table class="table table-striped table-hover">
              <thead>
                <tr>
                  <th>Date</th>
                  <th>Student Name</th>
                  <th>Block</th>
                  <th>Amount</th>
                  <th>Account</th>
                </tr>
              </thead>
              <tbody>
                {% for record in recent_payrolls %}
                <tr>
                  <td>
                    {% if record.timestamp %}
                      <span class="local-timestamp" data-timestamp="{{ record.timestamp.isoformat() }}Z"></span>
                    {% else %}
                      N/A
                    {% endif %}
                  </td>
                  <td>
                    {% if record.student %}
                      <a href="{{ url_for('student_detail', student_id=record.student_id) }}">
                        {{ record.student.full_name }}
                      </a>
                    {% else %}
                      <em>Unknown</em>
                    {% endif %}
                  </td>
                  <td>{{ record.student.block if record.student else "N/A" }}</td>
                  <td class="text-success fw-bold">${{ "%.2f"|format(record.amount) }}</td>
                  <td><span class="badge bg-secondary">{{ record.account_type|title }}</span></td>
                </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
          <div class="text-end">
            <a href="{{ url_for('admin_payroll_history') }}" class="btn btn-outline-secondary btn-sm">View Full History</a>
          </div>
        {% else %}
          <p class="text-muted">No recent payrolls found.</p>
        {% endif %}
      </div>
    </div>
  </div>

  <!-- HISTORY TAB -->
  <div class="tab-pane fade" id="history" role="tabpanel">
    <div class="card shadow">
      <div class="card-header">
        <h5 class="mb-0"><i class="bi bi-clock-history me-2"></i>Payroll History</h5>
      </div>
      <div class="card-body">
        <!-- Filter and Actions -->
        <div class="row mb-3">
          <div class="col-md-4">
            <label for="historyBlockFilter" class="form-label fw-bold">Block:</label>
            <select id="historyBlockFilter" class="form-select">
              <option value="">All Blocks</option>
              {% for block in blocks %}
                <option value="{{ block }}">{{ block }}</option>
              {% endfor %}
            </select>
          </div>
          <div class="col-md-8 text-end">
            <button id="voidSelectedBtn" class="btn btn-danger" disabled>
              <i class="bi bi-x-circle me-2"></i>Void Selected (<span id="voidCount">0</span>)
            </button>
          </div>
        </div>

        <!-- History Table -->
        <div class="table-responsive">
          <table class="table table-striped table-hover" id="payrollHistoryTable">
            <thead>
              <tr>
                <th width="40">
                  <input type="checkbox" id="selectAllHistory" class="form-check-input">
                </th>
                <th>Date</th>
                <th>Type</th>
                <th>Block</th>
                <th>Student</th>
                <th>Amount</th>
                <th>Notes</th>
                <th width="100">Actions</th>
              </tr>
            </thead>
            <tbody>
              {% if payroll_history %}
                {% for entry in payroll_history %}
                <tr data-block="{{ entry.block }}" data-transaction-id="{{ entry.transaction_id }}" class="{% if entry.is_void %}table-secondary text-muted{% endif %}">
                  <td>
                    {% if not entry.is_void %}
                    <input type="checkbox" class="form-check-input history-checkbox" value="{{ entry.transaction_id }}">
                    {% endif %}
                  </td>
                  <td>
                    {% if entry.timestamp %}
                      <span class="local-timestamp" data-timestamp="{{ entry.timestamp.isoformat() }}Z"></span>
                    {% else %}
                      —
                    {% endif %}
                  </td>
                  <td>
                    <span class="badge bg-{% if entry.type == 'payroll' %}primary{% elif entry.type == 'reward' %}success{% elif entry.type == 'fine' %}danger{% else %}secondary{% endif %}">
                      {{ entry.type|title }}
                    </span>
                  </td>
                  <td>{{ entry.block }}</td>
                  <td>
                    {% if entry.student %}
                      <a href="{{ url_for('student_detail', student_id=entry.student_id) }}">
                        {{ entry.student_name }}
                      </a>
                    {% else %}
                      {{ entry.student_name }}
                    {% endif %}
                  </td>
                  <td class="{% if entry.amount > 0 %}text-success{% else %}text-danger{% endif %} fw-bold">
                    ${{ "%.2f"|format(entry.amount) }}
                    {% if entry.is_void %}
                      <span class="badge bg-secondary ms-1">VOID</span>
                    {% endif %}
                  </td>
                  <td>{{ entry.notes }}</td>
                  <td>
                    {% if not entry.is_void %}
                      <button class="btn btn-sm btn-outline-danger" onclick="voidTransaction({{ entry.transaction_id }})">
                        <i class="bi bi-x-circle"></i> Void
                      </button>
                    {% else %}
                      <span class="text-muted small">Voided</span>
                    {% endif %}
                  </td>
                </tr>
                {% endfor %}
              {% else %}
                <tr><td colspan="8" class="text-center text-muted">No payroll records found.</td></tr>
              {% endif %}
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </div>

  <!-- SETTINGS TAB -->
  <div class="tab-pane fade" id="settings" role="tabpanel">
    <div class="card shadow mb-4">
      <div class="card-header bg-primary text-white">
        <h5 class="mb-0"><i class="bi bi-gear me-2"></i>Payroll Settings</h5>
      </div>
      <div class="card-body">
        <form method="POST" action="{{ url_for('admin_payroll_settings') }}" id="payrollSettingsForm">
          {{ settings_form.hidden_tag() }}

          <!-- 2x2 Card Grid -->
          <div class="row">
            <!-- Top Left: Global Pay Rate Settings -->
            <div class="col-lg-6 mb-4">
              <div class="card shadow-sm h-100 border-primary">
                <div class="card-header bg-primary bg-opacity-10">
                  <h6 class="mb-0 text-primary"><i class="bi bi-currency-dollar me-2"></i>Pay Rate Settings</h6>
                </div>
                <div class="card-body">
                  <div class="mb-3">
                    {{ settings_form.pay_rate.label(class="form-label fw-bold") }}
                    <div class="input-group">
                      <span class="input-group-text">$</span>
                      {{ settings_form.pay_rate(class="form-control", placeholder="0.25", step="0.01") }}
                      <span class="input-group-text">/min</span>
                    </div>
                    <small class="text-muted">Amount paid per minute of attendance</small>
                  </div>
                  <div class="mb-3">
                    {{ settings_form.bonus_rate.label(class="form-label fw-bold") }}
                    <div class="input-group">
                      <span class="input-group-text">$</span>
                      {{ settings_form.bonus_rate(class="form-control", placeholder="0.00", step="0.01") }}
                      <span class="input-group-text">/min</span>
                    </div>
                    <small class="text-muted">Additional bonus rate (optional)</small>
                  </div>
                  <div class="mb-0">
                    {{ settings_form.overtime_multiplier.label(class="form-label fw-bold") }}
                    <div class="input-group">
                      {{ settings_form.overtime_multiplier(class="form-control", placeholder="1.0", step="0.1") }}
                      <span class="input-group-text">x</span>
                    </div>
                    <small class="text-muted">Multiplier for overtime hours</small>
                  </div>
                </div>
              </div>
            </div>

            <!-- Top Right: Schedule & Frequency -->
            <div class="col-lg-6 mb-4">
              <div class="card shadow-sm h-100 border-success">
                <div class="card-header bg-success bg-opacity-10">
                  <h6 class="mb-0 text-success"><i class="bi bi-calendar-check me-2"></i>Schedule & Frequency</h6>
                </div>
                <div class="card-body">
                  <div class="mb-3">
                    {{ settings_form.payroll_frequency_days.label(class="form-label fw-bold") }}
                    <div class="input-group">
                      {{ settings_form.payroll_frequency_days(class="form-control", placeholder="14") }}
                      <span class="input-group-text">days</span>
                    </div>
                    <small class="text-muted">How often payroll runs (e.g., 14 = bi-weekly)</small>
                  </div>
                  <div class="alert alert-info mb-0">
                    <small>
                      <i class="bi bi-info-circle me-2"></i>
                      <strong>Next Payroll:</strong>
                      {% if next_global_payroll %}
                        <span class="local-timestamp" data-timestamp="{{ next_global_payroll.isoformat() }}Z"></span>
                      {% else %}
                        Not scheduled
                      {% endif %}
                    </small>
                  </div>
                </div>
              </div>
            </div>

            <!-- Bottom Left: Per-Block Settings -->
            <div class="col-lg-6 mb-4">
              <div class="card shadow-sm h-100 border-info">
                <div class="card-header bg-info bg-opacity-10">
                  <h6 class="mb-0 text-info"><i class="bi bi-calendar2-week me-2"></i>Block-Specific Settings</h6>
                </div>
                <div class="card-body">
                  <div class="mb-3">
                    {{ settings_form.block.label(class="form-label fw-bold") }}
                    {{ settings_form.block(class="form-select") }}
                    <small class="text-muted">Apply settings to specific block or global</small>
                  </div>
                  <div class="mb-3">
                    <div class="form-check form-switch">
                      {{ settings_form.apply_to_all(class="form-check-input", role="switch") }}
                      {{ settings_form.apply_to_all.label(class="form-check-label fw-bold") }}
                    </div>
                    <small class="text-muted">Apply these settings to all blocks</small>
                  </div>
                  <div class="alert alert-light border mb-0">
                    <small>
                      <strong>Current Block Settings:</strong><br>
                      {% if block_settings %}
                        {% for setting in block_settings %}
                          <span class="badge bg-secondary me-1">{{ setting.block or "Global" }}: ${{ "%.2f"|format(setting.pay_rate) }}/min</span>
                        {% endfor %}
                      {% else %}
                        No specific settings configured
                      {% endif %}
                    </small>
                  </div>
                </div>
              </div>
            </div>

            <!-- Bottom Right: Advanced Options -->
            <div class="col-lg-6 mb-4">
              <div class="card shadow-sm h-100 border-warning">
                <div class="card-header bg-warning bg-opacity-10">
                  <h6 class="mb-0 text-warning"><i class="bi bi-sliders me-2"></i>Advanced Options</h6>
                </div>
                <div class="card-body">
                  <div class="mb-3">
                    <div class="form-check form-switch">
                      {{ settings_form.is_active(class="form-check-input", role="switch") }}
                      {{ settings_form.is_active.label(class="form-check-label fw-bold") }}
                    </div>
                    <small class="text-muted">Enable/disable these settings</small>
                  </div>
                  <div class="alert alert-warning mb-0">
                    <small>
                      <i class="bi bi-exclamation-triangle me-2"></i>
                      <strong>Note:</strong> Changes to payroll settings will affect the next payroll run. Past payrolls are not retroactively adjusted.
                    </small>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <div class="text-end">
            {{ settings_form.submit(class="btn btn-primary btn-lg") }}
          </div>
        </form>
      </div>
    </div>
  </div>

  <!-- REWARDS & FINES TAB -->
  <div class="tab-pane fade" id="rewards-fines" role="tabpanel">
    <div class="row">
      <!-- Rewards Section -->
      <div class="col-lg-6 mb-4">
        <div class="card shadow h-100">
          <div class="card-header bg-success text-white">
            <h5 class="mb-0"><i class="bi bi-award me-2"></i>Rewards</h5>
          </div>
          <div class="card-body">
            <!-- Add Reward Form -->
            <form method="POST" action="{{ url_for('admin_payroll_add_reward') }}" class="mb-4">
              {{ reward_form.hidden_tag() }}
              <div class="mb-2">
                {{ reward_form.name(class="form-control form-control-sm", placeholder="Reward Name") }}
              </div>
              <div class="mb-2">
                {{ reward_form.description(class="form-control form-control-sm", rows=2, placeholder="Description (optional)") }}
              </div>
              <div class="input-group input-group-sm mb-2">
                <span class="input-group-text">$</span>
                {{ reward_form.amount(class="form-control", placeholder="Amount", step="0.01") }}
              </div>
              <div class="form-check form-switch mb-2">
                {{ reward_form.is_active(class="form-check-input", role="switch", checked="checked") }}
                {{ reward_form.is_active.label(class="form-check-label") }}
              </div>
              {{ reward_form.submit(class="btn btn-success btn-sm w-100") }}
            </form>

            <!-- Existing Rewards -->
            <hr>
            <h6>Existing Rewards</h6>
            {% if rewards %}
              <ul class="list-group list-group-flush">
                {% for reward in rewards %}
                <li class="list-group-item d-flex justify-content-between align-items-center">
                  <div>
                    <strong>{{ reward.name }}</strong>
                    {% if reward.description %}
                      <br><small class="text-muted">{{ reward.description }}</small>
                    {% endif %}
                  </div>
                  <div class="text-end">
                    <span class="badge bg-success">${{ "%.2f"|format(reward.amount) }}</span>
                    {% if not reward.is_active %}
                      <span class="badge bg-secondary">Inactive</span>
                    {% endif %}
                    <br>
                    <button class="btn btn-sm btn-outline-primary mt-1 me-1" onclick="editReward({{ reward.id }}, '{{ reward.name|replace("'", "\\'") }}', '{{ reward.description|replace("'", "\\'")|default('') }}', {{ reward.amount }}, {{ reward.is_active|lower }})">
                      <i class="bi bi-pencil me-1"></i>Edit
                    </button>
                    <button class="btn btn-sm btn-outline-danger mt-1" onclick="deleteReward({{ reward.id }})">Delete</button>
                  </div>
                </li>
                {% endfor %}
              </ul>
            {% else %}
              <p class="text-muted small">No rewards created yet.</p>
            {% endif %}
          </div>
        </div>
      </div>

      <!-- Fines Section -->
      <div class="col-lg-6 mb-4">
        <div class="card shadow h-100">
          <div class="card-header bg-danger text-white">
            <h5 class="mb-0"><i class="bi bi-exclamation-triangle me-2"></i>Fines</h5>
          </div>
          <div class="card-body">
            <!-- Add Fine Form -->
            <form method="POST" action="{{ url_for('admin_payroll_add_fine') }}" class="mb-4">
              {{ fine_form.hidden_tag() }}
              <div class="mb-2">
                {{ fine_form.name(class="form-control form-control-sm", placeholder="Fine Name") }}
              </div>
              <div class="mb-2">
                {{ fine_form.description(class="form-control form-control-sm", rows=2, placeholder="Description (optional)") }}
              </div>
              <div class="input-group input-group-sm mb-2">
                <span class="input-group-text">$</span>
                {{ fine_form.amount(class="form-control", placeholder="Amount", step="0.01") }}
              </div>
              <div class="form-check form-switch mb-2">
                {{ fine_form.is_active(class="form-check-input", role="switch", checked="checked") }}
                {{ fine_form.is_active.label(class="form-check-label") }}
              </div>
              {{ fine_form.submit(class="btn btn-danger btn-sm w-100") }}
            </form>

            <!-- Existing Fines -->
            <hr>
            <h6>Existing Fines</h6>
            {% if fines %}
              <ul class="list-group list-group-flush">
                {% for fine in fines %}
                <li class="list-group-item d-flex justify-content-between align-items-center">
                  <div>
                    <strong>{{ fine.name }}</strong>
                    {% if fine.description %}
                      <br><small class="text-muted">{{ fine.description }}</small>
                    {% endif %}
                  </div>
                  <div class="text-end">
                    <span class="badge bg-danger">-${{ "%.2f"|format(fine.amount) }}</span>
                    {% if not fine.is_active %}
                      <span class="badge bg-secondary">Inactive</span>
                    {% endif %}
                    <br>
                    <button class="btn btn-sm btn-outline-primary mt-1 me-1" onclick="editFine({{ fine.id }}, '{{ fine.name|replace("'", "\\'") }}', '{{ fine.description|replace("'", "\\'")|default('') }}', {{ fine.amount }}, {{ fine.is_active|lower }})">
                      <i class="bi bi-pencil me-1"></i>Edit
                    </button>
                    <button class="btn btn-sm btn-outline-danger mt-1" onclick="deleteFine({{ fine.id }})">Delete</button>
                  </div>
                </li>
                {% endfor %}
              </ul>
            {% else %}
              <p class="text-muted small">No fines created yet.</p>
            {% endif %}
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- MANUAL PAYMENT TAB -->
  <div class="tab-pane fade" id="manual-payment" role="tabpanel">
    <div class="row">
      <!-- LEFT COLUMN: Student Selection -->
      <div class="col-lg-6 mb-4">
        <div class="card shadow h-100">
          <div class="card-header bg-primary text-white">
            <h5 class="mb-0"><i class="bi bi-people me-2"></i>Select Students</h5>
          </div>
          <div class="card-body">
            <!-- Block/Period Filter -->
            <div class="mb-3">
              <label for="studentBlockFilter" class="form-label fw-bold">Filter by Period/Block:</label>
              <select id="studentBlockFilter" class="form-select">
                <option value="">All Periods</option>
                {% for block in blocks %}
                  <option value="{{ block }}">{{ block }}</option>
                {% endfor %}
              </select>
            </div>

            <!-- Student Table -->
            <div class="table-responsive" style="max-height: 450px; overflow-y: auto;">
              <table class="table table-sm table-hover">
                <thead class="sticky-top bg-light">
                  <tr>
                    <th width="40">
                      <input type="checkbox" id="selectAllStudents" class="form-check-input">
                    </th>
                    <th>Student</th>
                    <th class="text-end">Checking</th>
                    <th class="text-end">Savings</th>
                  </tr>
                </thead>
                <tbody>
                  {% if all_students %}
                    {% for student in all_students %}
                    <tr class="student-row" data-blocks="{{ student.block }}" data-student-id="{{ student.id }}">
                      <td>
                        <input class="form-check-input student-checkbox" type="checkbox" value="{{ student.id }}" data-blocks="{{ student.block }}">
                      </td>
                      <td>
                        <strong>{{ student.full_name }}</strong><br>
                        <small class="text-muted">{{ student.block }}</small>
                      </td>
                      <td class="text-end">${{ "%.2f"|format(student.checking_balance) }}</td>
                      <td class="text-end">${{ "%.2f"|format(student.savings_balance) }}</td>
                    </tr>
                    {% endfor %}
                  {% else %}
                    <tr><td colspan="4" class="text-center text-muted">No students found.</td></tr>
                  {% endif %}
                </tbody>
              </table>
            </div>

            <div class="alert alert-info mt-3 mb-0">
              <i class="bi bi-info-circle me-2"></i>
              <strong>Selected:</strong> <span id="selectedCount">0</span> student(s)
            </div>
          </div>
        </div>
      </div>

      <!-- RIGHT COLUMN: Manual Payment Fields -->
      <div class="col-lg-6 mb-4">
        <div class="card shadow h-100">
          <div class="card-header bg-success text-white">
            <h5 class="mb-0"><i class="bi bi-cash-coin me-2"></i>Payment Details</h5>
          </div>
          <div class="card-body">
            <form id="manualPaymentForm">
              {{ manual_payment_form.hidden_tag() }}

              <!-- Preset Reward/Fine Selector -->
              <div class="mb-3">
                <label for="presetSelector" class="form-label fw-bold">Use Preset (Optional):</label>
                <select id="presetSelector" class="form-select">
                  <option value="">-- Select Preset --</option>
                  <optgroup label="Rewards">
                    {% for reward in rewards %}
                      {% if reward.is_active %}
                      <option value="reward_{{ reward.id }}" data-description="{{ reward.name }}" data-amount="{{ reward.amount }}" data-type="reward">
                        {{ reward.name }} (+${{ "%.2f"|format(reward.amount) }})
                      </option>
                      {% endif %}
                    {% endfor %}
                  </optgroup>
                  <optgroup label="Fines">
                    {% for fine in fines %}
                      {% if fine.is_active %}
                      <option value="fine_{{ fine.id }}" data-description="{{ fine.name }}" data-amount="-{{ fine.amount }}" data-type="fine">
                        {{ fine.name }} (-${{ "%.2f"|format(fine.amount) }})
                      </option>
                      {% endif %}
                    {% endfor %}
                  </optgroup>
                </select>
                <small class="text-muted">Selecting a preset will auto-fill description and amount (you can override)</small>
              </div>

              <!-- Description -->
              <div class="mb-3">
                {{ manual_payment_form.description.label(class="form-label fw-bold") }}
                {{ manual_payment_form.description(class="form-control", id="manualDescription", placeholder="e.g., Bonus for excellent attendance") }}
              </div>

              <!-- Amount (overrides preset) -->
              <div class="mb-3">
                {{ manual_payment_form.amount.label(class="form-label fw-bold") }}
                <div class="input-group">
                  <span class="input-group-text">$</span>
                  {{ manual_payment_form.amount(class="form-control", id="manualAmount", placeholder="0.00", step="0.01") }}
                </div>
                <small class="text-muted">This overrides the preset amount if filled</small>
              </div>

              <!-- Account Type -->
              <div class="mb-3">
                {{ manual_payment_form.account_type.label(class="form-label fw-bold") }}
                {{ manual_payment_form.account_type(class="form-select") }}
              </div>

              <hr>

              <!-- Action Buttons -->
              <div class="d-grid gap-2">
                <button type="button" id="applyToSelected" class="btn btn-primary btn-lg">
                  <i class="bi bi-check-circle me-2"></i>Apply to Selected
                </button>
                <button type="button" id="applyToAll" class="btn btn-outline-primary">
                  <i class="bi bi-check-circle-fill me-2"></i>Apply to All in Period
                </button>
              </div>
            </form>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Edit Reward Modal -->
<div class="modal fade" id="editRewardModal" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Edit Reward</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <input type="hidden" id="editRewardId">
        <div class="mb-3">
          <label for="editRewardName" class="form-label fw-bold">Name:</label>
          <input type="text" class="form-control" id="editRewardName" required>
        </div>
        <div class="mb-3">
          <label for="editRewardDescription" class="form-label fw-bold">Description:</label>
          <textarea class="form-control" id="editRewardDescription" rows="2"></textarea>
        </div>
        <div class="mb-3">
          <label for="editRewardAmount" class="form-label fw-bold">Amount:</label>
          <div class="input-group">
            <span class="input-group-text">$</span>
            <input type="number" class="form-control" id="editRewardAmount" step="0.01" required>
          </div>
        </div>
        <div class="mb-3">
          <div class="form-check form-switch">
            <input class="form-check-input" type="checkbox" id="editRewardActive">
            <label class="form-check-label" for="editRewardActive">Active</label>
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        <button type="button" class="btn btn-primary" onclick="saveReward()">Save Changes</button>
      </div>
    </div>
  </div>
</div>

<!-- Edit Fine Modal -->
<div class="modal fade" id="editFineModal" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Edit Fine</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <input type="hidden" id="editFineId">
        <div class="mb-3">
          <label for="editFineName" class="form-label fw-bold">Name:</label>
          <input type="text" class="form-control" id="editFineName" required>
        </div>
        <div class="mb-3">
          <label for="editFineDescription" class="form-label fw-bold">Description:</label>
          <textarea class="form-control" id="editFineDescription" rows="2"></textarea>
        </div>
        <div class="mb-3">
          <label for="editFineAmount" class="form-label fw-bold">Amount:</label>
          <div class="input-group">
            <span class="input-group-text">$</span>
            <input type="number" class="form-control" id="editFineAmount" step="0.01" required>
          </div>
        </div>
        <div class="mb-3">
          <div class="form-check form-switch">
            <input class="form-check-input" type="checkbox" id="editFineActive">
            <label class="form-check-label" for="editFineActive">Active</label>
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        <button type="button" class="btn btn-primary" onclick="saveFine()">Save Changes</button>
      </div>
    </div>
  </div>
</div>

<!-- JavaScript -->
<script>
// Convert UTC timestamps to local time
document.addEventListener("DOMContentLoaded", () => {
    // Timestamp conversion
    document.querySelectorAll(".local-timestamp").forEach(el => {
        const utcString = el.dataset.timestamp;
        if (utcString) {
            const date = new Date(utcString);
            const options = {
                year: 'numeric',
                month: 'short',
                day: 'numeric',
                hour: 'numeric',
                minute: 'numeric',
                hour12: true
            };
            el.textContent = date.toLocaleString(undefined, options);
        } else {
            el.textContent = '—';
        }
    });

    // Manual Payment Tab: Block Filter for Students
    const studentBlockFilter = document.getElementById('studentBlockFilter');
    const studentRows = document.querySelectorAll('.student-row');
    const selectAllCheckbox = document.getElementById('selectAllStudents');
    const selectedCountEl = document.getElementById('selectedCount');

    // Set default block (first option after "All Periods")
    if (studentBlockFilter && studentBlockFilter.options.length > 1) {
        studentBlockFilter.selectedIndex = 1; // Select first actual block
        studentBlockFilter.dispatchEvent(new Event('change')); // Trigger filter
    }

    if (studentBlockFilter) {
        studentBlockFilter.addEventListener('change', function() {
            const selectedBlock = this.value;
            studentRows.forEach(row => {
                const studentBlocks = row.dataset.blocks.split(',').map(b => b.trim());
                if (!selectedBlock || studentBlocks.includes(selectedBlock)) {
                    row.style.display = '';
                } else {
                    row.style.display = 'none';
                    // Uncheck hidden students
                    row.querySelector('.student-checkbox').checked = false;
                }
            });
            selectAllCheckbox.checked = false;
            updateSelectedCount();
        });
    }

    if (selectAllCheckbox) {
        selectAllCheckbox.addEventListener('change', function() {
            const visibleCheckboxes = Array.from(studentRows)
                .filter(row => row.style.display !== 'none')
                .map(row => row.querySelector('.student-checkbox'));
            visibleCheckboxes.forEach(cb => cb.checked = this.checked);
            updateSelectedCount();
        });
    }

    const studentCheckboxes = document.querySelectorAll('.student-checkbox');
    studentCheckboxes.forEach(cb => {
        cb.addEventListener('change', updateSelectedCount);
    });

    function updateSelectedCount() {
        const count = Array.from(studentCheckboxes).filter(cb => cb.checked && cb.closest('.student-row').style.display !== 'none').length;
        if (selectedCountEl) {
            selectedCountEl.textContent = count;
        }
    }

    updateSelectedCount();

    // Preset Selector for Manual Payment
    const presetSelector = document.getElementById('presetSelector');
    const manualDescription = document.getElementById('manualDescription');
    const manualAmount = document.getElementById('manualAmount');

    if (presetSelector) {
        presetSelector.addEventListener('change', function() {
            const selectedOption = this.options[this.selectedIndex];
            if (selectedOption.value) {
                const description = selectedOption.dataset.description;
                const amount = selectedOption.dataset.amount;

                if (manualDescription) manualDescription.value = description;
                if (manualAmount) manualAmount.value = Math.abs(parseFloat(amount));
            }
        });
    }

    // History Tab: Block Filter
    const historyBlockFilter = document.getElementById('historyBlockFilter');
    if (historyBlockFilter) {
        historyBlockFilter.addEventListener('change', function() {
            const selectedBlock = this.value;
            const historyRows = document.querySelectorAll('#payrollHistoryTable tbody tr[data-block]');
            historyRows.forEach(row => {
                const rowBlock = row.dataset.block;
                if (!selectedBlock || rowBlock === selectedBlock) {
                    row.style.display = '';
                } else {
                    row.style.display = 'none';
                }
            });
        });
    }

    // History Tab: Select All Checkbox
    const selectAllHistory = document.getElementById('selectAllHistory');
    const historyCheckboxes = document.querySelectorAll('.history-checkbox');
    const voidCountEl = document.getElementById('voidCount');
    const voidSelectedBtn = document.getElementById('voidSelectedBtn');

    if (selectAllHistory) {
        selectAllHistory.addEventListener('change', function() {
            const visibleCheckboxes = Array.from(historyCheckboxes).filter(cb => {
                const row = cb.closest('tr');
                return row && row.style.display !== 'none';
            });
            visibleCheckboxes.forEach(cb => cb.checked = this.checked);
            updateVoidCount();
        });
    }

    historyCheckboxes.forEach(cb => {
        cb.addEventListener('change', updateVoidCount);
    });

    function updateVoidCount() {
        const count = Array.from(historyCheckboxes).filter(cb => cb.checked).length;
        if (voidCountEl) voidCountEl.textContent = count;
        if (voidSelectedBtn) voidSelectedBtn.disabled = count === 0;
    }

    updateVoidCount();

    // Void Selected Button
    if (voidSelectedBtn) {
        voidSelectedBtn.addEventListener('click', voidSelectedTransactions);
    }
});

// Run Payroll
document.getElementById('runPayrollBtn')?.addEventListener('click', async function() {
  const csrfToken = document.querySelector('meta[name="csrf-token"]').getAttribute('content');
  try {
    const resp = await fetch('{{ url_for("run_payroll") }}', {
      method: 'POST',
      headers: {
        'X-Requested-With': 'XMLHttpRequest',
        'Content-Type': 'application/json',
        'X-CSRFToken': csrfToken
      }
    });
    const payload = await resp.json();
    if (!resp.ok) throw new Error(payload.message || 'Payroll failed');
    showToast(payload.message || 'Payroll complete.', 'success');
    setTimeout(() => location.reload(), 1500);
  } catch (e) {
    showToast(e.message, 'error');
  }
});

// Edit Reward
function editReward(id, name, description, amount, isActive) {
  document.getElementById('editRewardId').value = id;
  document.getElementById('editRewardName').value = name;
  document.getElementById('editRewardDescription').value = description;
  document.getElementById('editRewardAmount').value = amount;
  document.getElementById('editRewardActive').checked = isActive;

  const modal = new bootstrap.Modal(document.getElementById('editRewardModal'));
  modal.show();
}

// Save Reward
async function saveReward() {
  const id = document.getElementById('editRewardId').value;
  const name = document.getElementById('editRewardName').value;
  const description = document.getElementById('editRewardDescription').value;
  const amount = document.getElementById('editRewardAmount').value;
  const isActive = document.getElementById('editRewardActive').checked;

  const csrfToken = document.querySelector('meta[name="csrf-token"]').getAttribute('content');

  try {
    const resp = await fetch(`/admin/payroll/rewards/${id}/edit`, {
      method: 'POST',
      headers: {
        'X-CSRFToken': csrfToken,
        'Content-Type': 'application/json'
      },
      body: JSON.stringify({ name, description, amount, is_active: isActive })
    });

    const data = await resp.json();
    if (data.success) {
      showToast('Reward updated successfully', 'success');
      setTimeout(() => location.reload(), 1000);
    } else {
      showToast(data.message || 'Failed to update reward', 'error');
    }
  } catch (err) {
    showToast('Error updating reward', 'error');
  }
}

// Delete Reward
function deleteReward(rewardId) {
  if (!confirm('Are you sure you want to delete this reward?')) return;

  const csrfToken = document.querySelector('meta[name="csrf-token"]').getAttribute('content');
  fetch(`/admin/payroll/rewards/${rewardId}/delete`, {
    method: 'POST',
    headers: {
      'X-CSRFToken': csrfToken,
      'Content-Type': 'application/json'
    }
  })
  .then(resp => resp.json())
  .then(data => {
    if (data.success) {
      showToast('Reward deleted successfully', 'success');
      setTimeout(() => location.reload(), 1000);
    } else {
      showToast(data.message || 'Failed to delete reward', 'error');
    }
  })
  .catch(err => showToast('Error deleting reward', 'error'));
}

// Edit Fine
function editFine(id, name, description, amount, isActive) {
  document.getElementById('editFineId').value = id;
  document.getElementById('editFineName').value = name;
  document.getElementById('editFineDescription').value = description;
  document.getElementById('editFineAmount').value = amount;
  document.getElementById('editFineActive').checked = isActive;

  const modal = new bootstrap.Modal(document.getElementById('editFineModal'));
  modal.show();
}

// Save Fine
async function saveFine() {
  const id = document.getElementById('editFineId').value;
  const name = document.getElementById('editFineName').value;
  const description = document.getElementById('editFineDescription').value;
  const amount = document.getElementById('editFineAmount').value;
  const isActive = document.getElementById('editFineActive').checked;

  const csrfToken = document.querySelector('meta[name="csrf-token"]').getAttribute('content');

  try {
    const resp = await fetch(`/admin/payroll/fines/${id}/edit`, {
      method: 'POST',
      headers: {
        'X-CSRFToken': csrfToken,
        'Content-Type': 'application/json'
      },
      body: JSON.stringify({ name, description, amount, is_active: isActive })
    });

    const data = await resp.json();
    if (data.success) {
      showToast('Fine updated successfully', 'success');
      setTimeout(() => location.reload(), 1000);
    } else {
      showToast(data.message || 'Failed to update fine', 'error');
    }
  } catch (err) {
    showToast('Error updating fine', 'error');
  }
}

// Delete Fine
function deleteFine(fineId) {
  if (!confirm('Are you sure you want to delete this fine?')) return;

  const csrfToken = document.querySelector('meta[name="csrf-token"]').getAttribute('content');
  fetch(`/admin/payroll/fines/${fineId}/delete`, {
    method: 'POST',
    headers: {
      'X-CSRFToken': csrfToken,
      'Content-Type': 'application/json'
    }
  })
  .then(resp => resp.json())
  .then(data => {
    if (data.success) {
      showToast('Fine deleted successfully', 'success');
      setTimeout(() => location.reload(), 1000);
    } else {
      showToast(data.message || 'Failed to delete fine', 'error');
    }
  })
  .catch(err => showToast('Error deleting fine', 'error'));
}

// Manual Payment: Apply to Selected
document.getElementById('applyToSelected')?.addEventListener('click', async function() {
  const selectedStudents = Array.from(document.querySelectorAll('.student-checkbox:checked')).map(cb => cb.value);

  if (selectedStudents.length === 0) {
    alert('Please select at least one student.');
    return;
  }

  const description = document.getElementById('manualDescription').value;
  const amount = document.getElementById('manualAmount').value;
  const accountType = document.querySelector('select[name="account_type"]').value;

  if (!description || !amount) {
    alert('Please fill in description and amount.');
    return;
  }

  await submitManualPayment(selectedStudents, description, amount, accountType);
});

// Manual Payment: Apply to All in Period
document.getElementById('applyToAll')?.addEventListener('click', async function() {
  const selectedBlock = document.getElementById('studentBlockFilter').value;

  if (!selectedBlock) {
    alert('Please select a specific period/block first.');
    return;
  }

  const allStudentsInPeriod = Array.from(document.querySelectorAll('.student-row'))
    .filter(row => row.style.display !== 'none')
    .map(row => row.querySelector('.student-checkbox').value);

  if (allStudentsInPeriod.length === 0) {
    alert('No students found in the selected period.');
    return;
  }

  const description = document.getElementById('manualDescription').value;
  const amount = document.getElementById('manualAmount').value;
  const accountType = document.querySelector('select[name="account_type"]').value;

  if (!description || !amount) {
    alert('Please fill in description and amount.');
    return;
  }

  if (!confirm(`Apply payment to all ${allStudentsInPeriod.length} students in this period?`)) return;

  await submitManualPayment(allStudentsInPeriod, description, amount, accountType);
});

// Submit Manual Payment
async function submitManualPayment(studentIds, description, amount, accountType) {
  const csrfToken = document.querySelector('meta[name="csrf-token"]').getAttribute('content');

  const formData = new FormData();
  formData.append('description', description);
  formData.append('amount', amount);
  formData.append('account_type', accountType);
  studentIds.forEach(id => formData.append('student_ids', id));

  try {
    const resp = await fetch('{{ url_for("admin_payroll_manual_payment") }}', {
      method: 'POST',
      headers: {
        'X-CSRFToken': csrfToken
      },
      body: formData
    });

    if (resp.redirected) {
      showToast('Payment applied successfully!', 'success');
      setTimeout(() => location.reload(), 1000);
    } else {
      const data = await resp.json();
      if (data.success) {
        showToast(data.message || 'Payment applied successfully!', 'success');
        setTimeout(() => location.reload(), 1000);
      } else {
        showToast(data.message || 'Failed to apply payment', 'error');
      }
    }
  } catch (err) {
    showToast('Error applying payment', 'error');
  }
}

// Void Single Transaction
async function voidTransaction(transactionId) {
  if (!confirm('Are you sure you want to void this transaction? This cannot be undone.')) return;

  const csrfToken = document.querySelector('meta[name="csrf-token"]').getAttribute('content');

  try {
    const resp = await fetch(`/admin/payroll/transactions/${transactionId}/void`, {
      method: 'POST',
      headers: {
        'X-CSRFToken': csrfToken,
        'Content-Type': 'application/json'
      }
    });

    const data = await resp.json();
    if (data.success) {
      showToast('Transaction voided successfully', 'success');
      setTimeout(() => location.reload(), 1000);
    } else {
      showToast(data.message || 'Failed to void transaction', 'error');
    }
  } catch (err) {
    showToast('Error voiding transaction', 'error');
  }
}

// Void Selected Transactions
async function voidSelectedTransactions() {
  const selectedIds = Array.from(document.querySelectorAll('.history-checkbox:checked')).map(cb => cb.value);

  if (selectedIds.length === 0) {
    alert('Please select at least one transaction to void.');
    return;
  }

  if (!confirm(`Are you sure you want to void ${selectedIds.length} transaction(s)? This cannot be undone.`)) return;

  const csrfToken = document.querySelector('meta[name="csrf-token"]').getAttribute('content');

  try {
    const resp = await fetch('/admin/payroll/transactions/void-bulk', {
      method: 'POST',
      headers: {
        'X-CSRFToken': csrfToken,
        'Content-Type': 'application/json'
      },
      body: JSON.stringify({ transaction_ids: selectedIds })
    });

    const data = await resp.json();
    if (data.success) {
      showToast(`${selectedIds.length} transaction(s) voided successfully`, 'success');
      setTimeout(() => location.reload(), 1000);
    } else {
      showToast(data.message || 'Failed to void transactions', 'error');
    }
  } catch (err) {
    showToast('Error voiding transactions', 'error');
  }
}

// Toast notification helper
function showToast(message, type) {
  if (window.toast) {
    window.toast(message, type);
  } else {
    alert(message);
  }
}
</script>

{% endblock %}
