{% extends "layout_admin.html" %}
{% set page_title = "Payroll Management" %}
{% set current_page = "payroll" %}
{% block title %}Payroll Management{% endblock %}
{% block page_icon %}receipt_long{% endblock %}

{% block extra_head %}
<script src="{{ url_for('static', filename='js/economy-balance.js') }}"></script>
{% endblock %}

{% block content %}

<!-- Nav Tabs -->
<ul class="nav nav-tabs mb-4" id="payrollTabs" role="tablist">
  <li class="nav-item" role="presentation">
    <button class="nav-link active" id="overview-tab" data-bs-toggle="tab" data-bs-target="#overview" type="button" role="tab">
      <i class="bi bi-grid me-1"></i>Overview
    </button>
  </li>
  <li class="nav-item" role="presentation">
    <button class="nav-link" id="history-tab" data-bs-toggle="tab" data-bs-target="#history" type="button" role="tab">
      <i class="bi bi-clock-history me-1"></i>History
    </button>
  </li>
  <li class="nav-item" role="presentation">
    <button class="nav-link" id="settings-tab" data-bs-toggle="tab" data-bs-target="#settings" type="button" role="tab">
      <i class="bi bi-gear me-1"></i>Settings
    </button>
  </li>
  <li class="nav-item" role="presentation">
    <button class="nav-link" id="rewards-fines-tab" data-bs-toggle="tab" data-bs-target="#rewards-fines" type="button" role="tab">
      <i class="bi bi-star me-1"></i>Rewards & Fines
    </button>
  </li>
  <li class="nav-item" role="presentation">
    <button class="nav-link" id="manual-payment-tab" data-bs-toggle="tab" data-bs-target="#manual-payment" type="button" role="tab">
      <i class="bi bi-cash-coin me-1"></i>Manual
    </button>
  </li>
</ul>

<div class="tab-content" id="payrollTabContent">
  <!-- OVERVIEW TAB -->
  <div class="tab-pane fade show active" id="overview" role="tabpanel">
    <div class="row">
      <!-- Next Payroll by Class -->
      <div class="col-lg-6 mb-4">
        <div class="card shadow">
          <div class="card-header bg-primary text-white">
            <h5 class="mb-0"><i class="bi bi-calendar-event me-2"></i>Next Payroll by Class</h5>
          </div>
          <div class="card-body">
            {% if next_payroll_by_block %}
              <div class="table-responsive">
                <table class="table table-sm">
                  <thead>
                    <tr>
                      <th>Class</th>
                      <th>Next Run Date</th>
                      <th>Estimated Payout</th>
                    </tr>
                  </thead>
                  <tbody>
                    {% for block_info in next_payroll_by_block %}
                    <tr>
                      <td><strong>{{ block_info.class_label }}</strong></td>
                      <td>
                        {% if block_info.next_date %}
                          <span class="local-timestamp" data-timestamp="{{ block_info.next_date_iso or format_utc_iso(block_info.next_date) }}"></span>
                        {% else %}
                          N/A
                        {% endif %}
                      </td>
                      <td>${{ "%.2f"|format(block_info.estimate|default(0)) }}</td>
                    </tr>
                    {% endfor %}
                  </tbody>
                </table>
              </div>
            {% else %}
              <p class="text-muted">No payroll schedule configured.</p>
            {% endif %}
          </div>
        </div>
      </div>

      <!-- Quick Stats -->
      <div class="col-lg-6 mb-4">
        <div class="card shadow">
          <div class="card-header bg-success text-white">
            <h5 class="mb-0"><i class="bi bi-graph-up me-2"></i>Quick Stats</h5>
          </div>
          <div class="card-body">
            <div class="row text-center">
              <div class="col-6 mb-3">
                <h3 class="text-primary">${{ "%.2f"|format(total_payroll_estimate|default(0)) }}</h3>
                <small class="text-muted">Total Estimated Payout</small>
              </div>
              <div class="col-6 mb-3">
                <h3 class="text-success">{{ total_students|default(0) }}</h3>
                <small class="text-muted">Total Students</small>
              </div>
              <div class="col-6">
                <h3 class="text-info">${{ "%.2f"|format(avg_payout|default(0)) }}</h3>
                <small class="text-muted">Average Payout</small>
              </div>
              <div class="col-6">
                <h3 class="text-warning">{{ total_blocks|default(0) }}</h3>
                <small class="text-muted">Active Classes</small>
              </div>
            </div>
            <hr>
            <button id="runPayrollBtn" class="btn btn-primary w-100">
              <i class="bi bi-play-circle me-2"></i>Run Payroll Now
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Economy Balance Configuration -->
    <div class="card shadow mb-4">
      <div class="card-header bg-info text-white">
        <h5 class="mb-0"><i class="bi bi-graph-up-arrow me-2"></i>Classroom Wage Index (CWI)</h5>
      </div>
      <div class="card-body">
        <!-- Class Selector Banner -->
        <div class="alert alert-primary d-flex align-items-center justify-content-between mb-3">
          <div class="d-flex align-items-center gap-3">
            <i class="bi bi-calculator fs-3"></i>
            <div>
              <h6 class="mb-1 fw-bold">Configuring CWI For:</h6>
              <select class="form-select form-select-sm" id="cwi_block_selector" style="width: auto; min-width: 200px;">
                {% for block in blocks %}
                  <option value="{{ block }}" {% if block == cwi_block %}selected{% endif %}>
                    {{ class_labels_by_block.get(block, block) }}
                  </option>
                {% endfor %}
              </select>
            </div>
          </div>
          <div class="form-check form-switch">
            <input class="form-check-input" type="checkbox" id="apply_to_all_cwi_checkbox" role="switch">
            <label class="form-check-label fw-bold" for="apply_to_all_cwi_checkbox">
              Apply to All Classes
            </label>
          </div>
        </div>

        <form method="POST" action="{{ url_for('admin.update_expected_weekly_hours') }}" id="expectedHoursForm">
          <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
          <input type="hidden" name="cwi_block" id="cwi_block_input" value="{{ cwi_block }}">
          <input type="hidden" name="apply_to_all" id="apply_to_all_cwi_input" value="false">

          <div class="row align-items-end mb-3">
            <div class="col-md-4">
              <label for="expectedWeeklyHoursOverview" class="form-label fw-bold">
                Expected Weekly Hours:
                <i class="bi bi-info-circle text-primary" data-bs-toggle="tooltip"
                   title="How many hours per week do students typically attend class? Used for economy balance validation and CWI calculation."></i>
              </label>
              <div class="input-group">
                <input type="number" class="form-control" id="expectedWeeklyHoursOverview"
                       name="expected_weekly_hours" step="0.25" min="0.25" max="80" placeholder="5.0"
                       value="{% if cwi_setting and cwi_setting.expected_weekly_hours %}{{ cwi_setting.expected_weekly_hours }}{% else %}5.0{% endif %}">
                <span class="input-group-text">hours/week</span>
              </div>
              <small class="text-muted">Example: 75 min × 3 classes/week = 3.75 hours</small>
            </div>
            <div class="col-md-3">
              <button type="submit" class="btn btn-primary">
                <i class="bi bi-save me-1"></i>Update
              </button>
            </div>
          </div>
        </form>

        <!-- CWI Display -->
        <div id="cwi-display-overview"></div>
      </div>
    </div>

    <!-- Recent Payroll Activity -->
    <div class="card shadow">
      <div class="card-header">
        <h5 class="mb-0"><i class="bi bi-list-ul me-2"></i>Recent Payroll Activity</h5>
      </div>
      <div class="card-body">
        {% if recent_payrolls %}
          <div class="table-responsive">
            <table class="table table-striped table-hover">
              <thead>
                <tr>
                  <th>Date</th>
                  <th>Student Name</th>
                  <th>Class</th>
                  <th>Amount</th>
                  <th>Account</th>
                </tr>
              </thead>
              <tbody>
                {% for record in recent_payrolls %}
                <tr>
                  <td>
                    {% if record.timestamp %}
                      <span class="local-timestamp" data-timestamp="{{ format_utc_iso(record.timestamp) }}"></span>
                    {% else %}
                      N/A
                    {% endif %}
                  </td>
                  <td>
                    {% if record.student %}
                      <a href="{{ url_for('admin.student_detail', student_id=record.student_id) }}">
                        {{ record.student.full_name }}
                      </a>
                    {% else %}
                      <em>Unknown</em>
                    {% endif %}
                  </td>
                  <td>{{ class_labels_by_block.get(record.student.block, record.student.block) if record.student and record.student.block else "N/A" }}</td>
                  <td class="text-success fw-bold">${{ "%.2f"|format(record.amount) }}</td>
                  <td><span class="badge bg-secondary">{{ record.account_type|title }}</span></td>
                </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
        {% else %}
          <p class="text-muted">No recent payrolls found.</p>
        {% endif %}
      </div>
    </div>
  </div>

  <!-- HISTORY TAB -->
  <div class="tab-pane fade" id="history" role="tabpanel">
    <div class="card shadow">
      <div class="card-header">
        <h5 class="mb-0"><i class="bi bi-clock-history me-2"></i>Payroll History</h5>
      </div>
      <div class="card-body">
        <!-- Filter and Actions -->
        <div class="row mb-3">
          <div class="col-md-4">
            <label for="historyBlockFilter" class="form-label fw-bold">Class:</label>
            <select id="historyBlockFilter" class="form-select">
              <option value="">All Classes</option>
              {% for block in blocks %}
                <option value="{{ block }}">{{ class_labels_by_block.get(block, block) }}</option>
              {% endfor %}
            </select>
          </div>
          <div class="col-md-8 text-end">
            <button id="voidSelectedBtn" class="btn btn-danger" disabled>
              <i class="bi bi-x-circle me-2"></i>Void Selected (<span id="voidCount">0</span>)
            </button>
          </div>
        </div>

        <!-- History Table -->
        <div class="table-responsive">
          <table class="table table-striped table-hover" id="payrollHistoryTable">
            <thead>
              <tr>
                <th width="40">
                  <input type="checkbox" id="selectAllHistory" class="form-check-input">
                </th>
                <th>Date</th>
                <th>Type</th>
                <th>Class</th>
                <th>Student</th>
                <th>Amount</th>
                <th>Notes</th>
                <th width="100">Actions</th>
              </tr>
            </thead>
            <tbody>
              {% if payroll_history %}
                {% for entry in payroll_history %}
                <tr data-block="{{ entry.block }}" data-transaction-id="{{ entry.transaction_id }}" class="{% if entry.is_void %}table-secondary text-muted{% endif %}">
                  <td>
                    {% if not entry.is_void %}
                    <input type="checkbox" class="form-check-input history-checkbox" value="{{ entry.transaction_id }}">
                    {% endif %}
                  </td>
                  <td>
                    {% if entry.timestamp %}
                      <span class="local-timestamp" data-timestamp="{{ format_utc_iso(entry.timestamp) }}"></span>
                    {% else %}
                      —
                    {% endif %}
                  </td>
                  <td>
                    <span class="badge bg-{% if entry.type == 'payroll' %}primary{% elif entry.type == 'reward' %}success{% elif entry.type == 'fine' %}danger{% else %}secondary{% endif %}">
                      {{ entry.type|title }}
                    </span>
                  </td>
                  <td>{{ entry.class_label }}</td>
                  <td>
                    {% if entry.student %}
                      <a href="{{ url_for('admin.student_detail', student_id=entry.student_id) }}">
                        {{ entry.student_name }}
                      </a>
                    {% else %}
                      {{ entry.student_name }}
                    {% endif %}
                  </td>
                  <td class="{% if entry.amount > 0 %}text-success{% else %}text-danger{% endif %} fw-bold">
                    ${{ "%.2f"|format(entry.amount) }}
                    {% if entry.is_void %}
                      <span class="badge bg-secondary ms-1">VOID</span>
                    {% endif %}
                  </td>
                  <td>{{ entry.notes }}</td>
                  <td>
                    {% if not entry.is_void %}
                      <button class="btn btn-sm btn-outline-danger" onclick="voidTransaction({{ entry.transaction_id }})">
                        <i class="bi bi-x-circle"></i> Void
                      </button>
                    {% else %}
                      <span class="text-muted small">Voided</span>
                    {% endif %}
                  </td>
                </tr>
                {% endfor %}
              {% else %}
                <tr><td colspan="8" class="text-center text-muted">No payroll records found.</td></tr>
              {% endif %}
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </div>

  <!-- SETTINGS TAB -->
  <div class="tab-pane fade" id="settings" role="tabpanel">
    <div class="row">
      <!-- Setup/Update Banner -->
      {% if show_setup_banner %}
      <div class="col-12 mb-3">
        <div class="alert alert-warning alert-dismissible fade show" role="alert">
          <h5 class="alert-heading"><i class="bi bi-exclamation-triangle me-2"></i>No Payroll Settings</h5>
          <p class="mb-2">No Payroll Setting has been created yet. Do you want to use preset amounts?</p>
          <button type="button" class="btn btn-sm btn-warning" id="usePresetBtn">
            <i class="bi bi-check-circle me-1"></i>Yes, Use Preset Values
          </button>
          <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>
      </div>
      {% elif block_settings %}
      <div class="col-12 mb-3">
        <div class="alert alert-info alert-dismissible fade show" role="alert">
          <i class="bi bi-info-circle me-2"></i>
          Payroll settings have been set on <strong>{{ block_settings[0].created_at.strftime('%B %d, %Y') if block_settings[0].created_at else 'unknown date' }}</strong>. Any changes here will override the previous settings.
          <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>
      </div>
      {% endif %}

      <!-- LEFT: Settings Form -->
      <div class="col-lg-8 mb-4">
        <div class="card shadow">
          <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
            <h5 class="mb-0"><i class="bi bi-gear me-2"></i>Payroll Settings</h5>
            <!-- Mode Toggle -->
            <div class="form-check form-switch">
              <input class="form-check-input" type="checkbox" id="settingsModeToggle" role="switch" {% if default_setting and default_setting.settings_mode == 'advanced' %}checked{% endif %}>
              <label class="form-check-label text-white" for="settingsModeToggle">Advanced Mode</label>
            </div>
          </div>
          <div class="card-body">
            <!-- Current Settings Display -->
            {% if block_settings %}
            <div class="alert alert-secondary mb-3">
              <h6 class="fw-bold mb-2"><i class="bi bi-info-circle me-2"></i>Current Settings:</h6>
              {% if default_setting %}
              <div class="mb-2">
                <strong>Global Default:</strong>
                {% if default_setting.settings_mode == 'simple' %}
                  ${{ "%.2f"|format(default_setting.pay_rate * 60) }}/hour, {{ default_setting.pay_schedule_type }}
                  {% if default_setting.first_pay_date %}, starting {{ default_setting.first_pay_date.strftime('%m/%d/%Y') }}{% endif %}
                {% else %}
                  ${{ "%.2f"|format(default_setting.pay_rate) }}/{{ default_setting.time_unit }}, {{ default_setting.pay_schedule_type }}
                  {% if default_setting.first_pay_date %}, starting {{ default_setting.first_pay_date.strftime('%m/%d/%Y') }}{% endif %}
                {% endif %}
              </div>
              {% endif %}
              {% if settings_by_block %}
              <div class="mt-2">
                <strong>Per-Class Settings:</strong>
                <ul class="mb-0 mt-1 small">
                  {% for block, setting in settings_by_block.items() %}
                  <li>
                    <strong>{{ class_labels_by_block.get(block, block) }}:</strong>
                    {% if setting.settings_mode == 'simple' %}
                      ${{ "%.2f"|format(setting.pay_rate * 60) }}/hour, {{ setting.pay_schedule_type }}
                    {% else %}
                      ${{ "%.2f"|format(setting.pay_rate) }}/{{ setting.time_unit }}, {{ setting.pay_schedule_type }}
                    {% endif %}
                  </li>
                  {% endfor %}
                </ul>
              </div>
              {% endif %}
            </div>
            {% endif %}

            <form method="POST" action="{{ url_for('admin.payroll_settings') }}" id="payrollSettingsForm">
              {{ settings_form.hidden_tag() }}
              <input type="hidden" name="settings_mode" id="settingsModeInput" value="{% if default_setting and default_setting.settings_mode == 'advanced' %}advanced{% else %}simple{% endif %}">

              <!-- SIMPLE MODE -->
              <div id="simpleModeFields" {% if default_setting and default_setting.settings_mode == 'advanced' %}style="display:none;"{% endif %}>
                <div class="alert alert-info">
                  <i class="bi bi-info-circle me-2"></i>
                  <strong>Simple Mode:</strong> Easy-to-use settings for basic payroll configuration.
                </div>

                <!-- Pay Rate (per hour) -->
                <div class="mb-3">
                  <label for="simplePayRate" class="form-label fw-bold">Pay Rate:</label>
                  <div class="input-group">
                    <span class="input-group-text">$</span>
                    <input type="number" class="form-control" id="simplePayRate" name="simple_pay_rate" step="0.01" placeholder="15.00" value="{% if default_setting and default_setting.settings_mode == 'simple' %}{{ "%.2f"|format(default_setting.pay_rate * 60) }}{% endif %}">
                    <span class="input-group-text">/hour</span>
                  </div>
                  <small class="text-muted">Amount paid per hour of attendance</small>
                </div>

                <!-- Expected Weekly Hours (for economy balance checking) -->
                <div class="mb-3">
                  <label for="expectedWeeklyHours" class="form-label fw-bold">
                    Expected Weekly Hours:
                    <i class="bi bi-info-circle text-primary" data-bs-toggle="tooltip" title="How many hours per week do students typically attend class? Used only for economy balance validation, not payroll calculations."></i>
                  </label>
                  <div class="input-group">
                    <input type="number" class="form-control" id="expectedWeeklyHours" name="expected_weekly_hours" step="0.5" placeholder="5.0" value="{% if default_setting and default_setting.expected_weekly_hours %}{{ default_setting.expected_weekly_hours }}{% else %}5.0{% endif %}">
                    <span class="input-group-text">hours/week</span>
                  </div>
                  <small class="text-muted">Typical class hours per week. Example: 5 days × 1 hour = 5.0 hours/week. Used to calculate recommended economy settings.</small>
                </div>

                <!-- CWI Display (calculated from pay rate + expected hours) -->
                <div id="cwi-info-payroll" class="mb-3"></div>

                <template id="cwiInfoTemplate">
                  <div class="alert alert-success border-start border-5 border-success">
                    <div class="d-flex align-items-center mb-2">
                      <i class="bi bi-graph-up-arrow fs-3 me-2"></i>
                      <div>
                        <h6 class="mb-0 fw-bold">Classroom Wage Index (CWI)</h6>
                        <div class="fs-4 text-success fw-bold" data-field="weekly-income"></div>
                      </div>
                    </div>
                    <small class="text-muted" data-field="calculation-note"></small>

                    <details class="mt-3" role="region" aria-label="Recommended Economy Settings" aria-expanded="false" data-field="recommendations-details">
                      <summary class="fw-bold" style="cursor: pointer;" role="button">
                        <i class="bi bi-lightbulb-fill text-warning"></i> View Recommended Economy Settings
                      </summary>
                      <div class="mt-2 p-2 bg-light rounded">
                        <div class="row small">
                          <div class="col-md-6 mb-2" data-field="rent"></div>
                          <div class="col-md-6 mb-2" data-field="insurance"></div>
                          <div class="col-md-6 mb-2" data-field="fines"></div>
                          <div class="col-md-6" data-field="store"></div>
                        </div>
                        <div class="mt-2 alert alert-info mb-0 small">
                          <i class="bi bi-info-circle"></i> These recommendations follow the AGENTS financial setup specification to ensure a balanced classroom economy.
                        </div>
                      </div>
                    </details>
                  </div>
                </template>

                <!-- Payroll Frequency -->
                <div class="mb-3">
                  <label for="simpleFrequency" class="form-label fw-bold">Payroll Frequency:</label>
                  <select class="form-select" id="simpleFrequency" name="simple_frequency">
                    <option value="weekly" {% if default_setting and default_setting.pay_schedule_type == 'weekly' %}selected{% endif %}>Weekly</option>
                    <option value="biweekly" {% if not default_setting or default_setting.pay_schedule_type == 'biweekly' %}selected{% endif %}>Bi-weekly</option>
                    <option value="monthly" {% if default_setting and default_setting.pay_schedule_type == 'monthly' %}selected{% endif %}>Monthly</option>
                  </select>
                </div>

                <!-- First Pay Date -->
                <div class="mb-3">
                  <label for="simpleFirstPayDate" class="form-label fw-bold">Starting Date (First Payday):</label>
                  <input type="date" class="form-control" id="simpleFirstPayDate" name="simple_first_pay_date" value="{% if default_setting and default_setting.first_pay_date %}{{ default_setting.first_pay_date.strftime('%Y-%m-%d') }}{% endif %}">
                  <small class="text-muted">Date of the first payroll run</small>
                </div>

                <!-- Daily Limit -->
                <div class="mb-3">
                  <label for="simpleDailyLimit" class="form-label fw-bold">Daily Time Limit:</label>
                  <div class="input-group">
                    <input type="number" class="form-control" id="simpleDailyLimit" name="simple_daily_limit" step="0.5" placeholder="8.0" value="{% if default_setting and default_setting.daily_limit_hours %}{{ default_setting.daily_limit_hours }}{% endif %}">
                    <span class="input-group-text">hours/day</span>
                  </div>
                  <small class="text-muted">Maximum hours a student can earn per day. Students will be auto-tapped-out when this limit is reached and prevented from tapping in until the next day. Resets at midnight PST. Leave blank for no limit.</small>
                </div>

                <!-- Apply To -->
                <div class="mb-3">
                  <label class="form-label fw-bold">Apply Settings To:</label>
                  <div class="form-check">
                    <input class="form-check-input" type="radio" name="simple_apply_to" id="simpleApplyAll" value="all" checked>
                    <label class="form-check-label" for="simpleApplyAll">All Classes</label>
                  </div>
                  <div class="form-check">
                    <input class="form-check-input" type="radio" name="simple_apply_to" id="simpleApplySelected" value="selected">
                    <label class="form-check-label" for="simpleApplySelected">Selected Classes:</label>
                  </div>
                  <div id="simpleBlockCheckboxes" class="ms-4 mt-2" style="display:none;">
                    {% for block in blocks %}
                    <div class="form-check">
                      <input class="form-check-input simple-block-checkbox" type="checkbox" name="simple_blocks[]" value="{{ block }}" id="simple_block_{{ block }}">
                      <label class="form-check-label" for="simple_block_{{ block }}">{{ class_labels_by_block.get(block, block) }}</label>
                    </div>
                    {% endfor %}
                  </div>
                </div>
              </div>

              <!-- ADVANCED MODE (hidden by default) -->
              <div id="advancedModeFields" {% if default_setting and default_setting.settings_mode == 'advanced' %}style="display:block;"{% else %}style="display:none;"{% endif %}>
                <div class="alert alert-warning">
                  <i class="bi bi-exclamation-triangle me-2"></i>
                  <strong>Advanced Mode:</strong> Full control over payroll calculations with detailed options.
                </div>

                <!-- Pay Amount & Time Increment -->
                <div class="row mb-3">
                  <div class="col-md-6">
                    <label for="advPayAmount" class="form-label fw-bold">Pay Amount:</label>
                    <div class="input-group">
                      <span class="input-group-text">$</span>
                      <input type="number" class="form-control" id="advPayAmount" name="adv_pay_amount" step="0.01" placeholder="0.25" value="{% if default_setting and default_setting.settings_mode == 'advanced' %}{{ "%.2f"|format(default_setting.pay_rate) }}{% endif %}">
                    </div>
                  </div>
                  <div class="col-md-6">
                    <label for="advTimeUnit" class="form-label fw-bold">Time Increment:</label>
                    <select class="form-select" id="advTimeUnit" name="adv_time_unit">
                      <option value="seconds" {% if default_setting and default_setting.time_unit == 'seconds' %}selected{% endif %}>Per Second</option>
                      <option value="minutes" {% if not default_setting or default_setting.time_unit == 'minutes' %}selected{% endif %}>Per Minute</option>
                      <option value="hours" {% if default_setting and default_setting.time_unit == 'hours' %}selected{% endif %}>Per Hour</option>
                      <option value="days" {% if default_setting and default_setting.time_unit == 'days' %}selected{% endif %}>Per Day</option>
                    </select>
                  </div>
                </div>

                <!-- Overtime Settings -->
                <div class="card mb-3 border-info">
                  <div class="card-header bg-info bg-opacity-10">
                    <div class="form-check form-switch">
                      <input class="form-check-input" type="checkbox" id="advOvertimeEnabled" name="adv_overtime_enabled" {% if default_setting and default_setting.overtime_enabled %}checked{% endif %}>
                      <label class="form-check-label fw-bold" for="advOvertimeEnabled">Enable Overtime</label>
                    </div>
                  </div>
                  <div class="card-body" id="overtimeFields" {% if default_setting and default_setting.overtime_enabled %}style="display:block;"{% else %}style="display:none;"{% endif %}>
                    <div class="row mb-3">
                      <div class="col-md-4">
                        <label for="advOvertimeThreshold" class="form-label">Threshold:</label>
                        <input type="number" class="form-control" id="advOvertimeThreshold" name="adv_overtime_threshold" step="0.1" placeholder="8" value="{% if default_setting and default_setting.overtime_threshold %}{{ default_setting.overtime_threshold }}{% endif %}">
                      </div>
                      <div class="col-md-4">
                        <label for="advOvertimeUnit" class="form-label">Unit:</label>
                        <select class="form-select" id="advOvertimeUnit" name="adv_overtime_unit">
                          <option value="seconds" {% if default_setting and default_setting.overtime_threshold_unit == 'seconds' %}selected{% endif %}>Seconds</option>
                          <option value="minutes" {% if default_setting and default_setting.overtime_threshold_unit == 'minutes' %}selected{% endif %}>Minutes</option>
                          <option value="hours" {% if not default_setting or default_setting.overtime_threshold_unit == 'hours' %}selected{% endif %}>Hours</option>
                        </select>
                      </div>
                      <div class="col-md-4">
                        <label for="advOvertimePeriod" class="form-label">Per:</label>
                        <select class="form-select" id="advOvertimePeriod" name="adv_overtime_period">
                          <option value="day" {% if not default_setting or default_setting.overtime_threshold_period == 'day' %}selected{% endif %}>Day</option>
                          <option value="week" {% if default_setting and default_setting.overtime_threshold_period == 'week' %}selected{% endif %}>Week</option>
                          <option value="month" {% if default_setting and default_setting.overtime_threshold_period == 'month' %}selected{% endif %}>Month</option>
                        </select>
                      </div>
                    </div>
                    <div class="mb-0">
                      <label for="advOvertimeMultiplier" class="form-label">Overtime Multiplier:</label>
                      <div class="input-group">
                        <input type="number" class="form-control" id="advOvertimeMultiplier" name="adv_overtime_multiplier" step="0.1" min="1.0" placeholder="1.5" value="{% if default_setting and default_setting.overtime_multiplier %}{{ default_setting.overtime_multiplier }}{% endif %}">
                        <span class="input-group-text">x</span>
                      </div>
                      <small class="text-muted">Must be ≥ 1.0 (e.g., 1.5 = 1.5x base rate for overtime)</small>
                    </div>
                  </div>
                </div>

                <!-- Maximum Time Per Day -->
                <div class="mb-3">
                  <label class="form-label fw-bold">Daily Time Limit:</label>
                  <div class="row">
                    <div class="col-md-6">
                      <input type="number" class="form-control" id="advMaxTimeValue" name="adv_max_time_value" step="0.1" placeholder="Leave blank for unlimited" value="{% if default_setting and default_setting.max_time_per_day %}{{ default_setting.max_time_per_day }}{% endif %}">
                      <small class="text-muted">Students will be auto-tapped-out when limit is reached and prevented from tapping in until next day (resets at midnight PST)</small>
                    </div>
                    <div class="col-md-6">
                      <select class="form-select" id="advMaxTimeUnit" name="adv_max_time_unit">
                        <option value="seconds" {% if default_setting and default_setting.max_time_per_day_unit == 'seconds' %}selected{% endif %}>Seconds</option>
                        <option value="minutes" {% if default_setting and default_setting.max_time_per_day_unit == 'minutes' %}selected{% endif %}>Minutes</option>
                        <option value="hours" {% if not default_setting or default_setting.max_time_per_day_unit == 'hours' %}selected{% endif %}>Hours</option>
                      </select>
                    </div>
                  </div>
                  <small class="text-muted text-warning"><i class="bi bi-exclamation-triangle"></i> This overrides overtime calculations</small>
                </div>

                <!-- Pay Schedule -->
                <div class="mb-3">
                  <label for="advPaySchedule" class="form-label fw-bold">Pay Schedule:</label>
                  <select class="form-select mb-2" id="advPaySchedule" name="adv_pay_schedule">
                    <option value="daily" {% if default_setting and default_setting.pay_schedule_type == 'daily' %}selected{% endif %}>Daily</option>
                    <option value="weekly" {% if default_setting and default_setting.pay_schedule_type == 'weekly' %}selected{% endif %}>Weekly</option>
                    <option value="biweekly" {% if not default_setting or default_setting.pay_schedule_type == 'biweekly' %}selected{% endif %}>Bi-weekly</option>
                    <option value="monthly" {% if default_setting and default_setting.pay_schedule_type == 'monthly' %}selected{% endif %}>Monthly</option>
                    <option value="custom" {% if default_setting and default_setting.pay_schedule_type == 'custom' %}selected{% endif %}>Custom</option>
                  </select>
                  <div id="customScheduleFields" style="display:none;">
                    <div class="row">
                      <div class="col-md-6">
                        <input type="number" class="form-control" id="advCustomScheduleValue" name="adv_custom_schedule_value" placeholder="Enter number">
                      </div>
                      <div class="col-md-6">
                        <select class="form-select" id="advCustomScheduleUnit" name="adv_custom_schedule_unit">
                          <option value="days" selected>Day(s)</option>
                          <option value="weeks">Week(s)</option>
                        </select>
                      </div>
                    </div>
                  </div>
                </div>

                <!-- First Pay Date -->
                <div class="mb-3">
                  <label for="advFirstPayDate" class="form-label fw-bold">First Pay Date:</label>
                  <input type="date" class="form-control" id="advFirstPayDate" name="adv_first_pay_date" value="{% if default_setting and default_setting.first_pay_date %}{{ default_setting.first_pay_date.strftime('%Y-%m-%d') }}{% endif %}">
                </div>

                <!-- Rounding Mode -->
                <div class="mb-3">
                  <label for="advRounding" class="form-label fw-bold">Rounding:</label>
                  <select class="form-select" id="advRounding" name="adv_rounding">
                    <option value="down" {% if not default_setting or default_setting.rounding_mode == 'down' %}selected{% endif %}>Round Down</option>
                    <option value="up" {% if default_setting and default_setting.rounding_mode == 'up' %}selected{% endif %}>Round Up</option>
                    <option value="nearest" {% if default_setting and default_setting.rounding_mode == 'nearest' %}selected{% endif %}>Round to Nearest</option>
                  </select>
                  <small class="text-muted">If time doesn't reach next increment</small>
                </div>

                <!-- Expected Weekly Hours (shared field between modes) -->
                <div class="mb-3" style="display:none;">
                  <input type="hidden" id="expectedWeeklyHoursAdv" name="expected_weekly_hours" value="{% if default_setting and default_setting.expected_weekly_hours %}{{ default_setting.expected_weekly_hours }}{% else %}5.0{% endif %}">
                </div>

                <!-- Apply To -->
                <div class="mb-3">
                  <label class="form-label fw-bold">Apply Settings To:</label>
                  <div class="form-check">
                    <input class="form-check-input" type="radio" name="adv_apply_to" id="advApplyAll" value="all" checked>
                    <label class="form-check-label" for="advApplyAll">All Classes</label>
                  </div>
                  <div class="form-check">
                    <input class="form-check-input" type="radio" name="adv_apply_to" id="advApplySelected" value="selected">
                    <label class="form-check-label" for="advApplySelected">Selected Classes:</label>
                  </div>
                  <div id="advBlockCheckboxes" class="ms-4 mt-2" style="display:none;">
                    {% for block in blocks %}
                    <div class="form-check">
                      <input class="form-check-input adv-block-checkbox" type="checkbox" name="adv_blocks[]" value="{{ block }}" id="adv_block_{{ block }}">
                      <label class="form-check-label" for="adv_block_{{ block }}">{{ class_labels_by_block.get(block, block) }}</label>
                    </div>
                    {% endfor %}
                  </div>
                </div>
              </div>

              <!-- Validation Errors Display -->
              <div id="validationErrors" class="alert alert-danger" style="display:none;">
                <strong><i class="bi bi-exclamation-circle me-2"></i>Conflicting Settings:</strong>
                <ul id="validationErrorList" class="mb-0"></ul>
              </div>

              <!-- Save Button -->
              <div class="text-end">
                <button type="submit" class="btn btn-primary btn-lg">
                  <i class="bi bi-save me-2"></i>Save Settings
                </button>
              </div>
            </form>
          </div>
        </div>
      </div>

      <!-- RIGHT: Pay Simulator -->
      <div class="col-lg-4 mb-4">
        <div class="card shadow border-success">
          <div class="card-header bg-success text-white">
            <h5 class="mb-0"><i class="bi bi-calculator me-2"></i>Pay Simulator</h5>
          </div>
          <div class="card-body">
            <p class="text-muted small">Estimate student earnings based on your current settings.</p>

            <!-- Simulator Inputs -->
            <div class="mb-3">
              <label for="simMinutesPerClass" class="form-label fw-bold">Minutes per Class:</label>
              <input type="number" class="form-control" id="simMinutesPerClass" value="50" min="1">
            </div>

            <div class="mb-3">
              <label for="simClassesPerWeek" class="form-label fw-bold">Classes per Week:</label>
              <input type="number" class="form-control" id="simClassesPerWeek" value="5" min="1">
            </div>

            <button type="button" class="btn btn-success w-100 mb-3" id="calculatePayBtn">
              <i class="bi bi-calculator me-2"></i>Calculate
            </button>

            <!-- Results -->
            <div id="simulatorResults" style="display:none;">
              <div class="alert alert-success mb-0">
                <h6 class="fw-bold">Estimated Earnings:</h6>
                <table class="table table-sm table-borderless mb-0">
                  <tr>
                    <td>Per Week:</td>
                    <td class="text-end fw-bold">$<span id="simWeekly">0.00</span></td>
                  </tr>
                  <tr>
                    <td>Per Month (4 weeks):</td>
                    <td class="text-end fw-bold">$<span id="simMonthly">0.00</span></td>
                  </tr>
                  <tr>
                    <td>Per Semester (18 weeks):</td>
                    <td class="text-end fw-bold">$<span id="simSemester">0.00</span></td>
                  </tr>
                </table>
              </div>
            </div>

            <!-- Settings Summary (Plain English) -->
            <div class="mt-4 pt-3 border-top" id="settingsSummary">
              <h6 class="fw-bold mb-2"><i class="bi bi-file-text me-2"></i>Current Settings:</h6>
              <div id="settingsSummaryText" class="small text-muted">
                <p class="mb-0"><em>Configure your payroll settings above to see a summary here.</em></p>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- REWARDS & FINES TAB -->
  <div class="tab-pane fade" id="rewards-fines" role="tabpanel">
    <div class="row">
      <!-- Rewards Section -->
      <div class="col-lg-6 mb-4">
        <div class="card shadow h-100">
          <div class="card-header bg-success text-white">
            <h5 class="mb-0"><i class="bi bi-award me-2"></i>Rewards</h5>
          </div>
          <div class="card-body">
            <!-- Add Reward Form -->
            <form method="POST" action="{{ url_for('admin.payroll_add_reward') }}" class="mb-4">
              {{ reward_form.hidden_tag() }}
              <div class="mb-2">
                <label for="reward_name" class="form-label visually-hidden">Reward Name</label>
                {{ reward_form.name(class="form-control form-control-sm", placeholder="Reward Name", id="reward_name") }}
              </div>
              <div class="mb-2">
                <label for="reward_description" class="form-label visually-hidden">Description</label>
                {{ reward_form.description(class="form-control form-control-sm", rows=2, placeholder="Description (optional)", id="reward_description") }}
              </div>
              <div class="input-group input-group-sm mb-2">
                <span class="input-group-text">$</span>
                <label for="reward_amount" class="form-label visually-hidden">Amount</label>
                {{ reward_form.amount(class="form-control", placeholder="Amount", step="0.01", id="reward_amount") }}
              </div>
              <div class="form-check form-switch mb-2">
                {{ reward_form.is_active(class="form-check-input", role="switch", checked="checked", id="reward_is_active") }}
                {{ reward_form.is_active.label(class="form-check-label", **{"for": "reward_is_active"}) }}
              </div>
              {{ reward_form.submit(class="btn btn-success btn-sm w-100", id="reward_submit") }}
            </form>

            <!-- Existing Rewards -->
            <hr>
            <h6>Existing Rewards</h6>
            {% if rewards %}
              <ul class="list-group list-group-flush">
                {% for reward in rewards %}
                <li class="list-group-item d-flex justify-content-between align-items-center">
                  <div>
                    <strong>{{ reward.name }}</strong>
                    {% if reward.description %}
                      <br><small class="text-muted">{{ reward.description }}</small>
                    {% endif %}
                  </div>
                  <div class="text-end">
                    <span class="badge bg-success">${{ "%.2f"|format(reward.amount) }}</span>
                    {% if not reward.is_active %}
                      <span class="badge bg-secondary">Inactive</span>
                    {% endif %}
                    <br>
                    <button class="btn btn-sm btn-outline-primary mt-1 me-1" onclick="editReward({{ reward.id }}, '{{ reward.name|replace("'", "\\'") }}', '{{ reward.description|replace("'", "\\'")|default('') }}', {{ reward.amount }}, {{ reward.is_active|lower }})">
                      <i class="bi bi-pencil me-1"></i>Edit
                    </button>
                    <button class="btn btn-sm btn-outline-danger mt-1" onclick="deleteReward({{ reward.id }})">Delete</button>
                  </div>
                </li>
                {% endfor %}
              </ul>
            {% else %}
              <p class="text-muted small">No rewards created yet.</p>
            {% endif %}
          </div>
        </div>
      </div>

      <!-- Fines Section -->
      <div class="col-lg-6 mb-4">
        <div class="card shadow h-100">
          <div class="card-header bg-danger text-white">
            <h5 class="mb-0"><i class="bi bi-exclamation-triangle me-2"></i>Fines</h5>
          </div>
          <div class="card-body">
            <!-- Add Fine Form -->
            <form method="POST" action="{{ url_for('admin.payroll_add_fine') }}" class="mb-4">
              {{ fine_form.hidden_tag() }}
              <div class="mb-2">
                <label for="fine_name" class="form-label visually-hidden">Fine Name</label>
                {{ fine_form.name(class="form-control form-control-sm", placeholder="Fine Name", id="fine_name") }}
              </div>
              <div class="mb-2">
                <label for="fine_description" class="form-label visually-hidden">Description</label>
                {{ fine_form.description(class="form-control form-control-sm", rows=2, placeholder="Description (optional)", id="fine_description") }}
              </div>
              <div class="input-group input-group-sm mb-2">
                <span class="input-group-text">$</span>
                <label for="fine_amount" class="form-label visually-hidden">Amount</label>
                {{ fine_form.amount(class="form-control", placeholder="Amount", step="0.01", id="fine_amount") }}
              </div>
              <div class="form-check form-switch mb-2">
                {{ fine_form.is_active(class="form-check-input", role="switch", checked="checked", id="fine_is_active") }}
                {{ fine_form.is_active.label(class="form-check-label", **{"for": "fine_is_active"}) }}
              </div>
              {{ fine_form.submit(class="btn btn-danger btn-sm w-100", id="fine_submit") }}
            </form>

            <!-- Existing Fines -->
            <hr>
            <h6>Existing Fines</h6>
            {% if fines %}
              <ul class="list-group list-group-flush">
                {% for fine in fines %}
                <li class="list-group-item d-flex justify-content-between align-items-center">
                  <div>
                    <strong>{{ fine.name }}</strong>
                    {% if fine.description %}
                      <br><small class="text-muted">{{ fine.description }}</small>
                    {% endif %}
                  </div>
                  <div class="text-end">
                    <span class="badge bg-danger">-${{ "%.2f"|format(fine.amount) }}</span>
                    {% if not fine.is_active %}
                      <span class="badge bg-secondary">Inactive</span>
                    {% endif %}
                    <br>
                    <button class="btn btn-sm btn-outline-primary mt-1 me-1" onclick="editFine({{ fine.id }}, '{{ fine.name|replace("'", "\\'") }}', '{{ fine.description|replace("'", "\\'")|default('') }}', {{ fine.amount }}, {{ fine.is_active|lower }})">
                      <i class="bi bi-pencil me-1"></i>Edit
                    </button>
                    <button class="btn btn-sm btn-outline-danger mt-1" onclick="deleteFine({{ fine.id }})">Delete</button>
                  </div>
                </li>
                {% endfor %}
              </ul>
            {% else %}
              <p class="text-muted small">No fines created yet.</p>
            {% endif %}
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- MANUAL PAYMENT TAB -->
  <div class="tab-pane fade" id="manual-payment" role="tabpanel">
    <div class="row">
      <!-- LEFT COLUMN: Student Selection -->
      <div class="col-lg-6 mb-4">
        <div class="card shadow h-100">
          <div class="card-header bg-primary text-white">
            <h5 class="mb-0"><i class="bi bi-people me-2"></i>Select Students</h5>
          </div>
          <div class="card-body">
            <!-- Class Filter -->
            <div class="mb-3">
              <label for="studentBlockFilter" class="form-label fw-bold">Filter by Class:</label>
              <select id="studentBlockFilter" class="form-select">
                <option value="">All Classes</option>
                {% for block in blocks %}
                  <option value="{{ block }}">{{ class_labels_by_block.get(block, block) }}</option>
                {% endfor %}
              </select>
            </div>

            <!-- Student Table -->
            <div class="table-responsive" style="max-height: 450px; overflow-y: auto;">
              <table class="table table-sm table-hover">
                <thead class="sticky-top bg-light">
                  <tr>
                    <th width="40">
                      <input type="checkbox" id="selectAllStudents" class="form-check-input">
                    </th>
                    <th>Student</th>
                    <th class="text-end">Checking</th>
                    <th class="text-end">Savings</th>
                  </tr>
                </thead>
                <tbody>
                  {% if all_students %}
                    {% for student in all_students %}
                    <tr class="student-row" data-blocks="{{ student.block }}" data-student-id="{{ student.id }}">
                      <td>
                        <input class="form-check-input student-checkbox" type="checkbox" value="{{ student.id }}" data-blocks="{{ student.block }}">
                      </td>
                      <td>
                        <strong>{{ student.full_name }}</strong><br>
                        <small class="text-muted student-period-label">
                          {% if student.block %}
                            {% set blocks = student.block.split(',') %}
                            {% if blocks|length > 1 %}
                              {% set ns = namespace(labels=[]) %}
                              {% for b in blocks %}
                                {% set trimmed_block = b.strip() %}
                                {% set ns.labels = ns.labels + [class_labels_by_block.get(trimmed_block, trimmed_block)] %}
                              {% endfor %}
                              {{ ns.labels | join(', ') }}
                            {% else %}
                              {{ class_labels_by_block.get(student.block, student.block) }}
                            {% endif %}
                          {% else %}
                            N/A
                          {% endif %}
                        </small>
                      </td>
                      <td class="text-end">${{ "%.2f"|format(student.checking_balance) }}</td>
                      <td class="text-end">${{ "%.2f"|format(student.savings_balance) }}</td>
                    </tr>
                    {% endfor %}
                  {% else %}
                    <tr><td colspan="4" class="text-center text-muted">No students found.</td></tr>
                  {% endif %}
                </tbody>
              </table>
            </div>

            <div class="alert alert-info mt-3 mb-0">
              <i class="bi bi-info-circle me-2"></i>
              <strong>Selected:</strong> <span id="selectedCount">0</span> student(s)
            </div>
          </div>
        </div>
      </div>

      <!-- RIGHT COLUMN: Manual Payment Fields -->
      <div class="col-lg-6 mb-4">
        <div class="card shadow h-100">
          <div class="card-header bg-success text-white">
            <h5 class="mb-0"><i class="bi bi-cash-coin me-2"></i>Payment Details</h5>
          </div>
          <div class="card-body">
            <form id="manualPaymentForm">
              {{ manual_payment_form.hidden_tag() }}

              <!-- Preset Reward/Fine Selector -->
              <div class="mb-3">
                <label for="presetSelector" class="form-label fw-bold">Use Preset (Optional):</label>
                <select id="presetSelector" class="form-select">
                  <option value="">-- Select Preset --</option>
                  <optgroup label="Rewards">
                    {% for reward in rewards %}
                      {% if reward.is_active %}
                      <option value="reward_{{ reward.id }}" data-description="{{ reward.name }}" data-amount="{{ reward.amount }}" data-type="reward">
                        {{ reward.name }} (+${{ "%.2f"|format(reward.amount) }})
                      </option>
                      {% endif %}
                    {% endfor %}
                  </optgroup>
                  <optgroup label="Fines">
                    {% for fine in fines %}
                      {% if fine.is_active %}
                      <option value="fine_{{ fine.id }}" data-description="{{ fine.name }}" data-amount="-{{ fine.amount }}" data-type="fine">
                        {{ fine.name }} (-${{ "%.2f"|format(fine.amount) }})
                      </option>
                      {% endif %}
                    {% endfor %}
                  </optgroup>
                </select>
                <small class="text-muted">Selecting a preset will auto-fill description and amount (you can override)</small>
              </div>

              <!-- Description -->
              <div class="mb-3">
                {{ manual_payment_form.description.label(class="form-label fw-bold") }}
                {{ manual_payment_form.description(class="form-control", id="manualDescription", placeholder="e.g., Bonus for excellent attendance") }}
              </div>

              <!-- Amount (overrides preset) -->
              <div class="mb-3">
                {{ manual_payment_form.amount.label(class="form-label fw-bold") }}
                <div class="input-group">
                  <span class="input-group-text">$</span>
                  {{ manual_payment_form.amount(class="form-control", id="manualAmount", placeholder="0.00", step="0.01") }}
                </div>
                <small class="text-muted">This overrides the preset amount if filled</small>
              </div>

              <!-- Account Type -->
              <div class="mb-3">
                {{ manual_payment_form.account_type.label(class="form-label fw-bold") }}
                {{ manual_payment_form.account_type(class="form-select") }}
              </div>

              <hr>

              <!-- Action Buttons -->
              <div class="d-grid gap-2">
                <button type="button" id="applyToSelected" class="btn btn-primary btn-lg">
                  <i class="bi bi-check-circle me-2"></i>Apply to Selected
                </button>
                <button type="button" id="applyToAll" class="btn btn-outline-primary">
                  <i class="bi bi-check-circle-fill me-2"></i>Apply to All in Period
                </button>
              </div>
            </form>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Edit Reward Modal -->
<div class="modal fade" id="editRewardModal" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Edit Reward</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <input type="hidden" id="editRewardId">
        <div class="mb-3">
          <label for="editRewardName" class="form-label fw-bold">Name:</label>
          <input type="text" class="form-control" id="editRewardName" required>
        </div>
        <div class="mb-3">
          <label for="editRewardDescription" class="form-label fw-bold">Description:</label>
          <textarea class="form-control" id="editRewardDescription" rows="2"></textarea>
        </div>
        <div class="mb-3">
          <label for="editRewardAmount" class="form-label fw-bold">Amount:</label>
          <div class="input-group">
            <span class="input-group-text">$</span>
            <input type="number" class="form-control" id="editRewardAmount" step="0.01" required>
          </div>
        </div>
        <div class="mb-3">
          <div class="form-check form-switch">
            <input class="form-check-input" type="checkbox" id="editRewardActive">
            <label class="form-check-label" for="editRewardActive">Active</label>
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        <button type="button" class="btn btn-primary" onclick="saveReward()">Save Changes</button>
      </div>
    </div>
  </div>
</div>

<!-- Edit Fine Modal -->
<div class="modal fade" id="editFineModal" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Edit Fine</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <input type="hidden" id="editFineId">
        <div class="mb-3">
          <label for="editFineName" class="form-label fw-bold">Name:</label>
          <input type="text" class="form-control" id="editFineName" required>
        </div>
        <div class="mb-3">
          <label for="editFineDescription" class="form-label fw-bold">Description:</label>
          <textarea class="form-control" id="editFineDescription" rows="2"></textarea>
        </div>
        <div class="mb-3">
          <label for="editFineAmount" class="form-label fw-bold">Amount:</label>
          <div class="input-group">
            <span class="input-group-text">$</span>
            <input type="number" class="form-control" id="editFineAmount" step="0.01" required>
          </div>
        </div>
        <div class="mb-3">
          <div class="form-check form-switch">
            <input class="form-check-input" type="checkbox" id="editFineActive">
            <label class="form-check-label" for="editFineActive">Active</label>
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        <button type="button" class="btn btn-primary" onclick="saveFine()">Save Changes</button>
      </div>
    </div>
  </div>
</div>

<!-- JavaScript -->
<script>
// Utility: Debounce function (used across multiple DOMContentLoaded handlers)
function debounce(fn, delay = 400) {
    let timer;
    return (...args) => {
        clearTimeout(timer);
        timer = setTimeout(() => fn(...args), delay);
    };
}

// Convert UTC timestamps to local time
document.addEventListener("DOMContentLoaded", () => {
    // Auto-switch to Settings tab if no settings exist
    {% if show_setup_banner %}
    const settingsTab = document.querySelector('a[href="#settings"]');
    if (settingsTab) {
        const tab = new bootstrap.Tab(settingsTab);
        tab.show();
    }
    {% endif %}

    // Timestamp conversion handled by timezone-utils.js

    // Manual Payment Tab: Block Filter for Students
    const studentBlockFilter = document.getElementById('studentBlockFilter');
    const studentRows = document.querySelectorAll('.student-row');
    const selectAllCheckbox = document.getElementById('selectAllStudents');
    const selectedCountEl = document.getElementById('selectedCount');

    // Set default block (first option after "All Periods")
    if (studentBlockFilter && studentBlockFilter.options.length > 1) {
        studentBlockFilter.selectedIndex = 1; // Select first actual block
        studentBlockFilter.dispatchEvent(new Event('change')); // Trigger filter
    }

    if (studentBlockFilter) {
        studentBlockFilter.addEventListener('change', function() {
            const selectedBlock = this.value;
            const classLabels = {{ class_labels_by_block|tojson }};

            studentRows.forEach(row => {
                const studentBlocks = row.dataset.blocks.split(',').map(b => b.trim());
                const periodLabel = row.querySelector('.student-period-label');

                if (!selectedBlock) {
                    // Show all blocks when no filter is selected
                    row.style.display = '';
                    if (periodLabel) {
                        const allLabels = studentBlocks.map(b => classLabels[b] || b).join(', ');
                        periodLabel.textContent = allLabels;
                    }
                } else if (studentBlocks.includes(selectedBlock)) {
                    // Show only the selected period when filter is active
                    row.style.display = '';
                    if (periodLabel) {
                        periodLabel.textContent = classLabels[selectedBlock] || selectedBlock;
                    }
                } else {
                    row.style.display = 'none';
                    // Uncheck hidden students
                    row.querySelector('.student-checkbox').checked = false;
                }
            });
            selectAllCheckbox.checked = false;
            updateSelectedCount();
        });
    }

    if (selectAllCheckbox) {
        selectAllCheckbox.addEventListener('change', function() {
            const visibleCheckboxes = Array.from(studentRows)
                .filter(row => row.style.display !== 'none')
                .map(row => row.querySelector('.student-checkbox'));
            visibleCheckboxes.forEach(cb => cb.checked = this.checked);
            updateSelectedCount();
        });
    }

    const studentCheckboxes = document.querySelectorAll('.student-checkbox');
    studentCheckboxes.forEach(cb => {
        cb.addEventListener('change', updateSelectedCount);
    });

    function updateSelectedCount() {
        const count = Array.from(studentCheckboxes).filter(cb => cb.checked && cb.closest('.student-row').style.display !== 'none').length;
        if (selectedCountEl) {
            selectedCountEl.textContent = count;
        }
    }

    updateSelectedCount();

    // Preset Selector for Manual Payment
    const presetSelector = document.getElementById('presetSelector');
    const manualDescription = document.getElementById('manualDescription');
    const manualAmount = document.getElementById('manualAmount');

    if (presetSelector) {
        presetSelector.addEventListener('change', function() {
            const selectedOption = this.options[this.selectedIndex];
            if (selectedOption.value) {
                const description = selectedOption.dataset.description;
                const amount = selectedOption.dataset.amount;

                if (manualDescription) manualDescription.value = description;
                if (manualAmount) manualAmount.value = Math.abs(parseFloat(amount));
            }
        });
    }

    // History Tab: Block Filter
    const historyBlockFilter = document.getElementById('historyBlockFilter');
    if (historyBlockFilter) {
        historyBlockFilter.addEventListener('change', function() {
            const selectedBlock = this.value;
            const historyRows = document.querySelectorAll('#payrollHistoryTable tbody tr[data-block]');
            historyRows.forEach(row => {
                const rowBlock = row.dataset.block;
                if (!selectedBlock || rowBlock === selectedBlock) {
                    row.style.display = '';
                } else {
                    row.style.display = 'none';
                }
            });
        });
    }

    // History Tab: Select All Checkbox
    const selectAllHistory = document.getElementById('selectAllHistory');
    const historyCheckboxes = document.querySelectorAll('.history-checkbox');
    const voidCountEl = document.getElementById('voidCount');
    const voidSelectedBtn = document.getElementById('voidSelectedBtn');

    if (selectAllHistory) {
        selectAllHistory.addEventListener('change', function() {
            const visibleCheckboxes = Array.from(historyCheckboxes).filter(cb => {
                const row = cb.closest('tr');
                return row && row.style.display !== 'none';
            });
            visibleCheckboxes.forEach(cb => cb.checked = this.checked);
            updateVoidCount();
        });
    }

    historyCheckboxes.forEach(cb => {
        cb.addEventListener('change', updateVoidCount);
    });

    function updateVoidCount() {
        const count = Array.from(historyCheckboxes).filter(cb => cb.checked).length;
        if (voidCountEl) voidCountEl.textContent = count;
        if (voidSelectedBtn) voidSelectedBtn.disabled = count === 0;
    }

    updateVoidCount();

    // Void Selected Button
    if (voidSelectedBtn) {
        voidSelectedBtn.addEventListener('click', voidSelectedTransactions);
    }

    // SETTINGS TAB: Mode Toggle
    const settingsModeToggle = document.getElementById('settingsModeToggle');
    const settingsModeInput = document.getElementById('settingsModeInput');
    const simpleModeFields = document.getElementById('simpleModeFields');
    const advancedModeFields = document.getElementById('advancedModeFields');

    if (settingsModeToggle) {
        settingsModeToggle.addEventListener('change', function() {
            if (this.checked) {
                // Advanced mode
                simpleModeFields.style.display = 'none';
                advancedModeFields.style.display = 'block';
                settingsModeInput.value = 'advanced';
            } else {
                // Simple mode
                simpleModeFields.style.display = 'block';
                advancedModeFields.style.display = 'none';
                settingsModeInput.value = 'simple';
            }

            syncExpectedHoursToAdvanced();
            updateCWI();
        });
    }

    // Initialize Bootstrap tooltips
    const tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
    tooltipTriggerList.map(function (tooltipTriggerEl) {
        return new bootstrap.Tooltip(tooltipTriggerEl);
    });

    // Simple Mode: Apply To - Show/hide block checkboxes
    const simpleApplySelected = document.getElementById('simpleApplySelected');
    const simpleBlockCheckboxes = document.getElementById('simpleBlockCheckboxes');

    if (simpleApplySelected) {
        document.querySelectorAll('input[name="simple_apply_to"]').forEach(radio => {
            radio.addEventListener('change', function() {
                if (simpleApplySelected.checked) {
                    simpleBlockCheckboxes.style.display = 'block';
                } else {
                    simpleBlockCheckboxes.style.display = 'none';
                }
            });
        });
    }

    // Advanced Mode: Overtime toggle
    const advOvertimeEnabled = document.getElementById('advOvertimeEnabled');
    const overtimeFields = document.getElementById('overtimeFields');

    if (advOvertimeEnabled) {
        advOvertimeEnabled.addEventListener('change', function() {
            overtimeFields.style.display = this.checked ? 'block' : 'none';
        });
    }

    // Advanced Mode: Custom schedule toggle
    const advPaySchedule = document.getElementById('advPaySchedule');
    const customScheduleFields = document.getElementById('customScheduleFields');

    if (advPaySchedule) {
        advPaySchedule.addEventListener('change', function() {
            customScheduleFields.style.display = this.value === 'custom' ? 'block' : 'none';
        });
    }

    // Advanced Mode: Apply To - Show/hide block checkboxes
    const advApplySelected = document.getElementById('advApplySelected');
    const advBlockCheckboxes = document.getElementById('advBlockCheckboxes');

    if (advApplySelected) {
        document.querySelectorAll('input[name="adv_apply_to"]').forEach(radio => {
            radio.addEventListener('change', function() {
                if (advApplySelected.checked) {
                    advBlockCheckboxes.style.display = 'block';
                } else {
                    advBlockCheckboxes.style.display = 'none';
                }
            });
        });
    }

    // Pay Simulator
    const calculatePayBtn = document.getElementById('calculatePayBtn');
    if (calculatePayBtn) {
        calculatePayBtn.addEventListener('click', function() {
            const minutesPerClass = parseFloat(document.getElementById('simMinutesPerClass').value) || 0;
            const classesPerWeek = parseFloat(document.getElementById('simClassesPerWeek').value) || 0;

            // Get pay rate based on current mode
            let payRatePerMinute = 0;

            if (settingsModeToggle && settingsModeToggle.checked) {
                // Advanced mode
                const payAmount = parseFloat(document.getElementById('advPayAmount').value) || 0;
                const timeUnit = document.getElementById('advTimeUnit').value;

                // Convert to per-minute rate
                switch(timeUnit) {
                    case 'seconds':
                        payRatePerMinute = payAmount * 60;
                        break;
                    case 'minutes':
                        payRatePerMinute = payAmount;
                        break;
                    case 'hours':
                        payRatePerMinute = payAmount / 60;
                        break;
                    case 'days':
                        payRatePerMinute = payAmount / (60 * 24);
                        break;
                }
            } else {
                // Simple mode (pay rate per hour)
                const payRatePerHour = parseFloat(document.getElementById('simplePayRate').value) || 0;
                payRatePerMinute = payRatePerHour / 60;
            }

            // Calculate earnings
            const minutesPerWeek = minutesPerClass * classesPerWeek;
            const weeklyEarnings = minutesPerWeek * payRatePerMinute;
            const monthlyEarnings = weeklyEarnings * 4;
            const semesterEarnings = weeklyEarnings * 18;

            // Display results
            document.getElementById('simWeekly').textContent = weeklyEarnings.toFixed(2);
            document.getElementById('simMonthly').textContent = monthlyEarnings.toFixed(2);
            document.getElementById('simSemester').textContent = semesterEarnings.toFixed(2);
            document.getElementById('simulatorResults').style.display = 'block';
        });
    }

    // Use Preset Values Button
    const usePresetBtn = document.getElementById('usePresetBtn');
    if (usePresetBtn) {
        usePresetBtn.addEventListener('click', function() {
            // Simple mode preset values
            document.getElementById('simplePayRate').value = '15.00';
            document.getElementById('simpleFrequency').value = 'biweekly';

            // Set first pay date to next Monday
            const today = new Date();
            const nextMonday = new Date(today);
            nextMonday.setDate(today.getDate() + ((1 + 7 - today.getDay()) % 7 || 7));
            document.getElementById('simpleFirstPayDate').value = nextMonday.toISOString().split('T')[0];

            document.getElementById('simpleDailyLimit').value = '8';

            // Check "All Periods" by default
            const simpleApplyAll = document.getElementById('simpleApplyAll');
            if (simpleApplyAll) simpleApplyAll.checked = true;

            // Dismiss the alert
            this.closest('.alert').remove();

            // Update settings summary
            updateSettingsSummary();
        });
    }

    // Update Settings Summary (Plain English)
    function updateSettingsSummary() {
        const summaryDiv = document.getElementById('settingsSummaryText');
        if (!summaryDiv) return;

        const isAdvanced = settingsModeToggle && settingsModeToggle.checked;
        let summaryHTML = '';

        if (isAdvanced) {
            // Advanced Mode Summary
            const payAmount = parseFloat(document.getElementById('advPayAmount')?.value) || 0;
            const timeUnit = document.getElementById('advTimeUnit')?.value || 'minutes';
            const scheduleType = document.getElementById('advPaySchedule')?.value || 'biweekly';
            const firstPayDate = document.getElementById('advFirstPayDate')?.value;
            const overtimeEnabled = document.getElementById('advOvertimeEnabled')?.checked;
            const maxTimeValue = document.getElementById('advMaxTimeValue')?.value;
            const roundingMode = document.getElementById('advRoundingMode')?.value || 'down';

            summaryHTML = `<p class="mb-2">Students get paid <strong>$${payAmount.toFixed(2)}</strong> per <strong>${timeUnit}</strong>.</p>`;

            // Pay schedule
            const scheduleNames = {
                'daily': 'daily',
                'weekly': 'weekly',
                'biweekly': 'bi-weekly',
                'monthly': 'monthly',
                'custom': 'custom schedule'
            };
            summaryHTML += `<p class="mb-2">Their pay schedule is <strong>${scheduleNames[scheduleType]}</strong>`;
            if (firstPayDate) {
                const date = new Date(firstPayDate + 'T00:00:00');
                summaryHTML += `, and the first pay date is <strong>${date.toLocaleDateString('en-US', { month: 'long', day: 'numeric', year: 'numeric' })}</strong>`;
            }
            summaryHTML += '.</p>';

            // Overtime
            if (overtimeEnabled) {
                const threshold = document.getElementById('advOvertimeThreshold')?.value;
                const thresholdUnit = document.getElementById('advOvertimeThresholdUnit')?.value;
                const thresholdPeriod = document.getElementById('advOvertimeThresholdPeriod')?.value;
                const multiplier = document.getElementById('advOvertimeMultiplier')?.value;

                if (threshold && thresholdUnit && thresholdPeriod && multiplier) {
                    summaryHTML += `<p class="mb-2">Overtime is enabled at <strong>${multiplier}x</strong> pay after <strong>${threshold} ${thresholdUnit}</strong> per <strong>${thresholdPeriod}</strong>.</p>`;
                }
            }

            // Max time per day
            if (maxTimeValue) {
                const maxTimeUnit = document.getElementById('advMaxTimeUnit')?.value || 'hours';
                summaryHTML += `<p class="mb-2">Students will tap out after <strong>${maxTimeValue} ${maxTimeUnit}</strong> per day (resets at 12:00 AM PST).</p>`;
            }

            // Rounding
            const roundingNames = { 'up': 'rounds up', 'down': 'rounds down', 'nearest': 'rounds to nearest' };
            summaryHTML += `<p class="mb-1">Time tracking <strong>${roundingNames[roundingMode] || 'rounds down'}</strong> to the nearest time increment.</p>`;

        } else {
            // Simple Mode Summary
            const payRate = parseFloat(document.getElementById('simplePayRate')?.value) || 0;
            const frequency = document.getElementById('simpleFrequency')?.value || 'biweekly';
            const firstPayDate = document.getElementById('simpleFirstPayDate')?.value;
            const dailyLimit = document.getElementById('simpleDailyLimit')?.value;

            summaryHTML = `<p class="mb-2">Students get paid <strong>$${payRate.toFixed(2)}</strong> per hour.</p>`;

            const frequencyNames = {
                'weekly': 'weekly',
                'biweekly': 'bi-weekly',
                'monthly': 'monthly'
            };
            summaryHTML += `<p class="mb-2">Their pay schedule is <strong>${frequencyNames[frequency]}</strong>`;

            if (firstPayDate) {
                const date = new Date(firstPayDate + 'T00:00:00');
                summaryHTML += `, and the first pay date is <strong>${date.toLocaleDateString('en-US', { month: 'long', day: 'numeric', year: 'numeric' })}</strong>`;
            }
            summaryHTML += '.</p>';

            if (dailyLimit) {
                summaryHTML += `<p class="mb-1">Students will tap out after <strong>${dailyLimit} hours</strong> per day (resets at 12:00 AM PST).</p>`;
            }
        }

        summaryDiv.innerHTML = summaryHTML;
    }

    // Update summary when form fields change
    const formFields = document.querySelectorAll('#payrollSettingsForm input, #payrollSettingsForm select');
    formFields.forEach(field => {
        field.addEventListener('change', updateSettingsSummary);
        field.addEventListener('input', updateSettingsSummary);
    });

    // Update summary when mode toggle changes
    if (settingsModeToggle) {
        settingsModeToggle.addEventListener('change', updateSettingsSummary);
    }

    // Initial summary update if there are existing values
    updateSettingsSummary();

    // Settings Form Validation
    const payrollSettingsForm = document.getElementById('payrollSettingsForm');
    if (payrollSettingsForm) {
        payrollSettingsForm.addEventListener('submit', function(e) {
            const validationErrors = [];
            const errorList = document.getElementById('validationErrorList');
            const errorDiv = document.getElementById('validationErrors');

            // Clear previous errors
            errorList.innerHTML = '';
            errorDiv.style.display = 'none';

            if (settingsModeToggle && settingsModeToggle.checked) {
                // Advanced mode validations
                const overtimeEnabled = document.getElementById('advOvertimeEnabled').checked;
                const maxTimeValue = parseFloat(document.getElementById('advMaxTimeValue').value);
                const overtimeMultiplier = parseFloat(document.getElementById('advOvertimeMultiplier').value);

                // Check if overtime multiplier is >= 1.0
                if (overtimeEnabled && overtimeMultiplier && overtimeMultiplier < 1.0) {
                    validationErrors.push('Overtime multiplier must be ≥ 1.0');
                }

                // Check if max time per day and overtime are both enabled
                if (overtimeEnabled && maxTimeValue) {
                    validationErrors.push('Maximum time per day overrides overtime. Consider disabling one of them.');
                }

                // Check if custom schedule has values
                const scheduleType = document.getElementById('advPaySchedule').value;
                const customValue = document.getElementById('advCustomScheduleValue').value;
                if (scheduleType === 'custom' && !customValue) {
                    validationErrors.push('Custom schedule requires a value');
                }
            }

            // Display errors if any
            if (validationErrors.length > 0) {
                e.preventDefault();
                validationErrors.forEach(error => {
                    const li = document.createElement('li');
                    li.textContent = error;
                    errorList.appendChild(li);
                });
                errorDiv.style.display = 'block';
                errorDiv.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
            }
        });
    }

    // ========== ECONOMY BALANCE CHECKER ==========
    const payRateInput = document.getElementById('simplePayRate');
    const expectedHoursInput = document.getElementById('expectedWeeklyHours');
    const expectedHoursAdvInput = document.getElementById('expectedWeeklyHoursAdv');
    const cwiDisplay = document.getElementById('cwi-info-payroll');
    const advPayAmountInput = document.getElementById('advPayAmount');
    const advTimeUnitInput = document.getElementById('advTimeUnit');
    const cwiTemplate = document.getElementById('cwiInfoTemplate');

    const cwiChecker = new EconomyBalanceChecker({ autoValidate: false, debounceDelay: 400 });

    function getExpectedWeeklyHours() {
        return parseFloat(expectedHoursInput?.value) || 5.0;
    }

    function syncExpectedHoursToAdvanced() {
        const hours = getExpectedWeeklyHours();
        if (expectedHoursAdvInput) {
            expectedHoursAdvInput.value = hours;
        }
        cwiChecker.expectedWeeklyHours = hours;
    }

    function getHourlyRate() {
        const mode = settingsModeInput ? settingsModeInput.value : 'simple';
        let hourlyRate = 0;

        if (mode === 'advanced' && advPayAmountInput && advTimeUnitInput) {
            const advAmount = parseFloat(advPayAmountInput.value) || 0;
            const unit = advTimeUnitInput.value;

            switch (unit) {
                case 'seconds':
                    hourlyRate = advAmount * 3600;
                    break;
                case 'minutes':
                    hourlyRate = advAmount * 60;
                    break;
                case 'hours':
                    hourlyRate = advAmount;
                    break;
                case 'days':
                    hourlyRate = advAmount / 24;
                    break;
                default:
                    hourlyRate = 0;
            }
        } else if (payRateInput) {
            hourlyRate = parseFloat(payRateInput.value) || 0;
        }

        return hourlyRate;
    }

    function clearCWI() {
        if (!cwiDisplay) return;
        cwiDisplay.innerHTML = '';
        cwiDisplay.style.display = 'none';
    }

    function renderRecommendationRow(prefix, recommendation, label, icon) {
        if (!recommendation) return '';
        return `
            <strong><i class="bi ${icon}"></i> ${label}:</strong>
            $${recommendation.min?.toFixed(2)} - $${recommendation.max?.toFixed(2)}
            ${recommendation.recommended !== undefined ? `<span class="badge bg-info">Ideal: $${recommendation.recommended?.toFixed(2)}</span>` : ''}
        `;
    }

    function renderStoreTiers(tiers) {
        if (!tiers) return '';
        return `
            <strong><i class="bi bi-shop"></i> Store Items:</strong>
            <div class="ms-3">
                <div>BASIC: $${tiers.basic?.min?.toFixed(2)} - $${tiers.basic?.max?.toFixed(2)}</div>
                <div>STANDARD: $${tiers.standard?.min?.toFixed(2)} - $${tiers.standard?.max?.toFixed(2)}</div>
                <div>PREMIUM: $${tiers.premium?.min?.toFixed(2)} - $${tiers.premium?.max?.toFixed(2)}</div>
                <div>LUXURY: $${tiers.luxury?.min?.toFixed(2)} - $${tiers.luxury?.max?.toFixed(2)}</div>
            </div>
        `;
    }

    function renderCWIInfo(cwiData) {
        if (!cwiDisplay || !cwiTemplate) return;

        const recommendations = cwiData.recommendations || {};
        const clone = cwiTemplate.content.cloneNode(true);

        const weeklyIncomeEl = clone.querySelector('[data-field="weekly-income"]');
        const calcNoteEl = clone.querySelector('[data-field="calculation-note"]');
        const rentEl = clone.querySelector('[data-field="rent"]');
        const insuranceEl = clone.querySelector('[data-field="insurance"]');
        const finesEl = clone.querySelector('[data-field="fines"]');
        const storeEl = clone.querySelector('[data-field="store"]');
        const detailsEl = clone.querySelector('[data-field="recommendations-details"]');

        if (weeklyIncomeEl) {
            weeklyIncomeEl.textContent = `$${cwiData.cwi.toFixed(2)}/week`;
        }

        if (calcNoteEl) {
            const breakdown = cwiData.breakdown || {};
            const payRateHour = breakdown.pay_rate_per_hour !== undefined ? breakdown.pay_rate_per_hour : getHourlyRate();
            calcNoteEl.textContent = `Based on $${(payRateHour || 0).toFixed(2)}/hour × ${breakdown.expected_weekly_hours || getExpectedWeeklyHours()} hours/week`;
        }

        if (rentEl) {
            rentEl.innerHTML = renderRecommendationRow('rent', recommendations.rent, 'Rent', 'bi-house-door');
        }

        if (insuranceEl) {
            insuranceEl.innerHTML = renderRecommendationRow('insurance', recommendations.insurance_premium_weekly, 'Insurance (weekly)', 'bi-shield-check');
        }

        if (finesEl) {
            finesEl.innerHTML = renderRecommendationRow('fines', recommendations.fine, 'Fines', 'bi-exclamation-triangle');
        }

        if (storeEl) {
            storeEl.innerHTML = renderStoreTiers(recommendations.store_tiers);
        }

        if (detailsEl) {
            detailsEl.addEventListener('toggle', () => {
                detailsEl.setAttribute('aria-expanded', detailsEl.open.toString());
            });
        }

        cwiDisplay.innerHTML = '';
        cwiDisplay.appendChild(clone);
        cwiDisplay.style.display = 'block';
    }

    const updateCWI = debounce(async () => {
        if (!cwiDisplay) return;

        const hourlyRate = getHourlyRate();
        const expectedHours = getExpectedWeeklyHours();
        syncExpectedHoursToAdvanced();

        if (!hourlyRate || hourlyRate <= 0) {
            clearCWI();
            return;
        }

        try {
            const cwiData = await cwiChecker.calculateCWI(hourlyRate, expectedHours);
            renderCWIInfo(cwiData);
        } catch (error) {
            console.error('CWI calculation error:', error);
            clearCWI();
        }
    }, 400);

    [payRateInput, expectedHoursInput, advPayAmountInput, advTimeUnitInput].forEach(input => {
        if (!input) return;
        const eventName = input === advTimeUnitInput ? 'change' : 'input';
        input.addEventListener(eventName, updateCWI);
    });

    // Calculate on page load
    updateCWI();
});

// ========== OVERVIEW TAB: CWI DISPLAY ==========
document.addEventListener('DOMContentLoaded', function() {
    const expectedHoursOverview = document.getElementById('expectedWeeklyHoursOverview');
    const cwiDisplayOverview = document.getElementById('cwi-display-overview');
    const cwiTemplate = document.getElementById('cwiInfoTemplate');

    if (!expectedHoursOverview || !cwiDisplayOverview) return;

    const cwiChecker = new EconomyBalanceChecker({ autoValidate: false });

    async function updateCWIOverview() {
        const expectedHours = parseFloat(expectedHoursOverview.value) || 5.0;
        const currentBlock = document.getElementById('cwi_block_input')?.value;

        try {
            const analysis = await cwiChecker.analyzeEconomy(expectedHours, currentBlock);

            if (!analysis || !analysis.cwi) {
                cwiDisplayOverview.innerHTML = '<div class="alert alert-warning"><i class="bi bi-exclamation-triangle me-2"></i>Please configure payroll settings first to see CWI calculation.</div>';
                return;
            }

            // Render CWI info using the template
            const clone = cwiTemplate.content.cloneNode(true);
            const weeklyIncomeEl = clone.querySelector('[data-field="weekly-income"]');
            const calcNoteEl = clone.querySelector('[data-field="calculation-note"]');
            const rentEl = clone.querySelector('[data-field="rent"]');
            const insuranceEl = clone.querySelector('[data-field="insurance"]');
            const finesEl = clone.querySelector('[data-field="fines"]');
            const storeEl = clone.querySelector('[data-field="store"]');

            if (weeklyIncomeEl) {
                weeklyIncomeEl.textContent = `$${analysis.cwi.cwi.toFixed(2)}/week`;
            }

            if (calcNoteEl) {
                const breakdown = analysis.cwi.breakdown || {};
                const payRateHour = breakdown.pay_rate_per_hour || 0;
                const totalMinutes = breakdown.expected_weekly_minutes || (expectedHours * 60);
                calcNoteEl.innerHTML = `
                    <strong>Pay Rate:</strong> $${payRateHour.toFixed(2)}/hour ($${breakdown.pay_rate_per_minute?.toFixed(2) || '0.00'}/minute)<br>
                    <strong>Expected Hours:</strong> ${expectedHours.toFixed(2)} hours/week (${totalMinutes.toFixed(0)} minutes)
                `;
            }

            const recommendations = analysis.cwi.recommendations || {};

            if (rentEl && recommendations.rent) {
                rentEl.innerHTML = `<strong><i class="bi bi-house-door"></i> Rent:</strong> $${recommendations.rent.min?.toFixed(2)} - $${recommendations.rent.max?.toFixed(2)} <span class="badge bg-info">Ideal: $${recommendations.rent.recommended?.toFixed(2)}</span>`;
            }

            if (insuranceEl && recommendations.insurance_premium_weekly) {
                insuranceEl.innerHTML = `<strong><i class="bi bi-shield-check"></i> Insurance (weekly):</strong> $${recommendations.insurance_premium_weekly.min?.toFixed(2)} - $${recommendations.insurance_premium_weekly.max?.toFixed(2)} <span class="badge bg-info">Ideal: $${recommendations.insurance_premium_weekly.recommended?.toFixed(2)}</span>`;
            }

            if (finesEl && recommendations.fine) {
                finesEl.innerHTML = `<strong><i class="bi bi-exclamation-triangle"></i> Fines:</strong> $${recommendations.fine.min?.toFixed(2)} - $${recommendations.fine.max?.toFixed(2)} <span class="badge bg-info">Ideal: $${recommendations.fine.recommended?.toFixed(2)}</span>`;
            }

            if (storeEl && recommendations.store_tiers) {
                const tiers = recommendations.store_tiers;
                storeEl.innerHTML = `
                    <strong><i class="bi bi-shop"></i> Store Items:</strong>
                    <div class="ms-3">
                        <div>BASIC: $${tiers.basic?.min?.toFixed(2)} - $${tiers.basic?.max?.toFixed(2)}</div>
                        <div>STANDARD: $${tiers.standard?.min?.toFixed(2)} - $${tiers.standard?.max?.toFixed(2)}</div>
                        <div>PREMIUM: $${tiers.premium?.min?.toFixed(2)} - $${tiers.premium?.max?.toFixed(2)}</div>
                        <div>LUXURY: $${tiers.luxury?.min?.toFixed(2)} - $${tiers.luxury?.max?.toFixed(2)}</div>
                    </div>
                `;
            }

            cwiDisplayOverview.innerHTML = '';
            cwiDisplayOverview.appendChild(clone);
        } catch (error) {
            console.error('Error calculating CWI:', error);
            cwiDisplayOverview.innerHTML = '<div class="alert alert-warning"><i class="bi bi-exclamation-triangle me-2"></i>Please configure payroll settings first to see CWI calculation.</div>';
        }
    }

    // Update CWI when expected hours changes
    expectedHoursOverview.addEventListener('input', debounce(updateCWIOverview, 400));

    // Load CWI on page load
    updateCWIOverview();

    // Class selector - reload page when changed
    const cwiBlockSelector = document.getElementById('cwi_block_selector');
    const cwiBlockInput = document.getElementById('cwi_block_input');
    if (cwiBlockSelector && cwiBlockInput) {
        cwiBlockSelector.addEventListener('change', function() {
            const selectedBlock = this.value;
            const url = new URL(window.location.href);
            url.searchParams.set('cwi_block', selectedBlock);
            window.location.href = url.toString();
        });
    }

    // Apply to all checkbox - update hidden input
    const applyToAllCwiCheckbox = document.getElementById('apply_to_all_cwi_checkbox');
    const applyToAllCwiInput = document.getElementById('apply_to_all_cwi_input');
    if (applyToAllCwiCheckbox && applyToAllCwiInput && cwiBlockSelector) {
        applyToAllCwiCheckbox.addEventListener('change', function() {
            applyToAllCwiInput.value = this.checked ? 'true' : 'false';
            // Disable class selector when apply to all is checked
            if (cwiBlockSelector) {
                cwiBlockSelector.disabled = this.checked;
            }
        });
    }

    // Add confirmation dialog for expected hours form
    const expectedHoursForm = document.getElementById('expectedHoursForm');
    if (expectedHoursForm) {
        expectedHoursForm.addEventListener('submit', function(e) {
            const currentValue = parseFloat(expectedHoursOverview.value) || 5.0;
            const initialValue = parseFloat(expectedHoursOverview.getAttribute('value')) || 5.0;
            const applyToAll = applyToAllCwiCheckbox && applyToAllCwiCheckbox.checked;
            const selectedBlock = cwiBlockInput ? cwiBlockInput.value : 'Unknown';

            // Only show confirmation if the value has changed
            if (currentValue !== initialValue) {
                e.preventDefault();

                let message;
                if (applyToAll) {
                    message = `This will update the Expected Weekly Hours to ${currentValue.toFixed(2)} hours/week for ALL classes.\n\n` +
                        `This affects:\n` +
                        `• CWI calculations for all classes\n` +
                        `• Economy balance recommendations\n` +
                        `• Rent, insurance, and store pricing guidance\n\n` +
                        `Do you want to continue?`;
                } else {
                    message = `This will update the Expected Weekly Hours to ${currentValue.toFixed(2)} hours/week for ${selectedBlock}.\n\n` +
                        `This affects:\n` +
                        `• CWI calculation for ${selectedBlock}\n` +
                        `• Economy balance recommendations for ${selectedBlock}\n\n` +
                        `Do you want to continue?`;
                }

                const confirmed = confirm(message);

                if (confirmed) {
                    expectedHoursForm.submit();
                }
            }
        });
    }
});

// Run Payroll
document.getElementById('runPayrollBtn')?.addEventListener('click', async function() {
  const csrfToken = document.querySelector('meta[name="csrf-token"]').getAttribute('content');
  try {
    const resp = await fetch('{{ url_for("admin.run_payroll") }}', {
      method: 'POST',
      headers: {
        'X-Requested-With': 'XMLHttpRequest',
        'Content-Type': 'application/json',
        'X-CSRFToken': csrfToken
      }
    });
    const payload = await resp.json();
    if (!resp.ok) throw new Error(payload.message || 'Payroll failed');
    showToast(payload.message || 'Payroll complete.', 'success');
    setTimeout(() => location.reload(), 1500);
  } catch (e) {
    showToast(e.message, 'error');
  }
});

// Edit Reward
function editReward(id, name, description, amount, isActive) {
  document.getElementById('editRewardId').value = id;
  document.getElementById('editRewardName').value = name;
  document.getElementById('editRewardDescription').value = description;
  document.getElementById('editRewardAmount').value = amount;
  document.getElementById('editRewardActive').checked = isActive;

  const modal = new bootstrap.Modal(document.getElementById('editRewardModal'));
  modal.show();
}

// Save Reward
async function saveReward() {
  const id = document.getElementById('editRewardId').value;
  const name = document.getElementById('editRewardName').value;
  const description = document.getElementById('editRewardDescription').value;
  const amount = document.getElementById('editRewardAmount').value;
  const isActive = document.getElementById('editRewardActive').checked;

  const csrfToken = document.querySelector('meta[name="csrf-token"]').getAttribute('content');

  try {
    const resp = await fetch(`/admin/payroll/rewards/${id}/edit`, {
      method: 'POST',
      headers: {
        'X-CSRFToken': csrfToken,
        'Content-Type': 'application/json'
      },
      body: JSON.stringify({ name, description, amount, is_active: isActive })
    });

    const data = await resp.json();
    if (data.success) {
      showToast('Reward updated successfully', 'success');
      setTimeout(() => location.reload(), 1000);
    } else {
      showToast(data.message || 'Failed to update reward', 'error');
    }
  } catch (err) {
    showToast('Error updating reward', 'error');
  }
}

// Delete Reward
function deleteReward(rewardId) {
  if (!confirm('Are you sure you want to delete this reward?')) return;

  const csrfToken = document.querySelector('meta[name="csrf-token"]').getAttribute('content');
  fetch(`/admin/payroll/rewards/${rewardId}/delete`, {
    method: 'POST',
    headers: {
      'X-CSRFToken': csrfToken,
      'Content-Type': 'application/json'
    }
  })
  .then(resp => resp.json())
  .then(data => {
    if (data.success) {
      showToast('Reward deleted successfully', 'success');
      setTimeout(() => location.reload(), 1000);
    } else {
      showToast(data.message || 'Failed to delete reward', 'error');
    }
  })
  .catch(err => showToast('Error deleting reward', 'error'));
}

// Edit Fine
function editFine(id, name, description, amount, isActive) {
  document.getElementById('editFineId').value = id;
  document.getElementById('editFineName').value = name;
  document.getElementById('editFineDescription').value = description;
  document.getElementById('editFineAmount').value = amount;
  document.getElementById('editFineActive').checked = isActive;

  const modal = new bootstrap.Modal(document.getElementById('editFineModal'));
  modal.show();
}

// Save Fine
async function saveFine() {
  const id = document.getElementById('editFineId').value;
  const name = document.getElementById('editFineName').value;
  const description = document.getElementById('editFineDescription').value;
  const amount = document.getElementById('editFineAmount').value;
  const isActive = document.getElementById('editFineActive').checked;

  const csrfToken = document.querySelector('meta[name="csrf-token"]').getAttribute('content');

  try {
    const resp = await fetch(`/admin/payroll/fines/${id}/edit`, {
      method: 'POST',
      headers: {
        'X-CSRFToken': csrfToken,
        'Content-Type': 'application/json'
      },
      body: JSON.stringify({ name, description, amount, is_active: isActive })
    });

    const data = await resp.json();
    if (data.success) {
      showToast('Fine updated successfully', 'success');
      setTimeout(() => location.reload(), 1000);
    } else {
      showToast(data.message || 'Failed to update fine', 'error');
    }
  } catch (err) {
    showToast('Error updating fine', 'error');
  }
}

// Delete Fine
function deleteFine(fineId) {
  if (!confirm('Are you sure you want to delete this fine?')) return;

  const csrfToken = document.querySelector('meta[name="csrf-token"]').getAttribute('content');
  fetch(`/admin/payroll/fines/${fineId}/delete`, {
    method: 'POST',
    headers: {
      'X-CSRFToken': csrfToken,
      'Content-Type': 'application/json'
    }
  })
  .then(resp => resp.json())
  .then(data => {
    if (data.success) {
      showToast('Fine deleted successfully', 'success');
      setTimeout(() => location.reload(), 1000);
    } else {
      showToast(data.message || 'Failed to delete fine', 'error');
    }
  })
  .catch(err => showToast('Error deleting fine', 'error'));
}

// Manual Payment: Apply to Selected
document.getElementById('applyToSelected')?.addEventListener('click', async function() {
  const selectedStudents = Array.from(document.querySelectorAll('.student-checkbox:checked')).map(cb => cb.value);

  if (selectedStudents.length === 0) {
    alert('Please select at least one student.');
    return;
  }

  const description = document.getElementById('manualDescription').value;
  const amount = document.getElementById('manualAmount').value;
  const accountType = document.querySelector('select[name="account_type"]').value;

  if (!description || !amount) {
    alert('Please fill in description and amount.');
    return;
  }

  await submitManualPayment(selectedStudents, description, amount, accountType);
});

// Manual Payment: Apply to All in Period
document.getElementById('applyToAll')?.addEventListener('click', async function() {
  const selectedBlock = document.getElementById('studentBlockFilter').value;

  if (!selectedBlock) {
    alert('Please select a specific period/block first.');
    return;
  }

  const allStudentsInPeriod = Array.from(document.querySelectorAll('.student-row'))
    .filter(row => row.style.display !== 'none')
    .map(row => row.querySelector('.student-checkbox').value);

  if (allStudentsInPeriod.length === 0) {
    alert('No students found in the selected period.');
    return;
  }

  const description = document.getElementById('manualDescription').value;
  const amount = document.getElementById('manualAmount').value;
  const accountType = document.querySelector('select[name="account_type"]').value;

  if (!description || !amount) {
    alert('Please fill in description and amount.');
    return;
  }

  if (!confirm(`Apply payment to all ${allStudentsInPeriod.length} students in this period?`)) return;

  await submitManualPayment(allStudentsInPeriod, description, amount, accountType);
});

// Submit Manual Payment
async function submitManualPayment(studentIds, description, amount, accountType) {
  const csrfToken = document.querySelector('meta[name="csrf-token"]').getAttribute('content');

  const formData = new FormData();
  formData.append('description', description);
  formData.append('amount', amount);
  formData.append('account_type', accountType);
  studentIds.forEach(id => formData.append('student_ids', id));

  try {
    const resp = await fetch('{{ url_for("admin.payroll_manual_payment") }}', {
      method: 'POST',
      headers: {
        'X-CSRFToken': csrfToken
      },
      body: formData
    });

    if (resp.redirected) {
      showToast('Payment applied successfully!', 'success');
      setTimeout(() => location.reload(), 1000);
    } else {
      const data = await resp.json();
      if (data.success) {
        showToast(data.message || 'Payment applied successfully!', 'success');
        setTimeout(() => location.reload(), 1000);
      } else {
        showToast(data.message || 'Failed to apply payment', 'error');
      }
    }
  } catch (err) {
    showToast('Error applying payment', 'error');
  }
}

// Void Single Transaction
async function voidTransaction(transactionId) {
  if (!confirm('Are you sure you want to void this transaction? This cannot be undone.')) return;

  const csrfToken = document.querySelector('meta[name="csrf-token"]').getAttribute('content');

  try {
    const resp = await fetch(`/admin/payroll/transactions/${transactionId}/void`, {
      method: 'POST',
      headers: {
        'X-CSRFToken': csrfToken,
        'Content-Type': 'application/json'
      }
    });

    const data = await resp.json();
    if (data.success) {
      showToast('Transaction voided successfully', 'success');
      setTimeout(() => location.reload(), 1000);
    } else {
      showToast(data.message || 'Failed to void transaction', 'error');
    }
  } catch (err) {
    showToast('Error voiding transaction', 'error');
  }
}

// Void Selected Transactions
async function voidSelectedTransactions() {
  const selectedIds = Array.from(document.querySelectorAll('.history-checkbox:checked')).map(cb => cb.value);

  if (selectedIds.length === 0) {
    alert('Please select at least one transaction to void.');
    return;
  }

  if (!confirm(`Are you sure you want to void ${selectedIds.length} transaction(s)? This cannot be undone.`)) return;

  const csrfToken = document.querySelector('meta[name="csrf-token"]').getAttribute('content');

  try {
    const resp = await fetch('/admin/payroll/transactions/void-bulk', {
      method: 'POST',
      headers: {
        'X-CSRFToken': csrfToken,
        'Content-Type': 'application/json'
      },
      body: JSON.stringify({ transaction_ids: selectedIds })
    });

    const data = await resp.json();
    if (data.success) {
      showToast(`${selectedIds.length} transaction(s) voided successfully`, 'success');
      setTimeout(() => location.reload(), 1000);
    } else {
      showToast(data.message || 'Failed to void transactions', 'error');
    }
  } catch (err) {
    showToast('Error voiding transactions', 'error');
  }
}

// Toast notification helper
function showToast(message, type) {
  if (window.toast) {
    window.toast(message, type);
  } else {
    alert(message);
  }
}
</script>

{% endblock %}
