{% extends "layout_admin.html" %}
{% set page_title = "Banking Management" %}
{% set current_page = "banking" %}
{% block title %}Banking Management{% endblock %}
{% block page_icon %}account_balance{% endblock %}
{% block content %}

<!-- Nav Tabs -->
<ul class="nav nav-tabs mb-4" id="bankingTabs" role="tablist">
  <li class="nav-item" role="presentation">
    <button class="nav-link active" id="overview-tab" data-bs-toggle="tab" data-bs-target="#overview" type="button" role="tab">
      <i class="bi bi-grid me-1"></i>Overview
    </button>
  </li>
  <li class="nav-item" role="presentation">
    <button class="nav-link" id="transactions-tab" data-bs-toggle="tab" data-bs-target="#transactions" type="button" role="tab">
      <i class="bi bi-receipt me-1"></i>Transactions
    </button>
  </li>
  <li class="nav-item" role="presentation">
    <button class="nav-link" id="settings-tab" data-bs-toggle="tab" data-bs-target="#settings" type="button" role="tab">
      <i class="bi bi-gear me-1"></i>Settings
    </button>
  </li>
</ul>

<div class="tab-content" id="bankingTabContent">
  <!-- OVERVIEW TAB -->
  <div class="tab-pane fade show active" id="overview" role="tabpanel">
    <div class="row">
      <!-- Banking Stats -->
      <div class="col-lg-6 mb-4">
        <div class="card shadow">
          <div class="card-header bg-primary text-white">
            <h5 class="mb-0"><i class="bi bi-graph-up me-2"></i>Banking Statistics</h5>
          </div>
          <div class="card-body">
            <div class="row text-center">
              <div class="col-6 mb-3">
                <h3 class="text-primary">${{ "%.2f"|format(total_checking|default(0)) }}</h3>
                <small class="text-muted">Total Checking</small>
              </div>
              <div class="col-6 mb-3">
                <h3 class="text-success">${{ "%.2f"|format(total_savings|default(0)) }}</h3>
                <small class="text-muted">Total Savings</small>
              </div>
              <div class="col-6">
                <h3 class="text-info">${{ "%.2f"|format(total_deposits|default(0)) }}</h3>
                <small class="text-muted">Total Deposits</small>
              </div>
              <div class="col-6">
                <h3 class="text-warning">{{ students_with_savings|default(0) }}/{{ total_students|default(0) }}</h3>
                <small class="text-muted">Students w/ Savings</small>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Current Settings Summary -->
      <div class="col-lg-6 mb-4">
        <div class="card shadow">
          <div class="card-header bg-success text-white">
            <h5 class="mb-0"><i class="bi bi-info-circle me-2"></i>Current Settings</h5>
          </div>
          <div class="card-body">
            {% if settings %}
              <ul class="list-unstyled mb-0">
                <li class="mb-2">
                  <strong>Savings APY:</strong> {{ "%.2f"|format(settings.savings_apy) }}%
                </li>
                <li class="mb-2">
                  <strong>Monthly Rate:</strong> {{ "%.2f"|format(settings.savings_monthly_rate) }}%
                </li>
                <li class="mb-2">
                  <strong>Interest Schedule:</strong> {{ settings.interest_schedule_type|title }}
                  {% if settings.interest_schedule_type == 'monthly' %}({{ settings.interest_schedule_cycle_days }} days){% endif %}
                </li>
                <li class="mb-2">
                  <strong>Overdraft Protection:</strong>
                  <span class="badge bg-{% if settings.overdraft_protection_enabled %}success{% else %}secondary{% endif %}">
                    {% if settings.overdraft_protection_enabled %}Enabled{% else %}Disabled{% endif %}
                  </span>
                </li>
                <li class="mb-0">
                  <strong>Overdraft Fees:</strong>
                  <span class="badge bg-{% if settings.overdraft_fee_enabled %}danger{% else %}secondary{% endif %}">
                    {% if settings.overdraft_fee_enabled %}Enabled ({{ settings.overdraft_fee_type|title }}){% else %}Disabled{% endif %}
                  </span>
                </li>
              </ul>
            {% else %}
              <p class="text-muted mb-0">No banking settings configured yet. Go to the Settings tab to configure.</p>
            {% endif %}
          </div>
        </div>
      </div>
    </div>

    <!-- Recent Activity -->
    <div class="card shadow">
      <div class="card-header">
        <h5 class="mb-0"><i class="bi bi-clock-history me-2"></i>Recent Transaction Activity</h5>
      </div>
      <div class="card-body">
        {% if transactions %}
          <div class="table-responsive">
            <table class="table table-striped table-hover">
              <thead>
                <tr>
                  <th>Date</th>
                  <th>Student</th>
                  <th>Block</th>
                  <th>Type</th>
                  <th>Account</th>
                  <th>Amount</th>
                  <th>Description</th>
                </tr>
              </thead>
              <tbody>
                {% for tx in transactions[:10] %}
                <tr>
                  <td>
                    {% if tx.timestamp %}
                      <span class="local-timestamp" data-timestamp="{{ format_utc_iso(tx.timestamp) }}"></span>
                    {% else %}
                      N/A
                    {% endif %}
                  </td>
                  <td>
                    <a href="{{ url_for('admin.student_detail', student_id=tx.student_id) }}">
                      {{ tx.student_name }}
                    </a>
                  </td>
                  <td>{{ tx.student_block }}</td>
                  <td>
                    {% if tx.type %}
                      <span class="badge bg-secondary">{{ tx.type|title }}</span>
                    {% endif %}
                  </td>
                  <td>
                    <span class="badge bg-{% if tx.account_type == 'checking' %}primary{% else %}success{% endif %}">
                      {{ tx.account_type|title }}
                    </span>
                  </td>
                  <td class="{% if tx.amount > 0 %}text-success{% else %}text-danger{% endif %} fw-bold">
                    ${{ "%.2f"|format(tx.amount) }}
                  </td>
                  <td>{{ tx.description or '—' }}</td>
                </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
          <div class="text-center mt-3">
            <button class="btn btn-outline-primary" onclick="document.getElementById('transactions-tab').click()">
              View All Transactions
            </button>
          </div>
        {% else %}
          <p class="text-muted">No recent transactions found.</p>
        {% endif %}
      </div>
    </div>
  </div>

  <!-- TRANSACTIONS TAB -->
  <div class="tab-pane fade" id="transactions" role="tabpanel">
    <div class="card shadow">
      <div class="card-header">
        <h5 class="mb-0"><i class="bi bi-receipt me-2"></i>All Banking Transactions</h5>
      </div>
      <div class="card-body">
        <!-- Filter Controls -->
        <div class="row mb-3">
          <div class="col-md-3">
            <label for="blockFilter" class="form-label fw-bold">Filter by Block:</label>
            <select id="blockFilter" class="form-select">
              <option value="">All Blocks</option>
              {% for block in blocks %}
                <option value="{{ block }}">{{ block }}</option>
              {% endfor %}
            </select>
          </div>
          <div class="col-md-3">
            <label for="accountFilter" class="form-label fw-bold">Filter by Account:</label>
            <select id="accountFilter" class="form-select">
              <option value="">All Accounts</option>
              <option value="checking">Checking</option>
              <option value="savings">Savings</option>
            </select>
          </div>
          <div class="col-md-3">
            <label for="studentSearch" class="form-label fw-bold">Search Student:</label>
            <input type="text" id="studentSearch" class="form-control" placeholder="Type name...">
          </div>
        </div>

        <!-- Transactions Table -->
        <div class="table-responsive">
          <table class="table table-striped table-hover" id="transactionsTable">
            <thead>
              <tr>
                <th>Date</th>
                <th>Student</th>
                <th>Block</th>
                <th>Type</th>
                <th>Account</th>
                <th>Amount</th>
                <th>Description</th>
              </tr>
            </thead>
            <tbody>
              {% if transactions %}
                {% for tx in transactions %}
                <tr data-block="{{ tx.student_block }}" data-account="{{ tx.account_type }}" data-student="{{ tx.student_name|lower }}">
                  <td>
                    {% if tx.timestamp %}
                      <span class="local-timestamp" data-timestamp="{{ format_utc_iso(tx.timestamp) }}"></span>
                    {% else %}
                      N/A
                    {% endif %}
                  </td>
                  <td>
                    <a href="{{ url_for('admin.student_detail', student_id=tx.student_id) }}">
                      {{ tx.student_name }}
                    </a>
                  </td>
                  <td>{{ tx.student_block }}</td>
                  <td>
                    {% if tx.type %}
                      <span class="badge bg-secondary">{{ tx.type|title }}</span>
                    {% endif %}
                  </td>
                  <td>
                    <span class="badge bg-{% if tx.account_type == 'checking' %}primary{% else %}success{% endif %}">
                      {{ tx.account_type|title }}
                    </span>
                  </td>
                  <td class="{% if tx.amount > 0 %}text-success{% else %}text-danger{% endif %} fw-bold">
                    ${{ "%.2f"|format(tx.amount) }}
                  </td>
                  <td>{{ tx.description or '—' }}</td>
                </tr>
                {% endfor %}
              {% else %}
                <tr><td colspan="7" class="text-center text-muted">No transactions found.</td></tr>
              {% endif %}
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </div>

  <!-- SETTINGS TAB -->
  <div class="tab-pane fade" id="settings" role="tabpanel">
    <form method="POST" action="{{ url_for('admin.banking_settings_update') }}" id="bankingSettingsForm">
      {{ form.hidden_tag() }}

      <div class="row">
        <!-- Interest Settings Card -->
        <div class="col-lg-6 mb-4">
          <div class="card shadow h-100">
            <div class="card-header bg-primary text-white">
              <h5 class="mb-0"><i class="bi bi-percent me-2"></i>Interest Settings</h5>
            </div>
            <div class="card-body">
              <div class="mb-3">
                {{ form.savings_apy.label(class="form-label fw-bold") }}
                <div class="input-group">
                  {{ form.savings_apy(class="form-control", placeholder="5.0") }}
                  <span class="input-group-text">%</span>
                </div>
                <small class="text-muted">Annual Percentage Yield for savings accounts</small>
              </div>

              <div class="mb-3">
                {{ form.savings_monthly_rate.label(class="form-label fw-bold") }}
                <div class="input-group">
                  {{ form.savings_monthly_rate(class="form-control", placeholder="0.42") }}
                  <span class="input-group-text">%</span>
                </div>
                <small class="text-muted">Monthly interest rate (can be calculated from APY or set manually)</small>
              </div>

              <hr>

              <h6 class="fw-bold mb-3">Interest Payout Schedule</h6>

              <div class="mb-3">
                {{ form.interest_schedule_type.label(class="form-label fw-bold") }}
                {{ form.interest_schedule_type(class="form-select") }}
              </div>

              <div class="mb-3" id="cycleDaysField">
                {{ form.interest_schedule_cycle_days.label(class="form-label fw-bold") }}
                {{ form.interest_schedule_cycle_days(class="form-control", placeholder="30") }}
                <small class="text-muted">Number of days in each cycle (for monthly schedule)</small>
              </div>

              <div class="mb-0">
                {{ form.interest_payout_start_date.label(class="form-label fw-bold") }}
                {{ form.interest_payout_start_date(class="form-control") }}
                <small class="text-muted">Date when interest payouts begin</small>
              </div>
            </div>
          </div>
        </div>

        <!-- Overdraft Settings Card -->
        <div class="col-lg-6 mb-4">
          <div class="card shadow h-100">
            <div class="card-header bg-warning text-dark">
              <h5 class="mb-0"><i class="bi bi-shield-exclamation me-2"></i>Overdraft Settings</h5>
            </div>
            <div class="card-body">
              <div class="mb-4">
                <div class="form-check form-switch">
                  {{ form.overdraft_protection_enabled(class="form-check-input", role="switch") }}
                  {{ form.overdraft_protection_enabled.label(class="form-check-label fw-bold") }}
                </div>
                <small class="text-muted">If enabled, negative checking balances will be covered by savings</small>
              </div>

              <hr>

              <h6 class="fw-bold mb-3">Overdraft/NSF Fees</h6>

              <div class="mb-3">
                <div class="form-check form-switch">
                  {{ form.overdraft_fee_enabled(class="form-check-input", role="switch", id="overdraftFeeToggle") }}
                  {{ form.overdraft_fee_enabled.label(class="form-check-label fw-bold") }}
                </div>
              </div>

              <div id="feeSettings" style="{% if not settings or not settings.overdraft_fee_enabled %}display:none;{% endif %}">
                <div class="mb-3">
                  {{ form.overdraft_fee_type.label(class="form-label fw-bold") }}
                  {{ form.overdraft_fee_type(class="form-select", id="feeTypeSelect") }}
                </div>

                <!-- Flat Fee Settings -->
                <div id="flatFeeSettings" style="{% if settings and settings.overdraft_fee_type == 'progressive' %}display:none;{% endif %}">
                  <div class="mb-3">
                    {{ form.overdraft_fee_flat_amount.label(class="form-label fw-bold") }}
                    <div class="input-group">
                      <span class="input-group-text">$</span>
                      {{ form.overdraft_fee_flat_amount(class="form-control", placeholder="35.00") }}
                    </div>
                    <small class="text-muted">Fixed fee charged per overdraft transaction</small>
                  </div>
                </div>

                <!-- Progressive Fee Settings -->
                <div id="progressiveFeeSettings" style="{% if not settings or settings.overdraft_fee_type != 'progressive' %}display:none;{% endif %}">
                  <div class="mb-3">
                    {{ form.overdraft_fee_progressive_1.label(class="form-label fw-bold") }}
                    <div class="input-group">
                      <span class="input-group-text">$</span>
                      {{ form.overdraft_fee_progressive_1(class="form-control", placeholder="25.00") }}
                    </div>
                  </div>

                  <div class="mb-3">
                    {{ form.overdraft_fee_progressive_2.label(class="form-label fw-bold") }}
                    <div class="input-group">
                      <span class="input-group-text">$</span>
                      {{ form.overdraft_fee_progressive_2(class="form-control", placeholder="35.00") }}
                    </div>
                  </div>

                  <div class="mb-3">
                    {{ form.overdraft_fee_progressive_3.label(class="form-label fw-bold") }}
                    <div class="input-group">
                      <span class="input-group-text">$</span>
                      {{ form.overdraft_fee_progressive_3(class="form-control", placeholder="45.00") }}
                    </div>
                  </div>

                  <div class="mb-3">
                    {{ form.overdraft_fee_progressive_cap.label(class="form-label fw-bold") }}
                    <div class="input-group">
                      <span class="input-group-text">$</span>
                      {{ form.overdraft_fee_progressive_cap(class="form-control", placeholder="100.00") }}
                    </div>
                    <small class="text-muted">Optional maximum total fees per period</small>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Save Button -->
      <div class="text-center mb-4">
        {{ form.submit(class="btn btn-primary btn-lg px-5") }}
      </div>
    </form>
  </div>
</div>

<!-- JavaScript -->
<script>
// Convert UTC timestamps to local time
document.addEventListener("DOMContentLoaded", () => {
    // Timestamp conversion
    document.querySelectorAll(".local-timestamp").forEach(el => {
        const utcString = el.dataset.timestamp;
        if (utcString) {
            const normalized = utcString
                .replace(' ', 'T')
                .replace('+00:00Z', 'Z')
                .replace('+00:00', 'Z');
            const date = new Date(normalized);
            const options = {
                year: 'numeric',
                month: 'short',
                day: 'numeric',
                hour: 'numeric',
                minute: 'numeric',
                hour12: true
            };
            el.textContent = date.toLocaleString(undefined, options);
        } else {
            el.textContent = '—';
        }
    });

    // Transaction Filtering
    const blockFilter = document.getElementById('blockFilter');
    const accountFilter = document.getElementById('accountFilter');
    const studentSearch = document.getElementById('studentSearch');
    const tableRows = document.querySelectorAll('#transactionsTable tbody tr[data-block]');

    function filterTransactions() {
        const selectedBlock = blockFilter ? blockFilter.value : '';
        const selectedAccount = accountFilter ? accountFilter.value : '';
        const searchTerm = studentSearch ? studentSearch.value.toLowerCase() : '';

        tableRows.forEach(row => {
            const rowBlock = row.dataset.block;
            const rowAccount = row.dataset.account;
            const rowStudent = row.dataset.student;

            const blockMatch = !selectedBlock || rowBlock === selectedBlock;
            const accountMatch = !selectedAccount || rowAccount === selectedAccount;
            const studentMatch = !searchTerm || rowStudent.includes(searchTerm);

            if (blockMatch && accountMatch && studentMatch) {
                row.style.display = '';
            } else {
                row.style.display = 'none';
            }
        });
    }

    if (blockFilter) blockFilter.addEventListener('change', filterTransactions);
    if (accountFilter) accountFilter.addEventListener('change', filterTransactions);
    if (studentSearch) studentSearch.addEventListener('input', filterTransactions);

    // Overdraft Fee Toggle
    const overdraftFeeToggle = document.getElementById('overdraftFeeToggle');
    const feeSettings = document.getElementById('feeSettings');

    if (overdraftFeeToggle) {
        overdraftFeeToggle.addEventListener('change', function() {
            feeSettings.style.display = this.checked ? 'block' : 'none';
        });
    }

    // Fee Type Toggle
    const feeTypeSelect = document.getElementById('feeTypeSelect');
    const flatFeeSettings = document.getElementById('flatFeeSettings');
    const progressiveFeeSettings = document.getElementById('progressiveFeeSettings');

    if (feeTypeSelect) {
        feeTypeSelect.addEventListener('change', function() {
            if (this.value === 'flat') {
                flatFeeSettings.style.display = 'block';
                progressiveFeeSettings.style.display = 'none';
            } else {
                flatFeeSettings.style.display = 'none';
                progressiveFeeSettings.style.display = 'block';
            }
        });
    }

    // Interest Schedule Type Toggle
    const scheduleType = document.getElementById('interest_schedule_type');
    const cycleDaysField = document.getElementById('cycleDaysField');

    if (scheduleType) {
        scheduleType.addEventListener('change', function() {
            cycleDaysField.style.display = this.value === 'monthly' ? 'block' : 'none';
        });

        // Initialize visibility
        cycleDaysField.style.display = scheduleType.value === 'monthly' ? 'block' : 'none';
    }
});

// Toast notification helper
function showToast(message, type) {
  if (window.toast) {
    window.toast(message, type);
  } else {
    alert(message);
  }
}
</script>

{% endblock %}
