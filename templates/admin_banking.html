{% extends "layout_admin.html" %}
{% set page_title = "Banking Management" %}
{% set current_page = "banking" %}
{% block title %}Banking Management{% endblock %}
{% block page_icon %}account_balance{% endblock %}
{% block content %}

<!-- Nav Tabs -->
<ul class="nav nav-tabs mb-4" id="bankingTabs" role="tablist">
  <li class="nav-item" role="presentation">
    <button class="nav-link active" id="overview-tab" data-bs-toggle="tab" data-bs-target="#overview" type="button" role="tab">
      <i class="bi bi-grid me-1"></i>Overview
    </button>
  </li>
  <li class="nav-item" role="presentation">
    <button class="nav-link" id="transactions-tab" data-bs-toggle="tab" data-bs-target="#transactions" type="button" role="tab">
      <i class="bi bi-receipt me-1"></i>Transactions
    </button>
  </li>
  <li class="nav-item" role="presentation">
    <button class="nav-link" id="settings-tab" data-bs-toggle="tab" data-bs-target="#settings" type="button" role="tab">
      <i class="bi bi-gear me-1"></i>Settings
    </button>
  </li>
</ul>

<div class="tab-content" id="bankingTabContent">
  <!-- OVERVIEW TAB -->
  <div class="tab-pane fade show active" id="overview" role="tabpanel">
    <div class="row">
      <!-- Banking Stats -->
      <div class="col-lg-6 mb-4">
        <div class="card shadow">
          <div class="card-header bg-primary text-white">
            <h5 class="mb-0"><i class="bi bi-graph-up me-2"></i>Banking Statistics</h5>
          </div>
          <div class="card-body">
            <div class="row text-center">
              <div class="col-6 mb-3">
                <h3 class="text-primary">${{ "%.2f"|format(total_checking|default(0)) }}</h3>
                <small class="text-muted">Total Checking</small>
              </div>
              <div class="col-6 mb-3">
                <h3 class="text-success">${{ "%.2f"|format(total_savings|default(0)) }}</h3>
                <small class="text-muted">Total Savings</small>
              </div>
              <div class="col-6">
                <h3 class="text-info">${{ "%.2f"|format(total_deposits|default(0)) }}</h3>
                <small class="text-muted">Total Deposits</small>
              </div>
              <div class="col-6">
                <h3 class="text-warning">{{ students_with_savings|default(0) }}/{{ total_students|default(0) }}</h3>
                <small class="text-muted">Students w/ Savings</small>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Current Settings Summary -->
      <div class="col-lg-6 mb-4">
        <div class="card shadow">
          <div class="card-header bg-success text-white">
            <h5 class="mb-0"><i class="bi bi-info-circle me-2"></i>Current Settings</h5>
          </div>
          <div class="card-body">
            {% if settings %}
              <ul class="list-unstyled mb-0">
                <li class="mb-2">
                  <strong>Savings APY:</strong> {{ "%.2f"|format(settings.savings_apy) }}%
                </li>
                <li class="mb-2">
                  <strong>Monthly Rate:</strong> {{ "%.2f"|format(settings.savings_monthly_rate) }}%
                </li>
                <li class="mb-2">
                  <strong>Interest Schedule:</strong> {{ settings.interest_schedule_type|title }}
                  {% if settings.interest_schedule_type == 'monthly' %}({{ settings.interest_schedule_cycle_days }} days){% endif %}
                </li>
                <li class="mb-2">
                  <strong>Overdraft Protection:</strong>
                  <span class="badge bg-{% if settings.overdraft_protection_enabled %}success{% else %}secondary{% endif %}">
                    {% if settings.overdraft_protection_enabled %}Enabled{% else %}Disabled{% endif %}
                  </span>
                </li>
                <li class="mb-0">
                  <strong>Overdraft Fees:</strong>
                  <span class="badge bg-{% if settings.overdraft_fee_enabled %}danger{% else %}secondary{% endif %}">
                    {% if settings.overdraft_fee_enabled %}Enabled ({{ settings.overdraft_fee_type|title }}){% else %}Disabled{% endif %}
                  </span>
                </li>
              </ul>
            {% else %}
              <p class="text-muted mb-0">No banking settings configured yet. Go to the Settings tab to configure.</p>
            {% endif %}
          </div>
        </div>
      </div>
    </div>

    <!-- Recent Activity -->
    <div class="card shadow">
      <div class="card-header">
        <h5 class="mb-0"><i class="bi bi-clock-history me-2"></i>Recent Transaction Activity</h5>
      </div>
      <div class="card-body">
        {% if transactions %}
          <div class="table-responsive">
            <table class="table table-striped table-hover">
              <thead>
                <tr>
                  <th>Date</th>
                  <th>Student</th>
                  <th>Block</th>
                  <th>Type</th>
                  <th>Account</th>
                  <th>Amount</th>
                  <th>Description</th>
                </tr>
              </thead>
              <tbody>
                {% for tx in transactions[:10] %}
                <tr>
                  <td>
                    {% if tx.timestamp %}
                      <span class="local-timestamp" data-timestamp="{{ format_utc_iso(tx.timestamp) }}"></span>
                    {% else %}
                      N/A
                    {% endif %}
                  </td>
                  <td>
                    <a href="{{ url_for('admin.student_detail', student_id=tx.student_id) }}">
                      {{ tx.student_name }}
                    </a>
                  </td>
                  <td>{{ tx.student_block }}</td>
                  <td>
                    {% if tx.type %}
                      <span class="badge bg-secondary">{{ tx.type|title }}</span>
                    {% endif %}
                  </td>
                  <td>
                    <span class="badge bg-{% if tx.account_type == 'checking' %}primary{% else %}success{% endif %}">
                      {{ tx.account_type|title }}
                    </span>
                  </td>
                  <td class="{% if tx.amount > 0 %}text-success{% else %}text-danger{% endif %} fw-bold">
                    ${{ "%.2f"|format(tx.amount) }}
                  </td>
                  <td>{{ tx.description or '—' }}</td>
                </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
          <div class="text-center mt-3">
            <button class="btn btn-outline-primary" onclick="document.getElementById('transactions-tab').click()">
              View All Transactions
            </button>
          </div>
        {% else %}
          <p class="text-muted">No recent transactions found.</p>
        {% endif %}
      </div>
    </div>
  </div>

  <!-- TRANSACTIONS TAB -->
  <div class="tab-pane fade" id="transactions" role="tabpanel">
    <div class="card shadow">
      <div class="card-header">
        <h5 class="mb-0"><i class="bi bi-receipt me-2"></i>All Banking Transactions</h5>
      </div>
      <div class="card-body">
        <!-- Filter Controls -->
        <form method="GET" action="{{ url_for('admin.banking') }}" class="mb-4">
          <div class="row g-3">
            <div class="col-md-2">
              <label for="block" class="form-label fw-bold">Block:</label>
              <select name="block" id="block" class="form-select form-select-sm">
                <option value="">All</option>
                {% for block in blocks %}
                  <option value="{{ block }}" {% if request.args.get('block') == block %}selected{% endif %}>{{ block }}</option>
                {% endfor %}
              </select>
            </div>
            <div class="col-md-2">
              <label for="account" class="form-label fw-bold">Account:</label>
              <select name="account" id="account" class="form-select form-select-sm">
                <option value="">All</option>
                <option value="checking" {% if request.args.get('account') == 'checking' %}selected{% endif %}>Checking</option>
                <option value="savings" {% if request.args.get('account') == 'savings' %}selected{% endif %}>Savings</option>
              </select>
            </div>
            <div class="col-md-2">
              <label for="type" class="form-label fw-bold">Type:</label>
              <select name="type" id="type" class="form-select form-select-sm">
                <option value="">All</option>
                {% for tx_type in transaction_types %}
                  <option value="{{ tx_type }}" {% if request.args.get('type') == tx_type %}selected{% endif %}>{{ tx_type|title }}</option>
                {% endfor %}
              </select>
            </div>
            <div class="col-md-2">
              <label for="start_date" class="form-label fw-bold">From:</label>
              <input type="date" name="start_date" id="start_date" class="form-control form-control-sm" value="{{ request.args.get('start_date', '') }}">
            </div>
            <div class="col-md-2">
              <label for="end_date" class="form-label fw-bold">To:</label>
              <input type="date" name="end_date" id="end_date" class="form-control form-control-sm" value="{{ request.args.get('end_date', '') }}">
            </div>
            <div class="col-md-2">
              <label for="student" class="form-label fw-bold">Student:</label>
              <input type="text" name="student" id="student" class="form-control form-control-sm" placeholder="Name..." value="{{ request.args.get('student', '') }}">
            </div>
          </div>
          <div class="row mt-3">
            <div class="col-12">
              <button type="submit" class="btn btn-primary btn-sm me-2">
                <i class="bi bi-funnel me-1"></i>Apply Filters
              </button>
              <a href="{{ url_for('admin.banking') }}" class="btn btn-outline-secondary btn-sm">
                <i class="bi bi-x-circle me-1"></i>Clear Filters
              </a>
              <span class="ms-3 text-muted">
                Showing {{ transactions|length }} of {{ total_transactions|default(0) }} transactions
              </span>
            </div>
          </div>
        </form>

        <!-- Transactions Table -->
        <div class="table-responsive">
          <table class="table table-striped table-hover table-sm">
            <thead>
              <tr>
                <th width="130">Date</th>
                <th>Student</th>
                <th width="80">Block</th>
                <th width="100">Type</th>
                <th width="100">Account</th>
                <th width="100" class="text-end">Amount</th>
                <th>Description</th>
                <th width="80">Actions</th>
              </tr>
            </thead>
            <tbody>
              {% if transactions %}
                {% for tx in transactions %}
                <tr class="{% if tx.is_void %}table-secondary text-muted{% endif %}">
                  <td>
                    {% if tx.timestamp %}
                      <span class="local-timestamp" data-timestamp="{{ format_utc_iso(tx.timestamp) }}"></span>
                    {% else %}
                      N/A
                    {% endif %}
                  </td>
                  <td>
                    <a href="{{ url_for('admin.student_detail', student_id=tx.student_id) }}">
                      {{ tx.student_name }}
                    </a>
                  </td>
                  <td>{{ tx.student_block }}</td>
                  <td>
                    {% if tx.type %}
                      <span class="badge bg-secondary">{{ tx.type|title }}</span>
                    {% endif %}
                  </td>
                  <td>
                    <span class="badge bg-{% if tx.account_type == 'checking' %}primary{% else %}success{% endif %}">
                      {{ tx.account_type|title }}
                    </span>
                  </td>
                  <td class="{% if tx.amount > 0 %}text-success{% else %}text-danger{% endif %} fw-bold text-end">
                    ${{ "%.2f"|format(tx.amount) }}
                    {% if tx.is_void %}
                      <span class="badge bg-secondary ms-1">VOID</span>
                    {% endif %}
                  </td>
                  <td>{{ tx.description or '—' }}</td>
                  <td>
                    {% if not tx.is_void %}
                      <button class="btn btn-sm btn-outline-danger" onclick="voidTransaction({{ tx.id }})" title="Void transaction">
                        <i class="bi bi-x-circle"></i>
                      </button>
                    {% else %}
                      <span class="text-muted small">Voided</span>
                    {% endif %}
                  </td>
                </tr>
                {% endfor %}
              {% else %}
                <tr><td colspan="8" class="text-center text-muted">No transactions found.</td></tr>
              {% endif %}
            </tbody>
          </table>
        </div>

        <!-- Pagination -->
        {% if total_pages > 1 %}
        <nav aria-label="Transaction pagination">
          <ul class="pagination pagination-sm justify-content-center mt-3">
            <!-- Previous Button -->
            <li class="page-item {% if page <= 1 %}disabled{% endif %}">
              <a class="page-link" href="{{ url_for('admin.banking', page=page-1, student=request.args.get('student', ''), block=request.args.get('block', ''), account=request.args.get('account', ''), type=request.args.get('type', ''), start_date=request.args.get('start_date', ''), end_date=request.args.get('end_date', '')) }}">Previous</a>
            </li>

            <!-- Page Numbers -->
            {% set start_page = [1, page - 2]|max %}
            {% set end_page = [total_pages, page + 2]|min %}

            {% if start_page > 1 %}
              <li class="page-item">
                <a class="page-link" href="{{ url_for('admin.banking', page=1, student=request.args.get('student', ''), block=request.args.get('block', ''), account=request.args.get('account', ''), type=request.args.get('type', ''), start_date=request.args.get('start_date', ''), end_date=request.args.get('end_date', '')) }}">1</a>
              </li>
              {% if start_page > 2 %}
                <li class="page-item disabled"><span class="page-link">...</span></li>
              {% endif %}
            {% endif %}

            {% for p in range(start_page, end_page + 1) %}
              <li class="page-item {% if p == page %}active{% endif %}">
                <a class="page-link" href="{{ url_for('admin.banking', page=p, student=request.args.get('student', ''), block=request.args.get('block', ''), account=request.args.get('account', ''), type=request.args.get('type', ''), start_date=request.args.get('start_date', ''), end_date=request.args.get('end_date', '')) }}">{{ p }}</a>
              </li>
            {% endfor %}

            {% if end_page < total_pages %}
              {% if end_page < total_pages - 1 %}
                <li class="page-item disabled"><span class="page-link">...</span></li>
              {% endif %}
              <li class="page-item">
                <a class="page-link" href="{{ url_for('admin.banking', page=total_pages, student=request.args.get('student', ''), block=request.args.get('block', ''), account=request.args.get('account', ''), type=request.args.get('type', ''), start_date=request.args.get('start_date', ''), end_date=request.args.get('end_date', '')) }}">{{ total_pages }}</a>
              </li>
            {% endif %}

            <!-- Next Button -->
            <li class="page-item {% if page >= total_pages %}disabled{% endif %}">
              <a class="page-link" href="{{ url_for('admin.banking', page=page+1, student=request.args.get('student', ''), block=request.args.get('block', ''), account=request.args.get('account', ''), type=request.args.get('type', ''), start_date=request.args.get('start_date', ''), end_date=request.args.get('end_date', '')) }}">Next</a>
            </li>
          </ul>
        </nav>
        {% endif %}
      </div>
    </div>
  </div>

  <!-- SETTINGS TAB -->
  <div class="tab-pane fade" id="settings" role="tabpanel">
    <form method="POST" action="{{ url_for('admin.banking_settings_update') }}" id="bankingSettingsForm">
      {{ form.hidden_tag() }}

      <div class="row">
        <!-- Interest Settings Card -->
        <div class="col-lg-6 mb-4">
          <div class="card shadow h-100">
            <div class="card-header bg-primary text-white">
              <h5 class="mb-0"><i class="bi bi-percent me-2"></i>Interest Settings</h5>
            </div>
            <div class="card-body">
              <!-- Rate Input Mode Toggle -->
              <div class="mb-4">
                <label class="form-label fw-bold">Choose how you want to set the interest rate:</label>
                <div class="btn-group w-100" role="group" aria-label="Interest rate input mode">
                  <input type="radio" class="btn-check" name="rate_input_mode" id="mode_apy" value="apy" {% if not settings or settings.savings_apy >= settings.savings_monthly_rate or form.rate_input_mode.data == 'apy' %}checked{% endif %}>
                  <label class="btn btn-outline-primary" for="mode_apy">
                    <i class="bi bi-calendar-year me-1"></i>Annual Rate (APY)
                  </label>

                  <input type="radio" class="btn-check" name="rate_input_mode" id="mode_monthly" value="monthly" {% if settings and settings.savings_monthly_rate > settings.savings_apy and form.rate_input_mode.data != 'apy' %}checked{% endif %}>
                  <label class="btn btn-outline-primary" for="mode_monthly">
                    <i class="bi bi-calendar-month me-1"></i>Monthly Rate
                  </label>
                </div>
              </div>

              <!-- APY Input (shown when mode is APY) -->
              <div class="mb-3" id="apyInputSection">
                <label for="savings_apy" class="form-label fw-bold">Annual Percentage Yield (APY %)</label>
                <div class="input-group">
                  <input type="number" step="0.01" class="form-control" name="savings_apy" id="savings_apy" placeholder="5.0" value="{{ form.savings_apy.data or 0 }}">
                  <span class="input-group-text">%</span>
                </div>
                <small class="text-muted">Annual Percentage Yield for savings accounts</small>
                <div id="apyToMonthlyHint" class="mt-2 p-2 bg-light border rounded" style="display: none;">
                  <small class="text-info">
                    <i class="bi bi-arrow-right-circle me-1"></i>
                    <strong>Calculated Monthly Rate:</strong> <span id="calculatedMonthlyFromAPY">0.00</span>%
                  </small>
                </div>
              </div>

              <!-- Monthly Rate Input (shown when mode is Monthly) -->
              <div class="mb-3" id="monthlyInputSection" style="display: none;">
                <label for="savings_monthly_rate" class="form-label fw-bold">Monthly Interest Rate (%)</label>
                <div class="input-group">
                  <input type="number" step="0.0001" class="form-control" name="savings_monthly_rate" id="savings_monthly_rate" placeholder="0.42" value="{{ form.savings_monthly_rate.data or 0 }}">
                  <span class="input-group-text">%</span>
                </div>
                <small class="text-muted">Monthly interest rate</small>
                <div id="monthlyToAPYHint" class="mt-2 p-2 bg-light border rounded" style="display: none;">
                  <small class="text-info">
                    <i class="bi bi-arrow-right-circle me-1"></i>
                    <strong>Calculated APY:</strong> <span id="calculatedAPYFromMonthly">0.00</span>%
                  </small>
                </div>
              </div>

              <!-- Interest Preview -->
              <div class="alert alert-info" id="interestPreview">
                <h6 class="mb-2"><i class="bi bi-calculator me-1"></i>Interest Preview</h6>
                <div id="previewContent">
                  <small class="text-muted">Enter an interest rate to see estimated payouts</small>
                </div>
              </div>

              <hr>

              <h6 class="fw-bold mb-3">Interest Calculation Method</h6>

              <div class="mb-3">
                {{ form.interest_calculation_type.label(class="form-label fw-bold") }}
                {{ form.interest_calculation_type(class="form-select") }}
                <small class="text-muted">
                  <strong>Simple:</strong> Interest calculated on principal only.<br>
                  <strong>Compound:</strong> Interest calculated on principal + previously earned interest.
                </small>
              </div>

              <div class="mb-3" id="compoundFrequencyField">
                {{ form.compound_frequency.label(class="form-label fw-bold") }}
                {{ form.compound_frequency(class="form-select") }}
                <small class="text-muted">How often interest compounds (only applies to compound interest)</small>
              </div>

              <hr>

              <h6 class="fw-bold mb-3">Interest Payout Schedule</h6>

              <div class="mb-3">
                {{ form.interest_schedule_type.label(class="form-label fw-bold") }}
                {{ form.interest_schedule_type(class="form-select") }}
              </div>

              <div class="mb-3" id="cycleDaysField">
                {{ form.interest_schedule_cycle_days.label(class="form-label fw-bold") }}
                {{ form.interest_schedule_cycle_days(class="form-control", placeholder="30") }}
                <small class="text-muted">Number of days in each cycle (for monthly schedule)</small>
              </div>

              <div class="mb-0">
                {{ form.interest_payout_start_date.label(class="form-label fw-bold") }}
                {{ form.interest_payout_start_date(class="form-control") }}
                <small class="text-muted">Date when interest payouts begin</small>
              </div>
            </div>
          </div>
        </div>

        <!-- Overdraft Settings Card -->
        <div class="col-lg-6 mb-4">
          <div class="card shadow h-100">
            <div class="card-header bg-warning text-dark">
              <h5 class="mb-0"><i class="bi bi-shield-exclamation me-2"></i>Overdraft Settings</h5>
            </div>
            <div class="card-body">
              <div class="mb-4">
                <div class="form-check form-switch">
                  {{ form.overdraft_protection_enabled(class="form-check-input", role="switch") }}
                  {{ form.overdraft_protection_enabled.label(class="form-check-label fw-bold") }}
                </div>
                <small class="text-muted">If enabled, negative checking balances will be covered by savings</small>
              </div>

              <hr>

              <h6 class="fw-bold mb-3">Overdraft/NSF Fees</h6>

              <div class="mb-3">
                <div class="form-check form-switch">
                  {{ form.overdraft_fee_enabled(class="form-check-input", role="switch", id="overdraftFeeToggle") }}
                  {{ form.overdraft_fee_enabled.label(class="form-check-label fw-bold") }}
                </div>
              </div>

              <div id="feeSettings" style="{% if not settings or not settings.overdraft_fee_enabled %}display:none;{% endif %}">
                <div class="mb-3">
                  {{ form.overdraft_fee_type.label(class="form-label fw-bold") }}
                  {{ form.overdraft_fee_type(class="form-select", id="feeTypeSelect") }}
                </div>

                <!-- Flat Fee Settings -->
                <div id="flatFeeSettings" style="{% if settings and settings.overdraft_fee_type == 'progressive' %}display:none;{% endif %}">
                  <div class="mb-3">
                    {{ form.overdraft_fee_flat_amount.label(class="form-label fw-bold") }}
                    <div class="input-group">
                      <span class="input-group-text">$</span>
                      {{ form.overdraft_fee_flat_amount(class="form-control", placeholder="35.00") }}
                    </div>
                    <small class="text-muted">Fixed fee charged per overdraft transaction</small>
                  </div>
                </div>

                <!-- Progressive Fee Settings -->
                <div id="progressiveFeeSettings" style="{% if not settings or settings.overdraft_fee_type != 'progressive' %}display:none;{% endif %}">
                  <div class="mb-3">
                    {{ form.overdraft_fee_progressive_1.label(class="form-label fw-bold") }}
                    <div class="input-group">
                      <span class="input-group-text">$</span>
                      {{ form.overdraft_fee_progressive_1(class="form-control", placeholder="25.00") }}
                    </div>
                  </div>

                  <div class="mb-3">
                    {{ form.overdraft_fee_progressive_2.label(class="form-label fw-bold") }}
                    <div class="input-group">
                      <span class="input-group-text">$</span>
                      {{ form.overdraft_fee_progressive_2(class="form-control", placeholder="35.00") }}
                    </div>
                  </div>

                  <div class="mb-3">
                    {{ form.overdraft_fee_progressive_3.label(class="form-label fw-bold") }}
                    <div class="input-group">
                      <span class="input-group-text">$</span>
                      {{ form.overdraft_fee_progressive_3(class="form-control", placeholder="45.00") }}
                    </div>
                  </div>

                  <div class="mb-3">
                    {{ form.overdraft_fee_progressive_cap.label(class="form-label fw-bold") }}
                    <div class="input-group">
                      <span class="input-group-text">$</span>
                      {{ form.overdraft_fee_progressive_cap(class="form-control", placeholder="100.00") }}
                    </div>
                    <small class="text-muted">Optional maximum total fees per period</small>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Save Button -->
      <div class="text-center mb-4">
        {{ form.submit(class="btn btn-primary btn-lg px-5") }}
      </div>
    </form>
  </div>
</div>

<!-- JavaScript -->
<script>
// Timestamp conversion handled by timezone-utils.js
document.addEventListener("DOMContentLoaded", () => {

    // -------------------- INTEREST RATE CALCULATIONS --------------------
    const avgSavingsBalance = {{ average_savings_balance|default(0) }};
    const totalSavings = {{ total_savings|default(0) }};

    // Toggle between APY and Monthly input modes
    const modeAPY = document.getElementById('mode_apy');
    const modeMonthly = document.getElementById('mode_monthly');
    const apyInputSection = document.getElementById('apyInputSection');
    const monthlyInputSection = document.getElementById('monthlyInputSection');
    const apyInput = document.getElementById('savings_apy');
    const monthlyInput = document.getElementById('savings_monthly_rate');

    function toggleInputMode() {
        if (modeAPY.checked) {
            apyInputSection.style.display = 'block';
            monthlyInputSection.style.display = 'none';
            // Disable monthly input to prevent validation errors on hidden field
            monthlyInput.disabled = true;
            apyInput.disabled = false;
        } else {
            apyInputSection.style.display = 'none';
            monthlyInputSection.style.display = 'block';
            // Disable APY input to prevent validation errors on hidden field
            apyInput.disabled = true;
            monthlyInput.disabled = false;
        }
        updateInterestPreview();
    }

    // APY to Monthly Rate: monthly = (1 + APY/100)^(1/12) - 1
    function apyToMonthly(apy) {
        if (!apy || apy <= 0) return 0;
        const monthly = (Math.pow(1 + apy / 100, 1 / 12) - 1) * 100;
        return monthly;
    }

    // Monthly Rate to APY: APY = (1 + monthly/100)^12 - 1
    function monthlyToAPY(monthly) {
        if (!monthly || monthly <= 0) return 0;
        const apy = (Math.pow(1 + monthly / 100, 12) - 1) * 100;
        return apy;
    }

    // Update calculations when APY changes
    apyInput.addEventListener('input', function() {
        const apy = parseFloat(this.value) || 0;
        const monthly = apyToMonthly(apy);

        document.getElementById('calculatedMonthlyFromAPY').textContent = monthly.toFixed(4);
        document.getElementById('apyToMonthlyHint').style.display = apy > 0 ? 'block' : 'none';

        // Update the monthly rate field with calculated value
        monthlyInput.value = monthly.toFixed(6);

        updateInterestPreview();
    });

    // Update calculations when Monthly Rate changes
    monthlyInput.addEventListener('input', function() {
        const monthly = parseFloat(this.value) || 0;
        const apy = monthlyToAPY(monthly);

        document.getElementById('calculatedAPYFromMonthly').textContent = apy.toFixed(4);
        document.getElementById('monthlyToAPYHint').style.display = monthly > 0 ? 'block' : 'none';

        // Update the APY field with calculated value
        apyInput.value = apy.toFixed(6);

        updateInterestPreview();
    });

    // Update interest preview
    function updateInterestPreview() {
        const previewContent = document.getElementById('previewContent');
        let monthlyRate = 0;
        let apyRate = 0;

        if (modeAPY.checked) {
            apyRate = parseFloat(apyInput.value) || 0;
            monthlyRate = apyToMonthly(apyRate);
        } else {
            monthlyRate = parseFloat(monthlyInput.value) || 0;
            apyRate = monthlyToAPY(monthlyRate);
        }

        if (monthlyRate <= 0 || avgSavingsBalance <= 0) {
            previewContent.innerHTML = '<small class="text-muted">Enter an interest rate to see estimated payouts</small>';
            return;
        }

        const monthlyInterestPerStudent = avgSavingsBalance * (monthlyRate / 100);
        const weeklyInterestPerStudent = monthlyInterestPerStudent / 4.33; // Approximate weeks per month
        const totalMonthlyInterest = totalSavings * (monthlyRate / 100);

        previewContent.innerHTML = `
            <div class="row text-center">
                <div class="col-6">
                    <strong>Average Student</strong><br>
                    <span class="text-success">$${avgSavingsBalance.toFixed(2)}</span> balance<br>
                    <small class="text-muted">
                        Weekly: <strong class="text-primary">$${weeklyInterestPerStudent.toFixed(2)}</strong><br>
                        Monthly: <strong class="text-primary">$${monthlyInterestPerStudent.toFixed(2)}</strong>
                    </small>
                </div>
                <div class="col-6">
                    <strong>Entire Class</strong><br>
                    <span class="text-success">$${totalSavings.toFixed(2)}</span> total<br>
                    <small class="text-muted">
                        Monthly payout: <strong class="text-primary">$${totalMonthlyInterest.toFixed(2)}</strong>
                    </small>
                </div>
            </div>
        `;
    }

    // Mode toggle listeners
    modeAPY.addEventListener('change', toggleInputMode);
    modeMonthly.addEventListener('change', toggleInputMode);

    // Initialize
    toggleInputMode();

    // If there are existing values, trigger calculation
    if (parseFloat(apyInput.value) > 0) {
        apyInput.dispatchEvent(new Event('input'));
    } else if (parseFloat(monthlyInput.value) > 0) {
        monthlyInput.dispatchEvent(new Event('input'));
    }

    // Re-enable all fields before form submission to ensure values are sent
    const bankingForm = document.getElementById('bankingSettingsForm');
    if (bankingForm) {
        bankingForm.addEventListener('submit', function(e) {
            // Temporarily enable both fields so their values are submitted
            apyInput.disabled = false;
            monthlyInput.disabled = false;
        });
    }

    // Overdraft Fee Toggle
    const overdraftFeeToggle = document.getElementById('overdraftFeeToggle');
    const feeSettings = document.getElementById('feeSettings');

    if (overdraftFeeToggle) {
        overdraftFeeToggle.addEventListener('change', function() {
            feeSettings.style.display = this.checked ? 'block' : 'none';
        });
    }

    // Fee Type Toggle
    const feeTypeSelect = document.getElementById('feeTypeSelect');
    const flatFeeSettings = document.getElementById('flatFeeSettings');
    const progressiveFeeSettings = document.getElementById('progressiveFeeSettings');

    if (feeTypeSelect) {
        feeTypeSelect.addEventListener('change', function() {
            if (this.value === 'flat') {
                flatFeeSettings.style.display = 'block';
                progressiveFeeSettings.style.display = 'none';
            } else {
                flatFeeSettings.style.display = 'none';
                progressiveFeeSettings.style.display = 'block';
            }
        });
    }

    // Interest Schedule Type Toggle
    const scheduleType = document.getElementById('interest_schedule_type');
    const cycleDaysField = document.getElementById('cycleDaysField');

    if (scheduleType) {
        scheduleType.addEventListener('change', function() {
            cycleDaysField.style.display = this.value === 'monthly' ? 'block' : 'none';
        });

        // Initialize visibility
        cycleDaysField.style.display = scheduleType.value === 'monthly' ? 'block' : 'none';
    }

    // Interest Calculation Type Toggle
    const calculationType = document.getElementById('interest_calculation_type');
    const compoundFrequencyField = document.getElementById('compoundFrequencyField');

    if (calculationType) {
        calculationType.addEventListener('change', function() {
            compoundFrequencyField.style.display = this.value === 'compound' ? 'block' : 'none';
        });

        // Initialize visibility
        compoundFrequencyField.style.display = calculationType.value === 'compound' ? 'block' : 'none';
    }
});

// Void Transaction
async function voidTransaction(transactionId) {
  if (!confirm('Are you sure you want to void this transaction? This cannot be undone.')) return;

  const csrfToken = document.querySelector('meta[name="csrf-token"]').getAttribute('content');

  try {
    const resp = await fetch(`/admin/void-transaction/${transactionId}`, {
      method: 'POST',
      headers: {
        'X-CSRFToken': csrfToken,
        'Content-Type': 'application/json',
        'X-Requested-With': 'XMLHttpRequest'
      }
    });

    const data = await resp.json();
    if (data.status === 'success') {
      showToast('Transaction voided successfully', 'success');
      setTimeout(() => location.reload(), 1000);
    } else {
      showToast(data.message || 'Failed to void transaction', 'error');
    }
  } catch (err) {
    showToast('Error voiding transaction', 'error');
  }
}

// Toast notification helper
function showToast(message, type) {
  if (window.toast) {
    window.toast(message, type);
  } else {
    alert(message);
  }
}
</script>

{% endblock %}
