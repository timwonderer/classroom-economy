<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Student Login - Classroom Token Hub</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="theme-color" content="#1a4d47">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <link rel="manifest" href="{{ static_url('manifest.json') }}">
    <link rel="apple-touch-icon" href="{{ static_url('images/icon-192.png') }}">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://challenges.cloudflare.com/turnstile/v0/api.js" async defer></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@20..48,100..700,0..1,-50..200" rel="stylesheet">
    <link href="{{ static_url('css/style.css') }}" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register("/sw.js")
                    .then(registration => {
                        console.log('ServiceWorker registration successful with scope: ', registration.scope);
                    })
                    .catch(err => {
                        console.log('ServiceWorker registration failed: ', err);
                    });
            });
        }
    </script>
    <style>
        body {
            background-color: var(--background);
            display: flex;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            padding: 1rem;
            overflow-x: hidden;
        }
        .login-card {
            background: var(--surface);
            border-radius: 24px;
            box-shadow: var(--shadow-lg);
            width: 100%;
            max-width: 440px;
            padding: 2.5rem;
            position: relative;
            overflow: hidden;
            border: 1px solid var(--border-color);
        }
        .login-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 6px;
            background: linear-gradient(90deg, var(--primary), var(--secondary));
        }
        .pin-input {
            letter-spacing: 0.5em;
            font-family: monospace;
            text-align: center;
            font-size: 1.5rem;
            font-weight: 600;
        }
    </style>
</head>
<body class="student-theme">
    <div class="login-card">
        <div class="text-center mb-4">
            <img src="{{ static_url('images/student-logo-192.png') }}" alt="Student Logo" width="80" height="80" class="mb-3">
            <h1 class="h3 fw-bold mb-1 text-primary">Student Login</h1>
            <p class="text-secondary small">Access your classroom bank account</p>
        </div>

        {% with messages = get_flashed_messages() %}
            {% if messages %}
                {% for message in messages %}
                <div class="alert alert-warning border-0 shadow-sm d-flex align-items-center mb-4" role="alert">
                    <span class="material-symbols-outlined fs-5 me-2">warning</span>
                    <div>{{ message }}</div>
                </div>
                {% endfor %}
            {% endif %}
        {% endwith %}

        <form method="POST">
            {{ form.hidden_tag() }}

            <div class="mb-3">
                <label class="form-label small fw-bold text-secondary text-uppercase">Username</label>
                {{ form.username(class="form-control form-control-lg", placeholder="Enter your username", autocomplete="username") }}
            </div>

            <div class="mb-4">
                <label class="form-label small fw-bold text-secondary text-uppercase">Secret PIN</label>
                {{ form.pin(class="form-control form-control-lg pin-input", placeholder="••••", inputmode="numeric", pattern="[0-9]*", autocomplete="current-password") }}
            </div>

            {% if turnstile_site_key %}
            <div class="mb-4 d-flex justify-content-center">
                <div class="cf-turnstile" data-sitekey="{{ turnstile_site_key }}" data-theme="light"></div>
            </div>
            {% endif %}

            {{ form.submit(class="btn btn-primary w-100 btn-lg mb-4") }}
        </form>

        <div class="text-center pt-3 border-top">
            <p class="mb-2 text-muted small">New student?</p>
            <a href="{{ url_for('student.claim_account') }}" class="btn btn-outline-primary btn-sm rounded-pill px-4 mb-3">Claim Account</a>

            <div class="d-flex gap-3 justify-content-center mb-3">
                <a href="{{ url_for('admin.login') }}" class="text-decoration-none small text-secondary">
                    Teacher Login
                </a>
                <span class="text-secondary">•</span>
                <a href="{{ url_for('admin.signup') }}" class="text-decoration-none small text-secondary">
                    Set up teacher account
                </a>
            </div>

            <div class="d-flex gap-3 justify-content-center">
                <a href="{{ url_for('main.privacy') }}" class="text-decoration-none small text-secondary">Privacy</a>
                <span class="text-secondary">•</span>
                <a href="{{ url_for('main.terms') }}" class="text-decoration-none small text-secondary">Terms</a>
            </div>
        </div>
    </div>

    <!-- Loading Tips Modal -->
    <div class="modal fade" id="loadingTipsModal" data-bs-backdrop="static" data-bs-keyboard="false" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content border-0 shadow-lg">
                <div class="modal-body text-center p-5">
                    <div class="spinner-border text-primary mb-4" role="status" style="width: 3rem; height: 3rem;">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                    <h5 class="fw-bold mb-3 text-primary">Did you know?</h5>
                    <p class="text-secondary mb-0" id="tipText" style="min-height: 3rem; line-height: 1.6;">
                        Loading your account...
                    </p>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Collection of helpful tips
        const tips = [
            "You don't have to stay logged in after starting work. You'll continue to earn minutes even when you're away from the page.",
            "Check your balance regularly to track your earnings and plan your spending wisely.",
            "Your teacher can award bonus tokens for exceptional work or good behavior.",
            "Remember to log your attendance every day to earn your payroll minutes.",
            "The shop refreshes with new items regularly - check back often for deals!",
            "Save up for big purchases by setting financial goals for yourself.",
            "Hall passes deduct from your balance - plan your breaks wisely.",
            "Insurance can protect your balance from unexpected classroom events.",
            "Ask your teacher about bonus opportunities to earn extra tokens.",
            "Keep track of your transaction history to understand your spending habits."
        ];

        const MINIMUM_DISPLAY_TIME = 2500; // Minimum 2.5 seconds to read the tip
        let currentTipIndex = 0;
        let tipRotationInterval;
        let loadingModal;
        let formSubmitted = false;

        // Initialize modal
        document.addEventListener('DOMContentLoaded', function() {
            const modalElement = document.getElementById('loadingTipsModal');
            loadingModal = new bootstrap.Modal(modalElement);

            // Intercept form submission
            const loginForm = document.querySelector('form');
            loginForm.addEventListener('submit', function(e) {
                // Prevent duplicate submissions
                if (formSubmitted) {
                    e.preventDefault();
                    return;
                }

                // Prevent default submission
                e.preventDefault();
                formSubmitted = true;

                // Show loading modal with tips
                const startTime = Date.now();
                showLoadingModal();

                // Wait for minimum display time, then submit
                setTimeout(function() {
                    loginForm.submit();
                }, MINIMUM_DISPLAY_TIME);
            });
        });

        function showLoadingModal() {
            // Show first tip
            currentTipIndex = Math.floor(Math.random() * tips.length);
            document.getElementById('tipText').textContent = tips[currentTipIndex];

            // Show modal
            loadingModal.show();

            // Rotate tips every 4 seconds
            tipRotationInterval = setInterval(function() {
                currentTipIndex = (currentTipIndex + 1) % tips.length;
                document.getElementById('tipText').textContent = tips[currentTipIndex];
            }, 4000);
        }

        // Clean up interval if page unloads
        window.addEventListener('beforeunload', function() {
            if (tipRotationInterval) {
                clearInterval(tipRotationInterval);
            }
        });
    </script>
</body>
</html>
