{% extends "layout_admin.html" %}
{% set page_title = "Hall Pass Management" %}
{% block title %}Hall Pass Management{% endblock %}

{% block page_icon %}confirmation_number{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="d-flex justify-content-end align-items-center mb-4">
        <div>
            <a href="/hall-pass/verification" target="_blank" class="btn btn-primary me-2">
                <span class="material-symbols-outlined">tv</span> Verification Display
            </a>
            <a href="/hall-pass/terminal" target="_blank" class="btn btn-secondary me-2">
                <span class="material-symbols-outlined">computer</span> Terminal
            </a>
            <a href="/hall-pass/queue" target="_blank" class="btn btn-info">
                <span class="material-symbols-outlined">list_alt</span> Queue Display
            </a>
        </div>
    </div>

    <!-- Compact Queue Settings Card -->
    <div class="card shadow mb-4">
        <div class="card-body py-3">
            <div class="row align-items-center g-3">
                <div class="col-auto">
                    <span class="material-symbols-outlined text-primary" style="font-size: 1.5rem;">settings</span>
                </div>
                <div class="col-md-5">
                    <div class="d-flex align-items-center">
                        <div class="form-check form-switch mb-0">
                            <input class="form-check-input" type="checkbox" id="queueEnabledSwitch" style="cursor: pointer; width: 2.5em; height: 1.25em;">
                            <label class="form-check-label ms-2 mb-0" for="queueEnabledSwitch" style="cursor: pointer;">
                                <strong id="queueStatusLabel">Queue System</strong>
                            </label>
                        </div>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="d-flex align-items-center">
                        <label for="queueLimitInput" class="form-label mb-0 me-2 fw-bold" style="white-space: nowrap;">Limit:</label>
                        <input type="number" class="form-control form-control-sm" id="queueLimitInput" min="1" max="50" value="10" style="width: 70px;">
                        <span class="ms-2 text-muted small">students</span>
                    </div>
                </div>
                <div class="col-auto ms-auto">
                    <span id="settingsSavedIndicator" class="badge bg-success" style="display: none;">Saved!</span>
                </div>
            </div>
        </div>
    </div>

    <!-- Tabbed Hall Pass Management -->
    <div class="card shadow">
        <div class="card-header bg-white pt-3 pb-0 border-bottom-0">
            <ul class="nav nav-tabs card-header-tabs" id="hallPassTabs" role="tablist">
                <li class="nav-item" role="presentation">
                    <button class="nav-link active d-flex align-items-center" id="pending-tab" data-bs-toggle="tab" data-bs-target="#pending" type="button" role="tab" aria-controls="pending" aria-selected="true">
                        <span class="material-symbols-outlined me-2" style="font-size: 1.25rem;">schedule</span>
                        <span class="fw-bold">Pending</span>
                        {% if pending_requests %}
                            <span class="badge bg-warning text-dark ms-2">{{ pending_requests|length }}</span>
                        {% endif %}
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link d-flex align-items-center" id="approved-tab" data-bs-toggle="tab" data-bs-target="#approved" type="button" role="tab" aria-controls="approved" aria-selected="false">
                        <span class="material-symbols-outlined me-2" style="font-size: 1.25rem;">check_circle</span>
                        <span class="fw-bold">Approved</span>
                        {% if approved_queue %}
                            <span class="badge bg-info ms-2">{{ approved_queue|length }}</span>
                        {% endif %}
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link d-flex align-items-center" id="out-tab" data-bs-toggle="tab" data-bs-target="#out" type="button" role="tab" aria-controls="out" aria-selected="false">
                        <span class="material-symbols-outlined me-2" style="font-size: 1.25rem;">logout</span>
                        <span class="fw-bold">Out</span>
                        {% if out_of_class %}
                            <span class="badge bg-success ms-2">{{ out_of_class|length }}</span>
                        {% endif %}
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link d-flex align-items-center" id="history-tab" data-bs-toggle="tab" data-bs-target="#history" type="button" role="tab" aria-controls="history" aria-selected="false">
                        <span class="material-symbols-outlined me-2" style="font-size: 1.25rem;">history</span>
                        <span class="fw-bold">History</span>
                    </button>
                </li>
            </ul>
        </div>
        <div class="card-body">
            <div class="tab-content" id="hallPassTabsContent">
                <!-- Pending Requests Tab -->
                <div class="tab-pane fade show active" id="pending" role="tabpanel" aria-labelledby="pending-tab">
                    {% if pending_requests %}
                        <div class="list-group">
                            {% for req in pending_requests %}
                                <div class="list-group-item d-flex justify-content-between align-items-center">
                                    <div>
                                        <strong>{{ req.student.full_name }}</strong> - {{ req.reason }}
                                        <small class="d-block text-muted">Requested: {{ req.request_time | format_datetime }} | Period: {{ req.period }}</small>
                                    </div>
                                    <div class="btn-group" role="group">
                                        <button class="btn btn-sm btn-success" onclick="handlePassAction({{ req.id }}, 'approve')">
                                            <span class="material-symbols-outlined" style="font-size: 1rem;">check</span> Approve
                                        </button>
                                        <button class="btn btn-sm btn-danger" onclick="handlePassAction({{ req.id }}, 'reject')">
                                            <span class="material-symbols-outlined" style="font-size: 1rem;">close</span> Reject
                                        </button>
                                    </div>
                                </div>
                            {% endfor %}
                        </div>
                    {% else %}
                        <div class="text-center py-5 text-muted">
                            <span class="material-symbols-outlined d-block mb-2" style="font-size: 3rem; opacity: 0.3;">inbox</span>
                            <p class="mb-0">No pending requests</p>
                        </div>
                    {% endif %}
                </div>

                <!-- Approved Queue Tab -->
                <div class="tab-pane fade" id="approved" role="tabpanel" aria-labelledby="approved-tab">
                    {% if approved_queue %}
                        <div class="list-group">
                            {% for req in approved_queue %}
                                <div class="list-group-item d-flex justify-content-between align-items-center">
                                    <div>
                                        <strong>{{ req.student.full_name }}</strong> - {{ req.reason }}
                                        {% if req.pass_number %}
                                            <span class="badge bg-primary ms-2">Pass #{{ req.pass_number }}</span>
                                        {% endif %}
                                        <small class="d-block text-muted">Approved: {{ req.decision_time | format_datetime }} | Period: {{ req.period }}</small>
                                    </div>
                                    <button class="btn btn-sm btn-primary" onclick="handlePassAction({{ req.id }}, 'leave')" {% if out_of_class %}disabled{% endif %}>
                                        <span class="material-symbols-outlined" style="font-size: 1rem;">logout</span> Left Class
                                    </button>
                                </div>
                            {% endfor %}
                        </div>
                    {% else %}
                        <div class="text-center py-5 text-muted">
                            <span class="material-symbols-outlined d-block mb-2" style="font-size: 3rem; opacity: 0.3;">check_circle</span>
                            <p class="mb-0">Queue is empty</p>
                        </div>
                    {% endif %}
                </div>

                <!-- Out of Classroom Tab -->
                <div class="tab-pane fade" id="out" role="tabpanel" aria-labelledby="out-tab">
                    {% if out_of_class %}
                        <div class="list-group">
                            {% for req in out_of_class %}
                                <div class="list-group-item d-flex justify-content-between align-items-center">
                                    <div>
                                        <strong>{{ req.student.full_name }}</strong> - {{ req.reason }}
                                        {% if req.pass_number %}
                                            <span class="badge bg-success ms-2">Pass #{{ req.pass_number }}</span>
                                        {% endif %}
                                        <small class="d-block text-muted">Left: {{ req.left_time | format_datetime }} | Period: {{ req.period }}</small>
                                    </div>
                                    <button class="btn btn-sm btn-secondary" onclick="handlePassAction({{ req.id }}, 'return')">
                                        <span class="material-symbols-outlined" style="font-size: 1rem;">login</span> Returned
                                    </button>
                                </div>
                            {% endfor %}
                        </div>
                    {% else %}
                        <div class="text-center py-5 text-muted">
                            <span class="material-symbols-outlined d-block mb-2" style="font-size: 3rem; opacity: 0.3;">person_off</span>
                            <p class="mb-0">No one is currently out</p>
                        </div>
                    {% endif %}
                </div>

                <!-- History Tab -->
                <div class="tab-pane fade" id="history" role="tabpanel" aria-labelledby="history-tab">
                    <!-- Filters -->
                    <div class="row g-3 mb-4">
                        <div class="col-md-3">
                            <label for="filterPeriod" class="form-label small fw-bold">Period/Block</label>
                            <select class="form-select form-select-sm" id="filterPeriod">
                                <option value="">All Periods</option>
                                {% if available_periods %}
                                    {% for period in available_periods %}
                                        <option value="{{ period }}">{{ period }}</option>
                                    {% endfor %}
                                {% else %}
                                    <!-- Fallback to numeric periods if no data available -->
                                    <option value="1">Period 1</option>
                                    <option value="2">Period 2</option>
                                    <option value="3">Period 3</option>
                                    <option value="4">Period 4</option>
                                    <option value="5">Period 5</option>
                                    <option value="6">Period 6</option>
                                    <option value="7">Period 7</option>
                                    <option value="8">Period 8</option>
                                {% endif %}
                            </select>
                        </div>
                        <div class="col-md-3">
                            <label for="filterType" class="form-label small fw-bold">Type</label>
                            <select class="form-select form-select-sm" id="filterType">
                                <option value="">All Types</option>
                                <option value="Restroom">Restroom</option>
                                <option value="Locker">Locker</option>
                                <option value="Office">Office</option>
                                <option value="Nurse">Nurse</option>
                                <option value="Summon">Summon</option>
                            </select>
                        </div>
                        <div class="col-md-2">
                            <label for="filterStartDate" class="form-label small fw-bold">Start Date</label>
                            <input type="date" class="form-control form-control-sm" id="filterStartDate">
                        </div>
                        <div class="col-md-2">
                            <label for="filterEndDate" class="form-label small fw-bold">End Date</label>
                            <input type="date" class="form-control form-control-sm" id="filterEndDate">
                        </div>
                        <div class="col-md-2 d-flex align-items-end">
                            <button class="btn btn-sm btn-primary w-100" onclick="loadHistory()">
                                <span class="material-symbols-outlined" style="font-size: 1rem;">filter_alt</span> Apply
                            </button>
                        </div>
                    </div>

                    <!-- History Table -->
                    <div class="table-responsive">
                        <table class="table table-hover table-sm">
                            <thead class="table-light">
                                <tr>
                                    <th>Date/Time</th>
                                    <th>Student</th>
                                    <th>Period</th>
                                    <th>Type</th>
                                    <th>Pass #</th>
                                    <th>Status</th>
                                    <th>Duration</th>
                                </tr>
                            </thead>
                            <tbody id="historyTableBody">
                                <tr>
                                    <td colspan="7" class="text-center py-4 text-muted">
                                        <span class="material-symbols-outlined d-block mb-2" style="font-size: 2rem; opacity: 0.3;">filter_alt</span>
                                        Select filters and click Apply to view history
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>

                    <!-- Pagination -->
                    <div class="d-flex justify-content-between align-items-center mt-3">
                        <div class="text-muted small" id="historyInfo">
                            Showing 0 - 0 of 0 records
                        </div>
                        <nav aria-label="History pagination">
                            <ul class="pagination pagination-sm mb-0" id="historyPagination">
                                <li class="page-item disabled"><a class="page-link" href="#">Previous</a></li>
                                <li class="page-item active"><a class="page-link" href="#">1</a></li>
                                <li class="page-item disabled"><a class="page-link" href="#">Next</a></li>
                            </ul>
                        </nav>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
function handlePassAction(passId, action) {
    const csrfToken = document.querySelector('meta[name="csrf-token"]').getAttribute('content');
    fetch(`/api/hall-pass/${passId}/${action}`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': csrfToken
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.status === 'success') {
            // A simple reload is the easiest way to update the state
            window.location.reload();
        } else {
            alert('Error: ' + data.message);
        }
    })
    .catch(error => {
        console.error('Hall pass action error:', error);
        alert('An unexpected error occurred.');
    });
}

// Queue Settings Management
const queueEnabledSwitch = document.getElementById('queueEnabledSwitch');
const queueLimitInput = document.getElementById('queueLimitInput');
const queueStatusLabel = document.getElementById('queueStatusLabel');
const settingsSavedIndicator = document.getElementById('settingsSavedIndicator');

// Load current settings on page load
function loadQueueSettings() {
    const csrfToken = document.querySelector('meta[name="csrf-token"]').getAttribute('content');
    fetch('/api/hall-pass/settings', {
        method: 'GET',
        headers: {
            'X-CSRFToken': csrfToken
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.status === 'success') {
            queueEnabledSwitch.checked = data.settings.queue_enabled;
            queueLimitInput.value = data.settings.queue_limit;
            updateQueueStatusLabel(data.settings.queue_enabled);
        }
    })
    .catch(error => {
        console.error('Error loading queue settings:', error);
    });
}

// Update the status label text based on queue state
function updateQueueStatusLabel(enabled) {
    queueStatusLabel.textContent = enabled ? 'Queue System' : 'Queue System';
    queueStatusLabel.style.color = enabled ? '#198754' : '#dc3545';
}

// Save queue settings
function saveQueueSettings() {
    const csrfToken = document.querySelector('meta[name="csrf-token"]').getAttribute('content');
    const queueEnabled = queueEnabledSwitch.checked;
    const queueLimit = parseInt(queueLimitInput.value);

    // Validate queue limit
    if (queueLimit < 1 || queueLimit > 50) {
        alert('Queue limit must be between 1 and 50');
        loadQueueSettings(); // Reset to previous value
        return;
    }

    fetch('/api/hall-pass/settings', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': csrfToken
        },
        body: JSON.stringify({
            queue_enabled: queueEnabled,
            queue_limit: queueLimit
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.status === 'success') {
            updateQueueStatusLabel(queueEnabled);
            // Show "Saved!" indicator
            settingsSavedIndicator.style.display = 'inline-block';
            setTimeout(() => {
                settingsSavedIndicator.style.display = 'none';
            }, 2000);
        } else {
            alert('Error: ' + data.message);
            loadQueueSettings(); // Reset to previous values
        }
    })
    .catch(error => {
        console.error('Error saving queue settings:', error);
        alert('Failed to save settings. Please try again.');
        loadQueueSettings(); // Reset to previous values
    });
}

// Event listeners
queueEnabledSwitch.addEventListener('change', saveQueueSettings);
queueLimitInput.addEventListener('change', saveQueueSettings);

// Load settings on page load
document.addEventListener('DOMContentLoaded', loadQueueSettings);

// History Management
let currentHistoryPage = 1;
const historyPageSize = 25;

function loadHistory(page = 1) {
    currentHistoryPage = page;

    const period = document.getElementById('filterPeriod').value;
    const type = document.getElementById('filterType').value;
    const startDate = document.getElementById('filterStartDate').value;
    const endDate = document.getElementById('filterEndDate').value;

    const params = new URLSearchParams({
        page: page,
        page_size: historyPageSize
    });

    if (period) params.append('period', period);
    if (type) params.append('type', type);
    if (startDate) params.append('start_date', startDate);
    if (endDate) params.append('end_date', endDate);

    fetch(`/api/hall-pass/history?${params.toString()}`)
        .then(response => response.json())
        .then(data => {
            if (data.status === 'success') {
                renderHistoryTable(data.records);
                renderPagination(data.total, data.page, data.page_size);
            } else {
                showHistoryError(data.message || 'Failed to load history');
            }
        })
        .catch(error => {
            console.error('Error loading history:', error);
            showHistoryError('Failed to load history. Please try again.');
        });
}

function renderHistoryTable(records) {
    const tbody = document.getElementById('historyTableBody');

    if (!records || records.length === 0) {
        tbody.innerHTML = `
            <tr>
                <td colspan="7" class="text-center py-4 text-muted">
                    <span class="material-symbols-outlined d-block mb-2" style="font-size: 2rem; opacity: 0.3;">search_off</span>
                    No records found matching the selected filters
                </td>
            </tr>
        `;
        return;
    }

    const html = records.map(record => {
        // Use centralized timezone utility for consistent formatting
        const formattedTime = window.TimezoneUtils.formatTimestamp(record.request_time);

        let statusBadge = '';
        switch (record.status) {
            case 'pending':
                statusBadge = '<span class="badge bg-warning text-dark">Pending</span>';
                break;
            case 'approved':
                statusBadge = '<span class="badge bg-info">Approved</span>';
                break;
            case 'left':
                statusBadge = '<span class="badge bg-primary">Out</span>';
                break;
            case 'returned':
                statusBadge = '<span class="badge bg-success">Returned</span>';
                break;
            case 'rejected':
                statusBadge = '<span class="badge bg-danger">Rejected</span>';
                break;
            default:
                statusBadge = `<span class="badge bg-secondary">${record.status}</span>`;
        }

        let duration = '-';
        if (record.left_time && record.return_time) {
            const left = new Date(record.left_time);
            const returned = new Date(record.return_time);
            const diffMs = returned - left;
            const diffMins = Math.floor(diffMs / 60000);
            duration = `${diffMins} min`;
        }

        return `
            <tr>
                <td>${formattedTime}</td>
                <td><strong>${record.student_name}</strong></td>
                <td>${record.period || '-'}</td>
                <td>${record.reason || '-'}</td>
                <td>${record.pass_number || '-'}</td>
                <td>${statusBadge}</td>
                <td>${duration}</td>
            </tr>
        `;
    }).join('');

    tbody.innerHTML = html;
}

function renderPagination(total, page, pageSize) {
    const totalPages = Math.ceil(total / pageSize);
    const historyInfo = document.getElementById('historyInfo');
    const pagination = document.getElementById('historyPagination');

    // Update info text
    const start = (page - 1) * pageSize + 1;
    const end = Math.min(page * pageSize, total);
    historyInfo.textContent = `Showing ${start} - ${end} of ${total} records`;

    // Build pagination
    let paginationHTML = '';

    // Previous button
    if (page > 1) {
        paginationHTML += `<li class="page-item"><a class="page-link" href="#" onclick="loadHistory(${page - 1}); return false;">Previous</a></li>`;
    } else {
        paginationHTML += `<li class="page-item disabled"><a class="page-link" href="#">Previous</a></li>`;
    }

    // Page numbers
    const maxButtons = 5;
    let startPage = Math.max(1, page - Math.floor(maxButtons / 2));
    let endPage = Math.min(totalPages, startPage + maxButtons - 1);

    if (endPage - startPage < maxButtons - 1) {
        startPage = Math.max(1, endPage - maxButtons + 1);
    }

    if (startPage > 1) {
        paginationHTML += `<li class="page-item"><a class="page-link" href="#" onclick="loadHistory(1); return false;">1</a></li>`;
        if (startPage > 2) {
            paginationHTML += `<li class="page-item disabled"><a class="page-link" href="#">...</a></li>`;
        }
    }

    for (let i = startPage; i <= endPage; i++) {
        if (i === page) {
            paginationHTML += `<li class="page-item active"><a class="page-link" href="#">${i}</a></li>`;
        } else {
            paginationHTML += `<li class="page-item"><a class="page-link" href="#" onclick="loadHistory(${i}); return false;">${i}</a></li>`;
        }
    }

    if (endPage < totalPages) {
        if (endPage < totalPages - 1) {
            paginationHTML += `<li class="page-item disabled"><a class="page-link" href="#">...</a></li>`;
        }
        paginationHTML += `<li class="page-item"><a class="page-link" href="#" onclick="loadHistory(${totalPages}); return false;">${totalPages}</a></li>`;
    }

    // Next button
    if (page < totalPages) {
        paginationHTML += `<li class="page-item"><a class="page-link" href="#" onclick="loadHistory(${page + 1}); return false;">Next</a></li>`;
    } else {
        paginationHTML += `<li class="page-item disabled"><a class="page-link" href="#">Next</a></li>`;
    }

    pagination.innerHTML = paginationHTML;
}

function showHistoryError(message) {
    const tbody = document.getElementById('historyTableBody');
    tbody.innerHTML = `
        <tr>
            <td colspan="7" class="text-center py-4 text-danger">
                <span class="material-symbols-outlined d-block mb-2" style="font-size: 2rem;">error</span>
                ${message}
            </td>
        </tr>
    `;
}
</script>
{% endblock %}
