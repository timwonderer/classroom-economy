{% extends "layout_admin.html" %}
{% set page_title = "Dashboard" %}
{% block title %}Teacher Dashboard{% endblock %}
{% block page_icon %}dashboard{% endblock %}
{% block content %}

<!-- Quick Actions -->
<div class="row mb-3">
  <div class="col-12">
    <div class="alert alert-info d-flex justify-content-between align-items-center">
      <div>
        <strong><span class="material-symbols-outlined" style="vertical-align: middle;">info</span> Auto Tap-Out:</strong>
        Daily limits are automatically enforced when students check their dashboard or when you load this page.
      </div>
      <button class="btn btn-sm btn-primary" onclick="enforceDailyLimits()">
        <span class="material-symbols-outlined" style="vertical-align: middle; font-size: 18px;">update</span> Enforce Now
      </button>
    </div>
  </div>
</div>

<!-- Quick Stats Row -->
<div class="row mb-4">
  <!-- Total Students Card -->
  <div class="col-lg-3 col-md-6 mb-3">
    <div class="card shadow-sm h-100">
      <div class="card-body text-center">
        <div class="mb-2">
          <i class="bi bi-people-fill text-primary" style="font-size: 2rem;"></i>
        </div>
        <h3 class="mb-0">{{ total_students }}</h3>
        <small class="text-muted">Total Students</small>
        <div class="mt-2">
          <a href="{{ url_for('admin.students') }}" class="btn btn-sm btn-outline-primary">View All</a>
        </div>
      </div>
    </div>
  </div>

  <!-- Pending Actions Card -->
  <div class="col-lg-3 col-md-6 mb-3">
    <div class="card shadow-sm h-100">
      <div class="card-body text-center">
        <div class="mb-2">
          <i class="bi bi-bell-fill text-warning" style="font-size: 2rem;"></i>
        </div>
        <h3 class="mb-0">{{ total_pending_actions }}</h3>
        <small class="text-muted">Pending Actions</small>
        <div class="mt-2">
          {% if total_pending_actions > 0 %}
            <span class="badge bg-warning text-dark">Action Required</span>
          {% else %}
            <span class="badge bg-success">All Clear</span>
          {% endif %}
        </div>
        <div class="mt-2" style="font-size: 0.75rem;">
          <div class="text-muted">
            {% if pending_redemptions_count > 0 %}<span class="badge bg-secondary">{{ pending_redemptions_count }} Redemptions</span> {% endif %}
            {% if pending_hall_passes_count > 0 %}<span class="badge bg-secondary">{{ pending_hall_passes_count }} Passes</span> {% endif %}
            {% if pending_insurance_claims_count > 0 %}<span class="badge bg-secondary">{{ pending_insurance_claims_count }} Claims</span>{% endif %}
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Today's Activity Card -->
  <div class="col-lg-3 col-md-6 mb-3">
    <div class="card shadow-sm h-100">
      <div class="card-body text-center">
        <div class="mb-2">
          <i class="bi bi-activity text-info" style="font-size: 2rem;"></i>
        </div>
        <h3 class="mb-0">{{ total_transactions_today }}</h3>
        <small class="text-muted">Transactions Today</small>
        <div class="mt-2">
          <a href="{{ url_for('admin.transactions') }}" class="btn btn-sm btn-outline-info">View All</a>
        </div>
      </div>
    </div>
  </div>

  <!-- Total Balance Card -->
  <div class="col-lg-3 col-md-6 mb-3">
    <div class="card shadow-sm h-100">
      <div class="card-body text-center">
        <div class="mb-2">
          <i class="bi bi-currency-dollar text-success" style="font-size: 2rem;"></i>
        </div>
        <h3 class="mb-0">${{ "%.2f"|format(avg_balance) }}</h3>
        <small class="text-muted">Avg Student Balance</small>
        <div class="mt-2 text-muted" style="font-size: 0.85rem;">
          Total: ${{ "%.2f"|format(total_balance) }}
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Second Row: Payroll & Redemptions -->
<div class="row mb-4">
  <!-- Payroll Summary Card -->
  <div class="col-lg-6 mb-3">
    <div class="card shadow h-100">
      <div class="card-header bg-primary text-white">
        <h5 class="mb-0"><i class="bi bi-cash-stack me-2"></i>Next Payroll</h5>
      </div>
      <div class="card-body">
        <div class="row mb-3">
          <div class="col-6">
            <p class="text-muted mb-1">Scheduled Date</p>
            <h5>
              {% if next_payroll_date %}
                <span class="local-timestamp" data-timestamp="{{ next_payroll_date.strftime('%Y-%m-%dT%H:%M:%SZ') }}"></span>
              {% else %}
                Not scheduled
              {% endif %}
            </h5>
          </div>
          <div class="col-6">
            <p class="text-muted mb-1">Estimated Payout</p>
            <h5 class="text-success">${{ "%.2f"|format(total_payroll_estimate|default(0)) }}</h5>
          </div>
        </div>
        <div class="d-grid gap-2">
          <button id="runPayrollBtn" class="btn btn-primary">
            <i class="bi bi-play-circle me-1"></i>Run Payroll Now
          </button>
          <a href="{{ url_for('admin.payroll') }}" class="btn btn-outline-primary">
            <i class="bi bi-gear me-1"></i>Manage Payroll Settings
          </a>
        </div>
      </div>
    </div>
  </div>

  <!-- Pending Actions Card -->
  <div class="col-lg-6 mb-3">
    <div class="card shadow h-100">
      <div class="card-header bg-warning">
        <h5 class="mb-0"><i class="bi bi-bell me-2"></i>Pending Actions ({{ total_pending_actions }})</h5>
      </div>
      <div class="card-body">
        {% if total_pending_actions > 0 %}
          <!-- Nav Tabs for Pending Actions -->
          <ul class="nav nav-pills nav-fill mb-3" id="pendingActionsTabs" role="tablist">
            {% if pending_redemptions_count > 0 %}
            <li class="nav-item" role="presentation">
              <button class="nav-link active" id="redemptions-tab" data-bs-toggle="tab" data-bs-target="#redemptions" type="button" role="tab">
                <i class="bi bi-gift me-1"></i>Redemptions <span class="badge bg-danger ms-1">{{ pending_redemptions_count }}</span>
              </button>
            </li>
            {% endif %}
            {% if pending_hall_passes_count > 0 %}
            <li class="nav-item" role="presentation">
              <button class="nav-link {% if pending_redemptions_count == 0 %}active{% endif %}" id="hall-passes-tab" data-bs-toggle="tab" data-bs-target="#hall-passes" type="button" role="tab">
                <i class="bi bi-door-open me-1"></i>Hall Passes <span class="badge bg-danger ms-1">{{ pending_hall_passes_count }}</span>
              </button>
            </li>
            {% endif %}
            {% if pending_insurance_claims_count > 0 %}
            <li class="nav-item" role="presentation">
              <button class="nav-link {% if pending_redemptions_count == 0 and pending_hall_passes_count == 0 %}active{% endif %}" id="claims-tab" data-bs-toggle="tab" data-bs-target="#claims" type="button" role="tab">
                <i class="bi bi-shield-check me-1"></i>Claims <span class="badge bg-danger ms-1">{{ pending_insurance_claims_count }}</span>
              </button>
            </li>
            {% endif %}
          </ul>

          <div class="tab-content" id="pendingActionsTabContent">
            <!-- Redemptions Tab -->
            {% if pending_redemptions_count > 0 %}
            <div class="tab-pane fade show active" id="redemptions" role="tabpanel">
              <div class="list-group list-group-flush" style="max-height: 300px; overflow-y: auto;">
                {% for req in recent_redemptions %}
                <div class="list-group-item px-0 d-flex justify-content-between align-items-center">
                  <div>
                    <strong>{{ student_lookup.get(req.student_id).full_name if student_lookup.get(req.student_id) else 'Unknown' }}</strong>
                    <br>
                    <small class="text-muted">{{ req.store_item.name }}</small>
                    {% if req.redemption_details %}
                      <br><small class="text-muted">{{ req.redemption_details }}</small>
                    {% endif %}
                  </div>
                  <button class="btn btn-sm btn-success approve-redemption-btn" data-student-item-id="{{ req.id }}">
                    <i class="bi bi-check-circle me-1"></i>Approve
                  </button>
                </div>
                {% endfor %}
              </div>
              {% if pending_redemptions_count > 5 %}
                <div class="mt-2 text-center">
                  <small class="text-muted">Showing 5 of {{ pending_redemptions_count }} pending redemptions</small>
                </div>
              {% endif %}
            </div>
            {% endif %}

            <!-- Hall Passes Tab -->
            {% if pending_hall_passes_count > 0 %}
            <div class="tab-pane fade {% if pending_redemptions_count == 0 %}show active{% endif %}" id="hall-passes" role="tabpanel">
              <div class="list-group list-group-flush" style="max-height: 300px; overflow-y: auto;">
                {% for pass in recent_hall_passes %}
                <div class="list-group-item px-0 d-flex justify-content-between align-items-center">
                  <div>
                    <strong>{{ student_lookup.get(pass.student_id).full_name if student_lookup.get(pass.student_id) else 'Unknown' }}</strong>
                    <br>
                    <small class="text-muted"><i class="bi bi-signpost me-1"></i>{{ pass.reason }}</small>
                    <br>
                    <small class="text-muted">
                      <span class="local-timestamp" data-timestamp="{{ pass.request_time.isoformat() }}Z"></span>
                    </small>
                  </div>
                  <div>
                    <a href="{{ url_for('admin.hall_pass') }}" class="btn btn-sm btn-primary">
                      <i class="bi bi-box-arrow-up-right"></i> View
                    </a>
                  </div>
                </div>
                {% endfor %}
              </div>
              {% if pending_hall_passes_count > 5 %}
                <div class="mt-2 text-center">
                  <small class="text-muted">Showing 5 of {{ pending_hall_passes_count }} pending hall passes</small>
                </div>
              {% endif %}
            </div>
            {% endif %}

            <!-- Insurance Claims Tab -->
            {% if pending_insurance_claims_count > 0 %}
            <div class="tab-pane fade {% if pending_redemptions_count == 0 and pending_hall_passes_count == 0 %}show active{% endif %}" id="claims" role="tabpanel">
              <div class="list-group list-group-flush" style="max-height: 300px; overflow-y: auto;">
                {% for claim in recent_insurance_claims %}
                <div class="list-group-item px-0 d-flex justify-content-between align-items-center">
                  <div>
                    <strong>{{ student_lookup.get(claim.student_id).full_name if student_lookup.get(claim.student_id) else 'Unknown' }}</strong>
                    <br>
                    <small class="text-muted">{{ claim.description[:50] }}{% if claim.description|length > 50 %}...{% endif %}</small>
                    {% if claim.claim_amount %}
                      <br><small class="text-success">${{ "%.2f"|format(claim.claim_amount) }}</small>
                    {% endif %}
                    <br>
                    <small class="text-muted">
                      <span class="local-timestamp" data-timestamp="{{ claim.filed_date.isoformat() }}Z"></span>
                    </small>
                  </div>
                  <div>
                    <a href="{{ url_for('admin.insurance_management') }}" class="btn btn-sm btn-primary">
                      <i class="bi bi-box-arrow-up-right"></i> View
                    </a>
                  </div>
                </div>
                {% endfor %}
              </div>
              {% if pending_insurance_claims_count > 5 %}
                <div class="mt-2 text-center">
                  <small class="text-muted">Showing 5 of {{ pending_insurance_claims_count }} pending claims</small>
                </div>
              {% endif %}
            </div>
            {% endif %}
          </div>
        {% else %}
          <div class="text-center text-muted py-4">
            <i class="bi bi-check-circle" style="font-size: 2rem;"></i>
            <p class="mb-0 mt-2">No pending actions</p>
          </div>
        {% endif %}
      </div>
    </div>
  </div>
</div>

<!-- Third Row: Recent Activity -->
<div class="row mb-4">
  <!-- Recent Transactions Card -->
  <div class="col-lg-6 mb-3">
    <div class="card shadow h-100">
      <div class="card-header bg-info text-white">
        <div class="d-flex justify-content-between align-items-center">
          <h5 class="mb-0"><i class="bi bi-receipt me-2"></i>Recent Transactions</h5>
          <a href="{{ url_for('admin.transactions') }}" class="btn btn-sm btn-light">View All</a>
        </div>
      </div>
      <div class="card-body">
        {% if recent_transactions %}
          <div class="list-group list-group-flush" style="max-height: 300px; overflow-y: auto;">
            {% for tx in recent_transactions %}
            <div class="list-group-item px-0">
              <div class="d-flex justify-content-between align-items-start">
                <div class="flex-grow-1">
                  <strong>{{ student_lookup.get(tx.student_id).full_name if student_lookup.get(tx.student_id) else "Unknown" }}</strong>
                  <span class="badge bg-secondary ms-1">{{ tx.type }}</span>
                  <br>
                  <small class="text-muted">{{ tx.description }}</small>
                  <br>
                  <small class="text-muted">
                    {% if tx.timestamp %}
                      <span class="local-timestamp" data-timestamp="{{ tx.timestamp.isoformat() }}Z"></span>
                    {% else %}
                      —
                    {% endif %}
                  </small>
                </div>
                <div class="text-end ms-2">
                  <strong class="{% if tx.amount > 0 %}text-success{% else %}text-danger{% endif %}">
                    {% if tx.amount is not none %}
                      {% if tx.amount > 0 %}+{% endif %}${{ "%.2f"|format(tx.amount) }}
                    {% else %}
                      —
                    {% endif %}
                  </strong>
                  <br>
                  <form method="POST" action="{{ url_for('admin.void_transaction', transaction_id=tx.id) }}" class="d-inline">
                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                    <button type="submit" class="btn btn-sm btn-outline-danger mt-1" onclick="return confirm('Are you sure you want to void this transaction?')">
                      <i class="bi bi-x-circle"></i> Void
                    </button>
                  </form>
                </div>
              </div>
            </div>
            {% endfor %}
          </div>
        {% else %}
          <div class="text-center text-muted py-4">
            <i class="bi bi-inbox" style="font-size: 2rem;"></i>
            <p class="mb-0 mt-2">No recent transactions</p>
          </div>
        {% endif %}
      </div>
    </div>
  </div>

  <!-- Recent Attendance Card -->
  <div class="col-lg-6 mb-3">
    <div class="card shadow h-100">
      <div class="card-header bg-success text-white">
        <div class="d-flex justify-content-between align-items-center">
          <h5 class="mb-0"><i class="bi bi-calendar-check me-2"></i>Recent Attendance</h5>
          <a href="{{ url_for('admin.attendance_log') }}" class="btn btn-sm btn-light">View All</a>
        </div>
      </div>
      <div class="card-body">
        {% if recent_logs %}
          <div class="list-group list-group-flush" style="max-height: 300px; overflow-y: auto;">
            {% for log in recent_logs %}
            <div class="list-group-item px-0">
              <div class="d-flex justify-content-between align-items-start">
                <div>
                  <strong>{{ log.student_name }}</strong>
                  <span class="badge bg-primary ms-1">{{ log.period|upper }}</span>
                  {% if log.status %}
                    <span class="badge bg-{% if log.status == 'present' %}success{% elif log.status == 'tardy' %}warning{% else %}secondary{% endif %} ms-1">
                      {{ log.status|capitalize }}
                    </span>
                  {% endif %}
                  <br>
                  {% if log.reason %}
                    <small class="text-muted">{{ log.reason }}</small>
                    <br>
                  {% endif %}
                  <small class="text-muted">
                    {% if log.timestamp %}
                      <span class="local-timestamp" data-timestamp="{{ log.timestamp.isoformat() }}Z"></span>
                    {% else %}
                      —
                    {% endif %}
                  </small>
                </div>
              </div>
            </div>
            {% endfor %}
          </div>
        {% else %}
          <div class="text-center text-muted py-4">
            <i class="bi bi-clock-history" style="font-size: 2rem;"></i>
            <p class="mb-0 mt-2">No recent attendance records</p>
          </div>
        {% endif %}
      </div>
    </div>
  </div>
</div>

<!-- Quick Links Section -->
<div class="row mb-4">
  <div class="col-12">
    <div class="card shadow-sm">
      <div class="card-header bg-secondary text-white">
        <h5 class="mb-0"><i class="bi bi-link-45deg me-2"></i>Quick Links</h5>
      </div>
      <div class="card-body">
        <div class="row text-center">
          <div class="col-md-3 col-6 mb-2">
            <a href="{{ url_for('admin.students') }}" class="btn btn-outline-primary w-100">
              <i class="bi bi-people d-block mb-1" style="font-size: 1.5rem;"></i>
              Students
            </a>
          </div>
          <div class="col-md-3 col-6 mb-2">
            <a href="{{ url_for('admin.store_management') }}" class="btn btn-outline-primary w-100">
              <i class="bi bi-shop d-block mb-1" style="font-size: 1.5rem;"></i>
              Store
            </a>
          </div>
          <div class="col-md-3 col-6 mb-2">
            <a href="{{ url_for('admin.insurance_management') }}" class="btn btn-outline-primary w-100">
              <i class="bi bi-shield-check d-block mb-1" style="font-size: 1.5rem;"></i>
              Insurance
            </a>
          </div>
          <div class="col-md-3 col-6 mb-2">
            <a href="{{ url_for('admin.hall_pass') }}" class="btn btn-outline-primary w-100">
              <i class="bi bi-door-open d-block mb-1" style="font-size: 1.5rem;"></i>
              Hall Passes
            </a>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
document.addEventListener("DOMContentLoaded", () => {
    // Handle redemption approval
    document.querySelectorAll(".approve-redemption-btn").forEach(button => {
        button.addEventListener("click", () => {
            const studentItemId = button.dataset.studentItemId;
            const csrfToken = document.querySelector('meta[name="csrf-token"]').getAttribute('content');

            // Disable button and show loading state
            button.disabled = true;
            button.innerHTML = '<i class="bi bi-hourglass-split"></i> Processing...';

            fetch('/api/approve-redemption', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': csrfToken
                },
                body: JSON.stringify({ student_item_id: studentItemId })
            })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    // Remove the item from the list with a fade effect
                    const listItem = button.closest('.list-group-item');
                    listItem.style.transition = 'opacity 0.3s';
                    listItem.style.opacity = '0';
                    setTimeout(() => {
                        listItem.remove();

                        // Update counts in header
                        const countBadge = document.querySelector('.card-header.bg-warning h5');
                        if (countBadge) {
                            const currentCount = parseInt(countBadge.textContent.match(/\d+/)[0]);
                            const newCount = currentCount - 1;
                            countBadge.innerHTML = `<i class="bi bi-bell me-2"></i>Pending Actions (${newCount})`;
                        }

                        // Update the redemptions tab badge
                        const redemptionsTabBadge = document.querySelector('#redemptions-tab .badge');
                        if (redemptionsTabBadge) {
                            const currentRedCount = parseInt(redemptionsTabBadge.textContent);
                            const newRedCount = currentRedCount - 1;
                            redemptionsTabBadge.textContent = newRedCount;
                        }

                        // Update the pending actions stat card
                        const pendingStatCards = document.querySelectorAll('.bi-bell-fill');
                        pendingStatCards.forEach(icon => {
                            const card = icon.closest('.card-body');
                            if (card) {
                                const h3 = card.querySelector('h3');
                                if (h3) {
                                    const currentStatCount = parseInt(h3.textContent);
                                    const newStatCount = currentStatCount - 1;
                                    h3.textContent = newStatCount;

                                    if (newStatCount === 0) {
                                        const badge = card.querySelector('.badge');
                                        if (badge) {
                                            badge.className = 'badge bg-success';
                                            badge.textContent = 'All Clear';
                                        }
                                    }
                                }
                            }
                        });

                        // Show empty state if no more items in this tab
                        const redemptionsTab = document.querySelector('#redemptions .list-group');
                        if (redemptionsTab && redemptionsTab.children.length === 0) {
                            document.querySelector('#redemptions').innerHTML = `
                                <div class="text-center text-muted py-4">
                                    <i class="bi bi-check-circle" style="font-size: 2rem;"></i>
                                    <p class="mb-0 mt-2">No pending redemptions</p>
                                </div>
                            `;
                        }
                    }, 300);
                } else {
                    alert('Approval failed: ' + data.message);
                    button.disabled = false;
                    button.innerHTML = '<i class="bi bi-check-circle me-1"></i>Approve';
                }
            })
            .catch(error => {
                console.error('Approval error:', error);
                alert('An unexpected error occurred.');
                button.disabled = false;
                button.innerHTML = '<i class="bi bi-check-circle me-1"></i>Approve';
            });
        });
    });

    // Handle "Run Payroll Now" button
    const runPayrollBtn = document.getElementById('runPayrollBtn');
    if (runPayrollBtn) {
        runPayrollBtn.addEventListener('click', () => {
            if (confirm('Are you sure you want to run payroll now?')) {
                const csrfToken = document.querySelector('meta[name="csrf-token"]').getAttribute('content');
                const form = document.createElement('form');
                form.method = 'POST';
                form.action = '{{ url_for("admin.run_payroll") }}';

                const csrfInput = document.createElement('input');
                csrfInput.type = 'hidden';
                csrfInput.name = 'csrf_token';
                csrfInput.value = csrfToken;
                form.appendChild(csrfInput);

                document.body.appendChild(form);
                form.submit();
            }
        });
    }

    // Convert UTC timestamps to local time
    document.querySelectorAll(".local-timestamp").forEach(el => {
        const utcString = el.dataset.timestamp;
        if (utcString) {
            const date = new Date(utcString);
            const options = {
                year: 'numeric',
                month: 'short',
                day: 'numeric',
                hour: 'numeric',
                minute: 'numeric',
                hour12: true
            };
            el.textContent = date.toLocaleString(undefined, options);
        } else {
            el.textContent = '—';
        }
    });
});

function enforceDailyLimits() {
  const btn = event.target.closest('button');
  const originalText = btn.innerHTML;
  btn.disabled = true;
  btn.innerHTML = '<span class="spinner-border spinner-border-sm"></span> Checking...';

  fetch('/admin/enforce-daily-limits', {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
      'X-CSRFToken': document.querySelector('meta[name="csrf-token"]')?.getAttribute('content')
    }
  })
  .then(response => response.json())
  .then(data => {
    if (data.status === 'success') {
      let message = data.message;
      if (data.tapped_out && data.tapped_out.length > 0) {
        message += '\n\nAuto-tapped out:\n' + data.tapped_out.join('\n');
      }
      if (data.errors && data.errors.length > 0) {
        message += '\n\nErrors:\n' + data.errors.join('\n');
      }
      alert(message);
    } else {
      alert('Error: ' + (data.message || 'Failed to enforce limits'));
    }
  })
  .catch(error => {
    console.error('Error:', error);
    alert('Network error occurred while enforcing limits.');
  })
  .finally(() => {
    btn.disabled = false;
    btn.innerHTML = originalText;
  });
}
</script>

{% endblock %}
