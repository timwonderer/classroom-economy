{% extends "layout_student.html" %}
{% set page_title = "Payroll" %}
{% set current_page = "payroll" %}
{% block title %}Payroll{% endblock %}
{% block page_icon %}receipt_long{% endblock %}

{% block content %}
<!-- Tabs -->
<ul class="nav nav-tabs mb-4" id="payrollTabs" role="tablist">
    <li class="nav-item" role="presentation">
        <button class="nav-link active" id="attendance-tab" data-bs-toggle="tab" data-bs-target="#attendance" type="button" role="tab">
            <span class="material-symbols-outlined">fact_check</span> Attendance Record
        </button>
    </li>
    <li class="nav-item" role="presentation">
        <button class="nav-link" id="productivity-tab" data-bs-toggle="tab" data-bs-target="#productivity" type="button" role="tab">
            <span class="material-symbols-outlined">analytics</span> Productivity Stats
        </button>
    </li>
    <li class="nav-item" role="presentation">
        <button class="nav-link" id="projected-tab" data-bs-toggle="tab" data-bs-target="#projected" type="button" role="tab">
            <span class="material-symbols-outlined">payments</span> Projected Pay
        </button>
    </li>
</ul>

<!-- Tab Content -->
<div class="tab-content" id="payrollTabContent">
    <!-- Attendance Record Tab -->
    <div class="tab-pane fade show active" id="attendance" role="tabpanel">
        <div class="card mb-4">
            <div class="card-header">
                <span class="material-symbols-outlined">schedule</span> Attendance Overview
            </div>
            <div class="card-body">
                {% if student_blocks %}
                <!-- Per-Block Attendance -->
                {% for blk in student_blocks %}
                <div class="mb-4">
                    <h5 class="mb-3">Block {{ blk|upper }}</h5>
                    {% set state = period_states[blk] %}
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <div class="p-3 bg-light rounded">
                                <strong>Current Status:</strong>
                                <span class="badge {% if state['active'] and not state['done'] %}bg-success{% else %}bg-secondary{% endif %} ms-2">
                                    {{ 'Active' if state['active'] and not state['done'] else 'Inactive' }}
                                </span>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="p-3 bg-light rounded">
                                <strong>Unpaid Time:</strong>
                                <span class="text-primary ms-2">{{ (unpaid_seconds_per_block[blk] // 3600)|string + 'h ' + ((unpaid_seconds_per_block[blk] % 3600) // 60)|string + 'm ' + (unpaid_seconds_per_block[blk] % 60)|string + 's' }}</span>
                            </div>
                        </div>
                    </div>

                    <!-- Tap Events for this block -->
                    {% set block_events = tap_events_by_block[blk] if blk in tap_events_by_block else [] %}
                    {% if block_events %}
                    <div class="table-responsive">
                        <table class="table table-sm table-hover">
                            <thead>
                                <tr>
                                    <th>Date</th>
                                    <th>Action</th>
                                    <th>Time</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for event in block_events[:20] %}
                                <tr>
                                    <td>
                                        {% if event.timestamp %}
                                            <span class="local-timestamp" data-timestamp="{{ event.timestamp.isoformat() }}Z" data-format="date"></span>
                                        {% else %}
                                            N/A
                                        {% endif %}
                                    </td>
                                    <td>
                                        {% set is_tap_in = event.status == 'active' %}
                                        <span class="badge {% if is_tap_in %}bg-success{% else %}bg-danger{% endif %}">
                                            {{ 'Tap In' if is_tap_in else 'Tap Out' }}
                                        </span>
                                    </td>
                                    <td>
                                        {% if event.timestamp %}
                                            <span class="local-timestamp" data-timestamp="{{ event.timestamp.isoformat() }}Z" data-format="time"></span>
                                        {% else %}
                                            N/A
                                        {% endif %}
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    {% if block_events|length > 20 %}
                    <p class="text-muted text-center small">Showing most recent 20 events</p>
                    {% endif %}
                    {% else %}
                    <div class="alert alert-info">
                        <span class="material-symbols-outlined">info</span> No attendance events recorded for this block yet.
                    </div>
                    {% endif %}
                </div>
                {% if not loop.last %}<hr>{% endif %}
                {% endfor %}
                {% else %}
                <div class="alert alert-info">
                    <span class="material-symbols-outlined">info</span> No blocks assigned.
                </div>
                {% endif %}
            </div>
        </div>
    </div>

    <!-- Productivity Stats Tab -->
    <div class="tab-pane fade" id="productivity" role="tabpanel">
        <div class="row">
            <!-- Overall Stats -->
            <div class="col-md-6 mb-4">
                <div class="card">
                    <div class="card-header">
                        <span class="material-symbols-outlined">trending_up</span> Overall Productivity
                    </div>
                    <div class="card-body">
                        {% set total_unpaid = unpaid_seconds_per_block.values()|sum %}
                        <div class="mb-3 pb-3 border-bottom">
                            <div class="d-flex justify-content-between align-items-center">
                                <span class="text-muted">Total Unpaid Time</span>
                                <h5 class="mb-0 text-primary">{{ (total_unpaid // 3600)|int }}h {{ ((total_unpaid % 3600) // 60)|int }}m</h5>
                            </div>
                        </div>
                        <div class="mb-3 pb-3 border-bottom">
                            <div class="d-flex justify-content-between align-items-center">
                                <span class="text-muted">Total Projected Earnings</span>
                                <h5 class="mb-0 text-success">${{ "%.2f"|format(projected_pay_per_block.values()|sum) }}</h5>
                            </div>
                        </div>
                        <div class="mb-3 pb-3 border-bottom">
                            <div class="d-flex justify-content-between align-items-center">
                                <span class="text-muted">Total Lifetime Earnings</span>
                                <h5 class="mb-0 text-info">${{ "%.2f"|format(student.total_earnings) }}</h5>
                            </div>
                        </div>
                        <div>
                            <div class="d-flex justify-content-between align-items-center">
                                <span class="text-muted">Active Blocks</span>
                                <h5 class="mb-0">{{ student_blocks|length }}</h5>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Per-Block Breakdown -->
            <div class="col-md-6 mb-4">
                <div class="card">
                    <div class="card-header">
                        <span class="material-symbols-outlined">view_module</span> Per-Block Breakdown
                    </div>
                    <div class="card-body">
                        {% if student_blocks %}
                        <div class="table-responsive">
                            <table class="table table-sm">
                                <thead>
                                    <tr>
                                        <th>Block</th>
                                        <th>Unpaid Time</th>
                                        <th>Projected</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for blk in student_blocks %}
                                    <tr>
                                        <td><strong>{{ blk|upper }}</strong></td>
                                        <td>{{ (unpaid_seconds_per_block[blk] // 3600)|string + 'h ' + ((unpaid_seconds_per_block[blk] % 3600) // 60)|string + 'm' }}</td>
                                        <td class="text-success">${{ "%.2f"|format(projected_pay_per_block[blk]) }}</td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                        {% else %}
                        <div class="alert alert-info">
                            <span class="material-symbols-outlined">info</span> No blocks assigned.
                        </div>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>

        <!-- Attendance History Stats -->
        <div class="card">
            <div class="card-header">
                <span class="material-symbols-outlined">history</span> Attendance History
            </div>
            <div class="card-body">
                {% if all_tap_events %}
                <div class="row mb-3">
                    <div class="col-md-4">
                        <div class="text-center p-3 bg-light rounded">
                            <h6 class="text-muted mb-1">Total Tap Events</h6>
                            <h3 class="mb-0">{{ all_tap_events|length }}</h3>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="text-center p-3 bg-light rounded">
                            <h6 class="text-muted mb-1">Tap Ins</h6>
                            <h3 class="mb-0 text-success">{{ all_tap_events|selectattr('action', 'equalto', 'tap_in')|list|length }}</h3>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="text-center p-3 bg-light rounded">
                            <h6 class="text-muted mb-1">Tap Outs</h6>
                            <h3 class="mb-0 text-danger">{{ all_tap_events|selectattr('action', 'equalto', 'tap_out')|list|length }}</h3>
                        </div>
                    </div>
                </div>
                {% else %}
                <div class="alert alert-info">
                    <span class="material-symbols-outlined">info</span> No attendance history available yet.
                </div>
                {% endif %}
            </div>
        </div>
    </div>

    <!-- Projected Pay Tab -->
    <div class="tab-pane fade" id="projected" role="tabpanel">
        <div class="row">
            <!-- Current Projected Earnings -->
            <div class="col-md-6 mb-4">
                <div class="card">
                    <div class="card-header">
                        <span class="material-symbols-outlined">account_balance_wallet</span> Current Projections
                    </div>
                    <div class="card-body">
                        <div class="text-center mb-4">
                            <h6 class="text-muted text-uppercase mb-2">Total Projected Earnings</h6>
                            <h1 class="display-4 text-success mb-0">${{ "%.2f"|format(projected_pay_per_block.values()|sum) }}</h1>
                            <small class="text-muted">Based on current unpaid time</small>
                        </div>
                        <hr>
                        <h6 class="mb-3">Breakdown by Block:</h6>
                        {% if student_blocks %}
                        {% for blk in student_blocks %}
                        <div class="mb-3 pb-3 {% if not loop.last %}border-bottom{% endif %}">
                            <div class="d-flex justify-content-between align-items-center">
                                <div>
                                    <strong>Block {{ blk|upper }}</strong>
                                    <div class="small text-muted">
                                        {{ (unpaid_seconds_per_block[blk] // 3600)|string + 'h ' + ((unpaid_seconds_per_block[blk] % 3600) // 60)|string + 'm ' + (unpaid_seconds_per_block[blk] % 60)|string + 's' }}
                                    </div>
                                </div>
                                <h5 class="mb-0 text-success">${{ "%.2f"|format(projected_pay_per_block[blk]) }}</h5>
                            </div>
                        </div>
                        {% endfor %}
                        {% else %}
                        <div class="alert alert-info">
                            <span class="material-symbols-outlined">info</span> No blocks assigned.
                        </div>
                        {% endif %}
                    </div>
                </div>
            </div>

            <!-- Pay Rate Info -->
            <div class="col-md-6 mb-4">
                <div class="card">
                    <div class="card-header">
                        <span class="material-symbols-outlined">attach_money</span> Pay Rate Information
                    </div>
                    <div class="card-body">
                        <div class="alert alert-info">
                            <span class="material-symbols-outlined">info</span> <strong>Current Pay Rate:</strong> $0.25 per minute
                        </div>
                        <h6 class="mb-3">Time Value Calculator:</h6>
                        <div class="table-responsive">
                            <table class="table table-sm table-striped">
                                <thead>
                                    <tr>
                                        <th>Time</th>
                                        <th>Earnings</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr>
                                        <td>1 minute</td>
                                        <td class="text-success">$0.25</td>
                                    </tr>
                                    <tr>
                                        <td>10 minutes</td>
                                        <td class="text-success">$2.50</td>
                                    </tr>
                                    <tr>
                                        <td>30 minutes</td>
                                        <td class="text-success">$7.50</td>
                                    </tr>
                                    <tr>
                                        <td>1 hour</td>
                                        <td class="text-success">$15.00</td>
                                    </tr>
                                    <tr>
                                        <td>2 hours</td>
                                        <td class="text-success">$30.00</td>
                                    </tr>
                                    <tr>
                                        <td>4 hours</td>
                                        <td class="text-success">$60.00</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                        <div class="alert alert-warning mt-3">
                            <span class="material-symbols-outlined">schedule</span> <strong>Remember:</strong> Time is tracked when you tap in and tap out. Make sure to tap in when you start working!
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Last Payroll Information -->
        {% if student.last_payroll %}
        <div class="card">
            <div class="card-header">
                <span class="material-symbols-outlined">history</span> Last Payroll Processed
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-4">
                        <div class="text-center p-3 bg-light rounded">
                            <h6 class="text-muted mb-1">Last Payment Date</h6>
                            <h5 class="mb-0">{{ student.last_payroll.strftime('%b %d, %Y') }}</h5>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="text-center p-3 bg-light rounded">
                            <h6 class="text-muted mb-1">Time Since Last Payroll</h6>
                            <h5 class="mb-0">{{ ((now - student.last_payroll).days) }} days</h5>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="text-center p-3 bg-light rounded">
                            <h6 class="text-muted mb-1">Total Earnings to Date</h6>
                            <h5 class="mb-0 text-success">${{ "%.2f"|format(student.total_earnings) }}</h5>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        {% endif %}
    </div>
</div>
{% endblock %}
