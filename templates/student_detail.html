<!DOCTYPE html>
<html>
<head>
    <title>Student Detail</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body class="p-4">
    <div id="flashToastContainer" class="position-fixed bottom-0 end-0 p-3" style="z-index:1050;"></div>
    <h2>üßë‚Äçüéì {{ student.full_name }} (Block {{ student.block }})</h2>

    <!-- SECTION 1: STUDENT INFO -->
    <div class="card mb-4">
        <div class="card-header bg-info text-white">Student Information</div>
        <div class="card-body">
            <p><strong>Checking Balance:</strong> ${{ "%.2f"|format(student.checking_balance) }}</p>
            <p><strong>Savings Balance:</strong> ${{ "%.2f"|format(student.savings_balance) }}</p>
            <hr>
            <h6>‚è±Ô∏è Recent Attendance</h6>
            {% if latest_tap_event %}
              <p><strong>Timestamp:</strong> <span class="local-timestamp" data-timestamp="{{ latest_tap_event.timestamp.isoformat() }}Z"></span></p>
              <p><strong>Status:</strong> {{ latest_tap_event.status|capitalize }}</p>
              <p><strong>Period:</strong> {{ latest_tap_event.period|upper }}</p>
              <p><strong>Reason:</strong> {{ latest_tap_event.reason if latest_tap_event.reason else '‚Äî' }}</p>
            {% else %}
              <p>‚Äî</p>
            {% endif %}
        </div>
    </div>

    <!-- Hall Pass Management Section -->
    <div class="card mb-4">
        <div class="card-header bg-warning text-dark">Hall Pass Management</div>
        <div class="card-body">
            <p><strong>Current Hall Passes:</strong> {{ student.hall_passes }}</p>
            <form action="{{ url_for('admin.set_hall_passes', student_id=student.id) }}" method="post" class="row g-3 align-items-center">
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                <div class="col-auto">
                    <label for="hall_passes" class="form-label">Set New Balance:</label>
                </div>
                <div class="col-auto">
                    <input type="number" class="form-control" name="hall_passes" id="hall_passes" value="{{ student.hall_passes }}" min="0" required>
                </div>
                <div class="col-auto">
                    <button type="submit" class="btn btn-primary">Update</button>
                </div>
            </form>
        </div>
    </div>

    <!-- SECTION 2: SETTINGS -->
    <div class="card mb-4">
        <div class="card-header bg-secondary text-white">Residency Information</div>
        <div class="card-body">
            <p><strong>Homeownership:</strong> {{ 'Yes' if student.owns_seat else 'No' }}</p>
            <p><strong>Renter:</strong> {{ 'Yes' if student.is_rent_enabled else 'No' }}</p>

            {% if student.is_rent_enabled %}
            <ul>
              <li><strong>Most Recent Rent Payment:</strong>
                {% if student.rent_last_paid %}
                  {{ student.rent_last_paid|format_datetime('%Y-%m-%d') }}
                {% else %}
                  ‚Äî
                {% endif %}
              </li>
              <li><strong>Overdue:</strong>
                {% if student.rent_overdue %}
                  Yes (Due Date: {{ student.rent_due_date|format_datetime('%Y-%m-%d') }})
                {% else %}
                  No
                {% endif %}
              </li>
            </ul>
            {% endif %}

            {% if student.owns_seat %}
            <ul>
              <li><strong>Most Recent Property Tax Payment:</strong>
                {% if student.property_tax_last_paid %}
                  {{ student.property_tax_last_paid|format_datetime('%Y-%m-%d') }}
                {% else %}
                  ‚Äî
                {% endif %}
              </li>
              <li><strong>Overdue:</strong>
                {% if student.property_tax_overdue %}
                  Yes (Due Date: {{ student.property_tax_due_date|format_datetime('%Y-%m-%d') }})
                {% else %}
                  No
                {% endif %}
              </li>
            </ul>
            {% endif %}
        </div>
    </div>

    <!-- SECTION 3: LOGS -->
    <div class="card mb-4">
        <div class="card-header bg-dark text-white">Logs: Transactions & Purchases</div>
        <div class="card-body">
            <h6>üí≥ Transaction History</h6>
            {% if transactions %}
            <table class="table table-sm table-striped">
                <thead>
                    <tr><th>Timestamp</th><th>Type</th><th>Amount</th><th>Description</th><th>Action</th></tr>
                </thead>
                <tbody>
                    {% for tx in transactions %}
                    <tr {% if tx.is_void %}class="text-muted text-decoration-line-through"{% endif %}>
                      <td>
                          {% if tx.timestamp %}
                            <span class="local-timestamp" data-timestamp="{{ tx.timestamp.isoformat() }}Z"></span>
                          {% else %}
                            ‚Äî
                          {% endif %}
                        </td>  
                      <td>{{ tx.type }}</td>
                        <td>${{ "%.2f"|format(tx.amount) }}</td>
                        <td>{{ tx.description }}</td>
                        
                        <td>
                            {% if tx.is_void %}
                                <span class="badge bg-secondary">Voided</span>
                            {% elif tx.type == 'refund' %}
                                <span class="badge bg-secondary">Refund</span>
                            {% else %}
                                 <button type="button" 
                                        class="btn btn-sm btn-outline-danger void-btn" 
                                        data-id="{{ tx.id }}"
                                      >‚ùå Void</button>
                            {% endif %}
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
            {% else %}
            <p><em>No transactions recorded.</em></p>
            {% endif %}

            <hr>
            <h6>üõí Owned Items</h6>
            {% if student_items %}
            <table class="table table-sm table-striped">
                <thead>
                    <tr>
                        <th>Item</th>
                        <th>Status</th>
                        <th>Purchased On</th>
                        <th>Details</th>
                    </tr>
                </thead>
                <tbody>
                  {% for s_item in student_items %}
                  <tr>
                    <td>{{ s_item.store_item.name }}</td>
                    <td><span class="badge bg-info">{{ s_item.status|title }}</span></td>
                    <td>
                      {% if s_item.purchase_date %}
                        <span class="local-timestamp" data-timestamp="{{ s_item.purchase_date.isoformat() }}Z"></span>
                      {% else %}
                        ‚Äî
                      {% endif %}
                    </td>
                    <td>{{ s_item.redemption_details or 'N/A' }}</td>
                  </tr>
                  {% endfor %}
                </tbody>
            </table>
            {% else %}
            <p><em>This student owns no items.</em></p>
            {% endif %}
        </div>
    </div>

    <!-- SECTION 4: PAYROLL AND BONUSES -->
    <div class="card mb-4">
        <div class="card-header bg-success text-white">Payroll & Bonuses</div>
        <div class="card-body">
            <p><em>Coming soon: Log of automatic pay and manual bonuses.</em></p>
        </div>
    </div>

    <a href="/admin/students?block={{ student.block }}" class="btn btn-outline-secondary">‚Üê Back to Block {{ student.block }}</a>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script>
  // Helper to show a Bootstrap toast
  function showToast(category, message) {
    const container = document.getElementById('flashToastContainer');
    const toastEl = document.createElement('div');
    toastEl.className = 'toast align-items-center text-bg-' +
      (category === 'success' ? 'success' : 'warning') +
      ' border-0 mb-2';
    toastEl.setAttribute('role', 'alert');
    toastEl.setAttribute('aria-live', 'assertive');
    toastEl.setAttribute('aria-atomic', 'true');
    toastEl.innerHTML = `
      <div class="d-flex">
        <div class="toast-body">${message}</div>
        <button type="button" class="btn-close btn-close-white me-2 m-auto"
                data-bs-dismiss="toast" aria-label="Close"></button>
      </div>`;
    container.appendChild(toastEl);
    new bootstrap.Toast(toastEl, { delay: 3000 }).show();
  }

  // AJAX void transaction
  function voidTransaction(id) {
    fetch(`/admin/void-transaction/${id}`, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'X-Requested-With': 'XMLHttpRequest'
      },
      body: JSON.stringify({})
    })
    .then(r => r.json())
    .then(data => {
  if (data.status === 'success') {
    showToast('success', data.message);
    const btn = document.querySelector(`.void-btn[data-id="${id}"]`);
    const row = btn.closest('tr');
    row.classList.add('text-muted', 'text-decoration-line-through');
    // Replace the Action cell contents with a Voided badge
    const cell = btn.parentElement;
    cell.innerHTML = '<span class="badge bg-secondary">Voided</span>';
  } else {
    showToast('warning', data.message || 'Error voiding transaction');
  }
})
    .catch(() => {
      showToast('warning', 'Network error');
    });
  }
  document.querySelectorAll('.void-btn').forEach(btn => {
    btn.addEventListener('click', () => {
      const id = btn.getAttribute('data-id');
      if (confirm('Void this transaction?')) {
        voidTransaction(id);
      }
    });
  });
</script>
<script>
    document.addEventListener("DOMContentLoaded", () => {
        document.querySelectorAll(".local-timestamp").forEach(el => {
            const utcString = el.dataset.timestamp;
            if (utcString) {
                const date = new Date(utcString);
                const options = {
                    year: 'numeric',
                    month: 'short',
                    day: 'numeric',
                    hour: 'numeric',
                    minute: 'numeric',
                    hour12: true
                };
                el.textContent = date.toLocaleString(undefined, options);
            } else {
                el.textContent = '‚Äî';
            }
        });
    });
  </script>
</body>
</html>
