<!DOCTYPE html>
<html>
<head>
    <title>Student Detail</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body class="p-4">
    <h2>üßë‚Äçüéì {{ student.name }} (Block {{ student.block }})</h2>

    <!-- SECTION 1: STUDENT INFO -->
    <div class="card mb-4">
        <div class="card-header bg-info text-white">Student Information</div>
        <div class="card-body">
            <p><strong>ID:</strong> {{ student.id }}</p>
            <p><strong>PIN:</strong> ****</p>
            <p><strong>Email:</strong> {{ student.email }}</p>
            <p><strong>QR Code ID:</strong> {{ student.qr_id }}</p>
            <p><strong>Owns Seat:</strong> {{ 'Yes' if student.owns_seat else 'No' }}</p>
            <p><strong>Checking Balance:</strong> ${{ "%.2f"|format(student.checking_balance) }}</p>
            <p><strong>Savings Balance:</strong> ${{ "%.2f"|format(student.savings_balance) }}</p>
            <hr>
            <h6>‚è±Ô∏è Recent Attendance</h6>
            <p><strong>Most Recent Tap In:</strong>
              {% if student.last_tap_in %}
                {{ student.last_tap_in|format_datetime }}
              {% else %}
                ‚Äî
              {% endif %}
            </p>
            <p><strong>Most Recent Tap Out:</strong>
              {% if student.last_tap_out %}
                {{ student.last_tap_out|format_datetime }}
              {% else %}
                ‚Äî
              {% endif %}
            </p>
            <p><strong>Reason:</strong> {{ student.last_tap_out_reason or '‚Äî' }}</p>
        </div>
    </div>

    <!-- SECTION 2: SETTINGS -->
    <div class="card mb-4">
        <div class="card-header bg-secondary text-white">Residency Information</div>
        <div class="card-body">
            <p><strong>Homeownership:</strong> {{ 'Yes' if student.owns_property else 'No' }}</p>
            <p><strong>Renter:</strong> {{ 'Yes' if student.is_renter else 'No' }}</p>

            {% if student.is_renter %}
            <ul>
              <li><strong>Most Recent Rent Payment:</strong>
                {% if student.rent_last_paid %}
                  {{ student.rent_last_paid|format_datetime('%Y-%m-%d') }}
                {% else %}
                  ‚Äî 
                {% endif %}
              </li>
              <li><strong>Overdue:</strong>
                {% if student.rent_overdue %}
                  Yes (Due Date: {{ student.rent_due_date|format_datetime('%Y-%m-%d') }})
                {% else %}
                  No
                {% endif %}
              </li>
            </ul>
            {% endif %}

            {% if student.owns_property %}
            <ul>
              <li><strong>Most Recent Property Tax Payment:</strong>
                {% if student.property_tax_last_paid %}
                  {{ student.property_tax_last_paid|format_datetime('%Y-%m-%d') }}
                {% else %}
                  ‚Äî 
                {% endif %}
              </li>
              <li><strong>Overdue:</strong>
                {% if student.property_tax_overdue %}
                  Yes (Due Date: {{ student.property_tax_due_date|format_datetime('%Y-%m-%d') }})
                {% else %}
                  No
                {% endif %}
              </li>
            </ul>
            {% endif %}
        </div>
    </div>

    <!-- SECTION 3: LOGS -->
    <div class="card mb-4">
        <div class="card-header bg-dark text-white">Logs: Transactions & Purchases</div>
        <div class="card-body">
            <h6>üí≥ Transaction History</h6>
            {% if transactions %}
            <table class="table table-sm table-striped">
                <thead>
                    <tr><th>Type</th><th>Amount</th><th>Description</th><th>Timestamp</th><th>Action</th></tr>
                </thead>
                <tbody>
                    {% for tx in transactions %}
                    <tr {% if tx.is_void %}class="text-muted text-decoration-line-through"{% endif %}>
                        <td>{{ tx.type }}</td>
                        <td>${{ "%.2f"|format(tx.amount) }}</td>
                        <td>{{ tx.description }}</td>
                        <td>
                          {% if tx.timestamp %}
                            {{ tx.timestamp|format_datetime }}
                          {% else %}
                            ‚Äî
                          {% endif %}
                        </td>
                        <td>
                            {% if tx.is_void %}
                                <span class="badge bg-secondary">Voided</span>
                            {% elif tx.type == 'refund' %}
                                <span class="badge bg-secondary">Refund</span>
                            {% else %}
                                <form method="POST" action="{{ url_for('void_transaction', transaction_id=tx.id) }}" style="display:inline;" onsubmit="return confirm('Void this transaction?');">
                                    <button type="submit" class="btn btn-sm btn-outline-danger">‚ùå Void</button>
                                </form>
                            {% endif %}
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
            {% else %}
            <p><em>No transactions recorded.</em></p>
            {% endif %}

            <hr>
            <h6>üõí Store Purchases</h6>
            {% if purchases %}
            <table class="table table-sm table-striped">
                <thead><tr><th>Item</th><th>Date Purchased</th><th>Redeemed?</th></tr></thead>
                <tbody>
                  {% for purchase in purchases %}
                  <tr>
                    <td>{{ purchase.item_name }}</td>
                    <td>
                      {% if purchase.date_purchased %}
                        {{ purchase.date_purchased|format_datetime('%Y-%m-%d') }}
                      {% else %}
                        ‚Äî
                      {% endif %}
                    </td>
                    <td>{{ 'Yes' if purchase.redeemed else 'No' }}</td>
                  </tr>
                  {% endfor %}
                </tbody>
            </table>
            {% else %}
            <p><em>No purchases yet.</em></p>
            {% endif %}
        </div>
    </div>

    <!-- SECTION 4: PAYROLL AND BONUSES -->
    <div class="card mb-4">
        <div class="card-header bg-success text-white">Payroll & Bonuses</div>
        <div class="card-body">
            <p><em>Coming soon: Log of automatic pay and manual bonuses.</em></p>
        </div>
    </div>

    <a href="/admin/students?block={{ student.block }}" class="btn btn-outline-secondary">‚Üê Back to Block {{ student.block }}</a>
</body>
</html>
