{% extends "layout_admin.html" %}
{% set page_title = student.full_name ~ " - Student Detail" %}
{% block title %}{{ student.full_name }} - Detail{% endblock %}
{% block page_icon %}person{% endblock %}

{% block extra_styles %}
<style>
    .stat-card {
        transition: transform 0.2s;
    }
    .stat-card:hover {
        transform: translateY(-2px);
    }
    .stat-value {
        font-size: 2rem;
        font-weight: bold;
    }
    .stat-label {
        color: #6c757d;
        font-size: 0.875rem;
        text-transform: uppercase;
    }
    .negative-balance {
        color: #dc3545;
    }
    .positive-balance {
        color: #28a745;
    }
</style>
{% endblock %}

{% block content %}
<!-- Header with Back Button and Edit -->
<div class="d-flex justify-content-between align-items-center mb-4">
    <div>
        <a href="{{ url_for('admin.students') }}" class="btn btn-outline-secondary mb-2">
            <i class="bi bi-arrow-left me-1"></i> Back to Students
        </a>
        <h2 class="mb-0">
            <i class="bi bi-person-circle me-2"></i>{{ student.full_name }}
            <span class="badge bg-primary">Block {{ student.block|upper }}</span>
        </h2>
    </div>
    <div>
        <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#editBasicInfoModal">
            <i class="bi bi-pencil me-1"></i> Edit Student
        </button>
    </div>
</div>

<!-- Stats Cards Row -->
<div class="row mb-4">
    <div class="col-md-3 mb-3">
        <div class="card stat-card shadow-sm h-100">
            <div class="card-body text-center">
                <div class="stat-label mb-2">Checking Balance</div>
                <div class="stat-value {% if student.checking_balance < 0 %}negative-balance{% else %}positive-balance{% endif %}">
                    ${{ "%.2f"|format(student.checking_balance) }}
                </div>
            </div>
        </div>
    </div>
    <div class="col-md-3 mb-3">
        <div class="card stat-card shadow-sm h-100">
            <div class="card-body text-center">
                <div class="stat-label mb-2">Savings Balance</div>
                <div class="stat-value positive-balance">
                    ${{ "%.2f"|format(student.savings_balance) }}
                </div>
            </div>
        </div>
    </div>
    <div class="col-md-3 mb-3">
        <div class="card stat-card shadow-sm h-100">
            <div class="card-body text-center">
                <div class="stat-label mb-2">Total Earnings</div>
                <div class="stat-value text-success">
                    ${{ "%.2f"|format(student.total_earnings) }}
                </div>
            </div>
        </div>
    </div>
    <div class="col-md-3 mb-3">
        <div class="card stat-card shadow-sm h-100">
            <div class="card-body text-center">
                <div class="stat-label mb-2">Hall Passes</div>
                <div class="stat-value text-info">
                    {{ student.hall_passes }}
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Main Content Tabs -->
<ul class="nav nav-tabs mb-4" id="studentDetailTabs" role="tablist">
    <li class="nav-item" role="presentation">
        <button class="nav-link active" id="overview-tab" data-bs-toggle="tab" data-bs-target="#overview" type="button" role="tab">
            <i class="bi bi-info-circle me-1"></i>Overview
        </button>
    </li>
    <li class="nav-item" role="presentation">
        <button class="nav-link" id="transactions-tab" data-bs-toggle="tab" data-bs-target="#transactions" type="button" role="tab">
            <i class="bi bi-receipt me-1"></i>Transactions
            <span class="badge bg-secondary">{{ transactions|length }}</span>
        </button>
    </li>
    <li class="nav-item" role="presentation">
        <button class="nav-link" id="items-tab" data-bs-toggle="tab" data-bs-target="#items" type="button" role="tab">
            <i class="bi bi-bag me-1"></i>Items
            <span class="badge bg-secondary">{{ student_items|length }}</span>
        </button>
    </li>
    <li class="nav-item" role="presentation">
        <button class="nav-link" id="attendance-tab" data-bs-toggle="tab" data-bs-target="#attendance" type="button" role="tab">
            <i class="bi bi-clock-history me-1"></i>Attendance
        </button>
    </li>
    {% if global_rent_enabled and student.is_rent_enabled %}
    <li class="nav-item" role="presentation">
        <button class="nav-link" id="housing-tab" data-bs-toggle="tab" data-bs-target="#housing" type="button" role="tab">
            <i class="bi bi-house me-1"></i>Rent
        </button>
    </li>
    {% endif %}
    <li class="nav-item" role="presentation">
        <button class="nav-link" id="payroll-tab" data-bs-toggle="tab" data-bs-target="#payroll" type="button" role="tab">
            <i class="bi bi-cash-coin me-1"></i>Payroll
        </button>
    </li>
    <li class="nav-item" role="presentation">
        <button class="nav-link" id="settings-tab" data-bs-toggle="tab" data-bs-target="#settings" type="button" role="tab">
            <i class="bi bi-gear me-1"></i>Settings
        </button>
    </li>
</ul>

<div class="tab-content" id="studentDetailTabContent">
    <!-- OVERVIEW TAB -->
    <div class="tab-pane fade show active" id="overview" role="tabpanel">
        <div class="row">
            <!-- Student Info Card -->
            <div class="col-lg-6 mb-4">
                <div class="card shadow h-100">
                    <div class="card-header bg-info text-white">
                        <h5 class="mb-0"><i class="bi bi-person me-2"></i>Student Information</h5>
                    </div>
                    <div class="card-body">
                        <table class="table table-borderless mb-0">
                            <tr>
                                <td class="fw-bold">Name:</td>
                                <td>{{ student.full_name }}</td>
                            </tr>
                            <tr>
                                <td class="fw-bold">Block(s):</td>
                                <td>
                                    {% set blocks = student.block.split(',') %}
                                    {% for block in blocks %}
                                        <span class="badge bg-primary me-1">{{ block.strip()|upper }}</span>
                                    {% endfor %}
                                </td>
                            </tr>
                            <tr>
                                <td class="fw-bold">Setup Status:</td>
                                <td>
                                    {% if student.has_completed_setup %}
                                        <span class="badge bg-success">Complete</span>
                                    {% else %}
                                        <span class="badge bg-warning text-dark">Pending</span>
                                    {% endif %}
                                </td>
                            </tr>
                            <tr>
                                <td class="fw-bold">Insurance:</td>
                                <td>
                                    {% if student.insurance_plan and student.insurance_plan != 'none' %}
                                        <span class="badge bg-info">{{ student.insurance_plan|title }}</span>
                                    {% else %}
                                        <span class="text-muted">None</span>
                                    {% endif %}
                                </td>
                            </tr>
                            {% if global_rent_enabled and student.is_rent_enabled %}
                            <tr>
                                <td class="fw-bold">Housing:</td>
                                <td><span class="badge bg-secondary">Renter</span></td>
                            </tr>
                            {% endif %}
                        </table>
                    </div>
                </div>
            </div>

            <!-- Recent Activity Card -->
            <div class="col-lg-6 mb-4">
                <div class="card shadow h-100">
                    <div class="card-header bg-secondary text-white">
                        <h5 class="mb-0"><i class="bi bi-clock-history me-2"></i>Recent Attendance</h5>
                    </div>
                    <div class="card-body">
                        {% if latest_tap_event %}
                            <table class="table table-borderless mb-0">
                                <tr>
                                    <td class="fw-bold">Last Activity:</td>
                                    <td>
                                        {% if latest_tap_event.timestamp %}
                                            <span class="local-timestamp" data-timestamp="{{ latest_tap_event.timestamp.isoformat() }}Z"></span>
                                        {% else %}
                                            <span class="text-muted">N/A</span>
                                        {% endif %}
                                    </td>
                                </tr>
                                <tr>
                                    <td class="fw-bold">Status:</td>
                                    <td>
                                        <span class="badge {% if latest_tap_event.status == 'active' %}bg-success{% else %}bg-secondary{% endif %}">
                                            {{ latest_tap_event.status|capitalize }}
                                        </span>
                                    </td>
                                </tr>
                                <tr>
                                    <td class="fw-bold">Period:</td>
                                    <td><span class="badge bg-primary">{{ latest_tap_event.period|upper }}</span></td>
                                </tr>
                                {% if latest_tap_event.reason %}
                                <tr>
                                    <td class="fw-bold">Reason:</td>
                                    <td>{{ latest_tap_event.reason }}</td>
                                </tr>
                                {% endif %}
                            </table>
                        {% else %}
                            <p class="text-muted mb-0">No attendance records found.</p>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- TRANSACTIONS TAB -->
    <div class="tab-pane fade" id="transactions" role="tabpanel">
        <div class="card shadow">
            <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
                <h5 class="mb-0"><i class="bi bi-receipt me-2"></i>Transaction History</h5>
                <div>
                    <span class="badge bg-light text-dark me-2">{{ transactions|length }} total</span>
                    {% if transactions|length > 0 %}
                    <form action="{{ url_for('admin.clear_student_transactions', student_id=student.id) }}" method="POST" style="display: inline;" onsubmit="return confirm('Are you sure you want to clear ALL transactions for this student? This action cannot be undone!');">
                        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                        <button type="submit" class="btn btn-sm btn-danger">
                            <i class="bi bi-trash me-1"></i>Clear All
                        </button>
                    </form>
                    {% endif %}
                </div>
            </div>
            <div class="card-body">
                {% if transactions %}
                    <div class="table-responsive">
                        <table class="table table-striped table-hover">
                            <thead class="table-dark">
                                <tr>
                                    <th>Date</th>
                                    <th>Type</th>
                                    <th>Account</th>
                                    <th>Amount</th>
                                    <th>Description</th>
                                    <th>Status</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for tx in transactions %}
                                <tr {% if tx.is_void %}class="table-secondary text-decoration-line-through"{% endif %}>
                                    <td>
                                        {% if tx.timestamp %}
                                            <span class="local-timestamp" data-timestamp="{{ tx.timestamp.isoformat() }}Z"></span>
                                        {% else %}
                                            <span class="text-muted">N/A</span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        <span class="badge bg-info">{{ tx.type|title if tx.type else 'General' }}</span>
                                    </td>
                                    <td>{{ tx.account_type|title }}</td>
                                    <td class="{% if tx.amount < 0 %}text-danger{% else %}text-success{% endif %}">
                                        ${{ "%.2f"|format(tx.amount) }}
                                    </td>
                                    <td>{{ tx.description or 'N/A' }}</td>
                                    <td>
                                        {% if tx.is_void %}
                                            <span class="badge bg-secondary">Voided</span>
                                        {% else %}
                                            <span class="badge bg-success">Active</span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        {% if not tx.is_void and tx.type != 'refund' %}
                                            <button class="btn btn-sm btn-outline-danger void-btn"
                                                    data-id="{{ tx.id }}">
                                                <i class="bi bi-x-circle"></i> Void
                                            </button>
                                        {% endif %}
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                {% else %}
                    <div class="alert alert-info mb-0">
                        <i class="bi bi-info-circle me-2"></i>No transactions found for this student.
                    </div>
                {% endif %}
            </div>
        </div>
    </div>

    <!-- ITEMS TAB -->
    <div class="tab-pane fade" id="items" role="tabpanel">
        <div class="card shadow">
            <div class="card-header bg-success text-white">
                <h5 class="mb-0"><i class="bi bi-bag me-2"></i>Purchased Items</h5>
            </div>
            <div class="card-body">
                {% if student_items %}
                    <div class="table-responsive">
                        <table class="table table-striped table-hover">
                            <thead class="table-dark">
                                <tr>
                                    <th>Item Name</th>
                                    <th>Purchase Date</th>
                                    <th>Status</th>
                                    <th>Type</th>
                                    <th>Details</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for s_item in student_items %}
                                <tr>
                                    <td>
                                        <strong>{{ s_item.store_item.name }}</strong>
                                    </td>
                                    <td>
                                        {% if s_item.purchase_date %}
                                            <span class="local-timestamp" data-timestamp="{{ s_item.purchase_date.isoformat() }}Z"></span>
                                        {% else %}
                                            <span class="text-muted">N/A</span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        {% if s_item.status == 'purchased' %}
                                            <span class="badge bg-primary">Purchased</span>
                                        {% elif s_item.status == 'processing' %}
                                            <span class="badge bg-warning text-dark">Processing</span>
                                        {% elif s_item.status == 'used' %}
                                            <span class="badge bg-success">Used</span>
                                        {% elif s_item.status == 'approved' %}
                                            <span class="badge bg-success">Approved</span>
                                        {% else %}
                                            <span class="badge bg-secondary">{{ s_item.status|title }}</span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        <span class="badge bg-info">{{ s_item.store_item.item_type|title }}</span>
                                    </td>
                                    <td>{{ s_item.redemption_details or 'N/A' }}</td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                {% else %}
                    <div class="alert alert-info mb-0">
                        <i class="bi bi-info-circle me-2"></i>This student has not purchased any items yet.
                    </div>
                {% endif %}
            </div>
        </div>
    </div>

    <!-- ATTENDANCE TAB -->
    <div class="tab-pane fade" id="attendance" role="tabpanel">
        <div class="card shadow">
            <div class="card-header bg-warning text-dark">
                <h5 class="mb-0"><i class="bi bi-clock-history me-2"></i>Attendance History</h5>
            </div>
            <div class="card-body">
                {% set tap_events = student.tap_events|sort(attribute='timestamp', reverse=True) %}
                {% if tap_events %}
                    <div class="table-responsive">
                        <table class="table table-striped table-hover">
                            <thead class="table-dark">
                                <tr>
                                    <th>Timestamp</th>
                                    <th>Period</th>
                                    <th>Status</th>
                                    <th>Reason</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for tap in tap_events[:50] %}
                                <tr>
                                    <td>
                                        {% if tap.timestamp %}
                                            <span class="local-timestamp" data-timestamp="{{ tap.timestamp.isoformat() }}Z"></span>
                                        {% else %}
                                            <span class="text-muted">N/A</span>
                                        {% endif %}
                                    </td>
                                    <td><span class="badge bg-primary">{{ tap.period|upper }}</span></td>
                                    <td>
                                        {% if tap.status == 'active' %}
                                            <span class="badge bg-success">Active</span>
                                        {% else %}
                                            <span class="badge bg-secondary">Inactive</span>
                                        {% endif %}
                                    </td>
                                    <td>{{ tap.reason or 'N/A' }}</td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    {% if tap_events|length > 50 %}
                        <p class="text-muted text-center mb-0">Showing most recent 50 records out of {{ tap_events|length }} total</p>
                    {% endif %}
                {% else %}
                    <div class="alert alert-info mb-0">
                        <i class="bi bi-info-circle me-2"></i>No attendance records found for this student.
                    </div>
                {% endif %}
            </div>
        </div>
    </div>

    <!-- RENT TAB (Only if rent enabled globally and for student) -->
    {% if global_rent_enabled and student.is_rent_enabled %}
    <div class="tab-pane fade" id="housing" role="tabpanel">
        <div class="row">
            <!-- Rent Card -->
            <div class="col-lg-12 mb-4">
                <div class="card shadow h-100">
                    <div class="card-header bg-primary text-white">
                        <h5 class="mb-0"><i class="bi bi-house-door me-2"></i>Rent Information</h5>
                    </div>
                    <div class="card-body">
                        <table class="table table-borderless">
                            <tr>
                                <td class="fw-bold">Status:</td>
                                <td>
                                    <span class="badge bg-info">Rent Enabled</span>
                                </td>
                            </tr>
                            <tr>
                                <td class="fw-bold">Last Payment:</td>
                                <td>
                                    {% if student.rent_last_paid %}
                                        <span class="local-timestamp" data-timestamp="{{ student.rent_last_paid.isoformat() }}Z"></span>
                                    {% else %}
                                        <span class="text-muted">Never</span>
                                    {% endif %}
                                </td>
                            </tr>
                            <tr>
                                <td class="fw-bold">Due Date:</td>
                                <td>{{ student.rent_due_date.strftime('%B %d, %Y') if student.rent_due_date else 'N/A' }}</td>
                            </tr>
                            <tr>
                                <td class="fw-bold">Overdue:</td>
                                <td>
                                    {% if student.rent_overdue %}
                                        <span class="badge bg-danger">Yes</span>
                                    {% else %}
                                        <span class="badge bg-success">No</span>
                                    {% endif %}
                                </td>
                            </tr>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
    {% endif %}

    <!-- PAYROLL TAB -->
    <div class="tab-pane fade" id="payroll" role="tabpanel">
        <div class="card shadow">
            <div class="card-header bg-success text-white">
                <h5 class="mb-0"><i class="bi bi-cash-coin me-2"></i>Earnings & Payroll</h5>
            </div>
            <div class="card-body">
                <div class="row mb-4">
                    <div class="col-md-4 text-center">
                        <h3 class="text-success">${{ "%.2f"|format(student.total_earnings) }}</h3>
                        <p class="text-muted">Total Earnings</p>
                    </div>
                    <div class="col-md-4 text-center">
                        <h3 class="text-info">{{ transactions|selectattr('type', 'equalto', 'payroll')|list|length }}</h3>
                        <p class="text-muted">Payroll Deposits</p>
                    </div>
                    <div class="col-md-4 text-center">
                        <h3 class="text-primary">{{ transactions|selectattr('type', 'equalto', 'bonus')|list|length }}</h3>
                        <p class="text-muted">Bonuses Received</p>
                    </div>
                </div>

                <h6 class="mb-3">Recent Earnings</h6>
                {% set earnings = transactions|selectattr('amount', 'gt', 0)|list %}
                {% if earnings %}
                    <div class="table-responsive">
                        <table class="table table-striped">
                            <thead class="table-dark">
                                <tr>
                                    <th>Date</th>
                                    <th>Type</th>
                                    <th>Amount</th>
                                    <th>Description</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for tx in earnings[:20] %}
                                <tr>
                                    <td>
                                        {% if tx.timestamp %}
                                            <span class="local-timestamp" data-timestamp="{{ tx.timestamp.isoformat() }}Z"></span>
                                        {% else %}
                                            <span class="text-muted">N/A</span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        <span class="badge bg-info">{{ tx.type|title if tx.type else 'Deposit' }}</span>
                                    </td>
                                    <td class="text-success">${{ "%.2f"|format(tx.amount) }}</td>
                                    <td>{{ tx.description or 'N/A' }}</td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                {% else %}
                    <div class="alert alert-info mb-0">
                        <i class="bi bi-info-circle me-2"></i>No earnings recorded yet.
                    </div>
                {% endif %}
            </div>
        </div>
    </div>

    <!-- SETTINGS TAB -->
    <div class="tab-pane fade" id="settings" role="tabpanel">
        <div class="row justify-content-center">
            <!-- Hall Passes Card -->
            <div class="col-lg-8 mb-4">
                <div class="card shadow">
                    <div class="card-header bg-warning text-dark">
                        <h5 class="mb-0"><i class="bi bi-ticket-perforated me-2"></i>Hall Pass Management</h5>
                    </div>
                    <div class="card-body">
                        <p><strong>Current Balance:</strong> <span class="badge bg-primary fs-5">{{ student.hall_passes }}</span></p>
                        <form action="{{ url_for('admin.set_hall_passes', student_id=student.id) }}" method="post" class="row g-3 align-items-end">
                            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                            <div class="col-md-6">
                                <label for="hall_passes" class="form-label fw-bold">Set New Balance</label>
                                <input type="number" class="form-control form-control-lg" name="hall_passes" id="hall_passes" value="{{ student.hall_passes }}" min="0" required>
                            </div>
                            <div class="col-md-6">
                                <button type="submit" class="btn btn-warning btn-lg w-100">
                                    <i class="bi bi-check-circle me-1"></i>Update Hall Passes
                                </button>
                            </div>
                        </form>
                        <div class="alert alert-info mt-3 mb-0">
                            <small><i class="bi bi-info-circle me-2"></i>Other settings can be changed via the "Edit Student" button at the top of the page.</small>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Edit Basic Info Modal -->
<div class="modal fade" id="editBasicInfoModal" tabindex="-1" aria-labelledby="editBasicInfoModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <form action="{{ url_for('admin.edit_student') }}" method="post">
            <div class="modal-content">
                <div class="modal-header bg-primary text-white">
                    <h5 class="modal-title" id="editBasicInfoModalLabel">
                        <i class="bi bi-pencil me-2"></i>Edit Student Information
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                    <input type="hidden" name="student_id" value="{{ student.id }}">

                    <!-- Basic Information -->
                    <div class="card border-primary mb-3">
                        <div class="card-header bg-primary bg-opacity-10">
                            <h6 class="mb-0 text-primary"><i class="bi bi-person me-2"></i>Basic Information</h6>
                        </div>
                        <div class="card-body">
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label for="edit_first_name" class="form-label fw-bold">First Name</label>
                                    <input type="text" class="form-control" id="edit_first_name" name="first_name" value="{{ student.first_name }}" required>
                                    <div class="form-text">Used for account claim process</div>
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label for="edit_last_name" class="form-label fw-bold">Last Name</label>
                                    <input type="text" class="form-control" id="edit_last_name" name="last_name" value="{{ student.last_initial }}" required>
                                    <div class="form-text">First letter will become last initial</div>
                                </div>
                            </div>
                            <div class="mb-3">
                                <label for="edit_dob_sum" class="form-label fw-bold">DOB Sum (Optional)</label>
                                <input type="number" class="form-control" id="edit_dob_sum" name="dob_sum" value="{{ student.dob_sum }}">
                                <div class="form-text">Sum of DOB components (MM + DD + YYYY). Leave blank to keep unchanged.</div>
                            </div>
                        </div>
                    </div>

                    <!-- Block Assignment -->
                    <div class="card border-info mb-3">
                        <div class="card-header bg-info bg-opacity-10">
                            <h6 class="mb-0 text-info"><i class="bi bi-calendar-week me-2"></i>Block Assignment</h6>
                        </div>
                        <div class="card-body">
                            <p class="text-muted small mb-2">Select all blocks this student attends (can select multiple):</p>
                            <div class="row">
                                {% for block in blocks %}
                                <div class="col-6 col-md-4 mb-2">
                                    <div class="form-check">
                                        <input class="form-check-input block-checkbox" type="checkbox" name="blocks" value="{{ block }}" id="edit_block_{{ block }}"
                                        {% if block.upper() in student.block.upper().split(',') %}checked{% endif %}>
                                        <label class="form-check-label" for="edit_block_{{ block }}">
                                            Block {{ block|upper }}
                                        </label>
                                    </div>
                                </div>
                                {% endfor %}
                            </div>
                            <div class="form-text">At least one block must be selected</div>
                        </div>
                    </div>

                    <!-- Login Management -->
                    <div class="card border-warning mb-3">
                        <div class="card-header bg-warning bg-opacity-10">
                            <h6 class="mb-0 text-warning"><i class="bi bi-key me-2"></i>Login Management</h6>
                        </div>
                        <div class="card-body">
                            <div class="d-flex justify-content-between align-items-center">
                                <div>
                                    <p class="mb-1 fw-bold">Reset Student Login</p>
                                    <p class="text-muted small mb-0">Forces student to go through account claim process again. Account data will be preserved.</p>
                                </div>
                                <div class="form-check form-switch">
                                    <input class="form-check-input" type="checkbox" id="edit_reset_login" name="reset_login" role="switch">
                                    <label class="form-check-label" for="edit_reset_login">Reset</label>
                                </div>
                            </div>
                            <div class="alert alert-warning mt-3 mb-0" id="reset_login_warning" style="display:none;">
                                <small><i class="bi bi-exclamation-triangle me-2"></i>Student will need to re-claim their account using their name and DOB.</small>
                            </div>
                        </div>
                    </div>

                    <div class="alert alert-info mb-0">
                        <small><i class="bi bi-info-circle me-2"></i><strong>Note:</strong> Changing the name will update what the student needs to enter during the account claim process.</small>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">Save Changes</button>
                </div>
            </div>
        </form>
    </div>
</div>

{% endblock %}

{% block extra_scripts %}
<!-- Local Timestamp Conversion -->
<script>
    document.addEventListener("DOMContentLoaded", () => {
        document.querySelectorAll(".local-timestamp").forEach(el => {
            const utcString = el.dataset.timestamp;
            if (utcString) {
                const date = new Date(utcString);
                const options = {
                    year: 'numeric',
                    month: 'short',
                    day: 'numeric',
                    hour: 'numeric',
                    minute: 'numeric',
                    hour12: true
                };
                el.textContent = date.toLocaleString(undefined, options);
            } else {
                el.textContent = 'â€”';
            }
        });
    });

    // Edit modal - reset login checkbox toggle warning
    const resetLoginCheckbox = document.getElementById('edit_reset_login');
    const resetLoginWarning = document.getElementById('reset_login_warning');
    if (resetLoginCheckbox && resetLoginWarning) {
        resetLoginCheckbox.addEventListener('change', function() {
            resetLoginWarning.style.display = this.checked ? 'block' : 'none';
        });
    }
</script>

<!-- Void Transaction AJAX -->
<script>
    function showToast(message, isError = false) {
        const toastContainer = document.getElementById('flashToastContainer') || createToastContainer();
        const toastEl = document.createElement('div');
        toastEl.className = 'toast align-items-center text-bg-' + (isError ? 'warning' : 'success') + ' border-0 mb-2';
        toastEl.setAttribute('role', 'alert');
        toastEl.setAttribute('aria-live', 'assertive');
        toastEl.setAttribute('aria-atomic', 'true');
        toastEl.innerHTML = `
            <div class="d-flex">
                <div class="toast-body">${message}</div>
                <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
            </div>`;
        toastContainer.appendChild(toastEl);
        new bootstrap.Toast(toastEl, { delay: 3000 }).show();
    }

    function createToastContainer() {
        const container = document.createElement('div');
        container.id = 'flashToastContainer';
        container.className = 'position-fixed bottom-0 end-0 p-3';
        container.style.zIndex = '1050';
        document.body.appendChild(container);
        return container;
    }

    function voidTransaction(id) {
        if (!confirm('Are you sure you want to void this transaction?')) return;

        fetch(`/admin/void-transaction/${id}`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-Requested-With': 'XMLHttpRequest'
            },
            body: JSON.stringify({})
        })
        .then(r => r.json())
        .then(data => {
            if (data.status === 'success') {
                showToast(data.message);
                setTimeout(() => location.reload(), 1000);
            } else {
                showToast(data.message || 'Error voiding transaction', true);
            }
        })
        .catch(() => {
            showToast('Network error', true);
        });
    }

    document.querySelectorAll('.void-btn').forEach(btn => {
        btn.addEventListener('click', () => {
            const id = btn.getAttribute('data-id');
            voidTransaction(id);
        });
    });
</script>
{% endblock %}
