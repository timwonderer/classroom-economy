<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Hall Pass History</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@20..48,100..700,0..1,-50..200" rel="stylesheet">
    <link href="{{ static_url('css/style.css') }}" rel="stylesheet">
    <script src="{{ static_url('js/timezone-utils.js') }}"></script>
</head>
<body class="hall-pass-page">
    <div class="container">
        <div class="hall-pass-header mb-4">
            <div class="hall-pass-header-actions">
                <span id="teacherDisplayName" class="teacher-display-name"></span>
                <button class="btn btn-primary refresh-chip" onclick="fetchActivePasses()">
                    <span class="material-symbols-outlined">refresh</span>
                    Refresh
                </button>
            </div>
            <div class="text-center">
                <div class="hall-pass-subtitle text-uppercase small fw-semibold">Classroom Token Hub</div>
                <h1 class="d-flex justify-content-center align-items-center gap-2 mb-1">
                    <span class="material-symbols-outlined">badge</span>
                    Hall Pass History
                </h1>
                <p class="hall-pass-subtitle mb-3">This page shows the last 10 students who have used a hall pass.</p>
            </div>
        </div>

        <div id="noPassesMessage" class="alert alert-light text-center text-muted" style="display: none;">
            No recent hall pass activity
        </div>

        <div id="passesList" class="hall-pass-grid"></div>
    </div>

    <script>
        function getTeacherId() {
            const urlParams = new URLSearchParams(window.location.search);
            return urlParams.get('teacher_id');
        }

        function getTimeElapsed(isoString) {
            const leftTime = new Date(isoString);
            const now = new Date();
            const diffMs = now - leftTime;
            const diffMins = Math.floor(diffMs / 60000);

            if (diffMins < 1) return 'Just left';
            if (diffMins === 1) return '1 minute ago';
            return `${diffMins} minutes ago`;
        }

        function renderPasses(passes) {
            const passesList = document.getElementById('passesList');
            const noPassesMessage = document.getElementById('noPassesMessage');
            const teacherDisplayName = document.getElementById('teacherDisplayName');

            if (!passes || passes.length === 0) {
                passesList.innerHTML = '';
                noPassesMessage.style.display = 'block';
                return;
            }

            noPassesMessage.style.display = 'none';

            const html = passes.map(pass => {
                const isOut = pass.status === 'left';
                const statusClass = isOut ? 'out' : 'returned';
                const statusText = isOut ? 'Out Now' : 'Returned';
                const statusIcon = isOut ? 'output' : 'input';

                return `
                <div class="hall-pass-card ${statusClass}">
                    <div class="hall-pass-card-header">
                        <div>
                            <div class="h5 fw-bold mb-0">${pass.student_name}</div>
                            <div class="text-muted small">Period ${pass.period}</div>
                        </div>
                        ${isOut
                            ? `<span class="time-badge"><span class="material-symbols-outlined" style='vertical-align: middle; font-size:20px'>${statusIcon}</span>${getTimeElapsed(pass.left_time)}</span>`
                            : `<span class="status-chip returned"><span class="material-symbols-outlined" style='vertical-align: middle; font-size:20px'>${statusIcon}</span>${statusText}</span>`
                        }
                    </div>
                    <div class="info-grid hall-pass-info-grid mb-2">
                        <div class="info-item">
                            <div class="info-label">Destination</div>
                            <div class="info-value">${pass.destination || 'â€”'}</div>
                        </div>
                        <div class="info-item">
                            <div class="info-label">Left at</div>
                            <div class="info-value">${window.TimezoneUtils.formatTimestamp(pass.left_time)}</div>
                        </div>
                        ${pass.return_time ? `
                        <div class="info-item">
                            <div class="info-label">Returned at</div>
                            <div class="info-value">${window.TimezoneUtils.formatTimestamp(pass.return_time)}</div>
                        </div>` : ''}
                    </div>
                </div>
            `;
            }).join('');

            passesList.innerHTML = html;
        }

        function fetchActivePasses() {
            const teacherId = getTeacherId();
            const url = teacherId
                ? `/api/hall-pass/verification/active?teacher_id=${teacherId}`
                : '/api/hall-pass/verification/active';

            fetch(url)
                .then(response => response.json())
                .then(data => {
                    if (data.status === 'success') {
                        if (data.teacher_display_name) {
                            teacherDisplayName.textContent = data.teacher_display_name;
                            teacherDisplayName.style.display = 'inline-flex';
                        } else {
                            teacherDisplayName.textContent = '';
                            teacherDisplayName.style.display = 'none';
                        }
                        renderPasses(data.passes);
                    }
                })
                .catch(error => {
                    console.error('Error fetching active passes:', error);
                });
        }

        fetchActivePasses();
    </script>
</body>
</html>
