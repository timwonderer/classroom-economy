{% extends "layout_admin.html" %}
{% set page_title = "Getting Started" %}
{% block title %}Getting Started - Classroom Economy{% endblock %}
{% block page_icon %}rocket_launch{% endblock %}

{% block extra_head %}
<style>
    .onboarding-container {
        max-width: 900px;
        margin: 0 auto;
    }
    
    .step-indicator {
        display: flex;
        justify-content: space-between;
        margin-bottom: 2rem;
        position: relative;
    }
    
    .step-indicator::before {
        content: '';
        position: absolute;
        top: 20px;
        left: 10%;
        right: 10%;
        height: 4px;
        background: var(--gray-200);
        z-index: 0;
    }
    
    .step-item {
        flex: 1;
        text-align: center;
        position: relative;
        z-index: 1;
    }
    
    .step-circle {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        background: var(--primary);
        display: flex;
        align-items: center;
        justify-content: center;
        margin: 0 auto 0.5rem;
        font-weight: 600;
        color: var(--secondary);
        transition: all 0.3s ease;
    }
    
    .step-item.active .step-circle {
        background: var(--secondary);
        color: white;
        box-shadow: 0 4px 12px rgba(0, 175, 223, 0.3);
    }
    
    .step-item.completed .step-circle {
        background: #818181ff;
        color: white;
    }
    
    .step-label {
        font-size: 0.75rem;
        color: var(--gray-600);
    }
    
    .step-item.active .step-label {
        color: var(--brand-primary);
        font-weight: 600;
    }
    
    .welcome-hero {
        background: linear-gradient(135deg, var(--primary) 0%, var(--primary-hover) 100%);
        color: white;
        padding: 3rem;
        border-radius: 16px;
        text-align: center;
        margin-bottom: 2rem;
    }
    
    .welcome-hero h1 {
        margin-bottom: 1rem;
        color:white;
    }
    
    .feature-selection-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
        gap: 1rem;
    }
    
    .feature-card {
        border: 2px solid var(--gray-200);
        border-radius: 12px;
        padding: 1.5rem;
        cursor: pointer;
    }
    
    
    .feature-card.selected {
        border-color: var(--brand-cyan);
        background: rgba(0, 175, 223, 0.05);
    }
    
    .feature-card input[type="checkbox"] {
        display: none;
    }
    
    .feature-card .check-icon {
        opacity: 0;
        transition: opacity 0.2s ease;
    }
    
    .feature-card.selected .check-icon {
        opacity: 1;
    }
    
    .onboarding-nav {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-top: 2rem;
        padding-top: 1rem;
        border-top: 1px solid var(--gray-200);
    }
    
    .step-content {
        display: none;
    }
    
    .step-content.active {
        display: block;
    }
</style>
{% endblock %}

{% block content %}
<div class="onboarding-container">
    <!-- Step Indicator -->
    <div class="step-indicator">
        {% for step in steps %}
        <div class="step-item {% if loop.index == current_step %}active{% elif onboarding.is_step_completed(step.id) %}completed{% endif %}" 
             id="step-indicator-{{ step.id }}">
            <div class="step-circle">
                {% if onboarding.is_step_completed(step.id) %}
                    <span class="material-symbols-outlined">check</span>
                {% else %}
                    {{ loop.index }}
                {% endif %}
            </div>
            <div class="step-label">{{ step.title }}</div>
        </div>
        {% endfor %}
    </div>

    <!-- Step 1: Welcome -->
    <div class="step-content {% if current_step == 1 %}active{% endif %}" id="step-welcome">
        <div class="welcome-hero">
            <span class="material-symbols-outlined mb-0" style="font-size: 40pt;color:#D3AF37">local_atmstorefinance_mode</span>
            <hr>
            <h1><span style="font-weight:300">Hello</span>, Teachers!</h1>
            <p class="mb-0 text-start ">
                Thank you for bringing Classroom Token Hub into your classroom.</p>
            </p>
            <p class="mb-0 text-start ">
               To ensure you can start using Classroom Token Hub quickly, we have created this set up wizard to guide you through the key compoents of your classroom economy. If you need any assistant, you can find tutorials under settings on the left menu bar or submit a support ticket to us</p>
            </p>
            <p class="mb-0 text-start ">
               We hope you find Classroom Token Hub to be as useful as we have designed it to be. We look forward to hear your feedback and suggestions to make it even better!</p>
        </div>

        <div class="card shadow">
            <div class="card-body">
                <h4 class="mb-1">What is Classroom Token Hub?</h4>
                <p class="mb-4"> We are many things. But at our core, we are a classroom management system that simulates a real-world economy to teach students financial literacy and responsibility. Here are some of the key features:</p>
                <div class="row g-4">
                    <div class="col-md-4">
                        <div class="text-center">
                            <span class="material-symbols-outlined text-primary" style="font-size: 3rem;">payments</span>
                            <h5 class="mt-2">Earn & Save</h5>
                            <p class="text-muted small">Students earn virtual currency through attendance and good behavior. </p>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="text-center">
                            <span class="material-symbols-outlined text-success" style="font-size: 3rem;">storefront</span>
                            <h5 class="mt-2">Spend & Learn</h5>
                            <p class="text-muted small">Create a classroom store where students can spend their earnings.</p>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="text-center">
                            <span class="material-symbols-outlined text-warning" style="font-size: 3rem;">account_balance</span>
                            <h5 class="mt-2">Real-World Skills</h5>
                            <p class="text-muted small">Teach financial literacy with banking, insurance, and budgeting.</p>
                        </div>
                    </div>
                </div>
                <p class="mt-2 alert alert-info"> During this set up, if you don't want to set up certain features, you can simply skip them. You can always activate them later in your settings.</p>
                <div class="onboarding-nav">
                    <button type="button" class="btn btn-outline-secondary" onclick="skipOnboarding()">
                        Skip Setup
                    </button>
                    <button type="button" class="btn btn-primary btn-lg" onclick="nextStep('welcome')">
                        Let's Get Started
                        <span class="material-symbols-outlined ms-1" style="vertical-align: middle;">arrow_forward</span>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Step 2: Feature Selection -->
    <div class="step-content {% if current_step == 2 %}active{% endif %}" id="step-features">
        <div class="card shadow">
            <div class="card-header bg-primary text-white">
                <h5 class="mb-0">
                    <span class="material-symbols-outlined me-2" style="vertical-align: middle;">tune</span>
                    Choose Your Features
                </h5>
            </div>
            <div class="card-body">
                <p class="text-muted mb-4">
                    Select the features you want to use in your classroom economy. You can always change these later.
                </p>

                <div class="feature-selection-grid">
                    <div class="feature-card selected" onclick="toggleFeature(this, 'payroll')">
                        <input type="checkbox" name="feature_payroll" checked>
                        <div class="d-flex justify-content-between">
                            <span class="material-symbols-outlined text-primary">payments</span>
                            <span class="material-symbols-outlined text-success check-icon">check_circle</span>
                        </div>
                        <h6 class="mt-2 mb-1">Payroll</h6>
                        <small class="text-muted">Track attendance and pay students</small>
                    </div>

                    <div class="feature-card selected" onclick="toggleFeature(this, 'store')">
                        <input type="checkbox" name="feature_store" checked>
                        <div class="d-flex justify-content-between">
                            <span class="material-symbols-outlined text-primary">storefront</span>
                            <span class="material-symbols-outlined text-success check-icon">check_circle</span>
                        </div>
                        <h6 class="mt-2 mb-1">Store</h6>
                        <small class="text-muted">Classroom marketplace for rewards</small>
                    </div>

                    <div class="feature-card selected" onclick="toggleFeature(this, 'banking')">
                        <input type="checkbox" name="feature_banking" checked>
                        <div class="d-flex justify-content-between">
                            <span class="material-symbols-outlined text-primary">account_balance</span>
                            <span class="material-symbols-outlined text-success check-icon">check_circle</span>
                        </div>
                        <h6 class="mt-2 mb-1">Banking</h6>
                        <small class="text-muted">Savings accounts with interest</small>
                    </div>

                    <div class="feature-card" onclick="toggleFeature(this, 'rent')">
                        <input type="checkbox" name="feature_rent">
                        <div class="d-flex justify-content-between">
                            <span class="material-symbols-outlined text-primary">home</span>
                            <span class="material-symbols-outlined text-success check-icon">check_circle</span>
                        </div>
                        <h6 class="mt-2 mb-1">Rent</h6>
                        <small class="text-muted">Monthly desk/seat payments</small>
                    </div>

                    <div class="feature-card" onclick="toggleFeature(this, 'insurance')">
                        <input type="checkbox" name="feature_insurance">
                        <div class="d-flex justify-content-between">
                            <span class="material-symbols-outlined text-primary">shield</span>
                            <span class="material-symbols-outlined text-success check-icon">check_circle</span>
                        </div>
                        <h6 class="mt-2 mb-1">Insurance</h6>
                        <small class="text-muted">Protection policies for students</small>
                    </div>

                    <div class="feature-card selected" onclick="toggleFeature(this, 'hall_pass')">
                        <input type="checkbox" name="feature_hall_pass" checked>
                        <div class="d-flex justify-content-between">
                            <span class="material-symbols-outlined text-primary">confirmation_number</span>
                            <span class="material-symbols-outlined text-success check-icon">check_circle</span>
                        </div>
                        <h6 class="mt-2 mb-1">Hall Pass</h6>
                        <small class="text-muted">Digital bathroom/water passes</small>
                    </div>
                </div>

                <div class="onboarding-nav">
                    <button type="button" class="btn btn-outline-secondary" onclick="prevStep('features')">
                        <span class="material-symbols-outlined me-1" style="vertical-align: middle;">arrow_back</span>
                        Back
                    </button>
                    <button type="button" class="btn btn-primary btn-lg" onclick="nextStep('features')">
                        Continue
                        <span class="material-symbols-outlined ms-1" style="vertical-align: middle;">arrow_forward</span>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Step 3: Period Setup -->
    <div class="step-content {% if current_step == 3 %}active{% endif %}" id="step-periods">
        <div class="card shadow">
            <div class="card-header bg-info text-white">
                <h5 class="mb-0">
                    <span class="material-symbols-outlined me-2" style="vertical-align: middle;">calendar_today</span>
                    Set Up Your Periods
                </h5>
            </div>
            <div class="card-body">
                <p class="text-muted mb-4">
                    Periods are created automatically when you upload your student roster. You can also add them manually.
                </p>

                <div class="alert alert-info">
                    <div class="d-flex align-items-start gap-3">
                        <span class="material-symbols-outlined">lightbulb</span>
                        <div>
                            <strong>Tip:</strong> Most teachers upload their roster in the next step, which automatically creates periods based on student assignments.
                        </div>
                    </div>
                </div>

                <div class="row g-4">
                    <div class="col-md-6">
                        <div class="card h-100 border-primary">
                            <div class="card-body text-center">
                                <span class="material-symbols-outlined text-primary" style="font-size: 3rem;">upload_file</span>
                                <h5 class="mt-3">Upload Roster</h5>
                                <p class="text-muted small">Recommended: Upload a CSV file with student names and periods.</p>
                                <button class="btn btn-outline-primary" disabled>
                                    Done in Next Step
                                </button>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="card h-100">
                            <div class="card-body text-center">
                                <span class="material-symbols-outlined text-secondary" style="font-size: 3rem;">edit_note</span>
                                <h5 class="mt-3">Add Manually</h5>
                                <p class="text-muted small">Add students one at a time after completing setup.</p>
                                <button class="btn btn-outline-secondary" disabled>
                                    Available After Setup
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="onboarding-nav">
                    <button type="button" class="btn btn-outline-secondary" onclick="prevStep('periods')">
                        <span class="material-symbols-outlined me-1" style="vertical-align: middle;">arrow_back</span>
                        Back
                    </button>
                    <button type="button" class="btn btn-primary btn-lg" onclick="nextStep('periods')">
                        Continue
                        <span class="material-symbols-outlined ms-1" style="vertical-align: middle;">arrow_forward</span>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Step 4: Roster Upload -->
    <div class="step-content {% if current_step == 4 %}active{% endif %}" id="step-roster">
        <div class="card shadow">
            <div class="card-header bg-success text-white">
                <h5 class="mb-0">
                    <span class="material-symbols-outlined me-2" style="vertical-align: middle;">upload_file</span>
                    Upload Your Student Roster
                </h5>
            </div>
            <div class="card-body">
                <p class="text-muted mb-4">
                    Upload a CSV file with your students. Don't worry - you can add more students later!
                </p>

                <div class="row g-4">
                    <div class="col-md-6">
                        <div class="card h-100">
                            <div class="card-body">
                                <h6 class="mb-3">Required Columns:</h6>
                                <ul class="list-unstyled">
                                    <li class="mb-2">
                                        <span class="material-symbols-outlined text-success me-2">check_circle</span>
                                        First Name
                                    </li>
                                    <li class="mb-2">
                                        <span class="material-symbols-outlined text-success me-2">check_circle</span>
                                        Last Name
                                    </li>
                                    <li class="mb-2">
                                        <span class="material-symbols-outlined text-success me-2">check_circle</span>
                                        Date of Birth (MM/DD/YYYY)
                                    </li>
                                    <li class="mb-2">
                                        <span class="material-symbols-outlined text-success me-2">check_circle</span>
                                        Period/Block
                                    </li>
                                </ul>
                                <a href="{{ url_for('admin.download_csv_template') }}" class="btn btn-outline-primary">
                                    <span class="material-symbols-outlined me-1" style="vertical-align: middle;">download</span>
                                    Download Template
                                </a>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="card h-100 bg-light">
                            <div class="card-body">
                                <form method="POST" action="{{ url_for('admin.upload_students') }}" enctype="multipart/form-data" id="rosterUploadForm">
                                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                                    <div class="mb-3">
                                        <label class="form-label fw-bold">Upload CSV File:</label>
                                        <input type="file" class="form-control" name="csv_file" accept=".csv" id="rosterFile">
                                    </div>
                                    <button type="submit" class="btn btn-success w-100">
                                        <span class="material-symbols-outlined me-1" style="vertical-align: middle;">cloud_upload</span>
                                        Upload Roster
                                    </button>
                                </form>
                                <div class="text-center mt-3">
                                    <small class="text-muted">Or skip this step and add students later</small>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <p class="mt-2 alert alert-warning">It is very important that you followed the template format exactly to ensure the app can interpret your submissions. Watch out for roster with cutoff names</p>
                <div class="onboarding-nav">
                    <button type="button" class="btn btn-outline-secondary" onclick="prevStep('roster')">
                        <span class="material-symbols-outlined me-1" style="vertical-align: middle;">arrow_back</span>
                        Back
                    </button>
                    <button type="button" class="btn btn-primary btn-lg" onclick="nextStep('roster')">
                        {% if current_step == 4 %}Skip for Now{% else %}Continue{% endif %}
                        <span class="material-symbols-outlined ms-1" style="vertical-align: middle;">arrow_forward</span>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Step 5: Quick Settings -->
    <div class="step-content {% if current_step == 5 %}active{% endif %}" id="step-settings">
        <div class="card shadow">
            <div class="card-header bg-warning">
                <h5 class="mb-0">
                    <span class="material-symbols-outlined me-2" style="vertical-align: middle;">settings</span>
                    Quick Settings
                </h5>
            </div>
            <div class="card-body">
                <p class="text-muted mb-4">
                    Configure your basic settings. You can customize everything in detail later.
                </p>

                <div class="row g-4">
                    <div class="col-md-6">
                        <div class="card h-100">
                            <div class="card-header">
                                <span class="material-symbols-outlined me-2" style="vertical-align: middle;">payments</span>
                                Payroll Settings
                                <div class="text-muted small"> This is for pay based on attendance</div>
                            </div>
                            <div class="card-body">
                                <div class="mb-3">
                                    <label class="form-label">Pay Rate (per hour)</label>
                                    <div class="input-group">
                                        <span class="input-group-text">$</span>
                                        <input type="number" class="form-control" value="15" step="0.25" min="0" id="payRate">
                                    </div>
                                </div>
                                <div class="mb-0">
                                    <label class="form-label">Pay Frequency</label>
                                    <select class="form-select" id="payFrequency">
                                        <option value="weekly">Weekly</option>
                                        <option value="biweekly" selected>Bi-weekly</option>
                                        <option value="monthly">Monthly</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="card h-100">
                            <div class="card-header">
                                <span class="material-symbols-outlined me-2" style="vertical-align: middle;">account_balance</span>
                                Banking Settings
                            </div>
                            <div class="card-body">
                                <div class="mb-3">
                                    <label class="form-label">Savings Interest Rate (APY)</label>
                                    <div class="input-group">
                                        <input type="number" class="form-control" value="5" step="0.5" min="0" max="100" id="interestRate">
                                        <span class="input-group-text">%</span>
                                    </div>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="overdraftProtection">
                                    <label class="form-check-label" for="overdraftProtection">
                                        Enable overdraft protection
                                    </label>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="alert alert-success mt-4">
                    <div class="d-flex align-items-center gap-3">
                        <span class="material-symbols-outlined" style="font-size: 2rem;">celebration</span>
                        <div>
                            <strong>You're all set!</strong><br>
                            Click "Complete Setup" to finish and start using Classroom Token Hub. You can always find support under "Settings" in the left menu bar.
                        </div>
                    </div>
                </div>

                <div class="onboarding-nav">
                    <button type="button" class="btn btn-outline-secondary" onclick="prevStep('settings')">
                        <span class="material-symbols-outlined me-1" style="vertical-align: middle;">arrow_back</span>
                        Back
                    </button>
                    <button type="button" class="btn btn-success btn-lg" onclick="completeOnboarding()">
                        <span class="material-symbols-outlined me-1" style="vertical-align: middle;">check_circle</span>
                        Complete Setup
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
const csrfTokenMeta = document.querySelector('meta[name="csrf-token"]');
const csrfToken = csrfTokenMeta ? csrfTokenMeta.content : '';
const stepOrder = ['welcome', 'features', 'periods', 'roster', 'settings'];
let currentStepIndex = {{ current_step - 1 }};

function toggleFeature(card, feature) {
    card.classList.toggle('selected');
    const checkbox = card.querySelector('input[type="checkbox"]');
    checkbox.checked = !checkbox.checked;
}

function getSelectedFeatures() {
    const features = {};
    document.querySelectorAll('.feature-card input[type="checkbox"]').forEach(cb => {
        const feature = cb.name.replace('feature_', '');
        features[feature] = cb.checked;
    });
    return features;
}

function showStep(stepId) {
    // Hide all steps
    document.querySelectorAll('.step-content').forEach(step => {
        step.classList.remove('active');
    });
    
    // Show selected step
    document.getElementById('step-' + stepId).classList.add('active');
    
    // Update indicators
    stepOrder.forEach((step, index) => {
        const indicator = document.getElementById('step-indicator-' + step);
        indicator.classList.remove('active', 'completed');
        
        if (index < currentStepIndex) {
            indicator.classList.add('completed');
        } else if (index === currentStepIndex) {
            indicator.classList.add('active');
        }
    });
}

function nextStep(currentStep) {
    const stepData = {};
    
    if (currentStep === 'features') {
        stepData.features = getSelectedFeatures();
    }
    
    fetch('/admin/onboarding/step/' + currentStep, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': csrfToken
        },
        body: JSON.stringify(stepData)
    })
    .then(response => response.json())
    .then(data => {
        if (data.status === 'success') {
            currentStepIndex = data.next_step - 1;
            if (data.is_completed) {
                window.location.href = '/admin';
            } else {
                showStep(stepOrder[currentStepIndex]);
            }
        } else {
            alert('Error: ' + data.message);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        // Still advance step on error for better UX
        if (currentStepIndex < stepOrder.length - 1) {
            currentStepIndex++;
            showStep(stepOrder[currentStepIndex]);
        }
    });
}

function prevStep(currentStep) {
    if (currentStepIndex > 0) {
        currentStepIndex--;
        showStep(stepOrder[currentStepIndex]);
    }
}

function skipOnboarding() {
    if (confirm('Are you sure you want to skip the setup? You can configure settings later from the dashboard.')) {
        fetch('/admin/onboarding/skip', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': csrfToken
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.status === 'success') {
                window.location.href = data.redirect;
            }
        })
        .catch(error => {
            console.error('Error:', error);
            window.location.href = '/admin';
        });
    }
}

function completeOnboarding() {
    // Save quick settings first
    const payRate = document.getElementById('payRate').value;
    const payFrequency = document.getElementById('payFrequency').value;
    const interestRate = document.getElementById('interestRate').value;
    const overdraftProtection = document.getElementById('overdraftProtection').checked;
    
    // Complete onboarding
    fetch('/admin/onboarding/complete', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': csrfToken
        },
        body: JSON.stringify({
            payRate: payRate,
            payFrequency: payFrequency,
            interestRate: interestRate,
            overdraftProtection: overdraftProtection
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.status === 'success') {
            window.location.href = data.redirect;
        } else {
            alert('Error: ' + data.message);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        window.location.href = '/admin';
    });
}
</script>
{% endblock %}
