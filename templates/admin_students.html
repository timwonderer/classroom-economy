{% extends "layout_admin.html" %}
{% set page_title = "Student Management" %}
{% block title %}Student Management{% endblock %}
{% block page_icon %}school{% endblock %}

{# Helper macro to display class label with fallback #}
{% macro class_label(block) -%}
{{ class_labels_by_block.get(block|upper, block|upper) }}
{%- endmacro %}

{% block extra_styles %}
<style>
    .block-tab-content {
        min-height: 400px;
    }
    .quick-action-btn {
        padding: 0.25rem 0.5rem;
        font-size: 0.875rem;
    }
</style>
{% endblock %}

{% block content %}
<!-- Nav Tabs -->
<ul class="nav nav-tabs mb-4" id="studentTabs" role="tablist">
  <li class="nav-item" role="presentation">
    <button class="nav-link active" id="roster-tab" data-bs-toggle="tab" data-bs-target="#roster" type="button" role="tab">
      <span class="material-symbols-outlined me-1" style="vertical-align: middle;">groups</span>Class Roster
    </button>
  </li>
  <li class="nav-item" role="presentation">
    <button class="nav-link" id="bulk-upload-tab" data-bs-toggle="tab" data-bs-target="#bulk-upload" type="button" role="tab">
      <span class="material-symbols-outlined me-1" style="vertical-align: middle;">cloud_upload</span>Bulk Upload
    </button>
  </li>
  <li class="nav-item" role="presentation">
    <button class="nav-link" id="individual-upload-tab" data-bs-toggle="tab" data-bs-target="#individual-upload" type="button" role="tab">
      <span class="material-symbols-outlined me-1" style="vertical-align: middle;">person_add</span>Individual Upload
    </button>
  </li>
</ul>

<div class="tab-content" id="studentTabContent">
  <!-- ROSTER TAB -->
  <div class="tab-pane fade show active" id="roster" role="tabpanel">
      <div class="card shadow">
            <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
            <h5 class="mb-0 fs-3"><span class="material-symbols-outlined me-2 align-middle fs-1">groups</span>Class Roster</h5>
          <div>
            <a href="{{ url_for('admin.export_students') }}" class="btn btn-light btn-sm me-2">
              <span class="material-symbols-outlined me-1" style="vertical-align: middle;">download</span> Export All
            </a>
          </div>
        </div>
      <div class="card-body">
        <!-- Class Filter Tabs -->
        <ul class="nav nav-pills mb-3" id="blockTabs" role="tablist">
          {% for block in blocks %}
          <li class="nav-item" role="presentation">
            <button class="nav-link {% if loop.first %}active{% endif %}"
                    id="block-{{ block }}-tab"
                    data-bs-toggle="pill"
                    data-bs-target="#block-{{ block }}"
                    type="button"
                    role="tab">
              {% if block == "Unassigned" %}
                <span class="material-symbols-outlined me-1" style="vertical-align: middle;">help</span>{{ block }}
              {% else %}
                {{ class_label(block) }}
              {% endif %}
              {% set all_students_in_block = students_by_block[block] if block in students_by_block else [] %}
              {% set claimed_count = all_students_in_block|selectattr('username_hash')|list|length %}
              {% set unclaimed_students_count = all_students_in_block|rejectattr('username_hash')|list|length %}
              {% set unclaimed_seats_count = unclaimed_seats_by_block.get(block|upper, 0) %}
              {% set unclaimed_count = unclaimed_seats_count + unclaimed_students_count %}
              {% set total_count = claimed_count + unclaimed_count %}
              <span class="badge bg-secondary ms-1">{{ total_count }}</span>
              {% if unclaimed_count > 0 %}
                <span class="badge bg-warning text-dark ms-1">{{ unclaimed_count }} unclaimed</span>
              {% endif %}
            </button>
          </li>
          {% endfor %}
        </ul>

        <!-- Class Content -->
        <div class="tab-content block-tab-content" id="blockTabContent">
          {% for block in blocks %}
          <div class="tab-pane fade {% if loop.first %}show active{% endif %}"
               id="block-{{ block }}"
               role="tabpanel">
            {% set block_students = students_by_block[block] %}

            <!-- Join Code Section -->
            {% if block != "Unassigned" and join_codes_by_block.get(block|upper) %}
            <div class="card border-success mb-3">
                <div class="card-header bg-success bg-opacity-10">
                  <div class="d-flex justify-content-between align-items-center">
                    <h6 class="mb-0 text-success fs-4">
                      <span class="material-symbols-outlined me-2 align-middle">key</span>
                      Join Code for {{ class_label(block) }}
                    </h6>
                  {% set block_students_list = students_by_block[block] if block in students_by_block else [] %}
                  {% set unclaimed_students_in_block = block_students_list|rejectattr('username_hash')|list|length %}
                  {% set unclaimed_seats_in_block = unclaimed_seats_by_block.get(block|upper, 0) %}
                  {% set total_unclaimed_in_block = unclaimed_seats_in_block + unclaimed_students_in_block %}
                  {% if total_unclaimed_in_block > 0 %}
                    <span class="badge bg-warning text-dark">
                      {{ total_unclaimed_in_block }} unclaimed seat(s)
                    </span>
                  {% else %}
                    <span class="badge bg-success text-white">
                      All seats claimed
                    </span>
                  {% endif %}
                </div>
              </div>
              <div class="card-body">
                <div class="row align-items-center">
                  <div class="col-md-8">
                    <p class="mb-2"><strong>Students use this code to claim their accounts:</strong></p>
                    <div class="d-flex align-items-center gap-2">
                      <div class="input-group">
                        <label for="join-code-{{ block }}" class="visually-hidden">Join code for {{ class_label(block) }}</label>
                          <input type="text"
                                 class="form-control form-control-lg font-monospace text-center fw-bold fs-3"
                                 id="join-code-{{ block }}"
                                 value="{{ join_codes_by_block[block|upper] }}"
                                 readonly
                                 style="letter-spacing: 0.2em; background-color: #fff;">
                        <button class="btn btn-outline-success btn-lg join-code-copy-btn"
                                type="button"
                                data-block="{{ block }}"
                                data-join-code="{{ join_codes_by_block[block|upper] }}">
                          <span class="material-symbols-outlined" style="vertical-align: middle;">content_copy</span> Copy
                        </button>
                      </div>
                    </div>
                  </div>
                  <div class="col-md-4">
                    <div class="alert alert-info mb-0 small">
                        <span class="material-symbols-outlined me-1 align-middle fs-6">info</span>
                      <strong>Student Instructions:</strong>
                      <ol class="mb-0 mt-1 ps-3">
                        <li>Go to student sign-in page</li>
                        <li>Click "First Time? Set Up Account"</li>
                        <li>Enter this join code</li>
                        <li>Provide first name, last name, and DOB sum</li>
                      </ol>
                    </div>
                  </div>
                </div>
              </div>
            </div>
            {% endif %}

            <!-- Unclaimed Seats Section - includes both TeacherBlock seats and students without username -->
            {% set unclaimed_seats = unclaimed_seats_list_by_block.get(block|upper, []) %}
            {% set unclaimed_students = [] %}
            {% for student in block_students if not student.username_hash %}
              {% set _ = unclaimed_students.append(student) %}
            {% endfor %}
            {% set total_unclaimed = unclaimed_seats|length + unclaimed_students|length %}
            {% if block != "Unassigned" and total_unclaimed > 0 %}
            <div class="card border-warning mb-3">
                <div class="card-header bg-warning bg-opacity-10 d-flex justify-content-between align-items-center">
                  <h6 class="mb-0 text-dark fs-4">
                    <span class="material-symbols-outlined me-2 align-middle">pending</span>
                    Unclaimed Seats ({{ total_unclaimed }})
                  </h6>
                  {% if unclaimed_seats|length > 0 or unclaimed_students|length > 0 %}
                  <button type="button" class="btn btn-sm btn-outline-danger" onclick="deleteAllPendingInBlock('{{ block }}', {{ unclaimed_seats|length }}, {{ unclaimed_students|length }})">
                    <span class="material-symbols-outlined me-1 align-middle fs-6">delete_sweep</span>
                    Delete All Unclaimed
                  </button>
                  {% endif %}
              </div>
              <div class="card-body">
                <p class="text-muted mb-3">These students are in your roster but haven't set up their username yet. Share the join code above with them.</p>
                <div class="table-responsive">
                  <table class="table table-sm table-striped">
                    <thead class="table-light">
                      <tr>
                        <th scope="col">Name</th>
                        <th scope="col">Added</th>
                        <th scope="col">Status</th>
                        <th scope="col">Actions</th>
                      </tr>
                    </thead>
                    <tbody>
                      {% for seat in unclaimed_seats %}
                      <tr>
                        <td>
                          <span class="fw-bold">{{ seat.first_name }} {{ seat.last_initial }}.</span>
                        </td>
                        <td>
                          <small class="text-muted">{{ seat.created_at.strftime('%Y-%m-%d') if seat.created_at else 'N/A' }}</small>
                        </td>
                        <td>
                          <span class="badge bg-warning text-dark">Waiting for Claim</span>
                        </td>
                        <td>
                          <button type="button" class="btn btn-sm btn-outline-danger" onclick="deletePendingStudent({{ seat.id }}, '{{ seat.first_name }} {{ seat.last_initial }}.')" aria-label="Delete pending student {{ seat.first_name }} {{ seat.last_initial }}.">
                            <span class="material-symbols-outlined align-middle fs-6" aria-hidden="true">delete</span>
                          </button>
                        </td>
                      </tr>
                      {% endfor %}
                      {% for student in unclaimed_students %}
                      <tr>
                        <td>
                          <a href="{{ url_for('admin.student_detail', student_id=student.id) }}" class="text-decoration-none">
                            <span class="fw-bold">{{ student.first_name }} {{ student.last_initial }}.</span>
                          </a>
                        </td>
                        <td>
                          <small class="text-muted">-</small>
                        </td>
                        <td>
                          <span class="badge bg-warning text-dark">Needs Username</span>
                        </td>
                        <td>
                          <a href="{{ url_for('admin.student_detail', student_id=student.id) }}" class="btn btn-sm btn-outline-primary" aria-label="View details for {{ student.full_name }}">
                            <span class="material-symbols-outlined align-middle fs-6" aria-hidden="true">visibility</span>
                          </a>
                          <button type="button" class="btn btn-sm btn-outline-danger"
                                  data-bs-toggle="modal"
                                  data-bs-target="#deleteStudentModal"
                                  data-student-id="{{ student.id }}"
                                  data-student-name="{{ student.full_name }}"
                                  aria-label="Delete student {{ student.full_name }}">
                            <span class="material-symbols-outlined align-middle fs-6" aria-hidden="true">delete</span>
                          </button>
                        </td>
                      </tr>
                      {% endfor %}
                    </tbody>
                  </table>
                </div>
              </div>
            </div>
            {% endif %}

            {% set claimed_students = [] %}
            {% for student in block_students if student.username_hash %}
              {% set _ = claimed_students.append(student) %}
            {% endfor %}
            {% if claimed_students %}
              <div class="card border-success mb-3">
                <div class="card-header bg-success bg-opacity-10">
                  <h6 class="mb-0 text-success fs-4">
                    <span class="material-symbols-outlined me-2 align-middle">check_circle</span>
                    Active Students ({{ claimed_students|length }})
                  </h6>
                </div>
                <div class="card-body">
              <!-- Bulk Actions Toolbar -->
              <div class="bulk-actions-toolbar mb-3 p-3 bg-light border rounded d-none" id="bulk-toolbar-{{ block }}">
                <div class="d-flex justify-content-between align-items-center">
                  <div>
                    <strong><span class="selected-count">0</span> students selected</strong>
                  </div>
                  <div>
                      <button type="button" class="btn btn-info btn-sm me-2" onclick="tapOutSelected('{{ block }}')">
                        <span class="material-symbols-outlined align-middle fs-5">logout</span> Tap Out Selected
                      </button>
                      <button type="button" class="btn btn-secondary btn-sm me-2" onclick="tapOutAllBlock('{{ block }}')">
                        <span class="material-symbols-outlined align-middle fs-5">logout</span> Tap Out Entire Class
                    </button>
                    <button type="button" class="btn btn-danger btn-sm" onclick="bulkDeleteStudents('{{ block }}')">
                      <span class="material-symbols-outlined" style="vertical-align: middle;">delete</span> Delete Selected
                    </button>
                    <button type="button" class="btn btn-warning btn-sm" onclick="clearSelection('{{ block }}')">
                      <span class="material-symbols-outlined" style="vertical-align: middle;">cancel</span> Clear Selection
                    </button>
                  </div>
                </div>
              </div>

                <div class="mb-2">
                  <button type="button" class="btn btn-sm btn-outline-danger me-2" onclick="deleteEntireBlock('{{ block }}')">
                    <span class="material-symbols-outlined" style="vertical-align: middle;">delete_forever</span> Delete All Students in {{ class_label(block) }}
                  </button>
                </div>

              <div class="table-responsive">
                <table class="table table-hover table-striped" id="students-table-{{ block }}">
                  <thead class="table-dark">
                    <tr>
                      <th style="width: 40px;" scope="col">
                        <input type="checkbox" class="form-check-input select-all-checkbox" onchange="toggleSelectAll('{{ block }}', this)" aria-label="Select all students">
                      </th>
                      <th scope="col">Name</th>
                      <th scope="col">Username</th>
                      <th scope="col">Checking</th>
                      <th scope="col">Savings</th>
                      <th scope="col">Total Earnings</th>
                      <th scope="col">Hall Passes</th>
                      <th scope="col">Setup Status</th>
                      <th scope="col">Actions</th>
                    </tr>
                  </thead>
                  <tbody>
                    {% for student in claimed_students %}
                    <tr class="student-row" data-student-id="{{ student.id }}">
                      <td>
                        <input type="checkbox" class="form-check-input student-checkbox" value="{{ student.id }}" onchange="updateBulkToolbar('{{ block }}')" aria-label="Select {{ student.full_name }}">
                      </td>
                      <td>
                        <a href="{{ url_for('admin.student_detail', student_id=student.id) }}" class="fw-bold text-decoration-none">
                          {{ student.full_name }}
                        </a>
                      </td>
                      <td>
                        <span class="badge bg-info">{{ student.username_display if student.has_completed_setup else 'Not Set' }}</span>
                      </td>
                      <td class="{% if student.checking_balance < 0 %}text-danger{% endif %}">
                        ${{ "%.2f"|format(student.checking_balance) }}
                      </td>
                      <td>${{ "%.2f"|format(student.savings_balance) }}</td>
                      <td class="text-success">${{ "%.2f"|format(student.total_earnings) }}</td>
                      <td>
                        <span class="badge bg-primary text-white">{{ student.hall_passes }}</span>
                      </td>
                      <td>
                        {% if student.has_completed_setup %}
                          <span class="badge bg-success">Complete</span>
                        {% else %}
                          <span class="badge bg-warning text-dark">Pending</span>
                        {% endif %}
                      </td>
                      <td>
                        <button class="btn btn-sm btn-outline-primary quick-action-btn me-1"
                                data-bs-toggle="modal"
                                data-bs-target="#editStudentModal"
                                data-student-id="{{ student.id }}"
                                data-student-name="{{ student.first_name }}"
                                data-student-last-initial="{{ student.last_initial }}"
                                data-student-block="{{ student.block }}"
                                data-student-dob-sum="{{ student.dob_sum }}">
                          <span class="material-symbols-outlined" style="vertical-align: middle;">edit</span> Edit
                        </button>
                        <button class="btn btn-sm btn-outline-danger quick-action-btn"
                                data-bs-toggle="modal"
                                data-bs-target="#deleteStudentModal"
                                data-student-id="{{ student.id }}"
                                data-student-name="{{ student.full_name }}">
                          <span class="material-symbols-outlined" style="vertical-align: middle;">delete</span> Delete
                        </button>
                      </td>
                    </tr>
                    {% endfor %}
                  </tbody>
                </table>
              </div>
                </div>
              </div>
            {% else %}
              <div class="alert alert-info">
                <span class="material-symbols-outlined me-2" style="vertical-align: middle;">info</span>No students have claimed accounts in {{ class_label(block) }} yet.
              </div>
            {% endif %}
          </div>
          {% endfor %}
        </div>
      </div>
    </div>
  </div>

  <!-- BULK UPLOAD TAB -->
  <div class="tab-pane fade" id="bulk-upload" role="tabpanel">
    <div class="card shadow">
      <div class="card-header bg-success text-white">
        <h5 class="mb-0"><span class="material-symbols-outlined me-2" style="vertical-align: middle;">cloud_upload</span>Bulk Student Upload</h5>
      </div>
      <div class="card-body">
        <div class="row">
          <div class="col-lg-6 mb-4">
            <div class="card border-primary h-100">
                <div class="card-header bg-primary bg-opacity-10">
                  <h6 class="mb-0 text-white"><span class="material-symbols-outlined me-2 align-middle">info</span>Instructions</h6>
                </div>
              <div class="card-body">
                <ol class="mb-3">
                  <li class="mb-2">Download the CSV template using the button below</li>
                  <li class="mb-2">Fill in student information (First Name, Last Name, Date of Birth in MM/DD/YYYY format, Class/Block)</li>
                  <li class="mb-2">Save the file as CSV format</li>
                  <li class="mb-2">Upload the completed file</li>
                </ol>
                <div class="alert alert-warning mb-0">
                  <strong><span class="material-symbols-outlined me-2" style="vertical-align: middle;">warning</span>Important:</strong>
                  <ul class="mb-0 mt-2">
                    <li>Do not modify the header row</li>
                    <li>Date of Birth must be in MM/DD/YYYY format</li>
                    <li>Duplicate students will be automatically skipped</li>
                  </ul>
                </div>
              </div>
            </div>
          </div>
          <div class="col-lg-6 mb-4">
            <div class="card border-success h-100">
              <div class="card-header bg-success bg-opacity-10">
                <h6 class="mb-0 text-success"><span class="material-symbols-outlined me-2" style="vertical-align: middle;">cloud_upload</span>Upload File</h6>
              </div>
              <div class="card-body">
                <form action="{{ url_for('admin.upload_students') }}" method="post" enctype="multipart/form-data">
                  <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                  <div class="mb-3">
                    <label for="csv_file" class="form-label fw-bold">Select CSV File</label>
                    <input class="form-control form-control-lg"
                           type="file"
                           name="csv_file"
                           id="csv_file"
                           accept=".csv"
                           required>
                    <div class="form-text">Only .csv files are accepted</div>
                  </div>
                  <div class="d-grid gap-2">
                    <a href="{{ url_for('admin.download_csv_template') }}" class="btn btn-outline-primary">
                      <span class="material-symbols-outlined me-2" style="vertical-align: middle;">download</span>Download Template
                    </a>
                    <button type="submit" class="btn btn-success btn-lg">
                      <span class="material-symbols-outlined me-2" style="vertical-align: middle;">cloud_upload</span>Upload Students
                    </button>
                  </div>
                </form>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- INDIVIDUAL UPLOAD TAB -->
  <div class="tab-pane fade" id="individual-upload" role="tabpanel">
    <div class="card shadow">
      <div class="card-header bg-primary text-white">
        <h5 class="mb-0"><span class="material-symbols-outlined me-2" style="vertical-align: middle;">person_add</span>Add Individual Student</h5>
      </div>
      <div class="card-body">
        <div class="row justify-content-center">
          <div class="col-lg-8">
            <form action="{{ url_for('admin.add_individual_student') }}" method="post">
              <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">

              <div class="card  mb-3">
                <div class="card-header bg-primary bg-opacity-10">
                  <h6 class="mb-0 text-white"><span class="material-symbols-outlined me-2" style="vertical-align: middle;">person</span>Student Information</h6>
                </div>
                <div class="card-body">
                  <div class="row">
                    <div class="col-md-6 mb-3">
                      <label for="first_name" class="form-label fw-bold">First Name <span class="text-danger">*</span></label>
                      <input type="text" class="form-control" id="first_name" name="first_name" required>
                    </div>
                    <div class="col-md-6 mb-3">
                      <label for="last_name" class="form-label fw-bold">Last Name <span class="text-danger">*</span></label>
                      <input type="text" class="form-control" id="last_name" name="last_name" required>
                    </div>
                  </div>
                  <div class="row">
                    <div class="col-md-6 mb-3">
                      <label for="dob" class="form-label fw-bold">Date of Birth <span class="text-danger">*</span></label>
                      <input type="text"
                             class="form-control"
                             id="dob"
                             name="dob"
                             placeholder="MM/DD/YYYY"
                             pattern="\d{2}/\d{2}/\d{4}"
                             required>
                      <div class="form-text">Format: MM/DD/YYYY</div>
                    </div>
                    <div class="col-md-6 mb-3">
                      <label for="block" class="form-label fw-bold">Class <span class="text-danger">*</span></label>
                      <select class="form-select" id="block" name="block" required>
                        <option value="">Select a block...</option>
                        {% for block in blocks %}
                        {% if block != "Unassigned" %}
                        <option value="{{ block }}">{{ class_label(block) }}</option>
                        {% endif %}
                        {% endfor %}
                      </select>
                    </div>
                  </div>
                </div>
              </div>

              <div class="d-grid">
                <button type="submit" class="btn btn-info btn-lg">
                  <span class="material-symbols-outlined me-2" style="vertical-align: middle;">person_add</span>Add Student
                </button>
              </div>
            </form>
          </div>
        </div>
      </div>
    </div>
  </div>

</div>

<!-- Edit Student Modal -->
<div class="modal fade" id="editStudentModal" tabindex="-1" aria-labelledby="editStudentModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <form action="{{ url_for('admin.edit_student') }}" method="post">
      <div class="modal-content">
        <div class="modal-header bg-primary text-white">
          <h5 class="modal-title" id="editStudentModalLabel">
            <i class="bi bi-pencil me-2"></i>Edit Student
          </h5>
          <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
          <input type="hidden" id="edit_student_id" name="student_id">

          <!-- Basic Information -->
          <div class="card border-primary mb-3">
            <div class="card-header bg-primary bg-opacity-10">
              <h6 class="mb-0 text-primary"><span class="material-symbols-outlined me-2" style="vertical-align: middle;">person</span>Basic Information</h6>
            </div>
            <div class="card-body">
              <div class="row">
                <div class="col-md-6 mb-3">
                  <label for="edit_first_name" class="form-label fw-bold">First Name</label>
                  <input type="text" class="form-control" id="edit_first_name" name="first_name" required>
                  <div class="form-text">Used for account claim process</div>
                </div>
                <div class="col-md-6 mb-3">
                  <label for="edit_last_name" class="form-label fw-bold">Last Name</label>
                  <input type="text" class="form-control" id="edit_last_name" name="last_name" required>
                  <div class="form-text">First letter will become last initial</div>
                </div>
              </div>
              <div class="mb-3">
                <label for="edit_dob_sum" class="form-label fw-bold">DOB Sum (Optional)</label>
                <input type="number" class="form-control" id="edit_dob_sum" name="dob_sum">
                <div class="form-text">Sum of DOB components (MM + DD + YYYY). Leave blank to keep unchanged.</div>
              </div>
            </div>
          </div>

          <!-- Class Assignment -->
          <div class="card border-info mb-3">
            <div class="card-header bg-info bg-opacity-10">
              <h6 class="mb-0 text-info"><span class="material-symbols-outlined me-2" style="vertical-align: middle;">calendar_today</span>Class Assignment</h6>
            </div>
            <div class="card-body">
              <p class="text-muted small mb-2">Select all blocks this student attends (can select multiple):</p>
              <div class="row">
                {% for block in blocks %}
                {% if block != "Unassigned" %}
                <div class="col-6 col-md-4 mb-2">
                  <div class="form-check">
                    <input class="form-check-input block-checkbox" type="checkbox" name="blocks" value="{{ block }}" id="edit_block_{{ block }}">
                    <label class="form-check-label" for="edit_block_{{ block }}">
                      {{ class_label(block) }}
                    </label>
                  </div>
                </div>
                {% endif %}
                {% endfor %}
              </div>
              <div class="form-text">At least one block must be selected (uncheck all to mark as unassigned)</div>
            </div>
          </div>

          <!-- Login Management -->
          <div class="card border-warning mb-3">
            <div class="card-header bg-warning bg-opacity-10">
              <h6 class="mb-0 text-warning"><span class="material-symbols-outlined me-2" style="vertical-align: middle;">key</span>Login Management</h6>
            </div>
            <div class="card-body">
              <div class="d-flex justify-content-between align-items-center">
                <div>
                  <p class="mb-1 fw-bold">Reset Student Login</p>
                  <p class="text-muted small mb-0">Forces student to go through account claim process again. Account data will be preserved.</p>
                </div>
                <div class="form-check form-switch">
                  <input class="form-check-input" type="checkbox" id="edit_reset_login" name="reset_login" role="switch">
                  <label class="form-check-label" for="edit_reset_login">Reset</label>
                </div>
              </div>
              <div class="alert alert-warning mt-3 mb-0" id="reset_login_warning" style="display:none;">
                <small><span class="material-symbols-outlined me-2" style="vertical-align: middle;">warning</span>Student will need to re-claim their account using their name and DOB.</small>
              </div>
            </div>
          </div>

          <div class="alert alert-info mb-0">
            <small><span class="material-symbols-outlined me-2" style="vertical-align: middle;">info</span><strong>Note:</strong> Changing the name will update what the student needs to enter during the account claim process.</small>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="submit" class="btn btn-primary">Save Changes</button>
        </div>
      </div>
    </form>
  </div>
</div>

<!-- Delete Student Modal -->
<div class="modal fade" id="deleteStudentModal" tabindex="-1" aria-labelledby="deleteStudentModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <form action="{{ url_for('admin.delete_student') }}" method="post">
      <div class="modal-content">
        <div class="modal-header bg-danger text-white">
          <h5 class="modal-title" id="deleteStudentModalLabel">
            <span class="material-symbols-outlined me-2" style="vertical-align: middle;">warning</span>Delete Student
          </h5>
          <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
          <input type="hidden" id="delete_student_id" name="student_id">

          <div class="alert alert-danger">
            <h6><span class="material-symbols-outlined me-2" style="vertical-align: middle;">warning</span>Warning</h6>
            <p>You are about to delete <strong id="delete_student_name"></strong>.</p>
            <p class="mb-0">This action will permanently delete:</p>
            <ul class="mb-0">
              <li>All transaction history</li>
              <li>All attendance records</li>
              <li>All purchased items</li>
              <li>All other student data</li>
            </ul>
          </div>

          <p class="mb-3">Type <strong class="text-danger">DELETE</strong> to confirm:</p>
          <input type="text" class="form-control" id="delete_confirmation" name="confirmation" required>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="submit" class="btn btn-danger">Delete Permanently</button>
        </div>
      </div>
    </form>
  </div>
</div>

{% endblock %}

{% block extra_scripts %}
<script>
console.log('üìù Script block executing (before DOMContentLoaded)');

// Join Code Copy Function
function copyJoinCode(code, btn) {
  navigator.clipboard.writeText(code).then(function() {
    // Show success feedback
    const originalHTML = btn.innerHTML;
    btn.innerHTML = '<span class="material-symbols-outlined" style="vertical-align: middle;">check</span> Copied!';
    btn.classList.remove('btn-outline-success');
    btn.classList.add('btn-success');

    setTimeout(function() {
      btn.innerHTML = originalHTML;
      btn.classList.remove('btn-success');
      btn.classList.add('btn-outline-success');
    }, 2000);
  }).catch(function(err) {
    console.error('Failed to copy: ', err);
    alert('Failed to copy join code. Please copy manually.');
  });
}

document.addEventListener('DOMContentLoaded', function() {
  // Attach event listeners to join code copy buttons
  document.querySelectorAll('.join-code-copy-btn').forEach(function(btn) {
    btn.addEventListener('click', function(event) {
      const code = this.getAttribute('data-join-code');
      copyJoinCode(code, this);
    });
  });
  console.log('üöÄ Student management page scripts loaded (inside DOMContentLoaded)');

  // Edit Student Modal
  const editModal = document.getElementById('editStudentModal');
  if (editModal) {
    editModal.addEventListener('show.bs.modal', event => {
      const button = event.relatedTarget;
      const studentId = button.getAttribute('data-student-id');
      const firstName = button.getAttribute('data-student-name');
      const lastInitial = button.getAttribute('data-student-last-initial');
      const blocksStr = button.getAttribute('data-student-block');
      const dobSum = button.getAttribute('data-student-dob-sum');

      // Populate basic fields
      editModal.querySelector('#edit_student_id').value = studentId;
      editModal.querySelector('#edit_first_name').value = firstName;
      editModal.querySelector('#edit_last_name').value = lastInitial; // Show just the initial, teacher can expand
      editModal.querySelector('#edit_dob_sum').value = dobSum || '';

      // Uncheck all blocks first
      editModal.querySelectorAll('.block-checkbox').forEach(cb => cb.checked = false);

      // Check the appropriate blocks (handle comma-separated list)
      if (blocksStr) {
        const blocks = blocksStr.split(',').map(b => b.trim().toUpperCase());
        blocks.forEach(block => {
          const checkbox = editModal.querySelector(`#edit_block_${block.toLowerCase()}`);
          if (checkbox) {
            checkbox.checked = true;
          }
        });
      }

      // Reset login checkbox and warning
      const resetLoginCheckbox = editModal.querySelector('#edit_reset_login');
      const resetLoginWarning = editModal.querySelector('#reset_login_warning');
      if (resetLoginCheckbox) {
        resetLoginCheckbox.checked = false;
        if (resetLoginWarning) {
          resetLoginWarning.style.display = 'none';
        }
      }
    });

    // Show/hide warning when reset login checkbox is toggled
    const resetLoginCheckbox = editModal.querySelector('#edit_reset_login');
    const resetLoginWarning = editModal.querySelector('#reset_login_warning');
    if (resetLoginCheckbox && resetLoginWarning) {
      resetLoginCheckbox.addEventListener('change', function() {
        resetLoginWarning.style.display = this.checked ? 'block' : 'none';
      });
    }
  }

  // Delete Student Modal
  const deleteModal = document.getElementById('deleteStudentModal');
  console.log('üóëÔ∏è Delete modal element:', deleteModal);

  if (deleteModal) {
    console.log('‚úÖ Delete modal found, attaching event listeners');
    deleteModal.addEventListener('show.bs.modal', event => {
      const button = event.relatedTarget;
      const studentId = button.getAttribute('data-student-id');
      const studentName = button.getAttribute('data-student-name');

      console.log('Delete modal opening:', { studentId, studentName });

      const studentIdField = deleteModal.querySelector('#delete_student_id');
      const studentNameField = deleteModal.querySelector('#delete_student_name');
      const confirmationField = deleteModal.querySelector('#delete_confirmation');

      if (studentIdField) {
        studentIdField.value = studentId;
        console.log('Set student_id field to:', studentIdField.value);
      } else {
        console.error('Could not find #delete_student_id field');
      }

      if (studentNameField) {
        studentNameField.textContent = studentName;
      } else {
        console.error('Could not find #delete_student_name field');
      }

      if (confirmationField) {
        confirmationField.value = '';
      } else {
        console.error('Could not find #delete_confirmation field');
      }
    });

    // Add form submit debugging
    const deleteForm = deleteModal.querySelector('form');
    if (deleteForm) {
      deleteForm.addEventListener('submit', function(e) {
        const formData = new FormData(deleteForm);
        console.log('Delete form submitting with data:');
        for (let [key, value] of formData.entries()) {
          console.log(`  ${key}: ${value}`);
        }
      });
    }
  } else {
    console.error('‚ùå Delete modal not found in DOM');
  }

  console.log('‚úÖ All student management scripts initialized');
});

// -------------------- BULK DELETE FUNCTIONS --------------------

function toggleSelectAll(block, checkbox) {
  const table = document.getElementById(`students-table-${block}`);
  const checkboxes = table.querySelectorAll('.student-checkbox');
  checkboxes.forEach(cb => cb.checked = checkbox.checked);
  updateBulkToolbar(block);
}

function updateBulkToolbar(block) {
  const table = document.getElementById(`students-table-${block}`);
  const checkboxes = table.querySelectorAll('.student-checkbox:checked');
  const toolbar = document.getElementById(`bulk-toolbar-${block}`);
  const count = checkboxes.length;

  if (count > 0) {
    toolbar.classList.remove('d-none');
    toolbar.querySelector('.selected-count').textContent = count;
  } else {
    toolbar.classList.add('d-none');
  }
}

function clearSelection(block) {
  const table = document.getElementById(`students-table-${block}`);
  const checkboxes = table.querySelectorAll('.student-checkbox');
  checkboxes.forEach(cb => cb.checked = false);
  table.querySelector('.select-all-checkbox').checked = false;
  updateBulkToolbar(block);
}

function bulkDeleteStudents(block) {
  const table = document.getElementById(`students-table-${block}`);
  const checkboxes = table.querySelectorAll('.student-checkbox:checked');
  const studentIds = Array.from(checkboxes).map(cb => cb.value);

  if (studentIds.length === 0) {
    alert('Please select at least one student to delete.');
    return;
  }

  const count = studentIds.length;
  const confirmation = confirm(
    `‚ö†Ô∏è WARNING: You are about to permanently delete ${count} student(s) and ALL their data:\n\n` +
    `‚Ä¢ All transactions and balances\n` +
    `‚Ä¢ All attendance records\n` +
    `‚Ä¢ All hall pass logs\n` +
    `‚Ä¢ All purchases and items\n\n` +
    `This action CANNOT be undone!\n\n` +
    `Type "DELETE" in the next prompt to confirm.`
  );

  if (!confirmation) return;

  const confirmText = prompt(`Type "DELETE" to confirm deletion of ${count} student(s):`);
  if (confirmText !== 'DELETE') {
    alert('Deletion cancelled. You must type "DELETE" exactly to confirm.');
    return;
  }

  // Send bulk delete request
  fetch('/admin/students/bulk-delete', {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
      'X-CSRFToken': document.querySelector('meta[name="csrf-token"]')?.getAttribute('content')
    },
    body: JSON.stringify({ student_ids: studentIds })
  })
  .then(response => response.json())
  .then(data => {
    if (data.status === 'success') {
      alert(data.message);
      location.reload();
    } else {
      alert('Error: ' + data.message);
    }
  })
  .catch(error => {
    console.error('Error:', error);
    alert('Network error occurred while deleting students.');
  });
}

function deleteEntireBlock(block) {
  const table = document.getElementById(`students-table-${block}`);
  const allRows = table.querySelectorAll('.student-row');
  const count = allRows.length;

  if (count === 0) {
    alert('No students in this block to delete.');
    return;
  }

  const confirmation = confirm(
    `‚ö†Ô∏è CRITICAL WARNING: You are about to permanently delete ALL ${count} students in Block ${block.toUpperCase()} and ALL their data:\n\n` +
    `‚Ä¢ All transactions and balances\n` +
    `‚Ä¢ All attendance records\n` +
    `‚Ä¢ All hall pass logs\n` +
    `‚Ä¢ All purchases and items\n\n` +
    `This action CANNOT be undone!\n\n` +
    `Type "DELETE BLOCK ${block.toUpperCase()}" in the next prompt to confirm.`
  );

  if (!confirmation) return;

  const confirmText = prompt(`Type "DELETE BLOCK ${block.toUpperCase()}" to confirm:`);
  if (confirmText !== `DELETE BLOCK ${block.toUpperCase()}`) {
    alert('Deletion cancelled. You must type the exact confirmation text.');
    return;
  }

  // Send block delete request
  fetch('/admin/students/delete-block', {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
      'X-CSRFToken': document.querySelector('meta[name="csrf-token"]')?.getAttribute('content')
    },
    body: JSON.stringify({ block: block })
  })
  .then(response => response.json())
  .then(data => {
    if (data.status === 'success') {
      alert(data.message);
      location.reload();
    } else {
      alert('Error: ' + data.message);
    }
  })
  .catch(error => {
    console.error('Error:', error);
    alert('Network error occurred while deleting block.');
  });
}

function deletePendingStudent(teacherBlockId, studentName) {
  const confirmation = confirm(
    `‚ö†Ô∏è Are you sure you want to delete the pending roster entry for ${studentName}?\n\n` +
    `This student has not yet claimed their account. This action will remove them from your roster.\n\n` +
    `This action CANNOT be undone!`
  );

  if (!confirmation) return;

  // Send delete request
  fetch('/admin/pending-students/delete', {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
      'X-CSRFToken': document.querySelector('meta[name="csrf-token"]')?.getAttribute('content')
    },
    body: JSON.stringify({ teacher_block_id: teacherBlockId })
  })
  .then(response => response.json())
  .then(data => {
    if (data.status === 'success') {
      alert(data.message);
      location.reload();
    } else {
      alert('Error: ' + data.message);
    }
  })
  .catch(error => {
    console.error('Error:', error);
    alert('Network error occurred while deleting pending student.');
  });
}

function deleteAllPendingInBlock(block, unclaimedSeatsCount, unclaimedStudentsCount) {
  const totalCount = unclaimedSeatsCount + unclaimedStudentsCount;
  const confirmation = confirm(
    `‚ö†Ô∏è WARNING: You are about to delete ALL ${totalCount} unclaimed roster entries in Block ${block.toUpperCase()}.\n\n` +
    `This includes:\n` +
    `‚Ä¢ ${unclaimedSeatsCount} unclaimed seat(s) (TeacherBlock entries)\n` +
    `‚Ä¢ ${unclaimedStudentsCount} legacy unclaimed student(s) (Students without usernames)\n\n` +
    `These are students who have been added to your roster but haven't claimed their accounts yet.\n\n` +
    `Students who have already claimed their accounts will NOT be affected.\n\n` +
    `This action CANNOT be undone!\n\n` +
    `Are you sure you want to continue?`
  );

  if (!confirmation) return;

  // Helper function to delete a type of unclaimed students
  const deleteUnclaimedType = (endpoint, errorPrefix) => {
    return fetch(endpoint, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'X-CSRFToken': document.querySelector('meta[name="csrf-token"]')?.getAttribute('content')
      },
      body: JSON.stringify({ block: block })
    })
    .then(response => response.json())
    .then(data => {
      if (data.status === 'success') {
        return data.deleted_count;
      } else {
        throw new Error(`${errorPrefix}: ${data.message}`);
      }
    });
  };

  // Use Promise.all to delete both types in parallel
  const promises = [];
  
  // Delete pending TeacherBlock entries if any
  if (unclaimedSeatsCount > 0) {
    promises.push(deleteUnclaimedType('/admin/pending-students/bulk-delete', 'Pending students'));
  }
  
  // Delete legacy unclaimed students if any
  if (unclaimedStudentsCount > 0) {
    promises.push(deleteUnclaimedType('/admin/legacy-unclaimed-students/bulk-delete', 'Legacy unclaimed students'));
  }
  
  // Wait for all deletions to complete
  Promise.all(promises)
    .then(deletedCounts => {
      const totalDeleted = deletedCounts.reduce((sum, count) => sum + count, 0);
      alert(`‚úì Successfully deleted ${totalDeleted} unclaimed student(s) from Block ${block.toUpperCase()}`);
      location.reload();
    })
    .catch(error => {
      console.error('Error:', error);
      alert('Error: ' + error.message);
      location.reload(); // Reload anyway to show current state
    });
}

function tapOutSelected(block) {
  const table = document.getElementById(`students-table-${block}`);
  const checkboxes = table.querySelectorAll('.student-checkbox:checked');
  const studentIds = Array.from(checkboxes).map(cb => parseInt(cb.value));

  if (studentIds.length === 0) {
    alert('Please select at least one student to tap out.');
    return;
  }

  const count = studentIds.length;
  const confirmation = confirm(
    `Are you sure you want to tap out ${count} selected student(s) from Block ${block.toUpperCase()}?\n\n` +
    `This will mark them as inactive for this period.`
  );

  if (!confirmation) return;

  // Call the tap-out API
  fetch('/admin/tap-out-students', {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
      'X-CSRFToken': document.querySelector('meta[name="csrf-token"]')?.getAttribute('content')
    },
    body: JSON.stringify({
      student_ids: studentIds,
      period: block.toUpperCase(),
      reason: 'Teacher tap-out (selected students)'
    })
  })
  .then(response => response.json())
  .then(data => {
    if (data.status === 'success') {
      let message = data.message;
      if (data.tapped_out && data.tapped_out.length > 0) {
        message += '\n\nTapped out:\n' + data.tapped_out.join(', ');
      }
      if (data.already_inactive && data.already_inactive.length > 0) {
        message += '\n\nAlready inactive:\n' + data.already_inactive.join(', ');
      }
      if (data.errors && data.errors.length > 0) {
        message += '\n\nErrors:\n' + data.errors.join('\n');
      }
      alert(message);
      // Clear selection after tap-out
      clearSelection(block);
    } else {
      alert('Error: ' + data.message);
    }
  })
  .catch(error => {
    console.error('Error:', error);
    alert('Network error occurred while tapping out students.');
  });
}

function tapOutAllBlock(block) {
  const table = document.getElementById(`students-table-${block}`);
  const allRows = table.querySelectorAll('.student-row');
  const count = allRows.length;

  if (count === 0) {
    alert('No students in this block to tap out.');
    return;
  }

  const confirmation = confirm(
    `Are you sure you want to tap out ALL active students in Block ${block.toUpperCase()}?\n\n` +
    `This will mark all currently active students as inactive for this period.`
  );

  if (!confirmation) return;

  // Call the tap-out API with tap_out_all flag
  fetch('/admin/tap-out-students', {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
      'X-CSRFToken': document.querySelector('meta[name="csrf-token"]')?.getAttribute('content')
    },
    body: JSON.stringify({
      tap_out_all: true,
      period: block.toUpperCase(),
      reason: 'Teacher tap-out (entire block)'
    })
  })
  .then(response => response.json())
  .then(data => {
    if (data.status === 'success') {
      let message = data.message;
      if (data.tapped_out && data.tapped_out.length > 0) {
        message += '\n\nTapped out:\n' + data.tapped_out.join(', ');
      }
      if (data.already_inactive && data.already_inactive.length > 0) {
        message += '\n\nAlready inactive:\n' + data.already_inactive.join(', ');
      }
      if (data.errors && data.errors.length > 0) {
        message += '\n\nErrors:\n' + data.errors.join('\n');
      }
      alert(message);
    } else {
      alert('Error: ' + data.message);
    }
  })
  .catch(error => {
    console.error('Error:', error);
    alert('Network error occurred while tapping out block.');
  });
}

// (Tap toggle controls moved to Attendance page)
</script>
{% endblock %}
