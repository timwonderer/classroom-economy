{% extends "layout_admin.html" %}
{% set page_title = "Student Overview by Block" %}
{% block title %}Student Overview by Block{% endblock %}
{% block content %}
    <div class="mb-3">
        
        <p class="text-muted">View all students in a specific block, including their passes left, checking balance, and last tap in/out times.</p>
    </div>

    <div class="card mb-4 p-3 bg-light">
        <h5 class="mb-3">Bulk Student Upload</h5>
        <p class="text-muted mb-3">You can upload a CSV file to add or update students in the system. Please click Download CSV Template to use the custom template.</p>
        <p class="text-muted mb-3">If you are using your own CSV file, please ensure it includes the following columns: First Name, Last Name, Date of Birth (DD/MM/YYYY), and Period/Block</p>
            <a href="{{ url_for('download_csv_template') }}" class="btn btn-secondary me-3 mb-2">
                Download CSV Template
            </a>
            <button class="btn btn-primary mb-2" data-bs-toggle="modal" data-bs-target="#uploadModal">
                Upload Students CSV
            </button>
        </div>
    </div>

<!-- Upload Modal -->
<div class="modal fade" id="uploadModal" tabindex="-1" aria-labelledby="uploadModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="uploadModalLabel">Upload Students CSV</h5>
      </div>
      <form action="{{ url_for('admin_upload_students') }}" method="post" enctype="multipart/form-data">
        {{ csrf_token() }}
        <div class="modal-body">
          <div class="mb-3">
            <label for="csv_file" class="form-label">Select CSV file:</label>
            <input class="form-control" type="file" name="csv_file" id="csv_file" accept=".csv" required onchange="document.getElementById('file-chosen').textContent = this.files[0]?.name || 'No file chosen';">
            <div id="file-chosen" class="form-text mt-1">No file chosen</div>
          </div>
          <p class="small text-muted">Please check your CSV file to ensure it includes First Name, Last Name, Date of Birth (DD/MM/YYYY), and Period/Block in the appropriate columns as designated in the template</p>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Clear Upload</button>
          <button type="submit" class="btn btn-primary">Upload</button>
        </div>
      </form>
    </div>
  </div>
</div>
    

    <div class="mb-3">
        <label for="block-select">Filter by Block:</label>
        <select id="block-select" onchange="changeBlock()" class="form-select mb-3" style="width: 200px;" aria-label="Select Block">
            {% for block in blocks %}
            <option value="{{ block }}" {% if block == selected_block %}selected{% endif %}>Block {{ block }}</option>
            {% endfor %}
        </select>
    </div>

    <script>
        function changeBlock() {
            
            let block = document.getElementById("block-select").value;
            window.location.href = "/admin/students?block=" + block;
        }
    </script>

    <table class="table table-bordered table-striped table-hover">
        <thead class="table-dark">
            <tr>
                <th>Name</th>
                <th>Passes Left</th>
                <th>Checking Balance</th>
                <th>Last Tap In</th>
                <th>Last Tap Out</th>
                <th>Reason</th>
            </tr>
        </thead>
        <tbody>
            {% for student in students %}
            <tr>
                <td>
                    <a href="{{ url_for('student_detail', student_id=student.id) }}">
                        {{ student.full_name }}
                    </a>
                </td>
                <td>{{ student.passes_left if student.passes_left is not none else '—' }}</td>
                <td>${{ "%.2f"|format(student.checking_balance) }}</td>
                <td>
                    {% if student.last_tap_in %}
                        {{ student.last_tap_in|format_datetime }}
                    {% else %}
                        —
                    {% endif %}
                </td>
                <td>
                    {% if student.last_tap_out %}
                        {{ student.last_tap_out|format_datetime }}
                    {% else %}
                        —
                    {% endif %}
                </td>
                <td>
                  {% if student.last_tap_out_reason %}
                    {{ student.last_tap_out_reason }}
                  {% else %}
                    —
                  {% endif %}
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
{% endblock %}
