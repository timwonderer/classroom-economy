{% extends "layout_admin.html" %}

{% block content %}
<div class="container-fluid">
    <h2 class="mb-4"><i class="bi bi-life-preserver me-2"></i>Help & Support</h2>

    <!-- Tabs -->
    <ul class="nav nav-tabs mb-4" id="helpTabs" role="tablist">
        <li class="nav-item" role="presentation">
            <button class="nav-link active" id="kb-tab" data-bs-toggle="tab" data-bs-target="#kb" type="button" role="tab" aria-controls="kb" aria-selected="true">
                <i class="bi bi-book-half me-2"></i>Knowledge Base
            </button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="report-tab" data-bs-toggle="tab" data-bs-target="#report" type="button" role="tab" aria-controls="report" aria-selected="false">
                <i class="bi bi-bug-fill me-2"></i>Report an Issue
            </button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="myreports-tab" data-bs-toggle="tab" data-bs-target="#myreports" type="button" role="tab" aria-controls="myreports" aria-selected="false">
                <i class="bi bi-list-ul me-2"></i>My Reports
            </button>
        </li>
    </ul>

    <div class="tab-content" id="helpTabsContent">
        <!-- Knowledge Base Tab -->
        <div class="tab-pane fade show active" id="kb" role="tabpanel" aria-labelledby="kb-tab">
            <div class="row g-4">
                <!-- Quick Start -->
                <div class="col-lg-6">
                    <div class="card shadow-sm h-100">
                        <div class="card-header bg-info text-white">
                            <h5 class="mb-0"><i class="bi bi-rocket-takeoff-fill me-2"></i>Quick Start Guide</h5>
                        </div>
                        <div class="card-body">
                            <ol class="list-group list-group-numbered list-group-flush">
                                <li class="list-group-item">
                                    <strong>Add Students:</strong> Go to the <a href="{{ url_for('admin.students') }}">Students</a> page. Upload your roster CSV or add students manually. Share the generated Join Codes with your students.
                                </li>
                                <li class="list-group-item">
                                    <strong>Set Up Payroll:</strong> Configure pay rates (e.g., $15/hr) in <a href="{{ url_for('admin.payroll') }}">Payroll Settings</a>. Run payroll periodically to pay students for attendance.
                                </li>
                                <li class="list-group-item">
                                    <strong>Stock the Store:</strong> Add items in <a href="{{ url_for('admin.store_management') }}">Store Management</a>. Use "Delayed" items for physical rewards that require redemption.
                                </li>
                                <li class="list-group-item">
                                    <strong>Enable Rent:</strong> In <a href="{{ url_for('admin.rent_settings') }}">Rent Settings</a>, enable rent to simulate real-world expenses.
                                </li>
                                <li class="list-group-item">
                                    <strong>Create Insurance:</strong> Offer protection plans in the <a href="{{ url_for('admin.insurance_management') }}">Insurance</a> tab.
                                </li>
                            </ol>
                        </div>
                    </div>
                </div>

                <!-- FAQ / Self Help -->
                <div class="col-lg-6">
                    <div class="card shadow-sm h-100">
                        <div class="card-header bg-secondary text-white">
                            <h5 class="mb-0"><i class="bi bi-question-circle-fill me-2"></i>Frequently Asked Questions</h5>
                        </div>
                        <div class="card-body">
                            <div class="accordion" id="faqAccordion">
                                <div class="accordion-item">
                                    <h2 class="accordion-header" id="headingOne">
                                        <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseOne" aria-expanded="false" aria-controls="collapseOne">
                                            How do students log in?
                                        </button>
                                    </h2>
                                    <div id="collapseOne" class="accordion-collapse collapse" aria-labelledby="headingOne" data-bs-parent="#faqAccordion">
                                        <div class="accordion-body">
                                            Students use the <strong>Join Code</strong> (found on the Students page) to claim their account. They will then set their own Username, PIN, and Passphrase.
                                        </div>
                                    </div>
                                </div>
                                <div class="accordion-item">
                                    <h2 class="accordion-header" id="headingTwo">
                                        <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseTwo" aria-expanded="false" aria-controls="collapseTwo">
                                            How do I reset a student's PIN?
                                        </button>
                                    </h2>
                                    <div id="collapseTwo" class="accordion-collapse collapse" aria-labelledby="headingTwo" data-bs-parent="#faqAccordion">
                                        <div class="accordion-body">
                                            Go to the Student Detail page and click "Edit Student". There is an option to "Reset Login", which will require the student to re-claim their account and set a new PIN.
                                        </div>
                                    </div>
                                </div>
                                <div class="accordion-item">
                                    <h2 class="accordion-header" id="headingThree">
                                        <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseThree" aria-expanded="false" aria-controls="collapseThree">
                                            Can I undo a transaction?
                                        </button>
                                    </h2>
                                    <div id="collapseThree" class="accordion-collapse collapse" aria-labelledby="headingThree" data-bs-parent="#faqAccordion">
                                        <div class="accordion-body">
                                            Yes. Go to <a href="{{ url_for('admin.banking') }}">Banking</a>, find the transaction, and click the "Void" button.
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Classroom Economy Guide -->
            <div class="row g-4 mt-2">
                <div class="col-12">
                    <div class="card shadow-sm">
                        <div class="card-header bg-success text-white">
                            <h5 class="mb-0"><i class="bi bi-graph-up-arrow me-2"></i>Classroom Economy Monetary System — Teacher Guide</h5>
                        </div>
                        <div class="card-body">
                            <p class="lead">This guide explains the logic behind how the Classroom Economy App handles money, prices, and financial decisions. It is designed to help you set fair, consistent numbers across your classes—even if each class has different wages or economic conditions.</p>

                            <hr>

                            <h6 class="fw-bold mt-4"><i class="bi bi-1-circle-fill me-2"></i>How the System Is Anchored</h6>
                            <p>Every class has a different schedule, different behavior patterns, and different needs. Instead of using a fixed $1000/month model, the app estimates:</p>

                            <div class="alert alert-info">
                                <h6 class="fw-bold"><i class="bi bi-graph-up-arrow me-2"></i>Classroom Wage Index (CWI)</h6>
                                <p class="mb-0"><strong>CWI = What a student earns in one week if they attend fully.</strong></p>
                                <p class="mb-0 mt-2">This becomes the baseline for all pricing in your simulated economy.</p>
                                <p class="mb-0 mt-2">Because everything is proportional to the CWI, you can adjust wages or create inflation without breaking the system.</p>
                            </div>

                            <hr>

                            <h6 class="fw-bold mt-4"><i class="bi bi-2-circle-fill me-2"></i>How Prices Stay Fair and Understandable</h6>
                            <p>The system follows several principles to keep the economy realistic but not overwhelming:</p>

                            <h6 class="fw-bold mt-3">2.1 Reasonable Trade-Offs</h6>
                            <p>Prices should push students to make choices:</p>
                            <ul>
                                <li>buy insurance vs. risk paying out-of-pocket</li>
                                <li>save vs. spend</li>
                                <li>invest vs. borrow</li>
                            </ul>
                            <p>But no single mistake should ruin them.</p>

                            <h6 class="fw-bold mt-3">2.2 Proportional Pricing</h6>
                            <p>Rent, store items, fines, and insurance all scale relative to weekly earnings. This ensures fairness even when different classes earn different amounts.</p>

                            <h6 class="fw-bold mt-3">2.3 Predictable Cost Structure</h6>
                            <p>Every major cost has a recommended ratio to the CWI (explained below). This keeps your economy internally consistent and easy to explain to students.</p>

                            <hr>

                            <h6 class="fw-bold mt-4"><i class="bi bi-3-circle-fill me-2"></i>Recommended Ratios for Pricing</h6>
                            <p>These ratios work for nearly all classes and automatically adjust when you change wages.</p>

                            <div class="table-responsive mt-3">
                                <table class="table table-bordered">
                                    <thead class="table-light">
                                        <tr>
                                            <th>Category</th>
                                            <th>Recommended Range</th>
                                            <th>Purpose</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr>
                                            <td><strong>Rent</strong></td>
                                            <td>2.0–2.5 × CWI</td>
                                            <td>Significant but manageable</td>
                                        </tr>
                                        <tr>
                                            <td><strong>Utilities / Taxes</strong></td>
                                            <td>0.2–0.3 × CWI</td>
                                            <td>Small but recurring</td>
                                        </tr>
                                        <tr>
                                            <td><strong>Insurance Premium</strong></td>
                                            <td>5–12% of CWI</td>
                                            <td>Worthwhile but not abusable</td>
                                        </tr>
                                        <tr>
                                            <td><strong>Fines & Penalties</strong></td>
                                            <td>5–15% of CWI</td>
                                            <td>Push responsibility, not break budgets</td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>

                            <h6 class="fw-bold mt-4">Store Item Tiers</h6>
                            <p>Organized into tiers for clarity:</p>
                            <div class="table-responsive">
                                <table class="table table-bordered">
                                    <thead class="table-light">
                                        <tr>
                                            <th>Item Tier</th>
                                            <th>% of CWI</th>
                                            <th>Typical Use</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr>
                                            <td><span class="badge bg-secondary">Basic</span></td>
                                            <td>2–5%</td>
                                            <td>pencils, small conveniences</td>
                                        </tr>
                                        <tr>
                                            <td><span class="badge bg-primary">Standard</span></td>
                                            <td>5–10%</td>
                                            <td>bathroom pass, late pass</td>
                                        </tr>
                                        <tr>
                                            <td><span class="badge bg-warning text-dark">Premium</span></td>
                                            <td>10–25%</td>
                                            <td>big perks</td>
                                        </tr>
                                        <tr>
                                            <td><span class="badge bg-danger">Luxury</span></td>
                                            <td>25–50%</td>
                                            <td>rare/auction items</td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>

                            <hr>

                            <h6 class="fw-bold mt-4"><i class="bi bi-4-circle-fill me-2"></i>Inflation and Dynamic Economy Options</h6>
                            <p>You may choose to simulate economic events:</p>
                            <ul>
                                <li>inflation</li>
                                <li>shortages</li>
                                <li>wage freezes</li>
                                <li>price spikes</li>
                                <li>supply shocks</li>
                            </ul>
                            <div class="alert alert-warning">
                                <strong>Guidelines:</strong>
                                <ul class="mb-0">
                                    <li>Raise prices before wages (teaches real-world tension)</li>
                                    <li>Keep all categories rising proportionally</li>
                                    <li>Avoid long-term extreme inflation</li>
                                </ul>
                            </div>

                            <hr>

                            <h6 class="fw-bold mt-4"><i class="bi bi-5-circle-fill me-2"></i>Student Experience Goals</h6>
                            <p>A well-balanced economy ensures:</p>
                            <ul>
                                <li>A week of perfect attendance covers rent</li>
                                <li>Students can save at least 10–20% after living costs</li>
                                <li>High performers have opportunities to invest</li>
                                <li>Risky decisions come with teachable consequences</li>
                                <li>Loans and insurance feel meaningful but not predatory</li>
                            </ul>

                            <hr>

                            <h6 class="fw-bold mt-4"><i class="bi bi-6-circle-fill me-2"></i>Customizing Your Class Economy</h6>
                            <p>You can modify:</p>
                            <ul>
                                <li>wage rates</li>
                                <li>rent multipliers</li>
                                <li>store pricing tiers</li>
                                <li>fines</li>
                                <li>insurance premiums</li>
                                <li>inflation behavior</li>
                                <li>special events</li>
                            </ul>
                            <p class="text-muted">Because the system uses proportional pricing, it will remain fair even as you change settings.</p>

                            <hr>

                            <h6 class="fw-bold mt-4"><i class="bi bi-check2-circle me-2"></i>Quick Teacher Checklist</h6>
                            <p>Before launching:</p>
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="check1">
                                <label class="form-check-label" for="check1">Confirm your weekly wage expectation (CWI)</label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="check2">
                                <label class="form-check-label" for="check2">Set rent to 2.0–2.5× CWI</label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="check3">
                                <label class="form-check-label" for="check3">Apply store item tiers</label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="check4">
                                <label class="form-check-label" for="check4">Set insurance to 5–12% of CWI premium</label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="check5">
                                <label class="form-check-label" for="check5">Confirm fines within 5–15% of CWI</label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="check6">
                                <label class="form-check-label" for="check6">Run a "one-week budget test": Can a student survive and still save something?</label>
                            </div>

                            <div class="alert alert-success mt-4">
                                <i class="bi bi-lightbulb-fill me-2"></i>
                                <strong>Tip:</strong> You can view your current CWI and recommended settings on the <a href="{{ url_for('admin.payroll') }}" class="alert-link">Payroll Management</a> page under the Overview tab.
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Report Issue Tab -->
        <div class="tab-pane fade" id="report" role="tabpanel" aria-labelledby="report-tab">
            <div class="card shadow-sm">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0"><i class="bi bi-bug-fill me-2"></i>Report a Bug or Issue</h5>
                </div>
                <div class="card-body">
                   <div class="alert alert-info">
                        <i class="bi bi-info-circle-fill me-2"></i>
                        <strong>Your feedback matters!</strong> Help us improve the system by reporting bugs, suggesting features, or providing feedback. All reports are reviewed by the system administrator.
                    </div>

                    <form method="POST" action="{{ url_for('admin.help_support') }}">
                        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">

                        <div class="mb-3">
                            <label for="report_type" class="form-label">What would you like to report?</label>
                            <select class="form-select" id="report_type" name="report_type" required>
                                <option value="bug">Bug / Error</option>
                                <option value="suggestion">Suggestion / Feature Request</option>
                                <option value="comment">General Comment / Feedback</option>
                            </select>
                        </div>

                        <div class="mb-3" id="error_code_container">
                            <label for="error_code" class="form-label">Error Code (if applicable)</label>
                            <select class="form-select" id="error_code" name="error_code">
                                <option value="">-- Select Error Code (Optional) --</option>
                                <option value="404">404 - Page Not Found</option>
                                <option value="500">500 - Internal Server Error</option>
                                <option value="503">503 - Service Unavailable</option>
                                <option value="403">403 - Forbidden</option>
                                <option value="401">401 - Unauthorized</option>
                                <option value="400">400 - Bad Request</option>
                                <option value="other">Other Error</option>
                            </select>
                        </div>

                        <div class="mb-3">
                            <label for="title" class="form-label">Title <span class="text-danger">*</span></label>
                            <input type="text" class="form-control" id="title" name="title"
                                   placeholder="Brief summary of the issue" required maxlength="200">
                        </div>

                        <div class="mb-3">
                            <label for="description" class="form-label">Description <span class="text-danger">*</span></label>
                            <textarea class="form-control" id="description" name="description" rows="4"
                                      placeholder="Please describe what happened in detail" required></textarea>
                        </div>

                        <div class="mb-3">
                            <label for="steps_to_reproduce" class="form-label">Steps to Reproduce (for bugs)</label>
                            <textarea class="form-control" id="steps_to_reproduce" name="steps_to_reproduce" rows="3"
                                      placeholder="What did you do right before the error occurred?"></textarea>
                        </div>

                        <div class="mb-3">
                            <label for="expected_behavior" class="form-label">Expected Behavior</label>
                            <textarea class="form-control" id="expected_behavior" name="expected_behavior" rows="2"
                                      placeholder="What did you expect to happen instead?"></textarea>
                        </div>

                        <div class="mb-3">
                            <label for="page_url" class="form-label">Page URL</label>
                            <input type="text" class="form-control" id="page_url" name="page_url"
                                   placeholder="e.g., /admin/students">
                        </div>

                        <button type="submit" class="btn btn-primary">
                            <i class="bi bi-send-fill me-2"></i>Submit Report
                        </button>
                    </form>
                </div>
            </div>
        </div>

        <!-- My Reports Tab -->
        <div class="tab-pane fade" id="myreports" role="tabpanel" aria-labelledby="myreports-tab">
            <div class="card shadow-sm">
                <div class="card-body">
                    {% if my_reports %}
                        <div class="list-group">
                            {% for report in my_reports %}
                            <div class="list-group-item">
                                <div class="d-flex justify-content-between align-items-start">
                                    <div>
                                        <h6 class="mb-1">{{ report.title }}</h6>
                                        <small class="text-muted">
                                            {% if report.submitted_at %}
                                                <span class="local-timestamp" data-timestamp="{{ report.submitted_at.isoformat() }}Z"></span>
                                            {% else %}
                                                N/A
                                            {% endif %}
                                        </small>
                                    </div>
                                    <span class="badge
                                        {% if report.status == 'new' %}bg-primary
                                        {% elif report.status == 'reviewed' %}bg-info
                                        {% elif report.status == 'closed' %}bg-secondary
                                        {% else %}bg-warning{% endif %}">
                                        {{ report.status|title }}
                                    </span>
                                </div>
                                <p class="mb-1 mt-2 text-muted small">{{ report.description[:100] }}{% if report.description|length > 100 %}...{% endif %}</p>
                                {% if report.admin_notes %}
                                <div class="alert alert-info py-1 px-2 mt-2 mb-0">
                                    <i class="bi bi-chat-left-text me-1"></i> <strong>Response:</strong> {{ report.admin_notes }}
                                </div>
                                {% endif %}
                            </div>
                            {% endfor %}
                        </div>
                    {% else %}
                        <div class="text-center py-5">
                            <i class="bi bi-inbox fs-1 text-muted"></i>
                            <p class="text-muted mt-2">No reports submitted yet.</p>
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    // Show/hide error code field based on report type
    document.getElementById('report_type').addEventListener('change', function() {
        const errorCodeContainer = document.getElementById('error_code_container');
        if (this.value === 'bug') {
            errorCodeContainer.style.display = 'block';
        } else {
            errorCodeContainer.style.display = 'none';
            document.getElementById('error_code').value = '';
        }
    });
</script>
{% endblock %}
