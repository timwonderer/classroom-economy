{% extends "layout_admin.html" %}
{% set page_title = "Process Insurance Claim" %}
{% block title %}Process Claim{% endblock %}
{% block content %}

<div class="row">
  <div class="col-md-8">
    <div class="card shadow mb-4">
      <div class="card-header">
        <h5 class="mb-0">Claim Details</h5>
      </div>
      <div class="card-body">
        <dl class="row">
          <dt class="col-sm-4">Student:</dt>
          <dd class="col-sm-8">{{ claim.student.full_name }}</dd>

          <dt class="col-sm-4">Insurance Policy:</dt>
          <dd class="col-sm-8">{{ claim.policy.title }}</dd>

          <dt class="col-sm-4">Incident Date:</dt>
          <dd class="col-sm-8">{{ claim.incident_date.strftime('%B %d, %Y') }}</dd>

          <dt class="col-sm-4">Filed Date:</dt>
          <dd class="col-sm-8">{{ claim.filed_date.strftime('%B %d, %Y at %I:%M %p') }}</dd>

          <dt class="col-sm-4">Claim Amount:</dt>
          <dd class="col-sm-8">
            {% if claim.claim_amount %}
              ${{ "%.2f".format(claim.claim_amount) }}
            {% else %}
              Not specified
            {% endif %}
          </dd>

          <dt class="col-sm-4">Current Status:</dt>
          <dd class="col-sm-8">
            <span class="badge
              {% if claim.status == 'pending' %}bg-warning text-dark
              {% elif claim.status == 'approved' %}bg-success
              {% elif claim.status == 'rejected' %}bg-danger
              {% elif claim.status == 'paid' %}bg-info
              {% endif %}">
              {{ claim.status|title }}
            </span>
          </dd>
        </dl>

        <hr>

        <h6>Claim Description:</h6>
        <p class="bg-light p-3 rounded">{{ claim.description }}</p>

        {% if claim.rejection_reason %}
        <h6>Rejection Reason:</h6>
        <p class="bg-danger bg-opacity-10 p-3 rounded text-danger">{{ claim.rejection_reason }}</p>
        {% endif %}

        {% if claim.admin_notes %}
        <h6>Admin Notes:</h6>
        <p class="bg-info bg-opacity-10 p-3 rounded">{{ claim.admin_notes }}</p>
        {% endif %}
      </div>
    </div>
  </div>

  <div class="col-md-4">
    <div class="card shadow mb-4">
      <div class="card-header">
        <h5 class="mb-0">Policy Information</h5>
      </div>
      <div class="card-body">
        <p><strong>Coverage Start:</strong><br>
          {% if enrollment.coverage_start_date %}
            {{ enrollment.coverage_start_date.strftime('%B %d, %Y') }}
          {% else %}
            <span class="text-warning">Still in waiting period</span>
          {% endif %}
        </p>

        <p><strong>Waiting Period:</strong><br>
          {{ claim.policy.waiting_period_days }} days
        </p>

        <p><strong>Claim Time Limit:</strong><br>
          {{ claim.policy.claim_time_limit_days }} days from incident
        </p>

        <p><strong>Max Claim Amount:</strong><br>
          {% if claim.policy.max_claim_amount %}
            ${{ "%.2f".format(claim.policy.max_claim_amount) }}
          {% else %}
            Unlimited
          {% endif %}
        </p>

        <p><strong>Max Claims:</strong><br>
          {% if claim.policy.max_claims_count %}
            {{ claim.policy.max_claims_count }} per {{ claim.policy.max_claims_period }}
          {% else %}
            Unlimited
          {% endif %}
        </p>

        <p><strong>Premium Status:</strong><br>
          {% if enrollment.payment_current %}
            <span class="badge bg-success">Current</span>
          {% else %}
            <span class="badge bg-danger">{{ enrollment.days_unpaid }} days overdue</span>
          {% endif %}
        </p>

        <hr>

        <h6>Validation Status:</h6>
        {% if validation_errors %}
          {% for error in validation_errors %}
            <div class="alert alert-danger py-2 small">{{ error }}</div>
          {% endfor %}
        {% else %}
          <div class="alert alert-success py-2 small">âœ“ Claim meets all requirements</div>
        {% endif %}
      </div>
    </div>

    <div class="card shadow">
      <div class="card-header">
        <h5 class="mb-0">Student's Claims History</h5>
      </div>
      <div class="card-body">
        <p class="mb-2"><strong>This Policy:</strong></p>
        <ul class="small mb-3">
          <li>Pending: {{ claims_stats.pending }} claims</li>
          <li>Approved: {{ claims_stats.approved }} claims</li>
          <li>Rejected: {{ claims_stats.rejected }} claims</li>
          <li>Paid: {{ claims_stats.paid }} claims</li>
        </ul>

        {% if claim.policy.max_claims_count %}
          <p class="text-muted small">
            Used {{ claims_stats.approved + claims_stats.paid }} of {{ claim.policy.max_claims_count }} claims this {{ claim.policy.max_claims_period }}
          </p>
        {% endif %}
      </div>
    </div>
  </div>
</div>

<!-- Process Claim Form -->
<div class="card shadow">
  <div class="card-header">
    <h5 class="mb-0">Process This Claim</h5>
  </div>
  <div class="card-body">
    <form method="POST" action="{{ url_for('admin_process_claim', claim_id=claim.id) }}">
      {{ form.hidden_tag() }}

      <div class="row">
        <div class="col-md-6 mb-3">
          {{ form.status.label(class="form-label") }}
          {{ form.status(class="form-select") }}
        </div>
        <div class="col-md-6 mb-3">
          {{ form.approved_amount.label(class="form-label") }}
          <div class="input-group">
            <span class="input-group-text">$</span>
            {{ form.approved_amount(class="form-control") }}
          </div>
          <small class="text-muted">Leave blank to use requested amount</small>
        </div>
      </div>

      <div class="mb-3">
        {{ form.rejection_reason.label(class="form-label") }}
        {{ form.rejection_reason(class="form-control", rows=3) }}
        <small class="text-muted">Required if rejecting claim</small>
      </div>

      <div class="mb-3">
        {{ form.admin_notes.label(class="form-label") }}
        {{ form.admin_notes(class="form-control", rows=3) }}
      </div>

      <div class="d-flex gap-2">
        {{ form.submit(class="btn btn-primary") }}
        <a href="{{ url_for('admin_insurance_management') }}" class="btn btn-secondary">Back to Insurance</a>
      </div>
    </form>
  </div>
</div>

{% endblock %}
