{% extends "layout_admin.html" %}
{% set page_title = "Insurance Management" %}
{% set current_page = "insurance" %}
{% block title %}Insurance Management{% endblock %}
{% block page_icon %}üõ°Ô∏è{% endblock %}
{% block content %}

<!-- Nav Tabs -->
<ul class="nav nav-tabs mb-4" id="insuranceTabs" role="tablist">
  <li class="nav-item" role="presentation">
    <button class="nav-link active" id="existing-policies-tab" data-bs-toggle="tab" data-bs-target="#existing-policies" type="button" role="tab">
      <i class="bi bi-list-ul me-1"></i>Existing Policies
    </button>
  </li>
  <li class="nav-item" role="presentation">
    <button class="nav-link" id="add-policy-tab" data-bs-toggle="tab" data-bs-target="#add-policy" type="button" role="tab">
      <i class="bi bi-plus-circle me-1"></i>Add New Policy
    </button>
  </li>
  <li class="nav-item" role="presentation">
    <button class="nav-link" id="student-policies-tab" data-bs-toggle="tab" data-bs-target="#student-policies" type="button" role="tab">
      <i class="bi bi-people me-1"></i>Active Student Policies
    </button>
  </li>
  <li class="nav-item" role="presentation">
    <button class="nav-link" id="cancelled-policies-tab" data-bs-toggle="tab" data-bs-target="#cancelled-policies" type="button" role="tab">
      <i class="bi bi-archive me-1"></i>Cancelled Policies
    </button>
  </li>
  <li class="nav-item" role="presentation">
    <button class="nav-link" id="claims-tab" data-bs-toggle="tab" data-bs-target="#claims" type="button" role="tab">
      <i class="bi bi-file-text me-1"></i>Claims <span class="badge bg-warning text-dark">{{ pending_claims_count }}</span>
    </button>
  </li>
</ul>

<div class="tab-content" id="insuranceTabContent">
  <!-- EXISTING POLICIES TAB -->
  <div class="tab-pane fade show active" id="existing-policies" role="tabpanel">
    <!-- Existing Policies -->
    <div class="card shadow">
      <div class="card-header">
        <h5 class="mb-0"><i class="bi bi-list-ul me-2"></i>Existing Insurance Policies</h5>
      </div>
      <div class="card-body">
        <div class="table-responsive">
          <table class="table table-striped">
            <thead>
              <tr>
                <th>Title</th>
                <th>Premium</th>
                <th>Frequency</th>
                <th>Claim Type</th>
                <th>Waiting Period</th>
                <th>Max Claims</th>
                <th>Status</th>
                <th>Enrolled</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody>
              {% for policy in policies %}
              <tr>
                <td><strong>{{ policy.title }}</strong></td>
                <td>${{ "%.2f"|format(policy.premium) }}</td>
                <td>{{ policy.charge_frequency|title }}</td>
                <td>
                  <span class="badge {{ 'bg-info' if policy.is_monetary else 'bg-warning' }}">
                    {{ 'Monetary' if policy.is_monetary else 'Item/Service' }}
                  </span>
                </td>
                <td>{{ policy.waiting_period_days }} days</td>
                <td>
                  {% if policy.max_claims_count %}
                    {{ policy.max_claims_count }}/{{ policy.max_claims_period }}
                  {% else %}
                    Unlimited
                  {% endif %}
                </td>
                <td>
                  <span class="badge {{ 'bg-success' if policy.is_active else 'bg-secondary' }}">
                    {{ 'Active' if policy.is_active else 'Inactive' }}
                  </span>
                </td>
                <td>{{ policy.student_policies.filter_by(status='active').count() }} students</td>
                <td>
                  <a href="{{ url_for('admin_edit_insurance_policy', policy_id=policy.id) }}" class="btn btn-sm btn-outline-primary">Edit</a>
                  <button class="btn btn-sm btn-outline-danger" data-bs-toggle="modal" data-bs-target="#deactivatePolicyModal" data-policy-id="{{ policy.id }}" data-policy-title="{{ policy.title }}">
                    Deactivate
                  </button>
                </td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </div>

  <!-- ADD NEW POLICY TAB -->
  <div class="tab-pane fade" id="add-policy" role="tabpanel">
    <!-- Add New Policy Form -->
    <div class="card shadow mb-4">
      <div class="card-header bg-primary text-white">
        <h5 class="mb-0"><i class="bi bi-plus-circle me-2"></i>Add New Insurance Policy</h5>
      </div>
      <div class="card-body">
        <form method="POST" action="{{ url_for('admin_insurance_management') }}">
          {{ form.hidden_tag() }}

          <!-- 2x2 Card Grid -->
          <div class="row">
            <!-- Top Left: Basic Information -->
            <div class="col-lg-6 mb-4">
              <div class="card shadow-sm h-100 border-primary">
                <div class="card-header bg-primary bg-opacity-10">
                  <h6 class="mb-0 text-primary"><i class="bi bi-info-circle me-2"></i>Basic Information</h6>
                </div>
                <div class="card-body">
                  <div class="mb-3">
                    {{ form.title.label(class="form-label fw-bold") }}
                    {{ form.title(class="form-control", placeholder="e.g., Basic Health Coverage") }}
                    <small class="text-muted">Policy name shown to students</small>
                  </div>
                  <div class="mb-3">
                    {{ form.description.label(class="form-label fw-bold") }}
                    {{ form.description(class="form-control", rows=4, placeholder="Describe what this policy covers...") }}
                    <small class="text-muted">Clear description of coverage and benefits</small>
                  </div>
                  <div class="mb-0">
                    <div class="form-check form-switch">
                      {{ form.is_monetary(class="form-check-input", role="switch", id="isMonetaryToggleNew") }}
                      {{ form.is_monetary.label(class="form-check-label fw-bold") }}
                    </div>
                    <div class="alert alert-light border mt-2 mb-0">
                      <small><strong>Monetary:</strong> Dollar claims<br>
                      <strong>Non-Monetary:</strong> Item/service claims</small>
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <!-- Top Right: Pricing & Payment -->
            <div class="col-lg-6 mb-4">
              <div class="card shadow-sm h-100 border-success">
                <div class="card-header bg-success bg-opacity-10">
                  <h6 class="mb-0 text-success"><i class="bi bi-currency-dollar me-2"></i>Pricing & Payment</h6>
                </div>
                <div class="card-body">
                  <div class="row">
                    <div class="col-md-6 mb-3">
                      {{ form.premium.label(class="form-label fw-bold") }}
                      <div class="input-group">
                        <span class="input-group-text">$</span>
                        {{ form.premium(class="form-control", placeholder="0.00") }}
                      </div>
                      <small class="text-muted">Cost per cycle</small>
                    </div>
                    <div class="col-md-6 mb-3">
                      {{ form.charge_frequency.label(class="form-label fw-bold") }}
                      {{ form.charge_frequency(class="form-select") }}
                      <small class="text-muted">Billing frequency</small>
                    </div>
                  </div>
                  <div class="mb-3">
                    <div class="form-check form-switch">
                      {{ form.autopay(class="form-check-input", role="switch") }}
                      {{ form.autopay.label(class="form-check-label fw-bold") }}
                    </div>
                    <small class="text-muted">Auto-deduct premiums from student accounts</small>
                  </div>
                  <div class="mb-3">
                    {{ form.auto_cancel_nonpay_days.label(class="form-label fw-bold") }}
                    <div class="input-group">
                      {{ form.auto_cancel_nonpay_days(class="form-control", placeholder="0") }}
                      <span class="input-group-text">days</span>
                    </div>
                    <small class="text-muted">Cancel if unpaid (0 = never)</small>
                  </div>
                  <div class="mb-0">
                    <div class="form-check form-switch">
                      {{ form.is_active(class="form-check-input", role="switch") }}
                      {{ form.is_active.label(class="form-check-label fw-bold") }}
                    </div>
                    <small class="text-muted">Make policy available to students</small>
                  </div>
                </div>
              </div>
            </div>

            <!-- Bottom Left: Coverage & Claims -->
            <div class="col-lg-6 mb-4">
              <div class="card shadow-sm h-100 border-info">
                <div class="card-header bg-info bg-opacity-10">
                  <h6 class="mb-0 text-info"><i class="bi bi-shield-check me-2"></i>Coverage & Claims</h6>
                </div>
                <div class="card-body">
                  <div class="row">
                    <div class="col-md-6 mb-3">
                      {{ form.waiting_period_days.label(class="form-label fw-bold") }}
                      <div class="input-group">
                        {{ form.waiting_period_days(class="form-control", placeholder="0") }}
                        <span class="input-group-text">days</span>
                      </div>
                      <small class="text-muted">Before coverage starts</small>
                    </div>
                    <div class="col-md-6 mb-3">
                      {{ form.claim_time_limit_days.label(class="form-label fw-bold") }}
                      <div class="input-group">
                        {{ form.claim_time_limit_days(class="form-control", placeholder="0") }}
                        <span class="input-group-text">days</span>
                      </div>
                      <small class="text-muted">To file after incident</small>
                    </div>
                  </div>
                  <div class="row">
                    <div class="col-md-6 mb-3">
                      {{ form.max_claims_count.label(class="form-label fw-bold") }}
                      {{ form.max_claims_count(class="form-control", placeholder="0") }}
                      <small class="text-muted">Max per period (0 = ‚àû)</small>
                    </div>
                    <div class="col-md-6 mb-3">
                      {{ form.max_claims_period.label(class="form-label fw-bold") }}
                      {{ form.max_claims_period(class="form-select") }}
                      <small class="text-muted">Period type</small>
                    </div>
                  </div>
                  <div class="mb-0">
                    {{ form.max_claim_amount.label(class="form-label fw-bold") }}
                    <div class="input-group">
                      <span class="input-group-text">$</span>
                      {{ form.max_claim_amount(class="form-control", placeholder="0.00") }}
                    </div>
                    <small class="text-muted">Max payout per claim (0 = ‚àû)</small>
                  </div>
                </div>
              </div>
            </div>

            <!-- Bottom Right: Policy Rules & Bundles -->
            <div class="col-lg-6 mb-4">
              <div class="card shadow-sm h-100 border-warning">
                <div class="card-header bg-warning bg-opacity-10">
                  <h6 class="mb-0 text-dark"><i class="bi bi-gear me-2"></i>Rules & Bundles</h6>
                </div>
                <div class="card-body">
                  <!-- Repurchase Rules -->
                  <div class="mb-3 pb-3 border-bottom">
                    <h6 class="fw-bold mb-2"><i class="bi bi-ban me-1"></i>Repurchase Restrictions</h6>

                    <!-- Permanent Block -->
                    <div class="form-check form-switch mb-2">
                      {{ form.no_repurchase_after_cancel(class="form-check-input", role="switch", id="permanentBlockToggleNew") }}
                      {{ form.no_repurchase_after_cancel.label(class="form-check-label fw-bold") }}
                    </div>
                    <small class="text-muted d-block mb-3">Students can NEVER repurchase after canceling</small>

                    <!-- Cooldown Period -->
                    <div id="cooldownSectionNew">
                      <div class="form-check form-switch mb-2">
                        {{ form.enable_repurchase_cooldown(class="form-check-input", role="switch", id="cooldownToggleNew") }}
                        {{ form.enable_repurchase_cooldown.label(class="form-check-label fw-bold") }}
                      </div>
                      <small class="text-muted d-block mb-2">Students must wait before repurchasing</small>

                      <div id="cooldownDaysNew" style="display: none;">
                        {{ form.repurchase_wait_days.label(class="form-label fw-bold small") }}
                        <div class="input-group input-group-sm">
                          {{ form.repurchase_wait_days(class="form-control", placeholder="30") }}
                          <span class="input-group-text">days</span>
                        </div>
                        <small class="text-muted">Cooldown period for repurchase</small>
                      </div>
                    </div>
                  </div>

                  <!-- Bundle Settings -->
                  <div>
                    <h6 class="fw-bold mb-2"><i class="bi bi-boxes me-1"></i>Bundle Discounts</h6>

                    <!-- Discount Options -->
                    <div class="row">
                      <div class="col-6 mb-3">
                        {{ form.bundle_discount_percent.label(class="form-label fw-bold small") }}
                        <div class="input-group input-group-sm">
                          {{ form.bundle_discount_percent(class="form-control", placeholder="0") }}
                          <span class="input-group-text">%</span>
                        </div>
                        <small class="text-muted">Percent off</small>
                      </div>
                      <div class="col-6 mb-3">
                        {{ form.bundle_discount_amount.label(class="form-label fw-bold small") }}
                        <div class="input-group input-group-sm">
                          <span class="input-group-text">$</span>
                          {{ form.bundle_discount_amount(class="form-control", placeholder="0.00") }}
                        </div>
                        <small class="text-muted">Dollar off</small>
                      </div>
                    </div>
                    <small class="text-muted fst-italic">Note: Bundle policies can be configured after creation via Edit</small>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <div class="d-grid">
            {{ form.submit(class="btn btn-primary btn-lg", value="üíæ Create Policy") }}
          </div>
        </form>
      </div>
    </div>

    <script>
    // Handle mutually exclusive repurchase restrictions for new policy form
    document.addEventListener('DOMContentLoaded', function() {
      const permanentBlockToggleNew = document.getElementById('permanentBlockToggleNew');
      const cooldownToggleNew = document.getElementById('cooldownToggleNew');
      const cooldownSectionNew = document.getElementById('cooldownSectionNew');
      const cooldownDaysNew = document.getElementById('cooldownDaysNew');

      function updateRepurchaseRestrictionsNew() {
        if (permanentBlockToggleNew.checked) {
          // Permanent block is ON - disable and hide cooldown section
          cooldownSectionNew.style.opacity = '0.5';
          cooldownSectionNew.style.pointerEvents = 'none';
          cooldownToggleNew.checked = false;
          cooldownToggleNew.disabled = true;
          cooldownDaysNew.style.display = 'none';
        } else {
          // Permanent block is OFF - enable cooldown section
          cooldownSectionNew.style.opacity = '1';
          cooldownSectionNew.style.pointerEvents = 'auto';
          cooldownToggleNew.disabled = false;

          // Show/hide days field based on cooldown toggle
          if (cooldownToggleNew.checked) {
            cooldownDaysNew.style.display = 'block';
          } else {
            cooldownDaysNew.style.display = 'none';
          }
        }
      }

      if (permanentBlockToggleNew && cooldownToggleNew) {
        permanentBlockToggleNew.addEventListener('change', updateRepurchaseRestrictionsNew);
        cooldownToggleNew.addEventListener('change', updateRepurchaseRestrictionsNew);
        updateRepurchaseRestrictionsNew(); // Initialize on load
      }
    });
    </script>
  </div>

  <!-- ACTIVE STUDENT POLICIES TAB -->
  <div class="tab-pane fade" id="student-policies" role="tabpanel">
    <div class="card shadow">
      <div class="card-header">
        <h5 class="mb-0">Active Student Policies</h5>
      </div>
      <div class="card-body">
        <div class="table-responsive">
          <table class="table table-striped">
            <thead>
              <tr>
                <th>Student</th>
                <th>Policy</th>
                <th>Purchase Date</th>
                <th>Coverage Start</th>
                <th>Premium</th>
                <th>Next Payment</th>
                <th>Payment Status</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody>
              {% for enrollment in active_enrollments %}
              <tr>
                <td>{{ enrollment.student.full_name }}</td>
                <td>{{ enrollment.policy.title }}</td>
                <td>{{ enrollment.purchase_date.strftime('%Y-%m-%d') }}</td>
                <td>
                  {% if enrollment.coverage_start_date %}
                    {{ enrollment.coverage_start_date.strftime('%Y-%m-%d') }}
                  {% else %}
                    Waiting Period
                  {% endif %}
                </td>
                <td>${{ "%.2f"|format(enrollment.policy.premium) }}</td>
                <td>
                  {% if enrollment.next_payment_due %}
                    {{ enrollment.next_payment_due.strftime('%Y-%m-%d') }}
                  {% else %}
                    N/A
                  {% endif %}
                </td>
                <td>
                  {% if enrollment.payment_current %}
                    <span class="badge bg-success">Current</span>
                  {% else %}
                    <span class="badge bg-danger">Overdue {{ enrollment.days_unpaid }} days</span>
                  {% endif %}
                </td>
                <td>
                  <a href="{{ url_for('admin_view_student_policy', enrollment_id=enrollment.id) }}" class="btn btn-sm btn-outline-info">View</a>
                </td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </div>

  <!-- CANCELLED POLICIES TAB -->
  <div class="tab-pane fade" id="cancelled-policies" role="tabpanel">
    <div class="card shadow">
      <div class="card-header">
        <h5 class="mb-0">Cancelled/Inactive Policies</h5>
      </div>
      <div class="card-body">
        <div class="table-responsive">
          <table class="table table-striped">
            <thead>
              <tr>
                <th>Student</th>
                <th>Policy</th>
                <th>Purchase Date</th>
                <th>Cancel Date</th>
                <th>Status</th>
              </tr>
            </thead>
            <tbody>
              {% for enrollment in cancelled_enrollments %}
              <tr>
                <td>{{ enrollment.student.full_name }}</td>
                <td>{{ enrollment.policy.title }}</td>
                <td>{{ enrollment.purchase_date.strftime('%Y-%m-%d') }}</td>
                <td>
                  {% if enrollment.cancel_date %}
                    {{ enrollment.cancel_date.strftime('%Y-%m-%d') }}
                  {% else %}
                    N/A
                  {% endif %}
                </td>
                <td><span class="badge bg-secondary">{{ enrollment.status|title }}</span></td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </div>

  <!-- CLAIMS TAB -->
  <div class="tab-pane fade" id="claims" role="tabpanel">
    <div class="card shadow">
      <div class="card-header">
        <h5 class="mb-0">Insurance Claims</h5>
      </div>
      <div class="card-body">
        <!-- Filter by status -->
        <ul class="nav nav-pills mb-3">
          <li class="nav-item">
            <a class="nav-link active" href="#" data-status="pending">Pending ({{ pending_claims_count }})</a>
          </li>
          <li class="nav-item">
            <a class="nav-link" href="#" data-status="approved">Approved</a>
          </li>
          <li class="nav-item">
            <a class="nav-link" href="#" data-status="rejected">Rejected</a>
          </li>
          <li class="nav-item">
            <a class="nav-link" href="#" data-status="paid">Paid</a>
          </li>
        </ul>

        <div class="table-responsive">
          <table class="table table-striped">
            <thead>
              <tr>
                <th>Student</th>
                <th>Policy</th>
                <th>Incident Date</th>
                <th>Filed Date</th>
                <th>Claim</th>
                <th>Status</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody>
              {% for claim in claims %}
              <tr class="claim-row" data-status="{{ claim.status }}">
                <td>{{ claim.student.full_name }}</td>
                <td>{{ claim.policy.title }}</td>
                <td>{{ claim.incident_date.strftime('%Y-%m-%d') }}</td>
                <td>{{ claim.filed_date.strftime('%Y-%m-%d') }}</td>
                <td>
                  {% if claim.claim_amount %}
                    <span class="badge bg-success">${{ "%.2f"|format(claim.claim_amount) }}</span>
                  {% elif claim.claim_item %}
                    <span class="badge bg-warning text-dark">{{ claim.claim_item }}</span>
                  {% else %}
                    N/A
                  {% endif %}
                </td>
                <td>
                  <span class="badge
                    {% if claim.status == 'pending' %}bg-warning text-dark
                    {% elif claim.status == 'approved' %}bg-success
                    {% elif claim.status == 'rejected' %}bg-danger
                    {% elif claim.status == 'paid' %}bg-info
                    {% endif %}">
                    {{ claim.status|title }}
                  </span>
                </td>
                <td>
                  <a href="{{ url_for('admin_process_claim', claim_id=claim.id) }}" class="btn btn-sm btn-outline-primary">Process</a>
                </td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Deactivate Policy Modal -->
<div class="modal fade" id="deactivatePolicyModal" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Deactivate Policy</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <p>Are you sure you want to deactivate <strong id="modalPolicyTitle"></strong>?</p>
        <p class="text-muted">This will prevent new enrollments but won't affect existing policies.</p>
      </div>
      <div class="modal-footer">
        <form id="deactivatePolicyForm" method="POST">
          <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="submit" class="btn btn-danger">Deactivate</button>
        </form>
      </div>
    </div>
  </div>
</div>

<script>
// Deactivate policy modal
const deactivatePolicyModal = document.getElementById('deactivatePolicyModal');
if (deactivatePolicyModal) {
  deactivatePolicyModal.addEventListener('show.bs.modal', event => {
    const button = event.relatedTarget;
    const policyTitle = button.getAttribute('data-policy-title');
    const policyId = button.getAttribute('data-policy-id');

    document.getElementById('modalPolicyTitle').textContent = policyTitle;
    document.getElementById('deactivatePolicyForm').action = `/admin/insurance/deactivate/${policyId}`;
  });
}

// Claims filter
document.querySelectorAll('.nav-pills .nav-link').forEach(link => {
  link.addEventListener('click', function(e) {
    e.preventDefault();
    const status = this.getAttribute('data-status');

    // Update active state
    document.querySelectorAll('.nav-pills .nav-link').forEach(l => l.classList.remove('active'));
    this.classList.add('active');

    // Filter claims
    document.querySelectorAll('.claim-row').forEach(row => {
      if (status === 'all' || row.getAttribute('data-status') === status) {
        row.style.display = '';
      } else {
        row.style.display = 'none';
      }
    });
  });
});

// Initialize with pending claims shown
document.addEventListener('DOMContentLoaded', function() {
  document.querySelectorAll('.claim-row').forEach(row => {
    if (row.getAttribute('data-status') !== 'pending') {
      row.style.display = 'none';
    }
  });
});
</script>

{% endblock %}
