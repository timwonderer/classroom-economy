{% extends "layout_admin.html" %}
{% set page_title = "Insurance Management" %}
{% set current_page = "insurance" %}
{% block title %}Insurance Management{% endblock %}
{% block page_icon %}shield{% endblock %}

{% block extra_head %}
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/easymde/dist/easymde.min.css">
<style>
    .EasyMDEContainer .CodeMirror {
        min-height: 120px;
    }
    .editor-toolbar {
        border-radius: 4px 4px 0 0;
    }
    .CodeMirror {
        border-radius: 0 0 4px 4px;
    }
</style>
{% endblock %}

{% block content %}

<!-- Class Selector Banner -->
{% if teacher_blocks %}
<div class="alert alert-primary d-flex align-items-center justify-content-between mb-4">
  <div class="d-flex align-items-center gap-3">
    <span class="material-symbols-outlined" style="font-size: 2rem;">school</span>
    <div>
      <h6 class="mb-1 fw-bold">Viewing Insurance For:</h6>
      <select class="form-select form-select-sm" id="settings_block_selector" style="width: auto; min-width: 200px;">
        {% for block in teacher_blocks %}
          <option value="{{ block }}" {% if block == settings_block %}selected{% endif %}>
            {{ class_labels_by_block.get(block, block) }}
          </option>
        {% endfor %}
      </select>
    </div>
  </div>
</div>
{% endif %}

<!-- Nav Tabs -->
<ul class="nav nav-tabs mb-4" id="insuranceTabs" role="tablist">
  <li class="nav-item" role="presentation">
    <button class="nav-link active" id="existing-policies-tab" data-bs-toggle="tab" data-bs-target="#existing-policies" type="button" role="tab">
      <i class="bi bi-list-ul me-1"></i>Existing Policies
    </button>
  </li>
  <li class="nav-item" role="presentation">
    <button class="nav-link" id="add-policy-tab" data-bs-toggle="tab" data-bs-target="#add-policy" type="button" role="tab">
      <i class="bi bi-plus-circle me-1"></i>Add New Policy
    </button>
  </li>
  <li class="nav-item" role="presentation">
    <button class="nav-link" id="student-policies-tab" data-bs-toggle="tab" data-bs-target="#student-policies" type="button" role="tab">
      <i class="bi bi-people me-1"></i>Active Student Policies
    </button>
  </li>
  <li class="nav-item" role="presentation">
    <button class="nav-link" id="cancelled-policies-tab" data-bs-toggle="tab" data-bs-target="#cancelled-policies" type="button" role="tab">
      <i class="bi bi-archive me-1"></i>Cancelled Policies
    </button>
  </li>
  <li class="nav-item" role="presentation">
    <button class="nav-link" id="claims-tab" data-bs-toggle="tab" data-bs-target="#claims" type="button" role="tab">
      <i class="bi bi-file-text me-1"></i>Claims <span class="badge bg-warning text-dark">{{ pending_claims_count }}</span>
    </button>
  </li>
</ul>

<div class="tab-content" id="insuranceTabContent">
  <!-- EXISTING POLICIES TAB -->
  <div class="tab-pane fade show active" id="existing-policies" role="tabpanel">
    <!-- Existing Policies -->
    <div class="card shadow">
      <div class="card-header">
        <h5 class="mb-0"><i class="bi bi-list-ul me-2"></i>Existing Insurance Policies</h5>
      </div>
      <div class="card-body">
        <div class="table-responsive">
          <table class="table table-striped">
            <thead>
              <tr>
                <th>Title</th>
                <th>Premium</th>
                <th>Frequency</th>
                <th>Claim Type</th>
                <th>Waiting Period</th>
                <th>Max Claims</th>
                <th>Status</th>
                <th>Enrolled</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody>
              {% for policy in policies %}
              <tr>
                <td><strong>{{ policy.title }}</strong></td>
                <td>${{ "%.2f"|format(policy.premium) }}</td>
                <td>{{ policy.charge_frequency|title }}</td>
                <td>
                  {% if policy.claim_type == 'transaction_monetary' %}
                    <span class="badge bg-info">[TXN]</span>
                  {% elif policy.claim_type == 'non_monetary' %}
                    <span class="badge bg-warning text-dark">[NON-MONETARY]</span>
                  {% else %}
                    <span class="badge bg-primary">[LEGACY]</span>
                  {% endif %}
                </td>
                <td>{{ policy.waiting_period_days }} days</td>
                <td>
                  {% if policy.max_claims_count %}
                    {{ policy.max_claims_count }}/{{ policy.max_claims_period }}
                  {% else %}
                    Unlimited
                  {% endif %}
                </td>
                <td>
                  <span class="badge {{ 'bg-success' if policy.is_active else 'bg-secondary' }}">
                    {{ 'Active' if policy.is_active else 'Inactive' }}
                  </span>
                </td>
                <td>{{ policy.student_policies.filter_by(status='active').count() }} students</td>
                <td>
                  <a href="{{ url_for('admin.edit_insurance_policy', policy_id=policy.id) }}" class="btn btn-sm btn-outline-primary mb-1">
                    <i class="bi bi-pencil"></i> Edit
                  </a>
                  <button class="btn btn-sm btn-outline-warning mb-1" data-bs-toggle="modal" data-bs-target="#massRemoveModal" data-policy-id="{{ policy.id }}" data-policy-title="{{ policy.title }}" data-active-count="{{ policy.student_policies.filter_by(status='active').count() }}">
                    <i class="bi bi-person-dash"></i> Mass Remove
                  </button>
                  <button class="btn btn-sm btn-outline-danger mb-1" data-bs-toggle="modal" data-bs-target="#deletePolicyModal" data-policy-id="{{ policy.id }}" data-policy-title="{{ policy.title }}" data-active-count="{{ policy.student_policies.filter_by(status='active').count() }}" data-pending-claims="{{ policy.claims.filter_by(status='pending').count() }}">
                    <i class="bi bi-trash"></i> Delete
                  </button>
                </td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </div>

  <!-- ADD NEW POLICY TAB -->
  <div class="tab-pane fade" id="add-policy" role="tabpanel">
    <!-- Add New Policy Form -->
    <div class="card shadow mb-4">
      <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
        <h5 class="mb-0"><i class="bi bi-plus-circle me-2"></i>Add New Insurance Policy</h5>
        <!-- Mode Toggle -->
        <div class="form-check form-switch">
          <input class="form-check-input" type="checkbox" id="insuranceModeToggle" role="switch">
          <label class="form-check-label text-white" for="insuranceModeToggle">Advanced Mode</label>
        </div>
      </div>
      <div class="card-body">
        <!-- Display Form Validation Errors -->
        {% if form.errors %}
        <div class="alert alert-danger alert-dismissible fade show" role="alert">
          <h6 class="alert-heading"><i class="bi bi-exclamation-triangle me-2"></i>Form Validation Errors</h6>
          <ul class="mb-0">
            {% for field_name, errors in form.errors.items() %}
              {% for error in errors %}
                <li>
                  {% if field_name in form and form[field_name].label %}
                    <strong>{{ form[field_name].label.text }}:</strong> {{ error }}
                  {% else %}
                    <strong>Error:</strong> {{ error }}
                  {% endif %}
                </li>
              {% endfor %}
            {% endfor %}
          </ul>
          <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>
        {% endif %}

        <form method="POST" action="{{ url_for('admin.insurance_management') }}" id="insuranceForm">
          {{ form.hidden_tag() }}
          <input type="hidden" name="settings_mode" id="settingsModeInput" value="simple">

          <!-- SIMPLE MODE -->
          <div id="simpleModeFields">
            <div class="alert alert-info">
              <i class="bi bi-info-circle me-2"></i>
              <strong>Simple Mode:</strong> Easy setup for basic insurance policies. For advanced features like groups and bundles, switch to Advanced Mode.
            </div>

            <div class="row">
              <div class="col-md-6 mb-3">
                {{ form.title.label(class="form-label fw-bold") }}
                {{ form.title(class="form-control", placeholder="e.g., Basic Coverage", id="simple_title") }}
              </div>
              <div class="col-md-6 mb-3">
                {{ form.premium.label(class="form-label fw-bold", for="simple_premium") }}
                <div class="input-group">
                  <span class="input-group-text">$</span>
                  {{ form.premium(class="form-control", placeholder="10.00", id="simple_premium") }}
                  <span class="input-group-text">/{{ form.charge_frequency(class="form-select", id="simple_charge_frequency", style="width: auto;") }}</span>
                </div>
              </div>
            </div>

            <div class="mb-3">
              {{ form.description.label(class="form-label fw-bold") }}
              {{ form.description(class="form-control", rows=3, placeholder="What does this insurance cover?", id="simple_description") }}
            </div>

            <div class="mb-3">
              {{ form.claim_type.label(class="form-label fw-bold") }}
              {{ form.claim_type(class="form-select", id="simple_claim_type") }}
              <small class="text-muted">Choose how claims are processed.</small>
            </div>

            <div class="row">
              <div class="col-md-6 mb-3">
                <label class="form-label fw-bold">Claim Amount (Flat Rate)</label>
                <div class="input-group">
                  <span class="input-group-text">$</span>
                  {{ form.max_claim_amount(class="form-control", placeholder="50.00", id="simple_max_claim_amount") }}
                </div>
                <small class="text-muted">Amount paid per approved claim</small>
              </div>
              <div class="col-md-6 mb-3">
                <label class="form-label fw-bold">Max Payout Per Period</label>
                <div class="input-group">
                  <span class="input-group-text">$</span>
                  {{ form.max_payout_per_period(class="form-control", placeholder="200.00", id="simple_max_payout_per_period") }}
                  <span class="input-group-text">/{{ form.max_claims_period(class="form-select", id="simple_max_claims_period", style="width: auto;") }}</span>
                </div>
                <small class="text-muted">Maximum total payout in the period</small>
              </div>
            </div>

            <div class="row">
              <div class="col-md-6 mb-3">
                {{ form.waiting_period_days.label(class="form-label fw-bold") }}
                <div class="input-group">
                  {{ form.waiting_period_days(class="form-control", placeholder="7", id="simple_waiting_period_days") }}
                  <span class="input-group-text">days</span>
                </div>
                <small class="text-muted">Waiting period before coverage starts</small>
              </div>
              <div class="col-md-6 mb-3">
                <div class="form-check form-switch mt-4">
                  {{ form.is_active(class="form-check-input", role="switch", id="simple_is_active") }}
                  {{ form.is_active.label(class="form-check-label fw-bold") }}
                </div>
              </div>
            </div>
          </div>

          <!-- ADVANCED MODE (hidden by default) -->
          <div id="advancedModeFields" style="display:none;">
          <!-- 2x2 Card Grid -->
          <div class="row">
            <!-- Top Left: Basic Information -->
            <div class="col-lg-6 mb-4">
              <div class="card shadow-sm h-100 border-primary">
                <div class="card-header bg-primary bg-opacity-10">
                  <h6 class="mb-0 text-primary"><i class="bi bi-info-circle me-2"></i>Basic Information</h6>
                </div>
                <div class="card-body">
                  <div class="mb-3">
                    {{ form.title.label(class="form-label fw-bold") }}
                    {{ form.title(class="form-control", placeholder="e.g., Basic Health Coverage") }}
                    <small class="text-muted">Policy name shown to students</small>
                  </div>
                  <div class="mb-3">
                    {{ form.description.label(class="form-label fw-bold") }}
                    {{ form.description(class="form-control", rows=4, placeholder="Describe what this policy covers...") }}
                    <small class="text-muted">Clear description of coverage and benefits</small>
                  </div>
                  <div class="mb-3">
                    {{ form.marketing_badge.label(class="form-label fw-bold") }}
                    {{ form.marketing_badge(class="form-select") }}
                    <small class="text-muted">Add a fun marketing badge to attract students</small>
                  </div>
                  <div class="mb-0">
                    {{ form.claim_type.label(class="form-label fw-bold") }}
                    {{ form.claim_type(class="form-select", id="advanced_claim_type") }}
                    <div class="alert alert-light border mt-2 mb-0">
                      <small>
                        <strong>Transactions-based:</strong> Students pick a spending transaction; amount auto-calculated.<br>
                        <strong>Non-monetary:</strong> Approval-only, no reimbursements.<br>
                        <strong>Legacy monetary:</strong> Students enter an amount manually.
                      </small>
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <!-- Top Right: Pricing & Payment -->
            <div class="col-lg-6 mb-4">
              <div class="card shadow-sm h-100 border-success">
                <div class="card-header bg-success bg-opacity-10">
                  <h6 class="mb-0 text-success"><i class="bi bi-currency-dollar me-2"></i>Pricing & Payment</h6>
                </div>
                <div class="card-body">
                  <div class="row">
                    <div class="col-md-6 mb-3">
                      {{ form.premium.label(class="form-label fw-bold") }}
                      <div class="input-group">
                        <span class="input-group-text">$</span>
                        {{ form.premium(class="form-control", placeholder="0.00") }}
                      </div>
                      <small class="text-muted">Cost per cycle</small>
                    </div>
                    <div class="col-md-6 mb-3">
                      {{ form.charge_frequency.label(class="form-label fw-bold") }}
                      {{ form.charge_frequency(class="form-select") }}
                      <small class="text-muted">Billing frequency</small>
                    </div>
                  </div>
                  <div class="mb-3">
                    <div class="form-check form-switch">
                      {{ form.autopay(class="form-check-input", role="switch") }}
                      {{ form.autopay.label(class="form-check-label fw-bold") }}
                    </div>
                    <small class="text-muted">Auto-deduct premiums from student accounts</small>
                  </div>
                  <div class="mb-3">
                    {{ form.auto_cancel_nonpay_days.label(class="form-label fw-bold") }}
                    <div class="input-group">
                      {{ form.auto_cancel_nonpay_days(class="form-control", placeholder="0") }}
                      <span class="input-group-text">days</span>
                    </div>
                    <small class="text-muted">Cancel if unpaid (0 = never)</small>
                  </div>
                  <div class="mb-0">
                    <div class="form-check form-switch">
                      {{ form.is_active(class="form-check-input", role="switch") }}
                      {{ form.is_active.label(class="form-check-label fw-bold") }}
                    </div>
                    <small class="text-muted">Make policy available to students</small>
                  </div>
                </div>
              </div>
            </div>

            <!-- Bottom Left: Coverage & Claims -->
            <div class="col-lg-6 mb-4">
              <div class="card shadow-sm h-100 border-info">
                <div class="card-header bg-info bg-opacity-10">
                  <h6 class="mb-0 text-info"><i class="bi bi-shield-check me-2"></i>Coverage & Claims</h6>
                </div>
                <div class="card-body">
                  <div class="row">
                    <div class="col-md-6 mb-3">
                      {{ form.waiting_period_days.label(class="form-label fw-bold") }}
                      <div class="input-group">
                        {{ form.waiting_period_days(class="form-control", placeholder="0") }}
                        <span class="input-group-text">days</span>
                      </div>
                      <small class="text-muted">Before coverage starts</small>
                    </div>
                    <div class="col-md-6 mb-3">
                      {{ form.claim_time_limit_days.label(class="form-label fw-bold") }}
                      <div class="input-group">
                        {{ form.claim_time_limit_days(class="form-control", placeholder="0") }}
                        <span class="input-group-text">days</span>
                      </div>
                      <small class="text-muted">To file after incident</small>
                    </div>
                  </div>
                  <div class="row">
                    <div class="col-md-6 mb-3">
                      {{ form.max_claims_count.label(class="form-label fw-bold") }}
                      {{ form.max_claims_count(class="form-control", placeholder="0") }}
                      <small class="text-muted">Max per period (0 = âˆž)</small>
                    </div>
                    <div class="col-md-6 mb-3">
                      {{ form.max_claims_period.label(class="form-label fw-bold") }}
                      {{ form.max_claims_period(class="form-select") }}
                      <small class="text-muted">Period type</small>
                    </div>
                  </div>
                  <div class="mb-3">
                    {{ form.max_claim_amount.label(class="form-label fw-bold") }}
                    <div class="input-group">
                      <span class="input-group-text">$</span>
                      {{ form.max_claim_amount(class="form-control", placeholder="0.00") }}
                    </div>
                    <small class="text-muted">Max payout per claim (0 = âˆž)</small>
                  </div>
                  <div class="mb-0">
                    {{ form.max_payout_per_period.label(class="form-label fw-bold") }}
                    <div class="input-group">
                      <span class="input-group-text">$</span>
                      {{ form.max_payout_per_period(class="form-control", placeholder="0.00") }}
                    </div>
                    <small class="text-muted">Max total payout per period (0 = âˆž)</small>
                  </div>
                </div>
              </div>
            </div>

            <!-- Bottom Right: Policy Rules & Bundles -->
            <div class="col-lg-6 mb-4">
              <div class="card shadow-sm h-100 border-warning">
                <div class="card-header bg-warning bg-opacity-10">
                  <h6 class="mb-0 text-dark"><i class="bi bi-gear me-2"></i>Rules & Bundles</h6>
                </div>
                <div class="card-body">
                  <!-- Repurchase Rules -->
                  <div class="mb-3 pb-3 border-bottom">
                    <h6 class="fw-bold mb-2"><i class="bi bi-ban me-1"></i>Repurchase Restrictions</h6>

                    <!-- Permanent Block -->
                    <div class="form-check form-switch mb-2">
                      {{ form.no_repurchase_after_cancel(class="form-check-input", role="switch", id="permanentBlockToggleNew") }}
                      {{ form.no_repurchase_after_cancel.label(class="form-check-label fw-bold") }}
                    </div>
                    <small class="text-muted d-block mb-3">Students can NEVER repurchase after canceling</small>

                    <!-- Cooldown Period -->
                    <div id="cooldownSectionNew">
                      <div class="form-check form-switch mb-2">
                        {{ form.enable_repurchase_cooldown(class="form-check-input", role="switch", id="cooldownToggleNew") }}
                        {{ form.enable_repurchase_cooldown.label(class="form-check-label fw-bold") }}
                      </div>
                      <small class="text-muted d-block mb-2">Students must wait before repurchasing</small>

                      <div id="cooldownDaysNew" style="display: none;">
                        {{ form.repurchase_wait_days.label(class="form-label fw-bold small") }}
                        <div class="input-group input-group-sm">
                          {{ form.repurchase_wait_days(class="form-control", placeholder="30") }}
                          <span class="input-group-text">days</span>
                        </div>
                        <small class="text-muted">Cooldown period for repurchase</small>
                      </div>
                    </div>
                  </div>

                  <!-- Bundle Settings -->
                  <div>
                    <h6 class="fw-bold mb-2"><i class="bi bi-boxes me-1"></i>Bundle Discounts</h6>

                    <!-- Discount Options -->
                    <div class="row">
                      <div class="col-6 mb-3">
                        {{ form.bundle_discount_percent.label(class="form-label fw-bold small") }}
                        <div class="input-group input-group-sm">
                          {{ form.bundle_discount_percent(class="form-control", placeholder="0") }}
                          <span class="input-group-text">%</span>
                        </div>
                        <small class="text-muted">Percent off</small>
                      </div>
                      <div class="col-6 mb-3">
                        {{ form.bundle_discount_amount.label(class="form-label fw-bold small") }}
                        <div class="input-group input-group-sm">
                          <span class="input-group-text">$</span>
                          {{ form.bundle_discount_amount(class="form-control", placeholder="0.00") }}
                        </div>
                        <small class="text-muted">Dollar off</small>
                      </div>
                    </div>
                    <small class="text-muted fst-italic">Note: Bundle policies can be configured after creation via Edit</small>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- Group Settings (Advanced Mode Only) -->
          <div class="card border-warning shadow-sm mb-3">
            <div class="card-body">
              <div class="d-flex justify-content-between align-items-center mb-2">
                <div>
                  <h6 class="fw-bold mb-0"><i class="bi bi-layers me-2"></i>Grouped Insurance</h6>
                  <small class="text-muted">Students can select <strong>one policy</strong> per group. <span class="ms-1" data-bs-toggle="tooltip" title="Grouped insurance policies are mutually exclusiveâ€”students choose only one from a group."><i class="bi bi-info-circle"></i></span></small>
                </div>
                <div class="form-check form-switch">
                  <input class="form-check-input" type="checkbox" id="tierToggleNew">
                  <label class="form-check-label fw-bold" for="tierToggleNew">This insurance is grouped</label>
                </div>
              </div>

              <div id="tierSelectionNew" class="card bg-light-subtle border-0 shadow-sm" style="display: none;">
                <div class="card-body">
                  <div class="row g-3 align-items-start">
                    <div class="col-lg-8">
                      <div class="alert alert-info py-2 px-3 d-none mb-0" id="tierSummaryNew"></div>
                    </div>
                    <div class="col-lg-4">
                      {{ form.tier_level.label(class="form-label fw-bold small mb-1") }}
                      {{ form.tier_level(class="form-select form-select-sm", id="tier_level") }}
                      <small class="text-muted">Tag this insurance as basic, mid-tier, or premium for clearer choices.</small>
                    </div>
                  </div>

                  {% if tier_groups %}
                  <div class="row g-3 mt-2">
                    {% for group in tier_groups %}
                    <div class="col-md-6">
                      <div class="card h-100 border-{{ group.color }} shadow-sm">
                        <div class="card-body d-flex flex-column">
                          <div class="d-flex justify-content-between align-items-start mb-2">
                            <div>
                              <span class="badge bg-{{ group.color }} text-white">{{ group.name }}</span>
                              <div class="small text-muted">Students choose one option in this group</div>
                            </div>
                            <button type="button" class="btn btn-outline-primary btn-sm select-tier-btn" data-tier-id="{{ group.id }}" data-tier-name="{{ group.name }}" data-tier-color="{{ group.color }}">
                              Add this insurance to group
                            </button>
                          </div>
                          <div class="small text-muted">{{ group.policies|length }} policy{{ 'ies' if group.policies|length != 1 else '' }} in this group</div>
                          {% if group.policies %}
                          <ul class="list-unstyled small mt-2 mb-0">
                            {% for policy_info in group.policies %}
                            <li class="d-flex align-items-center gap-2">
                              <i class="bi bi-shield-check text-{{ group.color }}"></i>
                              <span>{{ policy_info.title }}</span>
                              {% if policy_info.level %}
                              <span class="badge rounded-pill text-bg-light border border-{{ group.color }} text-{{ group.color }} text-uppercase" style="font-size: 0.65rem;">{{ policy_info.level.replace('_', ' ') }}</span>
                              {% endif %}
                            </li>
                            {% endfor %}
                          </ul>
                          {% endif %}
                        </div>
                      </div>
                    </div>
                    {% endfor %}
                  </div>
                  <div class="mt-3">
                    <button type="button" class="btn btn-outline-secondary btn-sm" id="startNewGroupBtnNew">Create a new group</button>
                  </div>
                  {% else %}
                  <div class="alert alert-warning d-flex align-items-center mt-3" role="alert">
                    <i class="bi bi-info-circle me-2"></i>
                    <div>No grouped insurance exists yet. Name your first group to create a "select one only" group.</div>
                  </div>
                  {% endif %}

                  <div id="newGroupFieldsNew" class="card card-body border-0 bg-white shadow-sm {% if tier_groups %}d-none{% endif %} mt-3">
                    <div class="d-flex align-items-center mb-3">
                      <small class="text-muted">Students can choose one policy per group.</small>
                    </div>
                    <div class="row g-2">
                      <div class="col-md-7">
                        {{ form.tier_name.label(class="form-label fw-bold small") }}
                        {{ form.tier_name(class="form-control form-control-sm", id="tier_name") }}
                      </div>
                      <div class="col-md-5">
                        {{ form.tier_color.label(class="form-label fw-bold small") }}
                        {{ form.tier_color(class="form-select form-select-sm", id="tier_color") }}
                      </div>
                    </div>
                  </div>
                </div>
              </div>

              <div class="d-none">
                {{ form.tier_category_id(id="tier_category_id") }}
              </div>
            </div>
          </div>
          </div><!-- End Advanced Mode Fields -->

          <div class="d-grid">
            {{ form.submit(class="btn btn-primary btn-lg", value="ðŸ’¾ Create Policy") }}
          </div>
        </form>
      </div>
    </div>

    <script>
    // Handle simple/advanced mode toggle
    document.addEventListener('DOMContentLoaded', function() {
      const insuranceModeToggle = document.getElementById('insuranceModeToggle');
      const settingsModeInput = document.getElementById('settingsModeInput');
      const simpleModeFields = document.getElementById('simpleModeFields');
      const advancedModeFields = document.getElementById('advancedModeFields');

      // Highlight fields with errors
      {% if form.errors %}
      const fields = {};
      {% for field_name, errors in form.errors.items() %}
        fields["{{ field_name }}"] = document.querySelector('[name="{{ field_name }}"]');
        if (fields["{{ field_name }}"]) {
          fields["{{ field_name }}"].classList.add('is-invalid');
          // Create and append error messages if they don't exist
          {% for error in errors %}
          if (!fields["{{ field_name }}"].nextElementSibling || !fields["{{ field_name }}"].nextElementSibling.classList.contains('invalid-feedback')) {
            const errorDiv = document.createElement('div');
            errorDiv.className = 'invalid-feedback d-block';
            errorDiv.textContent = '{{ error }}';
            fields["{{ field_name }}"].parentNode.appendChild(errorDiv);
          }
          {% endfor %}
        }
      {% endfor %}
      // Scroll to the error alert
      const errorAlert = document.querySelector('.alert-danger');
      if (errorAlert) {
        errorAlert.scrollIntoView({ behavior: 'smooth', block: 'center' });
      }
      {% endif %}

      if (insuranceModeToggle) {
        insuranceModeToggle.addEventListener('change', function() {
          if (this.checked) {
            // Advanced mode
            simpleModeFields.style.display = 'none';
            advancedModeFields.style.display = 'block';
            settingsModeInput.value = 'advanced';
          } else {
            // Simple mode
            simpleModeFields.style.display = 'block';
            advancedModeFields.style.display = 'none';
            settingsModeInput.value = 'simple';
          }
        });
      }

      // Handle mutually exclusive repurchase restrictions for new policy form
      const permanentBlockToggleNew = document.getElementById('permanentBlockToggleNew');
      const cooldownToggleNew = document.getElementById('cooldownToggleNew');
      const cooldownSectionNew = document.getElementById('cooldownSectionNew');
      const cooldownDaysNew = document.getElementById('cooldownDaysNew');

      function updateRepurchaseRestrictionsNew() {
        if (permanentBlockToggleNew.checked) {
          // Permanent block is ON - disable and hide cooldown section
          cooldownSectionNew.style.opacity = '0.5';
          cooldownSectionNew.style.pointerEvents = 'none';
          cooldownToggleNew.checked = false;
          cooldownToggleNew.disabled = true;
          cooldownDaysNew.style.display = 'none';
        } else {
          // Permanent block is OFF - enable cooldown section
          cooldownSectionNew.style.opacity = '1';
          cooldownSectionNew.style.pointerEvents = 'auto';
          cooldownToggleNew.disabled = false;

          // Show/hide days field based on cooldown toggle
          if (cooldownToggleNew.checked) {
            cooldownDaysNew.style.display = 'block';
          } else {
            cooldownDaysNew.style.display = 'none';
          }
        }
      }

      if (permanentBlockToggleNew && cooldownToggleNew) {
        permanentBlockToggleNew.addEventListener('change', updateRepurchaseRestrictionsNew);
        cooldownToggleNew.addEventListener('change', updateRepurchaseRestrictionsNew);
        updateRepurchaseRestrictionsNew(); // Initialize on load
      }

      // Tier grouping flow (advanced mode)
      const tierToggleNew = document.getElementById('tierToggleNew');
      const tierSelectionNew = document.getElementById('tierSelectionNew');
      const tierCategoryInput = document.getElementById('tier_category_id');
      const tierNameInput = document.getElementById('tier_name');
      const tierColorInput = document.getElementById('tier_color');
      const tierLevelInput = document.getElementById('tier_level');
      const tierSummaryNew = document.getElementById('tierSummaryNew');
      const newGroupFieldsNew = document.getElementById('newGroupFieldsNew');
      const startNewGroupBtnNew = document.getElementById('startNewGroupBtnNew');
      const selectTierButtons = document.querySelectorAll('.select-tier-btn');

      function clearTierFields() {
        if (tierCategoryInput) tierCategoryInput.value = '';
        if (tierNameInput) tierNameInput.value = '';
        if (tierColorInput) tierColorInput.value = '';
        if (tierLevelInput) tierLevelInput.value = '';
      }

      function showTierSelection() {
        if (tierSelectionNew) tierSelectionNew.style.display = 'block';
        if (!selectTierButtons.length && newGroupFieldsNew) {
          newGroupFieldsNew.classList.remove('d-none');
        }
      }

      function hideTierSelection() {
        if (tierSelectionNew) tierSelectionNew.style.display = 'none';
        if (tierSummaryNew) tierSummaryNew.classList.add('d-none');
        if (newGroupFieldsNew && selectTierButtons.length) {
          newGroupFieldsNew.classList.add('d-none');
        }
        clearTierFields();
      }

      function updateTierSummary() {
        if (!tierSummaryNew) return;
        const levelLabel = (tierLevelInput && tierLevelInput.value)
          ? ` Â· ${tierLevelInput.options[tierLevelInput.selectedIndex].text}`
          : '';
        const groupLabel = tierNameInput && tierNameInput.value ? tierNameInput.value : 'Untitled Group';
        tierSummaryNew.innerHTML = `<strong>Grouped:</strong> ${groupLabel} Â· select one only${levelLabel}`;
        tierSummaryNew.classList.remove('d-none');
      }

      function setTierValues(tier) {
        if (tierCategoryInput) tierCategoryInput.value = tier.id;
        if (tierNameInput) tierNameInput.value = tier.name || '';
        if (tierColorInput) tierColorInput.value = tier.color || 'primary';
        updateTierSummary();
        if (newGroupFieldsNew) newGroupFieldsNew.classList.add('d-none');
      }

      function startNewGroup() {
        showTierSelection();
        if (tierCategoryInput) tierCategoryInput.value = '';
        if (tierSummaryNew) tierSummaryNew.classList.add('d-none');
        if (newGroupFieldsNew) newGroupFieldsNew.classList.remove('d-none');
        if (tierColorInput && !tierColorInput.value) tierColorInput.value = 'primary';
      }

      selectTierButtons.forEach(btn => {
        btn.addEventListener('click', () => {
          if (tierToggleNew) tierToggleNew.checked = true;
          showTierSelection();
          setTierValues({
            id: btn.dataset.tierId,
            name: btn.dataset.tierName,
            color: btn.dataset.tierColor
          });
        });
      });

      if (startNewGroupBtnNew) {
        startNewGroupBtnNew.addEventListener('click', () => {
          if (tierToggleNew) tierToggleNew.checked = true;
          startNewGroup();
        });
      }

      if (tierToggleNew) {
        tierToggleNew.addEventListener('change', () => {
          if (tierToggleNew.checked) {
            showTierSelection();
            if (!selectTierButtons.length) {
              startNewGroup();
            }
          } else {
            hideTierSelection();
          }
        });
      }

      if (tierLevelInput) {
        tierLevelInput.addEventListener('change', () => {
          if (tierToggleNew && tierToggleNew.checked && tierCategoryInput && tierCategoryInput.value) {
            updateTierSummary();
          }
        });
      }

      // Initialize existing selection if data already present
      if (tierCategoryInput && tierCategoryInput.value) {
        if (tierToggleNew) tierToggleNew.checked = true;
        showTierSelection();
        setTierValues({
          id: tierCategoryInput.value,
          name: tierNameInput ? tierNameInput.value : '',
          color: tierColorInput ? tierColorInput.value : 'primary'
        });
      }

      // Enable tooltips for grouped insurance info
      const tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
      tooltipTriggerList.map(function (tooltipTriggerEl) {
        return new bootstrap.Tooltip(tooltipTriggerEl);
      });
    });
    </script>
  </div>

  <!-- ACTIVE STUDENT POLICIES TAB -->
  <div class="tab-pane fade" id="student-policies" role="tabpanel">
    <div class="card shadow">
      <div class="card-header">
        <h5 class="mb-0">Active Student Policies</h5>
      </div>
      <div class="card-body">
        <div class="table-responsive">
          <table class="table table-striped">
            <thead>
              <tr>
                <th>Student</th>
                <th>Policy</th>
                <th>Purchase Date</th>
                <th>Coverage Start</th>
                <th>Premium</th>
                <th>Next Payment</th>
                <th>Payment Status</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody>
              {% for enrollment in active_enrollments %}
              <tr>
                <td>{{ enrollment.student.full_name }}</td>
                <td>{{ enrollment.policy.title }}</td>
                <td>{{ enrollment.purchase_date.strftime('%Y-%m-%d') }}</td>
                <td>
                  {% if enrollment.coverage_start_date %}
                    {{ enrollment.coverage_start_date.strftime('%Y-%m-%d') }}
                  {% else %}
                    Waiting Period
                  {% endif %}
                </td>
                <td>${{ "%.2f"|format(enrollment.policy.premium) }}</td>
                <td>
                  {% if enrollment.next_payment_due %}
                    {{ enrollment.next_payment_due.strftime('%Y-%m-%d') }}
                  {% else %}
                    N/A
                  {% endif %}
                </td>
                <td>
                  {% if enrollment.payment_current %}
                    <span class="badge bg-success">Current</span>
                  {% else %}
                    <span class="badge bg-danger">Overdue {{ enrollment.days_unpaid }} days</span>
                  {% endif %}
                </td>
                <td>
                  <a href="{{ url_for('admin.view_student_policy', enrollment_id=enrollment.id) }}" class="btn btn-sm btn-outline-info">View</a>
                </td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </div>

  <!-- CANCELLED POLICIES TAB -->
  <div class="tab-pane fade" id="cancelled-policies" role="tabpanel">
    <div class="card shadow">
      <div class="card-header">
        <h5 class="mb-0">Cancelled/Inactive Policies</h5>
      </div>
      <div class="card-body">
        <div class="table-responsive">
          <table class="table table-striped">
            <thead>
              <tr>
                <th>Student</th>
                <th>Policy</th>
                <th>Purchase Date</th>
                <th>Cancel Date</th>
                <th>Status</th>
              </tr>
            </thead>
            <tbody>
              {% for enrollment in cancelled_enrollments %}
              <tr>
                <td>{{ enrollment.student.full_name }}</td>
                <td>{{ enrollment.policy.title }}</td>
                <td>{{ enrollment.purchase_date.strftime('%Y-%m-%d') }}</td>
                <td>
                  {% if enrollment.cancel_date %}
                    {{ enrollment.cancel_date.strftime('%Y-%m-%d') }}
                  {% else %}
                    N/A
                  {% endif %}
                </td>
                <td><span class="badge bg-secondary">{{ enrollment.status|title }}</span></td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </div>

  <!-- CLAIMS TAB -->
  <div class="tab-pane fade" id="claims" role="tabpanel">
    <div class="card shadow">
      <div class="card-header">
        <h5 class="mb-0">Insurance Claims</h5>
      </div>
      <div class="card-body">
        <!-- Filter by status -->
        <ul class="nav nav-pills mb-3">
          <li class="nav-item">
            <a class="nav-link active" href="#" data-status="pending">Pending ({{ pending_claims_count }})</a>
          </li>
          <li class="nav-item">
            <a class="nav-link" href="#" data-status="approved">Approved</a>
          </li>
          <li class="nav-item">
            <a class="nav-link" href="#" data-status="rejected">Rejected</a>
          </li>
          <li class="nav-item">
            <a class="nav-link" href="#" data-status="paid">Paid</a>
          </li>
        </ul>

        <div class="table-responsive">
          <table class="table table-striped">
            <thead>
              <tr>
                <th>Student</th>
                <th>Policy</th>
                <th>Incident Date</th>
                <th>Filed Date</th>
                <th>Claim</th>
                <th>Status</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody>
              {% for claim in claims %}
              <tr class="claim-row" data-status="{{ claim.status }}">
                <td>{{ claim.student.full_name }}</td>
                <td>{{ claim.policy.title }}</td>
                <td>{{ claim.incident_date.strftime('%Y-%m-%d') }}</td>
                <td>{{ claim.filed_date.strftime('%Y-%m-%d') }}</td>
                <td>
                  {% if claim.policy.claim_type == 'transaction_monetary' %}
                    <span class="badge bg-info me-1">TXN</span>
                  {% elif claim.policy.claim_type == 'non_monetary' %}
                    <span class="badge bg-warning text-dark me-1">NON-MONETARY</span>
                  {% else %}
                    <span class="badge bg-primary me-1">LEGACY</span>
                  {% endif %}
                  {% if claim.claim_amount %}
                    <span class="badge bg-success">${{ "%.2f"|format(claim.claim_amount) }}</span>
                  {% elif claim.claim_item %}
                    <span class="badge bg-warning text-dark">{{ claim.claim_item }}</span>
                  {% else %}
                    N/A
                  {% endif %}
                </td>
                <td>
                  <span class="badge
                    {% if claim.status == 'pending' %}bg-warning text-dark
                    {% elif claim.status == 'approved' %}bg-success
                    {% elif claim.status == 'rejected' %}bg-danger
                    {% elif claim.status == 'paid' %}bg-info
                    {% endif %}">
                    {{ claim.status|title }}
                  </span>
                </td>
                <td>
                  <a href="{{ url_for('admin.process_claim', claim_id=claim.id) }}" class="btn btn-sm btn-outline-primary">Process</a>
                </td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Deactivate Policy Modal -->
<div class="modal fade" id="deactivatePolicyModal" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Deactivate Policy</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <p>Are you sure you want to deactivate <strong id="modalPolicyTitle"></strong>?</p>
        <p class="text-muted">This will prevent new enrollments but won't affect existing policies.</p>
      </div>
      <div class="modal-footer">
        <form id="deactivatePolicyForm" method="POST">
          <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="submit" class="btn btn-danger">Deactivate</button>
        </form>
      </div>
    </div>
  </div>
</div>

<!-- Delete Policy Modal -->
<div class="modal fade" id="deletePolicyModal" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header bg-danger text-white">
        <h5 class="modal-title"><i class="bi bi-exclamation-triangle"></i> Delete Policy</h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <p class="fw-bold">Are you sure you want to permanently delete <strong id="deletePolicyTitle"></strong>?</p>
        <div class="alert alert-warning">
          <strong>Warning:</strong> This action cannot be undone!
        </div>
        <div id="deletePolicyInfo">
          <p><strong>Active enrollments:</strong> <span id="deleteActiveCount">0</span></p>
          <p><strong>Pending claims:</strong> <span id="deletePendingClaims">0</span></p>
        </div>
        <div class="form-check mt-3">
          <input class="form-check-input" type="checkbox" id="forceDeleteCheck">
          <label class="form-check-label fw-bold text-danger" for="forceDeleteCheck">
            Force delete (cancel all enrollments and delete all claims)
          </label>
        </div>
      </div>
      <div class="modal-footer">
        <form id="deletePolicyForm" method="POST">
          <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
          <input type="hidden" name="force_delete" id="forceDeleteInput" value="false">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="submit" class="btn btn-danger" id="deletePolicyBtn">
            <i class="bi bi-trash"></i> Delete Policy
          </button>
        </form>
      </div>
    </div>
  </div>
</div>

<!-- Mass Remove Policy Modal -->
<div class="modal fade" id="massRemoveModal" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header bg-warning">
        <h5 class="modal-title"><i class="bi bi-person-dash"></i> Mass Remove Policy</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <p>Remove <strong id="massRemovePolicyTitle"></strong> from students?</p>
        <div class="alert alert-info">
          <p class="mb-2"><strong>This will:</strong></p>
          <ul class="mb-0">
            <li>Cancel the policy for all selected students</li>
            <li>Stop future premium charges</li>
            <li>Keep claim history intact</li>
          </ul>
        </div>
        <div class="mt-3">
          <p><strong>Active enrollments:</strong> <span id="massRemoveActiveCount">0</span></p>
        </div>
        <div class="form-check">
          <input class="form-check-input" type="radio" name="removeScope" id="removeAll" value="all" checked>
          <label class="form-check-label" for="removeAll">
            Remove from ALL students
          </label>
        </div>
        <div class="form-check mt-2">
          <input class="form-check-input" type="radio" name="removeScope" id="removeSelected" value="selected">
          <label class="form-check-label" for="removeSelected">
            Remove from specific students (comma-separated IDs)
          </label>
        </div>
        <div class="mt-2" id="studentIdsInput" style="display: none;">
          <input type="text" class="form-control" id="studentIdsField" placeholder="e.g., 1,5,12,34">
          <small class="text-muted">Enter student IDs separated by commas</small>
        </div>
      </div>
      <div class="modal-footer">
        <form id="massRemoveForm" method="POST">
          <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
          <input type="hidden" name="student_ids" id="studentIdsHidden" value="all">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="submit" class="btn btn-warning">
            <i class="bi bi-person-dash"></i> Remove Policy
          </button>
        </form>
      </div>
    </div>
  </div>
</div>

<script>
// Deactivate policy modal
const deactivatePolicyModal = document.getElementById('deactivatePolicyModal');
if (deactivatePolicyModal) {
  deactivatePolicyModal.addEventListener('show.bs.modal', event => {
    const button = event.relatedTarget;
    const policyTitle = button.getAttribute('data-policy-title');
    const policyId = button.getAttribute('data-policy-id');

    document.getElementById('modalPolicyTitle').textContent = policyTitle;
    document.getElementById('deactivatePolicyForm').action = `/admin/insurance/deactivate/${policyId}`;
  });
}

// Delete policy modal
const deletePolicyModal = document.getElementById('deletePolicyModal');
if (deletePolicyModal) {
  deletePolicyModal.addEventListener('show.bs.modal', event => {
    const button = event.relatedTarget;
    const policyTitle = button.getAttribute('data-policy-title');
    const policyId = button.getAttribute('data-policy-id');
    const activeCount = button.getAttribute('data-active-count');
    const pendingClaims = button.getAttribute('data-pending-claims');

    document.getElementById('deletePolicyTitle').textContent = policyTitle;
    document.getElementById('deleteActiveCount').textContent = activeCount;
    document.getElementById('deletePendingClaims').textContent = pendingClaims;
    document.getElementById('deletePolicyForm').action = `/admin/insurance/delete/${policyId}`;

    // Reset checkbox
    document.getElementById('forceDeleteCheck').checked = false;
    document.getElementById('forceDeleteInput').value = 'false';
  });

  // Handle force delete checkbox
  document.getElementById('forceDeleteCheck').addEventListener('change', function() {
    document.getElementById('forceDeleteInput').value = this.checked ? 'true' : 'false';
  });
}

// Mass remove policy modal
const massRemoveModal = document.getElementById('massRemoveModal');
if (massRemoveModal) {
  massRemoveModal.addEventListener('show.bs.modal', event => {
    const button = event.relatedTarget;
    const policyTitle = button.getAttribute('data-policy-title');
    const policyId = button.getAttribute('data-policy-id');
    const activeCount = button.getAttribute('data-active-count');

    document.getElementById('massRemovePolicyTitle').textContent = policyTitle;
    document.getElementById('massRemoveActiveCount').textContent = activeCount;
    document.getElementById('massRemoveForm').action = `/admin/insurance/mass-remove/${policyId}`;

    // Reset to 'all'
    document.getElementById('removeAll').checked = true;
    document.getElementById('studentIdsHidden').value = 'all';
    document.getElementById('studentIdsInput').style.display = 'none';
    document.getElementById('studentIdsField').value = '';
  });

  // Handle radio button changes
  document.getElementById('removeAll').addEventListener('change', function() {
    if (this.checked) {
      document.getElementById('studentIdsInput').style.display = 'none';
      document.getElementById('studentIdsHidden').value = 'all';
    }
  });

  document.getElementById('removeSelected').addEventListener('change', function() {
    if (this.checked) {
      document.getElementById('studentIdsInput').style.display = 'block';
      document.getElementById('studentIdsHidden').value = '';
    }
  });

  // Update hidden field when student IDs change
  document.getElementById('studentIdsField').addEventListener('input', function() {
    document.getElementById('studentIdsHidden').value = this.value;
  });
}

// Claims filter
document.querySelectorAll('.nav-pills .nav-link').forEach(link => {
  link.addEventListener('click', function(e) {
    e.preventDefault();
    const status = this.getAttribute('data-status');

    // Update active state
    document.querySelectorAll('.nav-pills .nav-link').forEach(l => l.classList.remove('active'));
    this.classList.add('active');

    // Filter claims
    document.querySelectorAll('.claim-row').forEach(row => {
      if (status === 'all' || row.getAttribute('data-status') === status) {
        row.style.display = '';
      } else {
        row.style.display = 'none';
      }
    });
  });
});

// Initialize with pending claims shown
document.addEventListener('DOMContentLoaded', function() {
  document.querySelectorAll('.claim-row').forEach(row => {
    if (row.getAttribute('data-status') !== 'pending') {
      row.style.display = 'none';
    }
  });
});
</script>

<script src="https://cdn.jsdelivr.net/npm/easymde/dist/easymde.min.js"></script>
<script>
  // Initialize markdown editor for policy description
  document.addEventListener('DOMContentLoaded', function() {
    const descriptionField = document.getElementById('description');

    if (descriptionField) {
      new EasyMDE({
        element: descriptionField,
        spellChecker: false,
        autoDownloadFontAwesome: false,
        toolbar: ["bold", "italic", "heading", "|", "unordered-list", "ordered-list", "|", "link", "quote", "|", "preview", "side-by-side", "fullscreen", "|", "guide"],
        status: false,
        placeholder: "Describe what this policy covers (Markdown supported)...",
      });
    }

    // Handle class selector change
    const settingsBlockSelector = document.getElementById('settings_block_selector');
    if (settingsBlockSelector) {
      settingsBlockSelector.addEventListener('change', function() {
        const selectedBlock = this.value;
        window.location.href = "{{ url_for('admin.insurance_management') }}?settings_block=" + encodeURIComponent(selectedBlock);
      });
    }
  });
</script>

{% endblock %}
