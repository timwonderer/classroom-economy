{% extends "layout_admin.html" %}
{% set page_title = "Store Management" %}
{% block title %}Store Management{% endblock %}
{% block page_icon %}storefront{% endblock %}

{% block extra_head %}
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/easymde/dist/easymde.min.css">
<style>
    .EasyMDEContainer .CodeMirror {
        min-height: 120px;
    }
    .editor-toolbar {
        border-radius: 4px 4px 0 0;
    }
    .CodeMirror {
        border-radius: 0 0 4px 4px;
    }
</style>
{% endblock %}

{% block content %}

<!-- Nav Tabs -->
<ul class="nav nav-tabs mb-4" id="storeTabs" role="tablist">
  <li class="nav-item" role="presentation">
    <button class="nav-link active" id="overview-tab" data-bs-toggle="tab" data-bs-target="#overview" type="button" role="tab">
      <i class="bi bi-grid me-1"></i>Overview
    </button>
  </li>
  <li class="nav-item" role="presentation">
    <button class="nav-link" id="manage-tab" data-bs-toggle="tab" data-bs-target="#manage" type="button" role="tab">
      <i class="bi bi-box-seam me-1"></i>Manage Items
    </button>
  </li>
  <li class="nav-item" role="presentation">
    <button class="nav-link" id="history-tab" data-bs-toggle="tab" data-bs-target="#history" type="button" role="tab">
      <i class="bi bi-clock-history me-1"></i>Purchase History
    </button>
  </li>
</ul>

<div class="tab-content" id="storeTabContent">
  <!-- OVERVIEW TAB -->
  <div class="tab-pane fade show active" id="overview" role="tabpanel">
    <div class="row">
      <!-- Store Statistics -->
      <div class="col-lg-6 mb-4">
        <div class="card shadow">
          <div class="card-header bg-primary text-white">
            <h5 class="mb-0"><i class="bi bi-graph-up me-2"></i>Store Statistics</h5>
          </div>
          <div class="card-body">
            <div class="row text-center">
              <div class="col-6 mb-3">
                <h3 class="text-primary">{{ total_items|default(0) }}</h3>
                <small class="text-muted">Total Items</small>
              </div>
              <div class="col-6 mb-3">
                <h3 class="text-success">{{ active_items|default(0) }}</h3>
                <small class="text-muted">Active Items</small>
              </div>
              <div class="col-12">
                <h3 class="text-info">{{ total_purchases|default(0) }}</h3>
                <small class="text-muted">Total Purchases</small>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Quick Actions -->
      <div class="col-lg-6 mb-4">
        <div class="card shadow">
          <div class="card-header bg-success text-white">
            <h5 class="mb-0"><i class="bi bi-lightning me-2"></i>Quick Actions</h5>
          </div>
          <div class="card-body">
            <div class="d-grid gap-2">
              <button class="btn btn-outline-primary" onclick="document.getElementById('manage-tab').click()">
                <i class="bi bi-plus-circle me-2"></i>Add New Item
              </button>
              <button class="btn btn-outline-info" onclick="document.getElementById('history-tab').click()">
                <i class="bi bi-clock-history me-2"></i>View Purchase History
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Recent Items -->
    <div class="card shadow">
      <div class="card-header bg-info text-white">
        <h5 class="mb-0"><i class="bi bi-star me-2"></i>Active Store Items</h5>
      </div>
      <div class="card-body">
        {% if items %}
        <div class="row">
          {% for item in items[:6] if item.is_active %}
          <div class="col-md-4 mb-3">
            <div class="card h-100">
              <div class="card-body">
                <h6 class="card-title">{{ item.name }}</h6>
                <p class="card-text text-muted small">{{ item.description[:50] }}{% if item.description and item.description|length > 50 %}...{% endif %}</p>
                <div class="d-flex justify-content-between align-items-center">
                  <span class="badge bg-success">${{ "%.2f"|format(item.price) }}</span>
                  <span class="badge bg-secondary">{{ item.item_type.replace('_', ' ')|title }}</span>
                </div>
                {% if item.is_bundle %}
                <div class="mt-2">
                  <span class="badge bg-warning text-dark"><i class="bi bi-box-seam"></i> Bundle ({{ item.bundle_quantity }})</span>
                </div>
                {% endif %}
                {% if item.bulk_discount_enabled %}
                <div class="mt-2">
                  <span class="badge bg-info"><i class="bi bi-percent"></i> {{ item.bulk_discount_percentage }}% off {{ item.bulk_discount_quantity }}+</span>
                </div>
                {% endif %}
              </div>
            </div>
          </div>
          {% endfor %}
        </div>
        {% else %}
        <p class="text-muted">No items in store yet. Click "Manage Items" to add some!</p>
        {% endif %}
      </div>
    </div>
  </div>

  <!-- MANAGE ITEMS TAB -->
  <div class="tab-pane fade" id="manage" role="tabpanel">
    <div class="row">
      <!-- Add/Edit Item Form -->
      <div class="col-lg-12 mb-4">
        <div class="card shadow">
          <div class="card-header bg-primary text-white">
            <h5 class="mb-0"><i class="bi bi-plus-circle me-2"></i>Add New Item</h5>
          </div>
          <div class="card-body">
            <form method="POST" action="{{ url_for('admin.store_management') }}">
              {{ form.hidden_tag() }}

              <!-- Basic Information -->
              <div class="card mb-3">
                <div class="card-header bg-light">
                  <h6 class="mb-0">Basic Information</h6>
                </div>
                <div class="card-body">
                  <div class="row">
                    <div class="col-md-6 mb-3">
                      {{ form.name.label(class="form-label fw-bold") }}
                      {{ form.name(class="form-control") }}
                    </div>
                    <div class="col-md-6 mb-3">
                      {{ form.price.label(class="form-label fw-bold") }}
                      {{ form.price(class="form-control") }}
                    </div>
                  </div>
                  <div class="mb-3">
                    {{ form.description.label(class="form-label fw-bold") }}
                    {{ form.description(class="form-control", rows=3) }}
                  </div>
                  <div class="row">
                    <div class="col-md-6 mb-3">
                      {{ form.item_type.label(class="form-label fw-bold") }}
                      {{ form.item_type(class="form-select") }}
                      <small class="text-muted">Choose how students can use this item</small>
                    </div>
                    <div class="col-md-6 mb-3">
                      <div class="form-check mt-4">
                        {{ form.is_active(class="form-check-input") }}
                        {{ form.is_active.label(class="form-check-label fw-bold") }}
                      </div>
                    </div>
                  </div>
                  <div class="mb-3">
                    {{ form.blocks.label(class="form-label fw-bold") }}
                    {{ form.blocks(class="form-select", multiple=true, size=5) }}
                    <small class="text-muted">Hold Ctrl/Cmd to select multiple periods. Leave empty to show to all periods.</small>
                  </div>
                </div>
              </div>

              <!-- Inventory & Limits -->
              <div class="card mb-3">
                <div class="card-header bg-light">
                  <h6 class="mb-0">Inventory & Limits</h6>
                </div>
                <div class="card-body">
                  <div class="row">
                    <div class="col-md-6 mb-3">
                      {{ form.inventory.label(class="form-label fw-bold") }}
                      {{ form.inventory(class="form-control") }}
                      <small class="text-muted">Leave blank for unlimited inventory</small>
                    </div>
                    <div class="col-md-6 mb-3">
                      {{ form.limit_per_student.label(class="form-label fw-bold") }}
                      {{ form.limit_per_student(class="form-control") }}
                      <small class="text-muted">Leave blank for no purchase limit</small>
                    </div>
                  </div>
                </div>
              </div>

              <!-- Bundle Settings -->
              <div class="card mb-3">
                <div class="card-header bg-light">
                  <h6 class="mb-0"><i class="bi bi-box-seam me-2"></i>Bundle Settings</h6>
                </div>
                <div class="card-body">
                  <div class="form-check mb-3">
                    {{ form.is_bundle(class="form-check-input", id="isBundleCheck") }}
                    {{ form.is_bundle.label(class="form-check-label fw-bold") }}
                    <small class="d-block text-muted">Bundled items give students multiple uses that can be redeemed separately</small>
                  </div>
                  <div id="bundleOptions" style="display: none;">
                    <div class="row">
                      <div class="col-md-6 mb-3">
                        {{ form.bundle_quantity.label(class="form-label fw-bold") }}
                        {{ form.bundle_quantity(class="form-control", placeholder="e.g., 5") }}
                        <small class="text-muted">How many items in this bundle?</small>
                      </div>
                    </div>
                  </div>
                </div>
              </div>

              <!-- Bulk Discount Settings -->
              <div class="card mb-3">
                <div class="card-header bg-light">
                  <h6 class="mb-0"><i class="bi bi-percent me-2"></i>Bulk Discount Settings</h6>
                </div>
                <div class="card-body">
                  <div class="form-check mb-3">
                    {{ form.bulk_discount_enabled(class="form-check-input", id="bulkDiscountCheck") }}
                    {{ form.bulk_discount_enabled.label(class="form-check-label fw-bold") }}
                    <small class="d-block text-muted">Offer a discount when students buy multiple quantities</small>
                  </div>
                  <div id="bulkDiscountOptions" style="display: none;">
                    <div class="row">
                      <div class="col-md-6 mb-3">
                        {{ form.bulk_discount_quantity.label(class="form-label fw-bold") }}
                        {{ form.bulk_discount_quantity(class="form-control", placeholder="e.g., 3") }}
                        <small class="text-muted">Minimum quantity to qualify for discount</small>
                      </div>
                      <div class="col-md-6 mb-3">
                        {{ form.bulk_discount_percentage.label(class="form-label fw-bold") }}
                        {{ form.bulk_discount_percentage(class="form-control", placeholder="e.g., 10") }}
                        <small class="text-muted">Discount percentage (e.g., 10 for 10% off)</small>
                      </div>
                    </div>
                  </div>
                </div>
              </div>

              <!-- Collective Goal Settings -->
              <div class="card mb-3" id="collectiveGoalCard" style="display: none;">
                <div class="card-header bg-light">
                  <h6 class="mb-0"><i class="bi bi-people me-2"></i>Collective Goal Settings</h6>
                </div>
                <div class="card-body">
                  <div class="alert alert-info">
                    <small><strong>Info:</strong> Collective goals require multiple students to purchase before unlocking for everyone.</small>
                  </div>
                  <div class="mb-3">
                    {{ form.collective_goal_type.label(class="form-label fw-bold") }}
                    {{ form.collective_goal_type(class="form-select", id="collectiveGoalType") }}
                    <small class="text-muted">Choose how the goal is calculated</small>
                  </div>
                  <div id="fixedTargetDiv" style="display: none;">
                    <div class="mb-3">
                      {{ form.collective_goal_target.label(class="form-label fw-bold") }}
                      {{ form.collective_goal_target(class="form-control", placeholder="e.g., 10") }}
                      <small class="text-muted">Number of students who must purchase to unlock this item</small>
                    </div>
                  </div>
                  <div id="wholeClassInfo" style="display: none;">
                    <div class="alert alert-warning">
                      <small><i class="bi bi-info-circle me-2"></i><strong>Whole Class Mode:</strong> Every student in the class must purchase (1 per person). The target dynamically updates based on class size.</small>
                    </div>
                  </div>
                </div>
              </div>

              <!-- Advanced Settings -->
              <div class="card mb-3">
                <div class="card-header bg-light">
                  <h6 class="mb-0">Advanced Settings</h6>
                </div>
                <div class="card-body">
                  <div class="row">
                    <div class="col-md-6 mb-3">
                      {{ form.auto_delist_date.label(class="form-label fw-bold") }}
                      {{ form.auto_delist_date(class="form-control") }}
                      <small class="text-muted">Item will be automatically hidden on this date</small>
                    </div>
                    <div class="col-md-6 mb-3">
                      {{ form.auto_expiry_days.label(class="form-label fw-bold") }}
                      {{ form.auto_expiry_days(class="form-control") }}
                      <small class="text-muted">Days before item expires (for delayed-use items)</small>
                    </div>
                  </div>
                  <div class="mb-3">
                    {{ form.redemption_prompt.label(class="form-label fw-bold") }}
                    {{ form.redemption_prompt(class="form-control", rows=3, placeholder="e.g., Please describe when and where you'd like to use this item.") }}
                    <small class="text-muted">Optional prompt shown to students when redeeming delayed-use items. This helps you gather specific information when students request to use their item.</small>
                  </div>
                </div>
              </div>

              <div class="text-end">
                {{ form.submit(class="btn btn-primary btn-lg") }}
              </div>
            </form>
          </div>
        </div>
      </div>

      <!-- Existing Items Table -->
      <div class="col-lg-12">
        <div class="card shadow">
          <div class="card-header bg-secondary text-white">
            <h5 class="mb-0"><i class="bi bi-list-ul me-2"></i>All Store Items</h5>
          </div>
          <div class="card-body">
            <div class="table-responsive">
              <table class="table table-striped table-hover">
                <thead>
                  <tr>
                    <th>Name</th>
                    <th>Price</th>
                    <th>Type</th>
                    <th>Inventory</th>
                    <th>Bundle</th>
                    <th>Discount</th>
                    <th>Status</th>
                    <th>Actions</th>
                  </tr>
                </thead>
                <tbody>
                  {% for item in items %}
                  <tr>
                    <td><strong>{{ item.name }}</strong></td>
                    <td>${{ "%.2f"|format(item.price) }}</td>
                    <td><span class="badge bg-info">{{ item.item_type.replace('_', ' ')|title }}</span></td>
                    <td>{{ item.inventory if item.inventory is not none else 'Unlimited' }}</td>
                    <td>
                      {% if item.is_bundle %}
                        <span class="badge bg-warning text-dark">{{ item.bundle_quantity }} items</span>
                      {% else %}
                        <span class="text-muted">-</span>
                      {% endif %}
                    </td>
                    <td>
                      {% if item.bulk_discount_enabled %}
                        <span class="badge bg-success">{{ item.bulk_discount_percentage }}% off {{ item.bulk_discount_quantity }}+</span>
                      {% else %}
                        <span class="text-muted">-</span>
                      {% endif %}
                    </td>
                    <td><span class="badge {{ 'bg-success' if item.is_active else 'bg-secondary' }}">{{ 'Active' if item.is_active else 'Inactive' }}</span></td>
                    <td>
                      <div class="btn-group btn-group-sm" role="group">
                        <a href="{{ url_for('admin.edit_store_item', item_id=item.id) }}" class="btn btn-outline-primary" title="Edit">
                          <i class="bi bi-pencil"></i>
                        </a>
                        <button class="btn btn-outline-warning" data-bs-toggle="modal" data-bs-target="#deactivateItemModal" data-item-id="{{ item.id }}" data-item-name="{{ item.name }}" title="Deactivate">
                          <i class="bi bi-eye-slash"></i>
                        </button>
                        <button class="btn btn-outline-danger" data-bs-toggle="modal" data-bs-target="#deleteItemModal" data-item-id="{{ item.id }}" data-item-name="{{ item.name }}" title="Delete Permanently">
                          <i class="bi bi-trash"></i>
                        </button>
                      </div>
                    </td>
                  </tr>
                  {% endfor %}
                </tbody>
              </table>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- PURCHASE HISTORY TAB -->
  <div class="tab-pane fade" id="history" role="tabpanel">
    <div class="card shadow">
      <div class="card-header bg-info text-white">
        <h5 class="mb-0"><i class="bi bi-receipt me-2"></i>All Purchases</h5>
      </div>
      <div class="card-body">
        <div class="table-responsive">
          <table class="table table-striped">
            <thead>
              <tr>
                <th>Student</th>
                <th>Item</th>
                <th>Purchase Date</th>
                <th>Status</th>
                <th>Quantity</th>
                <th>Bundle</th>
              </tr>
            </thead>
            <tbody>
              {% if items %}
                {% for item in items %}
                  {% for student_item in item.student_items %}
                  <tr>
                    <td>{{ student_item.student.full_name if student_item.student else 'Unknown' }}</td>
                    <td>{{ item.name }}</td>
                    <td>{{ student_item.purchase_date.strftime('%Y-%m-%d %H:%M') if student_item.purchase_date else 'N/A' }}</td>
                    <td><span class="badge bg-{{ 'success' if student_item.status == 'completed' else 'warning' }}">{{ student_item.status|title }}</span></td>
                    <td>{{ student_item.quantity_purchased }}</td>
                    <td>
                      {% if student_item.is_from_bundle %}
                        <span class="badge bg-warning text-dark">
                          {% if student_item.bundle_remaining %}
                            {{ student_item.bundle_remaining }} left
                          {% else %}
                            Used
                          {% endif %}
                        </span>
                      {% else %}
                        <span class="text-muted">-</span>
                      {% endif %}
                    </td>
                  </tr>
                  {% endfor %}
                {% endfor %}
              {% else %}
              <tr>
                <td colspan="6" class="text-center text-muted">No purchases yet</td>
              </tr>
              {% endif %}
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Deactivate Item Modal -->
<div class="modal fade" id="deactivateItemModal" tabindex="-1" aria-labelledby="deactivateItemModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header bg-warning">
        <h5 class="modal-title" id="deactivateItemModalLabel">Confirm Deactivation</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <p>Are you sure you want to deactivate <strong id="modalDeactivateItemName"></strong>?</p>
        <p class="text-muted small">This will remove it from the student store but preserve purchase history. You can reactivate it later.</p>
      </div>
      <div class="modal-footer">
        <form id="deactivateItemForm" method="POST">
          <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="submit" class="btn btn-warning">Deactivate Item</button>
        </form>
      </div>
    </div>
  </div>
</div>

<!-- Delete Item Modal (Hard Delete) -->
<div class="modal fade" id="deleteItemModal" tabindex="-1" aria-labelledby="deleteItemModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header bg-danger text-white">
        <h5 class="modal-title" id="deleteItemModalLabel">Permanently Delete Item</h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <div class="alert alert-danger">
          <i class="bi bi-exclamation-triangle me-2"></i><strong>Warning!</strong> This action cannot be undone.
        </div>
        <p>Are you sure you want to permanently delete <strong id="modalDeleteItemName"></strong>?</p>
        <p class="text-muted small">This will completely remove the item from the database. If students have purchased this item, deletion will be blocked to preserve history.</p>
      </div>
      <div class="modal-footer">
        <form id="deleteItemForm" method="POST">
          <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="submit" class="btn btn-danger">Delete Permanently</button>
        </form>
      </div>
    </div>
  </div>
</div>

<script>
  // Deactivate modal handler
  const deactivateItemModal = document.getElementById('deactivateItemModal');
  deactivateItemModal.addEventListener('show.bs.modal', event => {
    const button = event.relatedTarget;
    const itemName = button.getAttribute('data-item-name');
    const itemId = button.getAttribute('data-item-id');

    const modalItemName = deactivateItemModal.querySelector('#modalDeactivateItemName');
    const deactivateForm = deactivateItemModal.querySelector('#deactivateItemForm');

    modalItemName.textContent = itemName;
    deactivateForm.action = `/admin/store/delete/${itemId}`;
  });

  // Delete modal handler
  const deleteItemModal = document.getElementById('deleteItemModal');
  deleteItemModal.addEventListener('show.bs.modal', event => {
    const button = event.relatedTarget;
    const itemName = button.getAttribute('data-item-name');
    const itemId = button.getAttribute('data-item-id');

    const modalItemName = deleteItemModal.querySelector('#modalDeleteItemName');
    const deleteForm = deleteItemModal.querySelector('#deleteItemForm');

    modalItemName.textContent = itemName;
    deleteForm.action = `/admin/store/hard-delete/${itemId}`;
  });

  // Toggle bundle options
  const isBundleCheck = document.getElementById('isBundleCheck');
  const bundleOptions = document.getElementById('bundleOptions');
  if (isBundleCheck) {
    isBundleCheck.addEventListener('change', function() {
      bundleOptions.style.display = this.checked ? 'block' : 'none';
    });
    // Initial state
    if (isBundleCheck.checked) {
      bundleOptions.style.display = 'block';
    }
  }

  // Toggle bulk discount options
  const bulkDiscountCheck = document.getElementById('bulkDiscountCheck');
  const bulkDiscountOptions = document.getElementById('bulkDiscountOptions');
  if (bulkDiscountCheck) {
    bulkDiscountCheck.addEventListener('change', function() {
      bulkDiscountOptions.style.display = this.checked ? 'block' : 'none';
    });
    // Initial state
    if (bulkDiscountCheck.checked) {
      bulkDiscountOptions.style.display = 'block';
    }
  }

  // Toggle collective goal card based on item type
  const itemTypeSelect = document.getElementById('item_type');
  const collectiveGoalCard = document.getElementById('collectiveGoalCard');
  const collectiveGoalTypeSelect = document.getElementById('collectiveGoalType');
  const fixedTargetDiv = document.getElementById('fixedTargetDiv');
  const wholeClassInfo = document.getElementById('wholeClassInfo');

  function updateCollectiveGoalVisibility() {
    if (itemTypeSelect && collectiveGoalCard) {
      if (itemTypeSelect.value === 'collective') {
        collectiveGoalCard.style.display = 'block';
        updateCollectiveGoalTypeVisibility();
      } else {
        collectiveGoalCard.style.display = 'none';
      }
    }
  }

  function updateCollectiveGoalTypeVisibility() {
    if (collectiveGoalTypeSelect) {
      const goalType = collectiveGoalTypeSelect.value;
      if (goalType === 'fixed') {
        fixedTargetDiv.style.display = 'block';
        wholeClassInfo.style.display = 'none';
      } else if (goalType === 'whole_class') {
        fixedTargetDiv.style.display = 'none';
        wholeClassInfo.style.display = 'block';
      } else {
        fixedTargetDiv.style.display = 'none';
        wholeClassInfo.style.display = 'none';
      }
    }
  }

  if (itemTypeSelect) {
    itemTypeSelect.addEventListener('change', updateCollectiveGoalVisibility);
    // Initial state
    updateCollectiveGoalVisibility();
  }

  if (collectiveGoalTypeSelect) {
    collectiveGoalTypeSelect.addEventListener('change', updateCollectiveGoalTypeVisibility);
    // Initial state
    updateCollectiveGoalTypeVisibility();
  }
</script>

<script src="https://cdn.jsdelivr.net/npm/easymde/dist/easymde.min.js"></script>
<script>
  // Initialize markdown editors for description and redemption_prompt fields
  document.addEventListener('DOMContentLoaded', function() {
    const descriptionField = document.getElementById('description');
    const redemptionPromptField = document.getElementById('redemption_prompt');

    if (descriptionField) {
      new EasyMDE({
        element: descriptionField,
        spellChecker: false,
        toolbar: ["bold", "italic", "heading", "|", "unordered-list", "ordered-list", "|", "link", "quote", "|", "preview", "side-by-side", "fullscreen", "|", "guide"],
        status: false,
        placeholder: "Enter item description (Markdown supported)...",
      });
    }

    if (redemptionPromptField) {
      new EasyMDE({
        element: redemptionPromptField,
        spellChecker: false,
        toolbar: ["bold", "italic", "heading", "|", "unordered-list", "ordered-list", "|", "link", "quote", "|", "preview", "side-by-side", "fullscreen", "|", "guide"],
        status: false,
        placeholder: "Enter redemption prompt (Markdown supported)...",
      });
    }
  });
</script>

{% endblock %}
