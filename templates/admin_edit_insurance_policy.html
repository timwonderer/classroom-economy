{% extends "layout_admin.html" %}
{% set page_title = "Edit Insurance Policy" %}
{% set current_page = "insurance" %}
{% block title %}Edit Policy{% endblock %}

{% block extra_head %}
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/easymde/dist/easymde.min.css">
<script src="{{ static_url('js/economy-balance.js') }}"></script>
<style>
    .EasyMDEContainer .CodeMirror {
        min-height: 150px;
    }
    .editor-toolbar {
        border-radius: 4px 4px 0 0;
    }
    .CodeMirror {
        border-radius: 0 0 4px 4px;
    }
</style>
{% endblock %}

{% block content %}

<div class="container-fluid">
  <div class="row mb-3">
    <div class="col">
      <nav aria-label="breadcrumb">
        <ol class="breadcrumb">
          <li class="breadcrumb-item"><a href="{{ url_for('admin.insurance_management') }}">Insurance</a></li>
          <li class="breadcrumb-item active">Edit Policy: {{ policy.title }}</li>
        </ol>
      </nav>
    </div>
  </div>

  <form method="POST" action="{{ url_for('admin.edit_insurance_policy', policy_id=policy.id) }}">
    {{ form.hidden_tag() }}

    <div class="row">
      <!-- Main Form Section - 2x2 Grid -->
      <div class="col-lg-8 mb-4">
        <!-- Row 1 -->
        <div class="row mb-4">
          <!-- Top Left: Basic Information -->
          <div class="col-md-6 mb-4">
            <div class="card shadow-sm h-100">
              <div class="card-header bg-primary text-white">
                <h6 class="mb-0"><i class="bi bi-info-circle me-2"></i>Basic Information</h6>
              </div>
              <div class="card-body">
                <div class="mb-3">
                  {{ form.title.label(class="form-label fw-bold") }}
                  {{ form.title(class="form-control", placeholder="e.g., Basic Health Coverage") }}
                  <small class="text-muted">Policy name shown to students</small>
                </div>
                <div class="mb-3">
                  {{ form.description.label(class="form-label fw-bold") }}
                  {{ form.description(class="form-control", rows=6, placeholder="Describe what this policy covers...") }}
                  <small class="text-muted">Clear description of coverage and benefits</small>
                </div>
                <div class="mb-3">
                  {{ form.marketing_badge.label(class="form-label fw-bold") }}
                  {{ form.marketing_badge(class="form-select") }}
                  <small class="text-muted">Add a fun marketing badge to attract students</small>
                </div>
                <div class="mb-0">
                  {{ form.claim_type.label(class="form-label fw-bold") }}
                  {{ form.claim_type(class="form-select", id="edit_claim_type") }}
                  <div class="alert alert-light border mt-2 mb-0">
                    <small>
                      <strong>Transactions-based:</strong> Link claims to a specific student transaction.<br>
                      <strong>Non-monetary:</strong> Approval-only workflow, no reimbursements.<br>
                      <strong>Legacy monetary:</strong> Manual claim amounts (backward compatible).
                    </small>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- Top Right: Pricing & Payment -->
          <div class="col-md-6 mb-4">
            <div class="card shadow-sm h-100">
              <div class="card-header bg-success text-white">
                <h6 class="mb-0"><i class="bi bi-currency-dollar me-2"></i>Pricing & Payment</h6>
              </div>
              <div class="card-body">
                <!-- Economy Balance Check -->
                <div id="cwi-info" class="mb-3"></div>

                <div class="row">
                  <div class="col-md-6 mb-3">
                    {{ form.premium.label(class="form-label fw-bold") }}
                    <div class="input-group">
                      <span class="input-group-text">$</span>
                      {{ form.premium(class="form-control", placeholder="0.00", **{'data-economy-validate': 'insurance'}) }}
                    </div>
                    <small class="text-muted">Cost per cycle</small>
                  </div>
                  <div class="col-md-6 mb-3">
                    {{ form.charge_frequency.label(class="form-label fw-bold") }}
                    {{ form.charge_frequency(class="form-select", **{'data-economy-frequency-field': 'true'}) }}
                    <small class="text-muted">Billing frequency</small>
                  </div>
                </div>

                <!-- Economy Balance Warnings -->
                <div id="economy-warnings"></div>
                <div class="mb-3">
                  <div class="form-check form-switch">
                    {{ form.autopay(class="form-check-input", role="switch") }}
                    {{ form.autopay.label(class="form-check-label fw-bold") }}
                  </div>
                  <small class="text-muted">Auto-deduct premiums from student accounts</small>
                </div>
                <div class="mb-0">
                  {{ form.auto_cancel_nonpay_days.label(class="form-label fw-bold") }}
                  <div class="input-group">
                    {{ form.auto_cancel_nonpay_days(class="form-control", placeholder="0") }}
                    <span class="input-group-text">days</span>
                  </div>
                  <small class="text-muted">Cancel if unpaid (0 = never)</small>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Row 2 -->
        <div class="row">
          <!-- Bottom Left: Coverage & Claims -->
          <div class="col-md-6 mb-4">
            <div class="card shadow-sm h-100">
              <div class="card-header bg-info text-white">
                <h6 class="mb-0"><i class="bi bi-shield-check me-2"></i>Coverage & Claims</h6>
              </div>
              <div class="card-body">
                <div class="row">
                  <div class="col-md-6 mb-3">
                    {{ form.waiting_period_days.label(class="form-label fw-bold") }}
                    <div class="input-group">
                      {{ form.waiting_period_days(class="form-control", placeholder="0") }}
                      <span class="input-group-text">days</span>
                    </div>
                    <small class="text-muted">Before coverage starts</small>
                  </div>
                  <div class="col-md-6 mb-3">
                    {{ form.claim_time_limit_days.label(class="form-label fw-bold") }}
                    <div class="input-group">
                      {{ form.claim_time_limit_days(class="form-control", placeholder="0") }}
                      <span class="input-group-text">days</span>
                    </div>
                    <small class="text-muted">To file after incident</small>
                  </div>
                </div>
                <div class="row">
                  <div class="col-md-6 mb-3">
                    {{ form.max_claims_count.label(class="form-label fw-bold") }}
                    {{ form.max_claims_count(class="form-control", placeholder="0") }}
                    <small class="text-muted">Max per period (0 = âˆž)</small>
                  </div>
                  <div class="col-md-6 mb-3">
                    {{ form.max_claims_period.label(class="form-label fw-bold") }}
                    {{ form.max_claims_period(class="form-select") }}
                    <small class="text-muted">Period type</small>
                  </div>
                </div>
                <div class="mb-3">
                  {{ form.max_claim_amount.label(class="form-label fw-bold") }}
                  <div class="input-group">
                    <span class="input-group-text">$</span>
                    {{ form.max_claim_amount(class="form-control", placeholder="0.00") }}
                  </div>
                  <small class="text-muted">Max payout per claim (0 = âˆž)</small>
                </div>
                <div class="mb-0">
                  {{ form.max_payout_per_period.label(class="form-label fw-bold") }}
                  <div class="input-group">
                    <span class="input-group-text">$</span>
                    {{ form.max_payout_per_period(class="form-control", placeholder="0.00") }}
                  </div>
                  <small class="text-muted">Max total payout per period (0 = âˆž)</small>
                </div>
              </div>
            </div>
          </div>

          <!-- Bottom Right: Policy Rules & Bundle Settings -->
          <div class="col-md-6 mb-4">
            <div class="card shadow-sm h-100">
              <div class="card-header bg-warning text-dark">
                <h6 class="mb-0"><i class="bi bi-gear me-2"></i>Rules & Bundles</h6>
              </div>
              <div class="card-body">
                <!-- Repurchase Rules -->
                <div class="mb-3 pb-3 border-bottom">
                  <h6 class="fw-bold mb-2"><i class="bi bi-ban me-1"></i>Repurchase Restrictions</h6>

                  <!-- Permanent Block -->
                  <div class="form-check form-switch mb-2">
                    {{ form.no_repurchase_after_cancel(class="form-check-input", role="switch", id="permanentBlockToggle") }}
                    {{ form.no_repurchase_after_cancel.label(class="form-check-label fw-bold") }}
                  </div>
                  <small class="text-muted d-block mb-3">Students can NEVER repurchase after canceling</small>

                  <!-- Cooldown Period -->
                  <div id="cooldownSection">
                    <div class="form-check form-switch mb-2">
                      {{ form.enable_repurchase_cooldown(class="form-check-input", role="switch", id="cooldownToggle") }}
                      {{ form.enable_repurchase_cooldown.label(class="form-check-label fw-bold") }}
                    </div>
                    <small class="text-muted d-block mb-2">Students must wait before repurchasing</small>

                    <div id="cooldownDays" style="display: none;">
                      {{ form.repurchase_wait_days.label(class="form-label fw-bold small") }}
                      <div class="input-group input-group-sm">
                        {{ form.repurchase_wait_days(class="form-control", placeholder="30") }}
                        <span class="input-group-text">days</span>
                      </div>
                      <small class="text-muted">Cooldown period for repurchase</small>
                    </div>
                  </div>
                </div>

                <!-- Bundle Settings -->
                <div>
                  <h6 class="fw-bold mb-2"><i class="bi bi-boxes me-1"></i>Bundle Discounts</h6>

                  <!-- Policy Selection -->
                  <div class="mb-3">
                    <label class="form-label fw-bold small">Bundle With Policies</label>
                    <div class="border rounded p-2" style="max-height: 120px; overflow-y: auto; background-color: #f8f9fa;">
                      {% if available_policies %}
                        {% for avail_policy in available_policies %}
                        <div class="form-check form-check-sm">
                          <input class="form-check-input bundle-policy-checkbox" type="checkbox"
                                 value="{{ avail_policy.id }}"
                                 id="bundle_{{ avail_policy.id }}"
                                 {% if policy.bundle_with_policy_ids and (avail_policy.id|string in policy.bundle_with_policy_ids.split(',')) %}checked{% endif %}>
                          <label class="form-check-label small" for="bundle_{{ avail_policy.id }}">
                            {{ avail_policy.title }} (${{ avail_policy.premium }})
                          </label>
                        </div>
                        {% endfor %}
                      {% else %}
                        <small class="text-muted">No other active policies available</small>
                      {% endif %}
                    </div>
                    {{ form.bundle_with_policy_ids(class="form-control d-none", id="bundlePolicyIds") }}
                    <small class="text-muted">Select policies that can be bundled</small>
                  </div>

                  <!-- Discount Options -->
                  <div class="row">
                    <div class="col-6">
                      {{ form.bundle_discount_percent.label(class="form-label fw-bold small") }}
                      <div class="input-group input-group-sm">
                        {{ form.bundle_discount_percent(class="form-control", placeholder="0") }}
                        <span class="input-group-text">%</span>
                      </div>
                      <small class="text-muted">Percent off</small>
                    </div>
                    <div class="col-6">
                      {{ form.bundle_discount_amount.label(class="form-label fw-bold small") }}
                      <div class="input-group input-group-sm">
                        <span class="input-group-text">$</span>
                        {{ form.bundle_discount_amount(class="form-control", placeholder="0.00") }}
                      </div>
                      <small class="text-muted">Dollar off</small>
                    </div>
                  </div>
                </div>

                <!-- Group Settings -->
                <hr>
                <div class="card border-warning bg-light-subtle">
                  <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center mb-2">
                      <div>
                        <h6 class="fw-bold mb-0"><i class="bi bi-layers me-2"></i>Grouped Insurance</h6>
                        <small class="text-muted">Students can select <strong>one policy</strong> per group. <span class="ms-1" data-bs-toggle="tooltip" title="Grouped insurance policies are mutually exclusiveâ€”students choose only one from a group."><i class="bi bi-info-circle"></i></span></small>
                      </div>
                      <div class="form-check form-switch">
                        <input class="form-check-input" type="checkbox" id="tierToggleEdit" {% if form.tier_category_id.data %}checked{% endif %}>
                        <label class="form-check-label fw-bold" for="tierToggleEdit">This insurance is grouped</label>
                      </div>
                    </div>

                    <div id="tierSelectionEdit" class="mt-2" style="{% if not form.tier_category_id.data %}display:none;{% endif %}">
                      <div class="alert alert-info py-2 px-3 {% if not form.tier_category_id.data %}d-none{% endif %}" id="tierSummaryEdit">
                        {% if form.tier_category_id.data %}
                          Currently grouped in <strong>{{ form.tier_name.data or ('Group ' ~ form.tier_category_id.data) }}</strong> Â· select one only
                        {% endif %}
                      </div>

                      <div class="d-flex align-items-center gap-2 mb-3" id="tierActionsEdit" {% if not form.tier_category_id.data %}style="display:none;"{% endif %}>
                        <button type="button" class="btn btn-outline-danger btn-sm" id="removeGroupBtn">Remove insurance from group</button>
                      </div>

                      {% if tier_groups %}
                      <div class="row g-3 mb-3">
                        {% for group in tier_groups %}
                        <div class="col-md-6">
                            <div class="card h-100 border-{{ group.color }}">
                              <div class="card-body">
                                <div class="d-flex justify-content-between align-items-start mb-2">
                                  <div>
                                    <span class="badge bg-{{ group.color }} text-white">{{ group.name }}</span>
                                    <div class="small text-muted">Students choose one option in this group</div>
                                  </div>
                                  <button type="button" class="btn btn-outline-primary btn-sm select-tier-btn-edit" data-tier-id="{{ group.id }}" data-tier-name="{{ group.name }}" data-tier-color="{{ group.color }}">
                                    Add this insurance to group
                                  </button>
                              </div>
                              <div class="small text-muted">{{ group.policies|length }} policy{{ 'ies' if group.policies|length != 1 else '' }} in this group</div>
                            </div>
                          </div>
                        </div>
                        {% endfor %}
                      </div>
                      <div class="mb-3">
                        <button type="button" class="btn btn-outline-secondary btn-sm" id="startNewGroupBtnEdit">Create a new group</button>
                      </div>
                      {% else %}
                        <div class="alert alert-warning d-flex align-items-center" role="alert">
                        <i class="bi bi-info-circle me-2"></i>
                        <div>No grouped insurance exists yet. Name your first group to create a "select one only" group.</div>
                      </div>
                      {% endif %}

                      <div id="newGroupFieldsEdit" class="card card-body border-0 bg-white shadow-sm {% if not form.tier_category_id.data and tier_groups %}d-none{% endif %}">
                        <div class="d-flex align-items-center mb-3">
                          <small class="text-muted">Students can choose one policy per group.</small>
                        </div>
                        <div class="row g-2">
                          <div class="col-md-7">
                            {{ form.tier_name.label(class="form-label fw-bold small") }}
                            {{ form.tier_name(class="form-control form-control-sm", id="tier_name") }}
                          </div>
                          <div class="col-md-5">
                            {{ form.tier_color.label(class="form-label fw-bold small") }}
                            {{ form.tier_color(class="form-select form-select-sm", id="tier_color") }}
                          </div>
                        </div>
                      </div>
                    </div>

                    <div class="d-none">
                      {{ form.tier_category_id(id="tier_category_id") }}
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Right Sidebar -->
      <div class="col-lg-4">
        <!-- Status Card -->
        <div class="card shadow-sm mb-4 border-{{ 'success' if policy.is_active else 'danger' }}">
          <div class="card-header bg-{{ 'success' if policy.is_active else 'danger' }} text-white">
            <h6 class="mb-0"><i class="bi bi-toggle-{{ 'on' if policy.is_active else 'off' }} me-2"></i>Policy Status</h6>
          </div>
          <div class="card-body">
            <div class="form-check form-switch mb-3">
              {{ form.is_active(class="form-check-input", role="switch", style="width: 3rem; height: 1.5rem;") }}
              {{ form.is_active.label(class="form-check-label fw-bold fs-5 ms-2") }}
            </div>
            <div class="alert alert-{{ 'success' if policy.is_active else 'warning' }} mb-0">
              <small>
                {% if policy.is_active %}
                <i class="bi bi-check-circle"></i> Visible and available for purchase
                {% else %}
                <i class="bi bi-x-circle"></i> Hidden from students
                {% endif %}
              </small>
            </div>
          </div>
        </div>

        <!-- Statistics Card -->
        <div class="card shadow-sm mb-4">
          <div class="card-header bg-secondary text-white">
            <h6 class="mb-0"><i class="bi bi-graph-up me-2"></i>Statistics</h6>
          </div>
          <div class="card-body p-3">
            <div class="d-flex justify-content-between align-items-center mb-3 pb-3 border-bottom">
              <div>
                <div class="text-muted small mb-1">Active Students</div>
                <h3 class="mb-0 text-primary">{{ policy.student_policies.filter_by(status='active').count() }}</h3>
              </div>
              <div class="text-end">
                <i class="bi bi-people-fill text-primary" style="font-size: 2.5rem; opacity: 0.2;"></i>
              </div>
            </div>
            <div class="d-flex justify-content-between align-items-center mb-3 pb-3 border-bottom">
              <div>
                <div class="text-muted small mb-1">Total Claims</div>
                <h3 class="mb-0 text-info">{{ policy.claims.count() }}</h3>
              </div>
              <div class="text-end">
                <i class="bi bi-file-text-fill text-info" style="font-size: 2.5rem; opacity: 0.2;"></i>
              </div>
            </div>
            <div class="d-flex justify-content-between align-items-center">
              <div>
                <div class="text-muted small mb-1">Created</div>
                <div class="fw-bold">{{ policy.created_at.strftime('%b %d, %Y') }}</div>
              </div>
              <div class="text-end">
                <i class="bi bi-calendar-check text-secondary" style="font-size: 2rem; opacity: 0.2;"></i>
              </div>
            </div>
          </div>
        </div>

        <!-- Quick Tips Card -->
        <div class="card shadow-sm mb-4 bg-light">
          <div class="card-header border-0 bg-transparent">
            <h6 class="mb-0 text-primary"><i class="bi bi-lightbulb-fill me-2"></i>Quick Tips</h6>
          </div>
          <div class="card-body pt-0">
            <ul class="small mb-0 ps-3" style="line-height: 1.8;" id="insurance-quick-tips">
              <li><strong>Price with CWI in mind:</strong> <span class="tip-pricing">Keep premium costs between 5-12% of weekly expected income (CWI) to ensure affordability</span></li>
              <li><strong>Waiting periods:</strong> 3-7 days prevents immediate claims after purchase while remaining student-friendly</li>
              <li><strong>Bundle discounts:</strong> 10-20% off encourages students to buy multiple policies together</li>
              <li><strong>Balance coverage:</strong> Set max payouts 2-4x higher than premiums to ensure claims feel worthwhile</li>
              <li><strong>Enable autopay:</strong> Auto-deduction reduces payment friction and improves participation rates</li>
              <li><strong>Monitor claims:</strong> Review claim patterns monthly to adjust coverage limits and identify abuse</li>
            </ul>
          </div>
        </div>

        <!-- Action Buttons -->
        <div class="d-grid gap-2">
          {{ form.submit(class="btn btn-primary btn-lg", value="ðŸ’¾ Save Changes") }}
          <a href="{{ url_for('admin.insurance_management') }}" class="btn btn-outline-secondary">Cancel</a>
        </div>
      </div>
    </div>
  </form>
</div>

<script>
// Update hidden field with selected bundle policies
document.addEventListener('DOMContentLoaded', function() {
  const checkboxes = document.querySelectorAll('.bundle-policy-checkbox');
  const hiddenField = document.getElementById('bundlePolicyIds');

  function updateBundleIds() {
    const selectedIds = Array.from(checkboxes)
      .filter(cb => cb.checked)
      .map(cb => cb.value);
    hiddenField.value = selectedIds.join(',');
  }

  checkboxes.forEach(cb => {
    cb.addEventListener('change', updateBundleIds);
  });

  // Initialize on load
  updateBundleIds();

  // Initialize Economy Balance Checker
  if (typeof EconomyBalanceChecker !== 'undefined') {
    const economyChecker = new EconomyBalanceChecker({
      warningsContainer: '#economy-warnings',
      expectedWeeklyHours: {{ (payroll_settings.expected_weekly_hours if payroll_settings and payroll_settings.expected_weekly_hours is not none else 5.0) | float }}
    });

    // Display CWI info if payroll is configured
    economyChecker.analyzeEconomy().then(analysis => {
      economyChecker.displayCWIInfo(analysis, '#cwi-info');
    }).catch(err => {
      console.log('Payroll not configured yet, skipping CWI display');
    });

    // Update frequency data attribute when frequency field changes
    const frequencyField = document.querySelector('[data-economy-frequency-field]');
    const premiumField = document.querySelector('[data-economy-validate="insurance"]');
    if (frequencyField && premiumField) {
      frequencyField.addEventListener('change', function() {
        premiumField.setAttribute('data-economy-frequency', this.value);
        // Trigger validation
        premiumField.dispatchEvent(new Event('input'));
        // Update Quick Tips based on frequency
        updateQuickTipsPricing(this.value, economyChecker.currentCWI);
      });
      // Set initial frequency
      premiumField.setAttribute('data-economy-frequency', frequencyField.value);
    }

    // Function to update Quick Tips pricing based on frequency
    function updateQuickTipsPricing(frequency, cwi) {
      if (!cwi) return;

      const tipPricingElement = document.querySelector('.tip-pricing');
      if (!tipPricingElement) return;

      // Calculate frequency-specific affordable range (5-12% of CWI for insurance)
      const minWeekly = cwi * 0.05;
      const maxWeekly = cwi * 0.12;

      let multiplier = 1;
      let frequencyLabel = 'weekly';

      switch(frequency) {
        case 'monthly':
          multiplier = 4.345; // average weeks per month
          frequencyLabel = 'monthly';
          break;
        case 'weekly':
          multiplier = 1;
          frequencyLabel = 'weekly';
          break;
        case 'biweekly':
          multiplier = 2;
          frequencyLabel = 'biweekly';
          break;
        case 'daily':
          multiplier = 1/7;
          frequencyLabel = 'daily';
          break;
        case 'semester':
          multiplier = 18; // 18 weeks per semester
          frequencyLabel = 'semester';
          break;
        case 'yearly':
          multiplier = 52;
          frequencyLabel = 'yearly';
          break;
      }

      const minPrice = (minWeekly * multiplier).toFixed(2);
      const maxPrice = (maxWeekly * multiplier).toFixed(2);
      const cwiDisplay = cwi.toFixed(2);

      tipPricingElement.textContent = `Keep ${frequencyLabel} premium costs in the $${minPrice}-$${maxPrice} range (5-12% of weekly expected income: $${cwiDisplay})`;
    }

    // Update Quick Tips with initial frequency and CWI
    economyChecker.analyzeEconomy().then(analysis => {
      updateQuickTipsPricing(frequencyField ? frequencyField.value : 'weekly', analysis.cwi);
    }).catch(err => {
      console.log('Could not update Quick Tips pricing');
    });
  }

  // Handle mutually exclusive repurchase restrictions
  const permanentBlockToggle = document.getElementById('permanentBlockToggle');
  const cooldownToggle = document.getElementById('cooldownToggle');
  const cooldownSection = document.getElementById('cooldownSection');
  const cooldownDays = document.getElementById('cooldownDays');

  function updateRepurchaseRestrictions() {
    if (permanentBlockToggle.checked) {
      // Permanent block is ON - disable and hide cooldown section
      cooldownSection.style.opacity = '0.5';
      cooldownSection.style.pointerEvents = 'none';
      cooldownToggle.checked = false;
      cooldownToggle.disabled = true;
      cooldownDays.style.display = 'none';
    } else {
      // Permanent block is OFF - enable cooldown section
      cooldownSection.style.opacity = '1';
      cooldownSection.style.pointerEvents = 'auto';
      cooldownToggle.disabled = false;

      // Show/hide days field based on cooldown toggle
      if (cooldownToggle.checked) {
        cooldownDays.style.display = 'block';
      } else {
        cooldownDays.style.display = 'none';
      }
    }
  }

  if (permanentBlockToggle && cooldownToggle) {
    permanentBlockToggle.addEventListener('change', updateRepurchaseRestrictions);
    cooldownToggle.addEventListener('change', updateRepurchaseRestrictions);
    updateRepurchaseRestrictions(); // Initialize on load
  }

  // Tier grouping flow (edit mode)
  const tierToggleEdit = document.getElementById('tierToggleEdit');
  const tierSelectionEdit = document.getElementById('tierSelectionEdit');
  const tierCategoryInput = document.getElementById('tier_category_id');
  const tierNameInput = document.getElementById('tier_name');
  const tierColorInput = document.getElementById('tier_color');
  const tierSummaryEdit = document.getElementById('tierSummaryEdit');
  const newGroupFieldsEdit = document.getElementById('newGroupFieldsEdit');
  const startNewGroupBtnEdit = document.getElementById('startNewGroupBtnEdit');
  const selectTierButtonsEdit = document.querySelectorAll('.select-tier-btn-edit');
  const removeGroupBtn = document.getElementById('removeGroupBtn');
  const tierActionsEdit = document.getElementById('tierActionsEdit');

  function clearTierFields() {
    if (tierCategoryInput) tierCategoryInput.value = '';
    if (tierNameInput) tierNameInput.value = '';
    if (tierColorInput) tierColorInput.value = '';
  }

  function showTierSelection() {
    if (tierSelectionEdit) tierSelectionEdit.style.display = 'block';
  }

  function hideTierSelection() {
    if (tierSelectionEdit) tierSelectionEdit.style.display = 'none';
    if (tierSummaryEdit) tierSummaryEdit.classList.add('d-none');
    if (tierActionsEdit) tierActionsEdit.style.display = 'none';
    if (newGroupFieldsEdit) newGroupFieldsEdit.classList.add('d-none');
    clearTierFields();
  }

  function setTierValues(tier) {
    if (tierCategoryInput) tierCategoryInput.value = tier.id;
    if (tierNameInput) tierNameInput.value = tier.name || '';
    if (tierColorInput) tierColorInput.value = tier.color || 'primary';
    if (tierSummaryEdit) {
      tierSummaryEdit.innerHTML = `<strong>Grouped:</strong> ${tier.name || 'Untitled Group'} Â· select one only`;
      tierSummaryEdit.classList.remove('d-none');
    }
    if (tierActionsEdit) tierActionsEdit.style.display = 'flex';
    if (newGroupFieldsEdit) newGroupFieldsEdit.classList.remove('d-none');
  }

  function startNewGroup() {
    showTierSelection();
    if (tierCategoryInput) tierCategoryInput.value = '';
    if (tierSummaryEdit) tierSummaryEdit.classList.add('d-none');
    if (tierActionsEdit) tierActionsEdit.style.display = 'flex';
    if (newGroupFieldsEdit) newGroupFieldsEdit.classList.remove('d-none');
    if (tierColorInput && !tierColorInput.value) tierColorInput.value = 'primary';
  }

  selectTierButtonsEdit.forEach(btn => {
    btn.addEventListener('click', () => {
      if (tierToggleEdit) tierToggleEdit.checked = true;
      showTierSelection();
      setTierValues({
        id: btn.dataset.tierId,
        name: btn.dataset.tierName,
        color: btn.dataset.tierColor
      });
    });
  });

  if (startNewGroupBtnEdit) {
    startNewGroupBtnEdit.addEventListener('click', () => {
      if (tierToggleEdit) tierToggleEdit.checked = true;
      startNewGroup();
    });
  }

  if (removeGroupBtn) {
    removeGroupBtn.addEventListener('click', () => {
      hideTierSelection();
      if (tierToggleEdit) tierToggleEdit.checked = false;
    });
  }

  if (tierToggleEdit) {
    tierToggleEdit.addEventListener('change', () => {
      if (tierToggleEdit.checked) {
        showTierSelection();
        if (!selectTierButtonsEdit.length) {
          startNewGroup();
        } else if (tierCategoryInput && tierCategoryInput.value) {
          setTierValues({
            id: tierCategoryInput.value,
            name: tierNameInput ? tierNameInput.value : '',
            color: tierColorInput ? tierColorInput.value : 'primary'
          });
        }
      } else {
        hideTierSelection();
      }
    });
  }

  // Initialize selection if already grouped
  if (tierCategoryInput && tierCategoryInput.value) {
    if (tierToggleEdit) tierToggleEdit.checked = true;
    showTierSelection();
    setTierValues({
      id: tierCategoryInput.value,
      name: tierNameInput ? tierNameInput.value : '',
      color: tierColorInput ? tierColorInput.value : 'primary'
    });
  }

  // Enable tooltips for grouped insurance info
  const tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
  tooltipTriggerList.map(function (tooltipTriggerEl) {
    return new bootstrap.Tooltip(tooltipTriggerEl);
  });
});
</script>

<script src="https://cdn.jsdelivr.net/npm/easymde/dist/easymde.min.js"></script>
<script>
  // Initialize markdown editor for policy description
  document.addEventListener('DOMContentLoaded', function() {
    const descriptionField = document.getElementById('description');

    if (descriptionField) {
      new EasyMDE({
        element: descriptionField,
        spellChecker: false,
        autoDownloadFontAwesome: false,
        toolbar: ["bold", "italic", "heading", "|", "unordered-list", "ordered-list", "|", "link", "quote", "|", "preview", "side-by-side", "fullscreen", "|", "guide"],
        status: false,
        placeholder: "Describe what this policy covers (Markdown supported)...",
      });
    }
  });
</script>

{% endblock %}
