{% extends "layout_admin.html" %}
{% set page_title = "Attendance Log" %}
{% block title %}Attendance Log{% endblock %}
{% block page_icon %}fact_check{% endblock %}
{% block content %}

<!-- Stats Summary Card -->
<div class="card shadow mb-4">
    <div class="card-body py-3">
        <div class="row align-items-center g-3">
            <div class="col-auto">
                <span class="material-symbols-outlined" style="font-size: 2rem; color: var(--brand-primary);">summarize</span>
            </div>
            <div class="col">
                <div class="row g-3">
                    <div class="col-md-3">
                        <div class="d-flex align-items-center">
                            <span class="material-symbols-outlined me-2 text-primary">event</span>
                            <div>
                                <div class="small text-muted">Total Records</div>
                                <div class="fw-bold" id="totalRecords">0</div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="d-flex align-items-center">
                            <span class="material-symbols-outlined me-2 text-success">login</span>
                            <div>
                                <div class="small text-muted">Tap Ins</div>
                                <div class="fw-bold text-success" id="tapInCount">0</div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="d-flex align-items-center">
                            <span class="material-symbols-outlined me-2 text-danger">logout</span>
                            <div>
                                <div class="small text-muted">Tap Outs</div>
                                <div class="fw-bold text-danger" id="tapOutCount">0</div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="d-flex align-items-center">
                            <span class="material-symbols-outlined me-2 text-info">schedule</span>
                            <div>
                                <div class="small text-muted">Showing</div>
                                <div class="fw-bold" id="showingRange">—</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="row g-3">
    <div class="col-lg-4">
        <div class="card shadow-sm h-100">
            <div class="card-header bg-white py-3 d-flex justify-content-between align-items-center">
                <h6 class="mb-0 fw-bold d-flex align-items-center gap-2">
                    <span class="material-symbols-outlined">toggle_on</span>
                    Tap In/Out Controls
                </h6>
            </div>
            <div class="card-body">
                {% if blocks %}
                    <p class="text-muted small mb-3">Disable tap in/out per class to pause attendance for that block.</p>
                    <div class="list-group list-group-flush">
                        {% for block in blocks %}
                        <div class="list-group-item d-flex justify-content-between align-items-center px-0">
                            <div>
                                <div class="fw-semibold">{{ class_labels_by_block.get(block, block) }}</div>
                                <div class="text-muted small">Block {{ block }}</div>
                            </div>
                            <div class="form-check form-switch m-0">
                                <input
                                    class="form-check-input block-tap-toggle"
                                    type="checkbox"
                                    id="blockTapToggle{{ loop.index }}"
                                    data-block="{{ block|upper }}"
                                    checked>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                {% else %}
                    <p class="text-muted mb-0">No classes available yet.</p>
                {% endif %}
            </div>
        </div>
    </div>

    <div class="col-lg-8">
        <div class="card shadow h-100">
            <div class="card-header bg-white py-3">
                <div class="d-flex justify-content-between align-items-center">
                    <h5 class="mb-0 fw-bold">
                        <span class="material-symbols-outlined me-2" style="vertical-align: text-bottom;">history</span>
                        Attendance History
                    </h5>
                </div>
            </div>

            <!-- Filters -->
            <div class="card-body border-bottom bg-light">
                <div class="row g-3">
                    <div class="col-md-3">
                        <label class="form-label small fw-bold">Period</label>
                        <select class="form-select form-select-sm" id="filterPeriod">
                            <option value="">All Periods</option>
                            {% for period in periods %}
                            <option value="{{ period }}">{{ period }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="col-md-3">
                        <label class="form-label small fw-bold">Class</label>
                        <select class="form-select form-select-sm" id="filterBlock">
                            <option value="">All Classes</option>
                            {% for block in blocks %}
                            <option value="{{ block }}">{{ class_labels_by_block.get(block, block) }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="col-md-2">
                        <label class="form-label small fw-bold">Status</label>
                        <select class="form-select form-select-sm" id="filterStatus">
                            <option value="">All</option>
                            <option value="active">Tap In (Active)</option>
                            <option value="inactive">Tap Out (Inactive)</option>
                        </select>
                    </div>
                    <div class="col-md-2">
                        <label class="form-label small fw-bold">Start Date</label>
                        <input type="date" class="form-control form-control-sm" id="filterStartDate">
                    </div>
                    <div class="col-md-2">
                        <label class="form-label small fw-bold">End Date</label>
                        <input type="date" class="form-control form-control-sm" id="filterEndDate">
                    </div>
                    <div class="col-12 d-flex align-items-center gap-2">
                        <button class="btn btn-sm btn-primary" onclick="loadAttendanceHistory()">
                            <span class="material-symbols-outlined" style="font-size: 1rem; vertical-align: text-bottom;">filter_alt</span>
                            Apply
                        </button>
                        <button class="btn btn-sm btn-outline-secondary" onclick="resetFilters()" title="Reset filters">
                            <span class="material-symbols-outlined" style="font-size: 1rem;">refresh</span>
                        </button>
                    </div>
                </div>
            </div>

            <!-- Table -->
            <div class="card-body p-0">
                <div id="loadingIndicator" class="text-center py-5 d-none">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                    <p class="text-muted mt-2">Loading attendance records...</p>
                </div>

                <div id="attendanceTableContainer">
                    <div class="table-responsive">
                        <table class="table table-hover align-middle mb-0" id="attendanceTable">
                            <thead style="background: linear-gradient(135deg, var(--brand-primary) 0%, var(--brand-blue) 100%); color: white; position: sticky; top: 0; z-index: 10;">
                                <tr>
                                    <th class="ps-4">Student</th>
                                    <th>Class</th>
                                    <th>Period</th>
                                    <th>Timestamp</th>
                                    <th>Status</th>
                                    <th>Reason</th>
                                </tr>
                            </thead>
                            <tbody id="attendanceTableBody">
                                <!-- Data will be populated by JavaScript -->
                            </tbody>
                        </table>
                    </div>

                    <div id="emptyState" class="text-center py-5 text-muted d-none">
                        <span class="material-symbols-outlined d-block mb-2" style="font-size: 3rem; opacity: 0.3;">search_off</span>
                        <p class="mb-0">No attendance records found</p>
                        <small>Try adjusting your filters</small>
                    </div>
                </div>
            </div>

            <!-- Pagination -->
            <div class="card-footer bg-white border-top">
                <div class="d-flex justify-content-between align-items-center">
                    <div class="text-muted small" id="paginationInfo">
                        Showing 0 - 0 of 0 records
                    </div>
                    <nav aria-label="Attendance pagination">
                        <ul class="pagination pagination-sm mb-0" id="paginationControls">
                            <!-- Pagination buttons will be populated by JavaScript -->
                        </ul>
                    </nav>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
// Global state
let currentPage = 1;
let totalPages = 1;
let totalRecords = 0;
const pageSize = 50;

// HTML escape function to prevent XSS
function escapeHtml(text) {
    if (text == null) return '';
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}

// Use centralized timezone utility for timestamp formatting
const formatTimestamp = window.TimezoneUtils.formatTimestamp;

function initTapToggles() {
    document.querySelectorAll('.block-tap-toggle').forEach(function(toggle) {
        const block = toggle.getAttribute('data-block');

        fetch(`/api/admin/block-tap-settings?block=${block}`)
            .then(response => response.json())
            .then(data => {
                if (data.tap_enabled !== undefined) {
                    toggle.checked = data.tap_enabled;
                }
            })
            .catch(error => console.error('Error loading tap settings:', error));

        toggle.addEventListener('change', function() {
            const isEnabled = this.checked;
            fetch('/api/admin/block-tap-settings', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': document.querySelector('meta[name=\"csrf-token\"]')?.getAttribute('content')
                },
                body: JSON.stringify({
                    block: block,
                    tap_enabled: isEnabled
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'ok') {
                    const toast = document.createElement('div');
                    toast.className = 'alert alert-success alert-dismissible fade show position-fixed top-0 start-50 translate-middle-x mt-3';
                    toast.style.zIndex = '9999';

                    // Create elements safely to prevent XSS
                    const icon = document.createElement('span');
                    icon.className = 'material-symbols-outlined me-2';
                    icon.style.verticalAlign = 'middle';
                    icon.textContent = 'check_circle';

                    const message = document.createTextNode(
                        isEnabled ? `Tap in/out enabled for Block ${block}` : `Tap in/out disabled for Block ${block}`
                    );

                    const closeBtn = document.createElement('button');
                    closeBtn.type = 'button';
                    closeBtn.className = 'btn-close';
                    closeBtn.setAttribute('data-bs-dismiss', 'alert');

                    toast.appendChild(icon);
                    toast.appendChild(message);
                    toast.appendChild(closeBtn);

                    document.body.appendChild(toast);
                    setTimeout(() => toast.remove(), 3000);
                } else {
                    alert('Error updating tap settings: ' + (data.message || 'Unknown error'));
                    toggle.checked = !isEnabled;
                }
            })
            .catch(error => {
                console.error('Error updating tap settings:', error);
                alert('Network error occurred while updating tap settings.');
                toggle.checked = !isEnabled;
            });
        });
    });
}

// Get status badge HTML (status is validated server-side but we escape for defense in depth)
function getStatusBadge(status) {
    const escapedStatus = escapeHtml(status);
    if (status === 'active') {
        return '<span class="badge bg-success"><span class="material-symbols-outlined" style="font-size: 0.875rem; vertical-align: text-bottom;">login</span> Tap In</span>';
    } else if (status === 'inactive') {
        return '<span class="badge bg-danger"><span class="material-symbols-outlined" style="font-size: 0.875rem; vertical-align: text-bottom;">logout</span> Tap Out</span>';
    }
    return '<span class="badge bg-secondary">' + escapedStatus + '</span>';
}

// Load attendance history with filters
async function loadAttendanceHistory(page = 1) {
    currentPage = page;

    // Show loading indicator
    document.getElementById('loadingIndicator').classList.remove('d-none');
    document.getElementById('attendanceTableContainer').classList.add('d-none');

    // Build query parameters
    const params = new URLSearchParams({
        page: page,
        page_size: pageSize
    });

    // Add filters
    const period = document.getElementById('filterPeriod').value;
    const block = document.getElementById('filterBlock').value;
    const status = document.getElementById('filterStatus').value;
    const startDate = document.getElementById('filterStartDate').value;
    const endDate = document.getElementById('filterEndDate').value;

    if (period) params.append('period', period);
    if (block) params.append('block', block);
    if (status) params.append('status', status);
    if (startDate) params.append('start_date', startDate);
    if (endDate) params.append('end_date', endDate);

    try {
        const response = await fetch(`/api/attendance/history?${params.toString()}`);
        const data = await response.json();

        if (data.status === 'success') {
            totalRecords = data.total;
            totalPages = data.total_pages;
            renderAttendanceTable(data.records);
            renderPagination();
            updateStats(data.records);
        } else {
            console.error('Error loading attendance history:', data.message);
            showEmptyState();
        }
    } catch (error) {
        console.error('Error fetching attendance history:', error);
        showEmptyState();
    } finally {
        // Hide loading indicator
        document.getElementById('loadingIndicator').classList.add('d-none');
        document.getElementById('attendanceTableContainer').classList.remove('d-none');
    }
}

// Render attendance table
function renderAttendanceTable(records) {
    const tbody = document.getElementById('attendanceTableBody');

    if (records.length === 0) {
        tbody.innerHTML = '';
        document.getElementById('emptyState').classList.remove('d-none');
        return;
    }

    document.getElementById('emptyState').classList.add('d-none');

    tbody.innerHTML = records.map(record => `
        <tr>
            <td class="ps-4">
                <div class="d-flex align-items-center">
                    <span class="material-symbols-outlined me-2 text-muted" style="font-size: 1.25rem;">person</span>
                    <span class="fw-medium">${escapeHtml(record.student_name)}</span>
                </div>
            </td>
            <td><span class="badge bg-primary bg-opacity-10 text-primary">${escapeHtml(record.student_class_label) || '—'}</span></td>
            <td><span class="badge bg-info bg-opacity-10 text-info">${escapeHtml(record.period)}</span></td>
            <td><span class="text-muted small">${formatTimestamp(record.timestamp)}</span></td>
            <td>${getStatusBadge(record.status)}</td>
            <td class="text-muted small">${escapeHtml(record.reason) || '—'}</td>
        </tr>
    `).join('');
}

// Update stats summary
function updateStats(records) {
    const tapIns = records.filter(r => r.status === 'active').length;
    const tapOuts = records.filter(r => r.status === 'inactive').length;

    document.getElementById('totalRecords').textContent = totalRecords.toLocaleString();
    document.getElementById('tapInCount').textContent = tapIns.toLocaleString();
    document.getElementById('tapOutCount').textContent = tapOuts.toLocaleString();

    const start = (currentPage - 1) * pageSize + 1;
    const end = Math.min(currentPage * pageSize, totalRecords);
    document.getElementById('showingRange').textContent = totalRecords > 0 ? `${start} - ${end}` : '—';
}

// Render pagination controls
function renderPagination() {
    const paginationControls = document.getElementById('paginationControls');
    const paginationInfo = document.getElementById('paginationInfo');

    // Update info text
    const start = (currentPage - 1) * pageSize + 1;
    const end = Math.min(currentPage * pageSize, totalRecords);
    paginationInfo.textContent = `Showing ${start.toLocaleString()} - ${end.toLocaleString()} of ${totalRecords.toLocaleString()} records`;

    // Build pagination buttons
    let html = '';

    // Previous button
    html += `
        <li class="page-item ${currentPage === 1 ? 'disabled' : ''}">
            <a class="page-link" href="#" onclick="loadAttendanceHistory(${currentPage - 1}); return false;">
                <span class="material-symbols-outlined" style="font-size: 1rem;">chevron_left</span>
            </a>
        </li>
    `;

    // Page numbers (show smart pagination)
    const maxVisible = 5;
    let startPage = Math.max(1, currentPage - Math.floor(maxVisible / 2));
    let endPage = Math.min(totalPages, startPage + maxVisible - 1);

    if (endPage - startPage < maxVisible - 1) {
        startPage = Math.max(1, endPage - maxVisible + 1);
    }

    if (startPage > 1) {
        html += `<li class="page-item"><a class="page-link" href="#" onclick="loadAttendanceHistory(1); return false;">1</a></li>`;
        if (startPage > 2) {
            html += `<li class="page-item disabled"><span class="page-link">...</span></li>`;
        }
    }

    for (let i = startPage; i <= endPage; i++) {
        html += `
            <li class="page-item ${i === currentPage ? 'active' : ''}">
                <a class="page-link" href="#" onclick="loadAttendanceHistory(${i}); return false;">${i}</a>
            </li>
        `;
    }

    if (endPage < totalPages) {
        if (endPage < totalPages - 1) {
            html += `<li class="page-item disabled"><span class="page-link">...</span></li>`;
        }
        html += `<li class="page-item"><a class="page-link" href="#" onclick="loadAttendanceHistory(${totalPages}); return false;">${totalPages}</a></li>`;
    }

    // Next button
    html += `
        <li class="page-item ${currentPage === totalPages ? 'disabled' : ''}">
            <a class="page-link" href="#" onclick="loadAttendanceHistory(${currentPage + 1}); return false;">
                <span class="material-symbols-outlined" style="font-size: 1rem;">chevron_right</span>
            </a>
        </li>
    `;

    paginationControls.innerHTML = html;
}

// Show empty state
function showEmptyState() {
    document.getElementById('attendanceTableBody').innerHTML = '';
    document.getElementById('emptyState').classList.remove('d-none');
    document.getElementById('totalRecords').textContent = '0';
    document.getElementById('tapInCount').textContent = '0';
    document.getElementById('tapOutCount').textContent = '0';
    document.getElementById('showingRange').textContent = '—';
}

// Reset filters
function resetFilters() {
    document.getElementById('filterPeriod').value = '';
    document.getElementById('filterBlock').value = '';
    document.getElementById('filterStatus').value = '';
    document.getElementById('filterStartDate').value = '';
    document.getElementById('filterEndDate').value = '';
    loadAttendanceHistory(1);
}

// Load data on page load
document.addEventListener('DOMContentLoaded', () => {
    initTapToggles();
    loadAttendanceHistory(1);
});
</script>

{% endblock %}
