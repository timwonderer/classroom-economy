{% extends "layout_student.html" %}
{% set page_title = "Dashboard" %}
{% set current_page = "dashboard" %}
{% block title %}Dashboard{% endblock %}
{% block page_icon %}dashboard{% endblock %}

{% block page_header %}
<!-- Custom greeting header -->
{% set current_hour = now.hour %}
<div class="greeting">
    {% if current_hour < 12 %}
        <span class="material-symbols-outlined">light_mode</span>
        Good morning{% if student_name %}, {{ student_name }}{% endif %}!
    {% elif current_hour < 18 %}
        <span class="material-symbols-outlined">wb_sunny</span>
        Good afternoon{% if student_name %}, {{ student_name }}{% endif %}!
    {% else %}
        <span class="material-symbols-outlined">nights_stay</span>
        Good evening{% if student_name %}, {{ student_name }}{% endif %}!
    {% endif %}
</div>
<time id="current-time"></time>
{% endblock %}

{% block content %}
<!-- Session Timer Alert -->
<div class="alert alert-warning text-center fw-bold" id="session-timer" style="margin-bottom: 1.5rem;">
    <span class="material-symbols-outlined">schedule</span> Session expires in <span id="countdown">10:00</span>
</div>

<!-- Quick Action Hub: Tap In/Out + Queue Status -->
<div class="row mb-3">
    <!-- Tap In/Out Card -->
    <div class="col-lg-7 mb-3">
        <div class="card h-100">
            <div class="card-header">
                <span class="material-symbols-outlined">fact_check</span> Attendance
            </div>
            <div class="card-body p-3">
                <ul class="nav nav-tabs nav-tabs-sm mb-2" id="attendanceTabs" role="tablist">
                    {% for blk in student_blocks %}
                    <li class="nav-item" role="presentation">
                        <button class="nav-link {% if loop.first %}active{% endif %} py-1 px-2 small"
                                id="tab-{{ blk }}-tab"
                                data-bs-toggle="tab"
                                data-bs-target="#tab-{{ blk }}"
                                type="button"
                                role="tab">
                            Block {{ blk|upper }}
                        </button>
                    </li>
                    {% endfor %}
                </ul>
                <div class="tab-content" id="attendanceTabContent">
                    {% for blk in student_blocks %}
                    <div class="tab-pane fade {% if loop.first %}show active{% endif %}"
                         id="tab-{{ blk }}"
                         role="tabpanel"
                         data-block-row="{{ blk }}">
                        {% set state = period_states[blk] %}

                        <!-- Hall Pass Info Display -->
                        <div id="hallPassInfo-{{ blk }}" style="display: none;" class="mb-2"></div>

                        <div class="row align-items-center">
                            <div class="col-md-7">
                                <div class="d-flex align-items-center gap-2 mb-2">
                                    <span id="status-{{ blk }}" class="block-status badge {% if state['active'] and not state['done'] %}bg-success{% else %}bg-secondary{% endif %} px-2 py-1">
                                        {{ 'Active' if state['active'] and not state['done'] else 'Inactive' }}
                                    </span>
                                    <small>
                                        <strong>Unpaid:</strong>
                                        <span class="block-duration text-primary">{{ (unpaid_seconds_per_block[blk] // 3600)|string + 'h ' + ((unpaid_seconds_per_block[blk] % 3600) // 60)|string + 'm' }}</span>
                                    </small>
                                </div>
                                <div>
                                    <small><strong>Projected Pay:</strong></small>
                                    <span class="text-success fs-5">$<span class="block-pay" data-period="{{ blk }}">{{ '%.2f'|format(projected_pay_per_block[blk]) }}</span></span>
                                </div>
                            </div>
                            <div class="col-md-5 text-md-end mt-2 mt-md-0">
                                <button class="btn btn-success me-1 mb-1 tap-btn"
                                        id="tapIn-{{ blk }}"
                                        data-period="{{ blk }}"
                                        data-action="tap_in"
                                        {% if state['active'] or state['done'] %}disabled{% endif %}>
                                    <span class="material-symbols-outlined" style="font-size: 1rem;">login</span> Tap In
                                </button>
                                <button class="btn btn-danger mb-1 tap-btn"
                                        id="tapOut-{{ blk }}"
                                        data-period="{{ blk }}"
                                        data-action="tap_out"
                                        {% if not state['active'] %}disabled{% endif %}>
                                    <span class="material-symbols-outlined" style="font-size: 1rem;">logout</span> Tap Out
                                </button>
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </div>
        </div>
    </div>

    <!-- Restroom Queue Card -->
    <div class="col-lg-5 mb-3">
        <div class="card h-100">
            <div class="card-header d-flex justify-content-between align-items-center">
                <span><span class="material-symbols-outlined">group</span> Queue Status</span>
                <small class="text-muted" style="font-size: 0.7rem;">Updates every 10s</small>
            </div>
            <div class="card-body p-3">
                <div class="row text-center g-2">
                    <div class="col-4">
                        <div class="p-2 bg-info bg-opacity-10 rounded">
                            <h4 class="mb-0" id="queueCountDash">-</h4>
                            <small class="text-muted" style="font-size: 0.7rem;">In Queue</small>
                        </div>
                    </div>
                    <div class="col-4">
                        <div class="p-2 bg-warning bg-opacity-10 rounded">
                            <h4 class="mb-0" id="outNowCountDash">-</h4>
                            <small class="text-muted" style="font-size: 0.7rem;">Out Now</small>
                        </div>
                    </div>
                    <div class="col-4">
                        <div class="p-2 bg-success bg-opacity-10 rounded">
                            <h4 class="mb-0" id="availableSlotsDash">-</h4>
                            <small class="text-muted" style="font-size: 0.7rem;">Available</small>
                        </div>
                    </div>
                </div>
                <div id="queueLimitWarning" class="alert alert-danger mt-2 mb-0 py-2 px-2" style="display: none; font-size: 0.85rem;">
                    <strong><span class="material-symbols-outlined" style="font-size: 1rem;">warning</span> Queue Limit!</strong><br>
                    <small>Restroom, Locker, and Office passes temporarily unavailable.</small>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Session Timeout Modal -->
<div class="modal fade" id="timeoutModal" tabindex="-1" aria-labelledby="timeoutModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="timeoutModalLabel">Session Expired</h5>
            </div>
            <div class="modal-body">
                <span class="material-symbols-outlined">alarm</span> Time's up! You are now being signed out.
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-danger" onclick="window.location.href='{{ url_for('student.logout') }}'">Log Out</button>
            </div>
        </div>
    </div>
</div>

<!-- Announcements Section -->
{% if not student.insurance_paid and student.insurance_plan != 'none' %}
<div class="alert alert-danger mb-4">
    <span class="material-symbols-outlined">warning</span> <strong>Action Required:</strong> Your insurance payment is past due.
</div>
{% endif %}
{% if recent_deposit %}
<div class="alert alert-success mb-4">
    <span class="material-symbols-outlined">check_circle</span> You received a deposit of ${{ '%.2f'|format(recent_deposit.amount) }}.
</div>
{% endif %}

<!-- Main Dashboard Content -->
<div class="row mb-3">
    <!-- Left Column: Stacked Info Cards -->
    <div class="col-lg-6 mb-3">
        <!-- Balances Card -->
        <div class="card mb-2">
            <div class="card-body p-3">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <h6 class="mb-1">Balances</h6>
                        <div class="d-flex gap-3">
                            <div>
                                <small class="text-muted d-block" style="font-size: 0.7rem;">Checking</small>
                                <strong class="text-primary">${{ "%.2f"|format(student.checking_balance) }}</strong>
                            </div>
                            <div>
                                <small class="text-muted d-block" style="font-size: 0.7rem;">Savings</small>
                                <strong class="text-success">${{ "%.2f"|format(student.savings_balance) }}</strong>
                            </div>
                            <div>
                                <small class="text-muted d-block" style="font-size: 0.7rem;">Total</small>
                                <strong>${{ "%.2f"|format(student.checking_balance + student.savings_balance) }}</strong>
                            </div>
                        </div>
                    </div>
                    <a href="{{ url_for('student.transfer') }}" class="btn btn-sm btn-primary">Manage</a>
                </div>
            </div>
        </div>

        <!-- Hall Pass Card -->
        <div class="card mb-2">
            <div class="card-body p-3">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <h6 class="mb-1">Hall Pass</h6>
                        <div>
                            <span class="text-warning fs-5" id="hall-pass-balance">{{ student.hall_passes }}</span>
                            <small class="text-muted ms-2">remaining</small>
                        </div>
                    </div>
                    <span class="material-symbols-outlined text-warning" style="font-size: 2rem;">confirmation_number</span>
                </div>
            </div>
        </div>

        <!-- Insurance Card -->
        <div class="card mb-2">
            <div class="card-body p-3">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <h6 class="mb-1">Insurance</h6>
                        <div>
                            {% if student.insurance_plan == 'none' %}
                                <span class="badge bg-secondary">None</span>
                            {% elif insurance_paid %}
                                <span class="badge bg-success">Active</span>
                                <small class="text-muted ms-2">{{ student.insurance_plan|title }}</small>
                            {% else %}
                                <span class="badge bg-danger">Overdue</span>
                                <small class="text-muted ms-2">{{ student.insurance_plan|title }}</small>
                            {% endif %}
                        </div>
                    </div>
                    <a href="{{ url_for('student.student_insurance') }}" class="btn btn-sm btn-outline-primary">View</a>
                </div>
            </div>
        </div>

        <!-- Rent Card (if enabled) -->
        {% if global_rent_enabled and student.is_rent_enabled %}
        <div class="card mb-2">
            <div class="card-body p-3">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <h6 class="mb-1">Rent</h6>
                        <div>
                            {% if rent_paid_current %}
                                <span class="badge bg-success">Paid</span>
                                <small class="text-muted ms-2">{{ rent_last_paid.astimezone(now.tzinfo).strftime('%b %d') if rent_last_paid else '' }}</small>
                            {% elif rent_overdue %}
                                <span class="badge bg-danger">Overdue</span>
                                <small class="text-muted ms-2">Due {{ rent_due_date.strftime('%b %d') }}</small>
                            {% else %}
                                <span class="badge bg-warning text-dark">Due</span>
                                <small class="text-muted ms-2">Due {{ rent_due_date.strftime('%b %d') }}</small>
                            {% endif %}
                        </div>
                    </div>
                    <a href="{{ url_for('student.rent') }}" class="btn btn-sm btn-outline-primary">Manage</a>
                </div>
            </div>
        </div>
        {% endif %}

        <!-- Job Card -->
        <div class="card mb-2">
            <div class="card-body p-3">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <h6 class="mb-1">Jobs</h6>
                        <div>
                            <span class="badge bg-secondary">Student</span>
                            <small class="text-muted ms-2">Current Role</small>
                        </div>
                    </div>
                    <span class="material-symbols-outlined text-success" style="font-size: 2rem;">work</span>
                </div>
            </div>
        </div>
    </div>

    <!-- Right Column: Item Status -->
    <div class="col-lg-6 mb-3">
        <div class="card h-100">
            <div class="card-header d-flex justify-content-between align-items-center">
                <span><span class="material-symbols-outlined">inventory_2</span> Item Status</span>
                <small class="text-muted" style="font-size: 0.7rem;">Updates every 30s</small>
            </div>
            <div class="card-body p-3" id="redemptionStatusCard">
                {% set processing_items = student_items|selectattr('status', 'equalto', 'processing')|list %}
                {% set redeemed_items = (student_items|selectattr('status', 'equalto', 'redeemed')|list) + (student_items|selectattr('status', 'equalto', 'completed')|list) %}
                {% set expired_items = student_items|selectattr('status', 'equalto', 'expired')|list %}

                <div class="row g-2">
                    <div class="col-md-4">
                        <div class="text-center p-2 bg-warning bg-opacity-10 rounded">
                            <h4 class="mb-0" id="processingCount">{{ processing_items|length }}</h4>
                            <small class="text-muted" style="font-size: 0.7rem;">Pending</small>
                        </div>
                        {% if processing_items|length > 0 and processing_items|length <= 2 %}
                        <ul class="list-group list-group-flush mt-1" id="processingList">
                            {% for item in processing_items[:2] %}
                            <li class="list-group-item px-0 py-1 border-0">
                                <small style="font-size: 0.7rem;">{{ item.store_item.name }}</small>
                            </li>
                            {% endfor %}
                        </ul>
                        {% endif %}
                    </div>
                    <div class="col-md-4">
                        <div class="text-center p-2 bg-success bg-opacity-10 rounded">
                            <h4 class="mb-0" id="redeemedCount">{{ redeemed_items|length }}</h4>
                            <small class="text-muted" style="font-size: 0.7rem;">Redeemed</small>
                        </div>
                        {% if redeemed_items|length > 0 and redeemed_items|length <= 2 %}
                        <ul class="list-group list-group-flush mt-1" id="redeemedList">
                            {% for item in redeemed_items[:2] %}
                            <li class="list-group-item px-0 py-1 border-0">
                                <small style="font-size: 0.7rem;">{{ item.store_item.name }}</small>
                            </li>
                            {% endfor %}
                        </ul>
                        {% endif %}
                    </div>
                    <div class="col-md-4">
                        <div class="text-center p-2 bg-danger bg-opacity-10 rounded">
                            <h4 class="mb-0" id="expiredCount">{{ expired_items|length }}</h4>
                            <small class="text-muted" style="font-size: 0.7rem;">Expired</small>
                        </div>
                        {% if expired_items|length > 0 and expired_items|length <= 2 %}
                        <ul class="list-group list-group-flush mt-1" id="expiredList">
                            {% for item in expired_items[:2] %}
                            <li class="list-group-item px-0 py-1 border-0">
                                <small style="font-size: 0.7rem;">{{ item.store_item.name }}</small>
                            </li>
                            {% endfor %}
                        </ul>
                        {% endif %}
                    </div>
                </div>
                <div class="mt-2 text-center">
                    <a href="{{ url_for('student.shop') }}" class="btn btn-sm btn-primary">
                        <span class="material-symbols-outlined" style="font-size: 1rem;">visibility</span> View All
                    </a>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Hall Pass Request Modal -->
<div class="modal fade" id="hallPassModal" tabindex="-1" aria-labelledby="hallPassModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="hallPassModalLabel">Request Hall Pass</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="hallPassForm">
                    <input type="hidden" id="hallPassPeriod">
                    <div class="mb-3">
                        <label for="hallPassReason" class="form-label">Reason for leaving:</label>
                        <select class="form-select" id="hallPassReason" required>
                            <option value="" disabled selected>-- Select a reason --</option>
                            <option value="Restroom">Restroom</option>
                            <option value="Office">Office</option>
                            <option value="Locker">Locker</option>
                            <option value="Nurse">Nurse</option>
                            <option value="Summons">Summons</option>
                            <option value="Done for the day">Done for the day</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="hallPassPin" class="form-label">Enter your PIN to confirm:</label>
                        <input type="password" class="form-control" id="hallPassPin" inputmode="numeric" pattern="[0-9]*" required>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="confirmHallPassBtn">Request Pass</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<!-- Session Timer Script -->
<script>
    let timeLeft = {{ session_remaining_seconds }};
    const countdownEl = document.getElementById('countdown');
    const formatTime = (seconds) => {
        const m = Math.floor(seconds / 60).toString().padStart(2, '0');
        const s = (seconds % 60).toString().padStart(2, '0');
        return `${m}:${s}`;
    };
    const interval = setInterval(() => {
        timeLeft--;
        countdownEl.textContent = formatTime(timeLeft);
        if (timeLeft <= 0) {
            clearInterval(interval);
            const modal = new bootstrap.Modal(document.getElementById('timeoutModal'));
            modal.show();
            setTimeout(() => window.location.href = "{{ url_for('student.logout') }}", 5000);
        }
    }, 1000);
</script>

<!-- Attendance Script -->
<script src="/static/js/attendance.js"></script>

<!-- Queue Status and Limit Logic -->
<script>
    let currentQueueTotal = 0;
    let queueEnabled = true;

    function updateQueueStatus() {
        fetch('/api/hall-pass/queue')
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    const queueCount = data.queue.length;
                    const outNow = data.currently_out;
                    const total = queueCount + outNow;
                    const queueLimit = data.queue_limit || 10;
                    const available = Math.max(0, queueLimit - total);

                    currentQueueTotal = total;
                    queueEnabled = data.queue_enabled;

                    // Update dashboard display
                    document.getElementById('queueCountDash').textContent = queueCount;
                    document.getElementById('outNowCountDash').textContent = outNow;
                    document.getElementById('availableSlotsDash').textContent = available;

                    // Show/hide warning
                    const warning = document.getElementById('queueLimitWarning');
                    if (!queueEnabled) {
                        warning.style.display = 'block';
                        warning.innerHTML = '<strong><span class="material-symbols-outlined">block</span> Queue System Disabled!</strong><br>Only Summon and Nurse passes are available at this time.';
                    } else if (total >= queueLimit) {
                        warning.style.display = 'block';
                        warning.innerHTML = '<strong><span class="material-symbols-outlined">warning</span> Queue Limit Reached!</strong><br>Restroom, Locker, and Office passes are temporarily unavailable. Please wait for the queue to clear.';
                    } else {
                        warning.style.display = 'none';
                    }

                    // Update hall pass modal options
                    updateHallPassOptions(!queueEnabled || total >= queueLimit);
                }
            })
            .catch(error => console.error('Failed to fetch queue status:', error));
    }

    function updateHallPassOptions(isRestricted) {
        const reasonSelect = document.getElementById('hallPassReason');
        if (!reasonSelect) return;

        const restrictedReasons = ['Restroom', 'Office', 'Locker'];
        const options = reasonSelect.querySelectorAll('option');

        options.forEach(option => {
            if (restrictedReasons.includes(option.value)) {
                if (isRestricted) {
                    option.disabled = true;
                    if (!queueEnabled) {
                        option.textContent = option.value + ' (Queue System Disabled)';
                    } else {
                        option.textContent = option.value + ' (Unavailable - Queue Full)';
                    }
                } else {
                    option.disabled = false;
                    option.textContent = option.value;
                }
            }
        });
    }

    // Initial fetch
    updateQueueStatus();

    // Refresh every 10 seconds
    setInterval(updateQueueStatus, 10000);
</script>

<!-- Redemption Status Auto-Refresh -->
<script>
    // Auto-refresh redemption status card every 30 seconds
    setInterval(() => {
        fetch(window.location.href)
            .then(response => response.text())
            .then(html => {
                const parser = new DOMParser();
                const doc = parser.parseFromString(html, 'text/html');
                const newCard = doc.getElementById('redemptionStatusCard');
                if (newCard) {
                    document.getElementById('redemptionStatusCard').innerHTML = newCard.innerHTML;
                }
            })
            .catch(error => console.error('Failed to refresh redemption status:', error));
    }, 30000); // 30 seconds
</script>

<!-- Server State -->
<script id="serverState" type="application/json">
    {{ period_states_json | safe }}
</script>
{% endblock %}
