<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Student Dashboard</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body {
            animation: fadein 0.6s ease-in;
        }
        @keyframes fadein {
            from { opacity: 0; }
            to   { opacity: 1; }
        }
        .overdue-row {
            background-color: #ffe5e5 !important;
        }
    </style>
</head>
<body class="container mt-4">
    <div class="alert alert-warning text-center fw-bold shadow-sm sticky-top" id="session-timer">
        ‚è≥ You will be signed out in <span id="countdown">10:00</span>
    </div>

    <!-- Session Timeout Modal -->
    <div class="modal fade" id="timeoutModal" tabindex="-1" aria-labelledby="timeoutModalLabel" aria-hidden="true">
      <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="timeoutModalLabel">Session Expired</h5>
          </div>
          <div class="modal-body">
            ‚è∞ Time's up! You are now being signed out.
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-danger" onclick="logoutNow()">Log Out</button>
          </div>
        </div>
      </div>
    </div>

    <script>
        let timeLeft = 600;  // 10 minutes
        const countdownEl = document.getElementById('countdown');
        const formatTime = (seconds) => {
            const m = Math.floor(seconds / 60).toString().padStart(2, '0');
            const s = (seconds % 60).toString().padStart(2, '0');
            return `${m}:${s}`;
        };
        const interval = setInterval(() => {
            timeLeft--;
            countdownEl.textContent = formatTime(timeLeft);
            if (timeLeft <= 0) {
                clearInterval(interval);
                const modal = new bootstrap.Modal(document.getElementById('timeoutModal'));
                modal.show();
                setTimeout(() => window.location.href = "/student/logout", 5000);
            }
        }, 1000);
    </script>

    {% set current_hour = now.hour %}
    {% if current_hour < 12 %}
        <h2 class="mb-4">Good morning, {{ student.name }}!</h2>
    {% elif current_hour < 18 %}
        <h2 class="mb-4">Good afternoon, {{ student.name }}!</h2>
    {% else %}
        <h2 class="mb-4">Good evening, {{ student.name }}!</h2>
    {% endif %}

    <!-- Basic Info -->
    <div class="mb-4">
        <p><strong>Email:</strong> {{ student.email }}</p>
        <p><strong>Block:</strong> {{ student.block }}</p>
    </div>

    <!-- Balances -->
    <div class="row mb-4">
        <div class="col-md-6">
            <div class="card border-success">
                <div class="card-body">
                    <h5 class="card-title">üí∞ Checking Balance</h5>
                    <p class="card-text">${{ '%.2f'|format(student.checking_balance) }}</p>
                </div>
            </div>
        </div>
        <div class="col-md-6">
            <div class="card border-info">
                <div class="card-body">
                    <h5 class="card-title">üè¶ Savings Balance</h5>
                    <p class="card-text">${{ '%.2f'|format(student.savings_balance) }}</p>
                    <p class="card-text"><small>Forecasted Interest: ${{ '%.2f'|format(forecast_interest) }}</small></p>
                </div>
            </div>
        </div>
    </div>

    <!-- Transaction Summary -->
    <div class="mb-4">
        <h4>üìä Transaction Summary</h4>
        <table class="table table-bordered">
            <tbody>
                <tr>
                    <th scope="row">Total Deposits</th>
                    <td>${{ student.total_earnings }}</td>
                </tr>
                <tr>
                    <th scope="row">Total Checking Transactions</th>
                    <td>${{ '%.2f'|format(student.checking_balance) }}</td>
                </tr>
                <tr>
                    <th scope="row">Total Savings Transactions</th>
                    <td>${{ '%.2f'|format(student.savings_balance) }}</td>
                </tr>
            </tbody>
        </table>
    </div>

    <!-- Account Summary -->
    <div class="mb-4">
        <h4>Account Summary</h4>
        <table class="table table-bordered">
            <tbody>
                <tr>
                    <th scope="row">Restroom Passes Left</th>
                    <td>{{ student.passes_left }}</td>
                </tr>
                <tr class="{% if not student.rent_paid and now.date() > now.date().replace(day=5) %}overdue-row{% endif %}">
                    <th scope="row">Rent</th>
                    <td>
                        {% if student.is_rent_enabled %}
                            {% set today = now.date() %}
                            {% set due_date = today.replace(day=1) %}
                            {% set overdue_date = today.replace(day=5) %}
                            <div class="d-flex align-items-center flex-wrap gap-2">
                                {% if student.rent_paid %}
                                    Paid for the month
                                {% else %}
                                    {% if today > overdue_date %}
                                        <span class="text-danger fw-bold">PAST DUE ‚Äì PAY IMMEDIATELY</span>
                                    {% else %}
                                        <span>Balance due: $800 (Due by {{ due_date.strftime('%b %d') }}, grace until {{ overdue_date.strftime('%b %d') }})</span>
                                    {% endif %}
                                {% endif %}
                                <form method="POST" action="/student/pay/rent">
                                    <button type="submit" class="btn btn-sm btn-primary">Pay Now</button>
                                </form>
                            </div>
                        {% else %}
                            Not applicable
                        {% endif %}
                    </td>
                </tr>
                <tr class="{% if not student.property_tax_paid and student.is_property_tax_enabled and student.owns_seat and now.date() > now.date().replace(day=5) %}overdue-row{% endif %}">
                    <th scope="row">Property Tax</th>
                    <td>
                        {% if student.is_property_tax_enabled and student.owns_seat %}
                            {% set today = now.date() %}
                            {% set due_date = today.replace(day=1) %}
                            {% set overdue_date = today.replace(day=5) %}
                            <div class="d-flex align-items-center flex-wrap gap-2">
                                {% if student.property_tax_paid %}
                                    Paid for the month
                                {% else %}
                                    {% if today > overdue_date %}
                                        <span class="text-danger fw-bold">PAST DUE ‚Äì PAY IMMEDIATELY</span>
                                    {% else %}
                                        <span>Balance due: $120 (Due by {{ due_date.strftime('%b %d') }}, grace until {{ overdue_date.strftime('%b %d') }})</span>
                                    {% endif %}
                                {% endif %}
                                <form method="POST" action="/student/pay/property_tax" class="d-inline ms-2">
                                    <button type="submit" class="btn btn-sm btn-primary">Pay Now</button>
                                </form>
                            </div>
                        {% else %}
                            Not applicable
                        {% endif %}
                    </td>
                </tr>
                <tr class="{% if student.insurance_plan != 'none' and not student.insurance_paid %}overdue-row{% endif %}">
                    <th scope="row">Insurance</th>
                    <td>
                        {% if student.insurance_plan != 'none' %}
                            {% set today = now.date() %}
                            {% set due_date = today.replace(day=1) %}
                            {% set overdue_date = today.replace(day=5) %}
                            <div class="d-flex align-items-center flex-wrap gap-2">
                                {% if student.insurance_paid %}
                                    {{ student.insurance_plan.replace('_', ' ').title() }} ‚Äì Paid for the month
                                {% else %}
                                    <span class="text-danger fw-bold">PAST DUE ‚Äì PAY IMMEDIATELY</span><br>
                                    {{ student.insurance_plan.replace('_', ' ').title() }} ‚Äì Balance due: $200 (Due by {{ due_date.strftime('%b %d') }}, grace until {{ overdue_date.strftime('%b %d') }})
                                {% endif %}
                                <form method="POST" action="/student/pay/insurance" class="d-inline ms-2">
                                    <button type="submit" class="btn btn-sm btn-primary">Pay Now</button>
                                </form>
                            </div>
                        {% else %}
                            Not applicable
                        {% endif %}
                    </td>
                </tr>
                <tr>
                    <th scope="row">Next Auto-Pay Date</th>
                    <td>{{ student.next_pay_date.strftime('%Y-%m-%d') if student.next_pay_date else "N/A" }}</td>
                </tr>
                <tr>
                    <th scope="row">Total Pay to Date</th>
                    <td>${{ student.earnings_since_last_payday | default(0, true) | float | round(2) }}</td>
                </tr>
                <tr>
                    <th scope="row">On Track for Next Month's Bills?</th>
                    <td>
                        {% if student.amount_needed_to_cover_bills <= 0 %}
                            ‚úÖ Yes
                        {% else %}
                            ‚ùå No: ${{ "{:,.2f}".format(student.amount_needed_to_cover_bills) }} left needed
                        {% endif %}
                    </td>
                </tr>
                {% if student.purchases %}
                <tr>
                    <th scope="row">Purchased Items</th>
                    <td>
                        <ul class="mb-0">
                            {% for item in student.purchases %}
                                <li>{{ item.item_name }} ({{ item.timestamp.strftime('%Y-%m-%d') }})</li>
                            {% endfor %}
                        </ul>
                    </td>
                </tr>
                {% endif %}
            </tbody>
        </table>
    </div>

    <!-- Checking Transaction History -->
    <div class="mb-4">
        <h4>üí≥ Checking Transaction History</h4>
        {% if checking_transactions %}
            <table class="table table-striped">
                <thead>
                    <tr>
                        <th>Date</th>
                        <th>Description</th>
                        <th>Amount</th>
                    </tr>
                </thead>
                <tbody>
                    {% for tx in checking_transactions %}
                    <tr class="{% if tx.is_void %}text-muted text-decoration-line-through{% endif %}">
                        <td>{{ tx.timestamp.strftime('%Y-%m-%d %H:%M') }}</td>
                        <td>{{ tx.description }}</td>
                        <td>
                            {% if tx.amount < 0 %}
                                <span class="text-danger">-${{ '%.2f'|format(-tx.amount) }}</span>
                            {% else %}
                                <span class="text-success">${{ '%.2f'|format(tx.amount) }}</span>
                            {% endif %}
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        {% else %}
            <p>No checking transactions found.</p>
        {% endif %}
    </div>

    <!-- Savings Transaction History -->
    <div class="mb-4">
        <h4>üè¶ Savings Transaction History</h4>
        {% if savings_transactions %}
            <table class="table table-striped">
                <thead>
                    <tr>
                        <th>Date</th>
                        <th>Description</th>
                        <th>Amount</th>
                    </tr>
                </thead>
                <tbody>
                    {% for tx in savings_transactions %}
                    <tr class="{% if tx.is_void %}text-muted text-decoration-line-through{% endif %}">
                        <td>{{ tx.timestamp.strftime('%Y-%m-%d %H:%M') }}</td>
                        <td>{{ tx.description }}</td>
                        <td>
                            {% if tx.amount < 0 %}
                                <span class="text-danger">-${{ '%.2f'|format(-tx.amount) }}</span>
                            {% else %}
                                <span class="text-success">${{ '%.2f'|format(tx.amount) }}</span>
                            {% endif %}
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        {% else %}
            <p>No savings transactions found.</p>
        {% endif %}
    </div>

    <!-- Actions -->
<div class="mb-4">
    <h5>Actions</h5>
    <a href="/student/transfer" class="btn btn-outline-primary me-2">Transfer Funds</a>
    <a href="/student/logout" class="btn btn-outline-danger">Logout</a>
</div>
</body>
</html>
