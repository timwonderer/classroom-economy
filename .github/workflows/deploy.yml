name: Deploy to DO on push to main

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest
    environment: production
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up SSH
      uses: webfactory/ssh-agent@v0.9.0
      with:
        ssh-private-key: ${{ secrets.DO_DEPLOY_KEY }}



    - name: Deploy to DO Production Server
      run: |
        MAINT_MODE="${{ vars.MAINTENANCE_MODE || 'false' }}"
        MAINT_MESSAGE="${{ vars.MAINTENANCE_MESSAGE || 'We are performing scheduled maintenance.' }}"
        MAINT_END="${{ vars.MAINTENANCE_EXPECTED_END || '' }}"
        MAINT_CONTACT="${{ vars.MAINTENANCE_CONTACT || '' }}"

        SSH_ENV_VARS="MAINT_MODE=$(printf %q "$MAINT_MODE") MAINT_MESSAGE=$(printf %q "$MAINT_MESSAGE") MAINT_END=$(printf %q "$MAINT_END") MAINT_CONTACT=$(printf %q "$MAINT_CONTACT")"

        # Connect to the production server and deploy
        ssh -o StrictHostKeyChecking=no root@24.199.127.184 "export ${SSH_ENV_VARS}; bash -s" << 'EOF'

          set -e  # Exit immediately if a command exits with a non-zero status

          echo 'Navigating to project directory...'
          cd ~/classroom-economy

          echo 'Fetching latest changes from main...'
          git fetch origin main

          echo 'Resetting to match remote main branch...'
          git reset --hard origin/main

          echo 'Activating virtual environment...'
          source venv/bin/activate

          echo 'Updating maintenance mode settings...'
          # Remove old maintenance mode variables if they exist
          sed -i '/^MAINTENANCE_MODE=/d' .env 2>/dev/null || true
          sed -i '/^MAINTENANCE_MESSAGE=/d' .env 2>/dev/null || true
          sed -i '/^MAINTENANCE_EXPECTED_END=/d' .env 2>/dev/null || true
          sed -i '/^MAINTENANCE_CONTACT=/d' .env 2>/dev/null || true

          # Add updated maintenance mode variables from GitHub
          echo "MAINTENANCE_MODE=${MAINT_MODE}" >> .env
          echo "MAINTENANCE_MESSAGE=\"${MAINT_MESSAGE}\"" >> .env
          echo "MAINTENANCE_EXPECTED_END=\"${MAINT_END}\"" >> .env
          echo "MAINTENANCE_CONTACT=\"${MAINT_CONTACT}\"" >> .env

          echo 'Installing dependencies...'
          pip install -r requirements.txt

          # Ensure DATABASE_URL is set for migrations
          echo 'Exporting DATABASE_URL for production migrations...'

          echo 'Checking for multiple migration heads...'
          HEAD_COUNT=$(flask db heads 2>&1 | grep -c "^[a-z0-9]" || echo "0")

          if [ "$HEAD_COUNT" -gt 1 ]; then
            echo "⚠️  Multiple heads detected. Attempting to resolve..."
            echo "Current heads:"
            flask db heads

            # Get all head revisions
            HEADS=$(flask db heads | grep "^[a-z0-9]" | awk '{print $1}' | tr '\n' ' ')
            echo "Heads to merge: $HEADS"

            # Create a merge migration
            echo "Creating merge migration..."
            flask db merge -m "Auto-merge multiple heads during deployment" $HEADS || {
              echo "❌ Failed to create merge migration. Stamping to latest known good head..."
              # Stamp to the expected head (b3c4d5e6f7g8)
              flask db stamp b3c4d5e6f7g8
            }
          fi

          echo 'Running database migrations...'
          flask db upgrade


          echo 'Restarting Gunicorn...'
          sudo systemctl restart gunicorn

          echo 'Deployment completed successfully.'

        EOF

