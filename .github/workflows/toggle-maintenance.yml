name: Toggle Maintenance Mode

on:
  workflow_dispatch:
    inputs:
      enabled:
        description: 'Enable maintenance mode'
        required: true
        type: boolean
        default: false
      badge_type:
        description: 'Badge type'
        required: false
        type: choice
        default: 'maintenance'
        options:
          - maintenance
          - bug
          - security
          - update
          - feature
          - unavailable
          - error
      message:
        description: 'Maintenance message'
        required: false
        default: ""
      expected_end:
        description: 'Expected end time (e.g., "Back online by 3:00 PM")'
        required: false
        default: ''
      contact:
        description: 'Contact email'
        required: false
        default: ''
      status_description:
        description: 'The application is currently:'
        required: false
        default: ''

jobs:
  toggle:
    runs-on: ubuntu-latest
    environment: production
    steps:
    - name: Set up SSH
      uses: webfactory/ssh-agent@v0.9.1
      with:
        ssh-private-key: ${{ secrets.DO_DEPLOY_KEY }}

    - name: Update maintenance mode on server
      run: |
        ENABLED="${{ inputs.enabled }}"
        MODE_VALUE="false"
        if [ "$ENABLED" = "true" ]; then
          MODE_VALUE="true"
        fi

        MESSAGE="${{ inputs.message }}"
        EXPECTED_END="${{ inputs.expected_end }}"
        CONTACT="${{ inputs.contact }}"
        BADGE_TYPE="${{ inputs.badge_type }}"
        STATUS_DESCRIPTION="${{ inputs.status_description }}"

        SSH_ENV_VARS="MODE_VALUE=$(printf %q "${MODE_VALUE}") MESSAGE=$(printf %q "${MESSAGE}") EXPECTED_END=$(printf %q "${EXPECTED_END}") CONTACT=$(printf %q "${CONTACT}") BADGE_TYPE=$(printf %q "${BADGE_TYPE}") STATUS_DESCRIPTION=$(printf %q "${STATUS_DESCRIPTION}")"

        ssh -o StrictHostKeyChecking=no root@24.199.127.184 "export ${SSH_ENV_VARS}; bash -s" << 'EOF'
          set -e

          echo 'Navigating to project directory...'
          cd ~/classroom-economy

          echo 'Updating maintenance mode settings...'
          # Remove old maintenance mode variables
          sed -i '/^MAINTENANCE_MODE=/d' .env 2>/dev/null || true
          sed -i '/^MAINTENANCE_MESSAGE=/d' .env 2>/dev/null || true
          sed -i '/^MAINTENANCE_EXPECTED_END=/d' .env 2>/dev/null || true
          sed -i '/^MAINTENANCE_CONTACT=/d' .env 2>/dev/null || true
          sed -i '/^MAINTENANCE_BADGE_TYPE=/d' .env 2>/dev/null || true
          sed -i '/^MAINTENANCE_STATUS_DESCRIPTION=/d' .env 2>/dev/null || true

          # Add new maintenance mode variables
          echo "MAINTENANCE_MODE=$MODE_VALUE" >> .env
          echo "MAINTENANCE_MESSAGE=\"$MESSAGE\"" >> .env
          echo "MAINTENANCE_EXPECTED_END=\"$EXPECTED_END\"" >> .env
          echo "MAINTENANCE_CONTACT=\"$CONTACT\"" >> .env
          echo "MAINTENANCE_BADGE_TYPE=\"$BADGE_TYPE\"" >> .env
          echo "MAINTENANCE_STATUS_DESCRIPTION=\"$STATUS_DESCRIPTION\"" >> .env

          echo 'Restarting Gunicorn to apply changes...'
          sudo systemctl restart gunicorn

          echo "Maintenance mode updated: $MODE_VALUE"
          if [ "$MODE_VALUE" = "true" ]; then
            echo "Badge type: $BADGE_TYPE"
            echo "Message: $MESSAGE"
            echo "Expected end: $EXPECTED_END"
            echo "Contact: $CONTACT"
            echo "Status description: $STATUS_DESCRIPTION"
          fi
        EOF

    - name: Summary
      run: |
        if [ "${{ inputs.enabled }}" = "true" ]; then
          echo "Maintenance mode ENABLED"
          echo "Badge type: ${{ inputs.badge_type }}"
          echo "Message: ${{ inputs.message }}"
          echo "Status: ${{ inputs.status_description }}"
        else
          echo "Maintenance mode DISABLED - Site is live"
        fi
