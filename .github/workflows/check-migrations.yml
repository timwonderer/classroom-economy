name: Check Database Migrations

on:
  pull_request:
    branches: [ main ]
    paths:
      - 'migrations/versions/**'
      - 'app/models/**'

  # Also allow manual trigger
  workflow_dispatch:

permissions:
  contents: read
  pull-requests: write  # For commenting on PRs

jobs:
  check-migration-heads:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0  # Full history needed for migration checks

    - name: Set up Python
      uses: actions/setup-python@v6
      with:
        python-version: '3.11'

    - name: Cache pip dependencies
      uses: actions/cache@v3
      with:
        path: ~/.cache/pip
        key: ${{ runner.os }}-pip-${{ hashFiles('**/requirements.txt') }}
        restore-keys: |
          ${{ runner.os }}-pip-

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install alembic flask-migrate
        if [ -f requirements.txt ]; then pip install -r requirements.txt; fi

    - name: Check for multiple migration heads
      run: |
        echo "üîç Checking for multiple migration heads..."
        python << 'PYTHON_SCRIPT'
        import sys
        from alembic.script import ScriptDirectory
        from alembic.config import Config

        try:
            config = Config('migrations/alembic.ini')
            config.set_main_option('script_location', 'migrations')
            script = ScriptDirectory.from_config(config)
            heads = list(script.get_revisions('heads'))

            print(f"\nüìä Migration Status:")
            print(f"   Total heads: {len(heads)}")

            if len(heads) > 1:
                print(f"\n‚ùå ERROR: {len(heads)} migration heads detected!")
                print("\n‚ö†Ô∏è  This PR would create divergent migration paths.")
                print("\nMigration heads found:")
                for i, head in enumerate(heads, 1):
                    print(f"  {i}. {head.revision} - {head.doc}")
                print("\nüîß To fix this:")
                print("   1. Sync with main: git fetch origin main && git merge origin/main")
                print("   2. Create merge migration: flask db merge heads -m 'Merge migration heads'")
                print("   3. Commit and push the merge migration")
                print("\n‚ùå Pull request cannot be merged until this is resolved.")
                sys.exit(1)
            else:
                print(f"‚úÖ Migration heads check passed!")
                if heads:
                    print(f"   Current head: {heads[0].revision}")
                    print(f"   Message: {heads[0].doc}")

        except Exception as e:
            print(f"‚ö†Ô∏è  Warning: Could not check migration heads: {e}")
            print("   Allowing check to pass...")
            sys.exit(0)
        PYTHON_SCRIPT

    - name: Verify migration files are valid
      run: |
        echo "üîç Validating migration file syntax..."
        python << 'PYTHON_SCRIPT'
        import sys
        import os
        from pathlib import Path

        migration_dir = Path('migrations/versions')
        if not migration_dir.exists():
            print("‚úì No migrations directory found")
            sys.exit(0)

        errors = []
        for migration_file in migration_dir.glob('*.py'):
            if migration_file.name == '__init__.py':
                continue

            try:
                with open(migration_file, 'r') as f:
                    content = f.read()

                # Check for required components
                if 'def upgrade():' not in content:
                    errors.append(f"{migration_file.name}: Missing upgrade() function")
                if 'def downgrade():' not in content:
                    errors.append(f"{migration_file.name}: Missing downgrade() function")
                if 'revision =' not in content:
                    errors.append(f"{migration_file.name}: Missing revision identifier")
                if 'down_revision =' not in content:
                    errors.append(f"{migration_file.name}: Missing down_revision")

            except Exception as e:
                errors.append(f"{migration_file.name}: {str(e)}")

        if errors:
            print("‚ùå Migration validation errors found:")
            for error in errors:
                print(f"   ‚Ä¢ {error}")
            sys.exit(1)
        else:
            print("‚úÖ All migration files are valid")
        PYTHON_SCRIPT

    - name: Comment on PR (if check fails)
      if: failure()
      uses: actions/github-script@v6
      with:
        script: |
          github.rest.issues.createComment({
            issue_number: context.issue.number,
            owner: context.repo.owner,
            repo: context.repo.repo,
            body: '‚ö†Ô∏è **Migration Check Failed**\n\nThis PR has multiple migration heads or invalid migration files. Please check the [workflow logs](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}) for details.\n\n**Common fixes:**\n1. Sync with main before creating migrations: `git fetch origin main && git merge origin/main`\n2. Create a merge migration: `flask db merge heads -m "Merge migration heads"`\n3. Ensure all migration files have valid `upgrade()` and `downgrade()` functions'
          })
