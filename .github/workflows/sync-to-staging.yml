name: Sync Feature to Staging and Deploy

on:
  push:
    branches-ignore:
      - main
      - staging

jobs:
  sync-and-deploy:
    runs-on: ubuntu-latest
    environment: staging
    steps:
      - name: Checkout staging
        uses: actions/checkout@v4
        with:
          ref: staging
          fetch-depth: 0

      - name: Configure Git
        run: |
          git config user.name "GitHub Actions"
          git config user.email "actions@github.com"

      - name: Merge Feature Branch
        run: |
          git fetch origin ${{ github.ref }}
          git merge origin/${{ github.ref_name }} --no-ff -m "Merge feature ${{ github.ref_name }} into staging"
          git push origin staging

      - name: Set up SSH
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.DO_DEPLOY_KEY }}

      - name: Deploy to Staging Server
        run: |
          MAINT_MODE="${{ vars.MAINTENANCE_MODE || 'false' }}"
          MAINT_MESSAGE="${{ vars.MAINTENANCE_MESSAGE || 'We are performing scheduled maintenance.' }}"
          MAINT_END="${{ vars.MAINTENANCE_EXPECTED_END || '' }}"
          MAINT_CONTACT="${{ vars.MAINTENANCE_CONTACT || '' }}"
          TURNSTILE_SITE="${{ secrets.TURNSTILE_SITE_KEY || '' }}"
          TURNSTILE_SECRET="${{ secrets.TURNSTILE_SECRET_KEY || '' }}"
          DEPLOY_BRANCH="staging"

          SSH_ENV_VARS="DEPLOY_BRANCH=$(printf %q "$DEPLOY_BRANCH") MAINT_MODE=$(printf %q "$MAINT_MODE") MAINT_MESSAGE=$(printf %q "$MAINT_MESSAGE") MAINT_END=$(printf %q "$MAINT_END") MAINT_CONTACT=$(printf %q "$MAINT_CONTACT") TURNSTILE_SITE=$(printf %q "$TURNSTILE_SITE") TURNSTILE_SECRET=$(printf %q "$TURNSTILE_SECRET")"

          ssh -o StrictHostKeyChecking=no root@${{ secrets.STAGING_SERVER_IP }} "export ${SSH_ENV_VARS}; bash -s" < scripts/deploy-app.sh
