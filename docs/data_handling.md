# Data Handling and Processing

This document provides a technical overview of the data collected, processed, and stored by the Classroom Token Hub application.

## 1. Data Collection Points

Data is collected at several points in the application lifecycle:

-   **Student Roster Upload**: An administrator uploads a CSV file containing student first names, last names, dates of birth, and class block assignments.
-   **Manual Student Entry**: An administrator can manually enter the same student information through the admin dashboard.
-   **Student Account Claim**: Students use a combination of identifiers derived from their uploaded information to claim their accounts.
-   **Student Setup**: During the setup process, students create a username, PIN, and passphrase.
-   **Application Usage**: The system logs all user activities, including attendance, transactions, and store purchases.

## 2. Student Data

The `Student` model is the central repository for student information. The following table details each field, its purpose, and how it is stored.

| Field                     | Data Type        | Storage Format                                                                                                                                                                                                                                                        | Description                                                                                                                                                                                                                                      |
| ------------------------- | ---------------- | --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- | ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------ |
| `id`                      | Integer          | Plaintext                                                                                                                                                                                                                                                             | Primary key for the student record.                                                                                                                                                                                                              |
| `first_name`              | String           | Plaintext                                                                                                                                                                                                                                                             | The student's first name.                                                                                                                                                                                                                        |
| `last_initial`            | String           | Plaintext                                                                                                                                                                                                                                                             | The first letter of the student's last name.                                                                                                                                                                                                     |
| `block`                   | String           | Plaintext                                                                                                                                                                                                                                                             | The class block or period the student belongs to (e.g., "A", "B1").                                                                                                                                                                              |
| `salt`                    | LargeBinary      | 16 random bytes, generated by `secrets.token_bytes(16)` or the `random.org` API.                                                                                                                                                                                      | A unique, per-student value used in hashing to prevent rainbow table attacks.                                                                                                                                                                  |
| `first_half_hash`         | String (64)      | HMAC-SHA256 hash of `salt + name_code`. The `name_code` is derived from the student's first and last name.                                                                                                                                                              | The first part of the two-factor credential used for initial account claiming.                                                                                                                                                                   |
| `second_half_hash`        | String (64)      | HMAC-SHA256 hash of `salt + dob_sum`.                                                                                                                                                                                                                                   | The second part of the two-factor credential used for initial account claiming.                                                                                                                                                                  |
| `username_hash`           | String (64)      | HMAC-SHA256 hash of `salt + username`.                                                                                                                                                                                                                                  | The hashed version of the student's chosen username. Used for login verification.                                                                                                                                                                |
| `pin_hash`                | Text             | Hashed using `werkzeug.security.generate_password_hash()`, which defaults to a strong key derivation function like Argon2.                                                                                                                                                | The hashed version of the student's PIN. Used for login verification.                                                                                                                                                                            |
| `passphrase_hash`         | Text             | Hashed using `werkzeug.security.generate_password_hash()`.                                                                                                                                                                                                              | The hashed version of the student's passphrase. Used for high-stakes actions like financial transfers.                                                                                                                                           |
| `dob_sum`                 | Integer          | Plaintext integer (Month + Day + Year).                                                                                                                                                                                                                               | A non-reversible sum of the student's date of birth components. Used as part of the account claim and username generation process. The full date of birth is never stored.                                                                         |
| `has_completed_setup`     | Boolean          | Plaintext                                                                                                                                                                                                                                                             | A flag indicating whether the student has completed the initial account setup.                                                                                                                                                                   |
| `passes_left`             | Integer          | Plaintext                                                                                                                                                                                                                                                             | Tracks the number of hall passes a student has.                                                                                                                                                                                                  |
| `is_rent_enabled`         | Boolean          | Plaintext                                                                                                                                                                                                                                                             | A flag to enable or disable automatic rent deductions.                                                                                                                                                                                           |
| `cumulative_daily_sec`    | Integer          | Plaintext                                                                                                                                                                                                                                                             | Stores the total number of seconds a student has been "tapped in" for attendance.                                                                                                                                                                |
| `cumulative_payroll_sec`  | Integer          | Plaintext                                                                                                                                                                                                                                                             | Stores the total number of seconds for which payroll has been calculated and paid.                                                                                                                                                               |

## 3. Administrator Data

The `Admin` and `SystemAdmin` models store credentials for teachers and system administrators.

| Model         | Field         | Data Type | Storage Format | Description                                                                 |
| ------------- | ------------- | --------- | -------------- | --------------------------------------------------------------------------- |
| `Admin`       | `username`    | String    | Plaintext      | The administrator's username.                                               |
| `Admin`       | `totp_secret` | String    | Plaintext      | The secret key used to generate Time-Based One-Time Passwords (TOTP).       |
| `SystemAdmin` | `username`    | String    | Plaintext      | The system administrator's username.                                        |
| `SystemAdmin` | `totp_secret` | String    | Plaintext      | The secret key for the system administrator's TOTP.                         |

## 4. Activity and Transactional Data

This data is generated through user interactions with the application.

-   **`Transaction` Model**: Records all financial activities, including payroll, bonuses, fees, and transfers. Each transaction is linked to a `student_id` and includes the amount, timestamp, account type, and a description. All transaction data is stored in plaintext.

-   **`TapEvent` Model**: An append-only log of all attendance-related events. Each event records the `student_id`, class `period`, `status` ('active' or 'inactive'), and a `timestamp`. This provides a granular and immutable history of student attendance.

-   **`StoreItem` & `StudentItem` Models**: These models manage the classroom store. `StoreItem` contains details about items for sale (name, price, inventory), while `StudentItem` tracks items purchased by students. All data is stored in plaintext.

-   **`AdminInviteCode` Model**: Stores single-use invite codes for new administrator signups. Each code has an expiration date and a `used` flag.

## 5. Data Encryption

The application includes a custom SQLAlchemy type `PIIEncryptedType` that uses the `cryptography.fernet` library (AES-128 in CBC mode with HMAC) to provide symmetric encryption for database columns.

**Note**: As of the current version, this encryption layer is defined in `app.py` but is not actively applied to any columns in the database models. This feature is available for future use cases requiring encryption of specific PII fields at rest.