# Data Security and Privacy

This document outlines the security measures and privacy protections implemented within the Classroom Token Hub application.

## 1. Authentication

The application employs distinct authentication mechanisms for each user role to ensure appropriate access control.

### 1.1. Student Authentication

Students log in using a three-factor system:

1.  **Username**: A unique identifier generated during the account setup process.
2.  **PIN**: A 4-6 digit personal identification number.
3.  **Passphrase**: A secret phrase required for high-stakes actions, such as transferring funds.

Both the PIN and the passphrase are treated as passwords and are hashed using a strong, modern key derivation function.

### 1.2. Administrator (Teacher) Authentication

Administrator accounts are secured exclusively with **Time-Based One-Time Passwords (TOTP)**.

-   **No Passwords**: Admins do not have passwords. Access is granted only by providing a valid TOTP code from an authenticator app (e.g., Google Authenticator, Authy).
-   **Secure Setup**: New administrators can only sign up using a single-use invite code generated by a System Admin. During setup, they are required to scan a QR code to configure their TOTP authenticator.

### 1.3. System Administrator Authentication

System administrator accounts, which have the highest level of privilege, are also secured with **TOTP-only authentication**. This ensures that access to system-level settings and user management is protected by strong multi-factor authentication.

## 2. Data at Rest Protection

### 2.1. Hashing

The application uses multiple state-of-the-art hashing techniques to protect sensitive data.

-   **Passwords, PINs, and Passphrases**: Student credentials (PINs and passphrases) are hashed using `werkzeug.security.generate_password_hash()`. This function uses a strong, modern key derivation function (such as `scrypt` or `pbkdf2:sha256`, depending on the library version) and automatically includes a per-user salt. This method is highly resistant to brute-force, dictionary, and rainbow table attacks. The project includes a `security.py` file with an Argon2 implementation, but it is not currently used for hashing student credentials.

-   **Usernames and Other Identifiers**: Non-password identifiers, such as student usernames and the components used for account claiming (`name_code`, `dob_sum`), are hashed using **HMAC-SHA256**. This process incorporates three key components to ensure maximum security:
    1.  **Per-Student Salt**: A unique, 16-byte random salt is generated for each student record.
    2.  **Global Pepper**: A secret key (`PEPPER_KEY`) stored as an environment variable is included in the hash calculation.
    3.  **HMAC**: The use of HMAC (Hash-based Message Authentication Code) prevents certain types of cryptographic attacks.

This multi-layered hashing strategy ensures that even if the database were compromised, the original values could not be feasibly recovered.

### 2.2. Encryption

The application includes a custom SQLAlchemy data type, `PIIEncryptedType`, designed to encrypt specific data fields at rest.

-   **Algorithm**: This feature uses the **`cryptography.fernet`** library, which provides symmetric authenticated cryptography using AES-128 in CBC mode with a PKCS7 padding, and signs all messages with HMAC-SHA256.
-   **Implementation**: Encryption and decryption are handled transparently at the application layer. When data is written to the database, it is encrypted; when read, it is decrypted.
-   **Current Usage**: While this encryption layer is implemented and available, it is not currently applied to any specific columns in the production database schema. It is reserved for future use cases involving the storage of highly sensitive PII.

## 3. Data in Transit Protection

All communication between the user's browser and the application server is encrypted using **HTTPS/TLS**. This is enforced by the production web server (e.g., Gunicorn behind NGINX) and ensures that all data, including credentials and session tokens, is protected from eavesdropping and man-in-the-middle attacks.

## 4. Other Security Measures

-   **Cross-Site Request Forgery (CSRF) Protection**: The application uses the `Flask-WTF` library to generate and validate CSRF tokens for all forms. This prevents attackers from tricking users into submitting malicious requests.

-   **Session Management**:
    -   **Secure Cookies**: Session cookies are configured with the `Secure` and `SameSite='None'` flags (for cross-origin requests if needed) or `SameSite='Lax'` by default, which helps mitigate CSRF and other session-based attacks.
    -   **Strict Timeouts**: All user sessions (student, admin, and system admin) have a strict, server-enforced idle timeout of 10 minutes. This reduces the risk of unauthorized access from unattended devices.

## 5. Privacy and Compliance

The application is designed with student privacy as a primary consideration and adheres to relevant regulations.

-   **Data Minimization**: The application collects the minimum amount of personally identifiable information necessary for its educational function. For example, it stores only the student's last initial and a non-reversible `dob_sum` instead of their full last name and date of birth.

-   **Compliance**: The application's data handling and security practices are designed to be compliant with:
    -   **FERPA** (Family Educational Rights and Privacy Act)
    -   **COPPA** (Children's Online Privacy Protection Act)

The user-facing [Privacy Policy](</privacy>) provides a simplified overview of these commitments.