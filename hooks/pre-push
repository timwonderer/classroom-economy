#!/bin/bash
#
# Pre-push hook to check for multiple Alembic migration heads
# This prevents pushing changes that would create migration conflicts
#

# ANSI color codes
RED='\033[0;31m'
YELLOW='\033[1;33m'
GREEN='\033[0;32m'
NC='\033[0m' # No Color

# Only check if migrations directory exists
if [ ! -d "migrations" ]; then
    exit 0
fi

echo "ğŸ” Checking for multiple migration heads..."

# Check for multiple heads using Python
python3 << 'PYTHON_SCRIPT'
import sys
import os

try:
    # Change to migrations directory
    if not os.path.exists('migrations/alembic.ini'):
        print("âœ“ No migrations directory found, skipping check")
        sys.exit(0)

    from alembic.script import ScriptDirectory
    from alembic.config import Config

    config = Config('migrations/alembic.ini')
    config.set_main_option('script_location', 'migrations')
    script = ScriptDirectory.from_config(config)
    heads = list(script.get_revisions('heads'))

    if len(heads) > 1:
        print(f"\nâŒ ERROR: {len(heads)} migration heads detected!")
        print("\nThis means you have divergent migration paths that will cause conflicts.")
        print("\nTo fix this, create a merge migration:")
        print("  flask db merge heads -m 'Merge migration heads'")
        print("\nOr sync with main before creating your migration:")
        print("  git fetch origin main")
        print("  git merge origin/main")
        print("  # Then recreate your migration")
        print("\nâš ï¸  Push blocked to prevent migration conflicts.")
        sys.exit(1)
    else:
        print(f"âœ“ Migration heads check passed ({len(heads)} head)")

except ImportError:
    print("âš ï¸  Warning: alembic not installed, skipping migration head check")
    sys.exit(0)
except Exception as e:
    print(f"âš ï¸  Warning: Could not check migration heads: {e}")
    print("   Allowing push to continue...")
    sys.exit(0)

PYTHON_SCRIPT

exit_code=$?

if [ $exit_code -ne 0 ]; then
    echo ""
    echo -e "${RED}â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—${NC}"
    echo -e "${RED}â•‘         Push blocked due to migration conflicts           â•‘${NC}"
    echo -e "${RED}â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
    echo ""
    echo "To bypass this check (not recommended):"
    echo "  git push --no-verify"
    echo ""
    exit 1
fi

exit 0
