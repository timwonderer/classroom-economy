# Grafana Proxy Configuration Fix
#
# This file contains the CORRECTED Nginx configuration for Grafana.
# Copy the relevant sections to your Nginx config file.
# Location: /etc/nginx/sites-available/default (or your config file)

# Auth check endpoint for auth_request directive
location /sysadmin/auth-check {
    internal;
    auth_request off;
    proxy_pass http://127.0.0.1:8000;

    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;

    proxy_pass_request_body off;
    proxy_set_header Content-Length "";
}

# Grafana proxy with authentication
location /sysadmin/grafana/ {
    # Auth check - validate sysadmin session
    auth_request /sysadmin/auth-check;
    auth_request_set $auth_user $upstream_http_x_auth_user;

    # If auth fails, redirect to login
    error_page 401 = @grafana_login_redirect;

    # FIX: Remove trailing slash to preserve path!
    # BEFORE (WRONG): proxy_pass http://127.0.0.1:3000/;
    # AFTER (CORRECT):
    proxy_pass http://127.0.0.1:3000;

    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;

    # Use the validated username from auth check
    proxy_set_header X-WEBAUTH-USER $auth_user;
    proxy_set_header X-WEBAUTH-ROLE Admin;

    # WebSocket support for Grafana live features
    proxy_http_version 1.1;
    proxy_set_header Upgrade $http_upgrade;
    proxy_set_header Connection "upgrade";
}

# Redirect to login if not authenticated
location @grafana_login_redirect {
    return 302 /sysadmin/login;
}

# General sysadmin routes (Flask application)
location /sysadmin/ {
    auth_request /sysadmin/auth-check;
    proxy_pass http://127.0.0.1:8000;

    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;
}

# DEPLOYMENT INSTRUCTIONS:
#
# 1. Edit your Nginx config:
#    sudo nano /etc/nginx/sites-available/default
#
# 2. Find the line:
#    proxy_pass http://127.0.0.1:3000/;
#
# 3. Remove the trailing slash:
#    proxy_pass http://127.0.0.1:3000;
#
# 4. Test configuration:
#    sudo nginx -t
#
# 5. Reload Nginx:
#    sudo systemctl reload nginx
#
# 6. Test by accessing:
#    https://classroomtokenhub.com/sysadmin/grafana/
#
# FALLBACK:
# If Nginx fix doesn't work or isn't deployed, the Flask proxy
# (already in this branch) will automatically handle Grafana requests.
